<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Kevin&#39;s Notes</title>
  
  <subtitle>Quick notes</subtitle>
  <link href="https://freemankevin.uk/atom.xml" rel="self"/>
  
  <link href="https://freemankevin.uk/"/>
  <updated>2025-10-21T03:34:40.415Z</updated>
  <id>https://freemankevin.uk/</id>
  
  <author>
    <name>Freeman Kevin</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ä»ä¼ ç»Ÿåˆ†åŒºåˆ°LVMç»Ÿä¸€å­˜å‚¨çš„å®Œæ•´è¿ç§»å®è·µ</title>
    <link href="https://freemankevin.uk/2025/09/16/lvm/"/>
    <id>https://freemankevin.uk/2025/09/16/lvm/</id>
    <published>2025-09-16T02:10:00.000Z</published>
    <updated>2025-10-21T03:34:40.415Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨ä¼ä¸šçº§LinuxæœåŠ¡å™¨ç®¡ç†ä¸­ï¼Œå­˜å‚¨æ‰©å±•å’Œæ•°æ®è¿ç§»æ˜¯è¿ç»´å·¥ç¨‹å¸ˆç»å¸¸é¢ä¸´çš„æŒ‘æˆ˜ã€‚æœ¬æ–‡å°†è¯¦ç»†è®°å½•ä¸€æ¬¡çœŸå®çš„ç”Ÿäº§ç¯å¢ƒå­˜å‚¨é‡æ„é¡¹ç›®ï¼šå°†åˆ†æ•£åœ¨å¤šä¸ªä¼ ç»Ÿåˆ†åŒºçš„æ•°æ®ç»Ÿä¸€è¿ç§»åˆ°LVMï¼ˆLogical Volume Managerï¼‰ç®¡ç†çš„å¤§å®¹é‡å­˜å‚¨ä¸­ï¼Œå®ç°å­˜å‚¨çš„ç»Ÿä¸€ç®¡ç†å’ŒåŠ¨æ€æ‰©å±•ã€‚</p><span id="more"></span><h2 id="é¡¹ç›®èƒŒæ™¯ä¸éœ€æ±‚åˆ†æ"><a href="#é¡¹ç›®èƒŒæ™¯ä¸éœ€æ±‚åˆ†æ" class="headerlink" title="é¡¹ç›®èƒŒæ™¯ä¸éœ€æ±‚åˆ†æ"></a>é¡¹ç›®èƒŒæ™¯ä¸éœ€æ±‚åˆ†æ</h2><h3 id="åŸå§‹ç¯å¢ƒçŠ¶å†µ"><a href="#åŸå§‹ç¯å¢ƒçŠ¶å†µ" class="headerlink" title="åŸå§‹ç¯å¢ƒçŠ¶å†µ"></a>åŸå§‹ç¯å¢ƒçŠ¶å†µ</h3><p>æˆ‘ä»¬çš„æœåŠ¡å™¨é…ç½®å¦‚ä¸‹ï¼š</p><ul><li>ç³»ç»Ÿç›˜ï¼šSDA 446.6GBï¼ˆæ ¹åˆ†åŒºã€EFIåˆ†åŒºï¼‰</li><li>æ•°æ®ç›˜1ï¼šNVMe0n1 3.5TBï¼ˆå·²åˆ†åŒºï¼ŒæŒ‚è½½åˆ° <code>/data</code>ï¼‰</li><li>æ•°æ®ç›˜2ï¼šNVMe1n1 3.5TBï¼ˆæœªä½¿ç”¨ï¼‰</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">NAME               MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS</span><br><span class="line">sda                  8:0    0 446.6G  0 disk</span><br><span class="line">â”œâ”€sda1               8:1    0     1G  0 part /boot/efi</span><br><span class="line">â”œâ”€sda2               8:2    0 445.6G  0 part /</span><br><span class="line">â””â”€sda3               8:3    0    65M  0 part</span><br><span class="line">nvme0n1            259:0    0   3.5T  0 disk</span><br><span class="line">â””â”€nvme0n1p1        259:3    0 931.3G  0 part /data</span><br><span class="line">nvme1n1            259:1    0   3.5T  0 disk</span><br></pre></td></tr></table></figure><h3 id="é¢ä¸´çš„é—®é¢˜"><a href="#é¢ä¸´çš„é—®é¢˜" class="headerlink" title="é¢ä¸´çš„é—®é¢˜"></a>é¢ä¸´çš„é—®é¢˜</h3><ol><li><strong>å­˜å‚¨åˆ†æ•£</strong>ï¼šæ•°æ®åˆ†æ•£åœ¨ <code>/data</code> å’Œ <code>/home</code> ç­‰å¤šä¸ªæŒ‚è½½ç‚¹</li><li><strong>æ‰©å±•å›°éš¾</strong>ï¼šä¼ ç»Ÿåˆ†åŒºæ— æ³•åŠ¨æ€è°ƒæ•´å¤§å°</li><li><strong>èµ„æºæµªè´¹</strong>ï¼šNVMe1n1 å®Œå…¨æœªä½¿ç”¨</li><li><strong>ç®¡ç†å¤æ‚</strong>ï¼šå¤šä¸ªç‹¬ç«‹åˆ†åŒºå¢åŠ äº†ç®¡ç†å¤æ‚åº¦</li></ol><h3 id="ç›®æ ‡æ¶æ„è®¾è®¡"><a href="#ç›®æ ‡æ¶æ„è®¾è®¡" class="headerlink" title="ç›®æ ‡æ¶æ„è®¾è®¡"></a>ç›®æ ‡æ¶æ„è®¾è®¡</h3><p>è®¾è®¡ä¸€ä¸ªç»Ÿä¸€çš„LVMå­˜å‚¨æ¶æ„ï¼š</p><ul><li>å°†ä¸¤å—NVMeç›˜æ•´åˆä¸ºå•ä¸€å·ç»„ï¼ˆVolume Groupï¼‰</li><li>åˆ›å»ºå¤§å®¹é‡é€»è¾‘å·ï¼Œæä¾›çº¦7TBå¯ç”¨ç©ºé—´</li><li>é€šè¿‡è½¯é“¾æ¥ä¿æŒåº”ç”¨ç¨‹åºè·¯å¾„å…¼å®¹æ€§</li><li>å®ç°å­˜å‚¨çš„ç»Ÿä¸€ç®¡ç†å’ŒåŠ¨æ€æ‰©å±•èƒ½åŠ›</li></ul><h2 id="LVMæŠ€æœ¯åŸç†æ·±åº¦è§£æ"><a href="#LVMæŠ€æœ¯åŸç†æ·±åº¦è§£æ" class="headerlink" title="LVMæŠ€æœ¯åŸç†æ·±åº¦è§£æ"></a>LVMæŠ€æœ¯åŸç†æ·±åº¦è§£æ</h2><h3 id="LVMæ¶æ„å±‚æ¬¡"><a href="#LVMæ¶æ„å±‚æ¬¡" class="headerlink" title="LVMæ¶æ„å±‚æ¬¡"></a>LVMæ¶æ„å±‚æ¬¡</h3><p>LVMé‡‡ç”¨ä¸‰å±‚æ¶æ„è®¾è®¡ï¼Œä»åº•å±‚åˆ°ä¸Šå±‚åˆ†åˆ«æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">åº”ç”¨å±‚          æ–‡ä»¶ç³»ç»Ÿ (ext4/xfs)</span><br><span class="line">é€»è¾‘å±‚    â†     é€»è¾‘å· (Logical Volume)</span><br><span class="line">ç»„ç®¡ç†å±‚  â†     å·ç»„ (Volume Group)  </span><br><span class="line">ç‰©ç†å±‚    â†     ç‰©ç†å· (Physical Volume)</span><br><span class="line">ç¡¬ä»¶å±‚          ç‰©ç†ç£ç›˜ (/dev/nvme0n1, /dev/nvme1n1)</span><br></pre></td></tr></table></figure><h4 id="Physical-Volume-PV"><a href="#Physical-Volume-PV" class="headerlink" title="Physical Volume (PV)"></a>Physical Volume (PV)</h4><p>ç‰©ç†å·æ˜¯LVMçš„åŸºç¡€æ„å»ºå—ï¼Œå°†ç‰©ç†å­˜å‚¨è®¾å¤‡ï¼ˆç¡¬ç›˜ã€åˆ†åŒºï¼‰è½¬æ¢ä¸ºLVMå¯ç®¡ç†çš„æ ¼å¼ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># PVåˆ›å»ºè¿‡ç¨‹ä¸­çš„å…³é”®æ“ä½œ</span></span><br><span class="line">pvcreate /dev/nvme1n1</span><br><span class="line"><span class="comment"># åœ¨ç£ç›˜å¼€å¤´å†™å…¥LVMæ ‡ç­¾å’Œå…ƒæ•°æ®</span></span><br><span class="line"><span class="comment"># åˆ’åˆ†PE (Physical Extent) å•ä½ï¼Œé»˜è®¤4MB</span></span><br></pre></td></tr></table></figure><h4 id="Volume-Group-VG"><a href="#Volume-Group-VG" class="headerlink" title="Volume Group (VG)"></a>Volume Group (VG)</h4><p>å·ç»„å°†å¤šä¸ªç‰©ç†å·èšåˆä¸ºç»Ÿä¸€çš„å­˜å‚¨æ± ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vgcreate data_vg /dev/nvme1n1</span><br><span class="line"><span class="comment"># åˆ›å»ºå·ç»„å…ƒæ•°æ®</span></span><br><span class="line"><span class="comment"># å»ºç«‹PEåˆ°VGçš„æ˜ å°„å…³ç³»</span></span><br><span class="line"><span class="comment"># æä¾›ç»Ÿä¸€çš„å­˜å‚¨åœ°å€ç©ºé—´</span></span><br></pre></td></tr></table></figure><h4 id="Logical-Volume-LV"><a href="#Logical-Volume-LV" class="headerlink" title="Logical Volume (LV)"></a>Logical Volume (LV)</h4><p>é€»è¾‘å·æ˜¯ç”¨æˆ·å®é™…ä½¿ç”¨çš„å­˜å‚¨å•å…ƒï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p><ul><li><strong>åŠ¨æ€æ‰©å±•</strong>ï¼šå¯åœ¨çº¿æ‰©å±•å®¹é‡</li><li><strong>å¿«ç…§æ”¯æŒ</strong>ï¼šæ”¯æŒä¸€è‡´æ€§å¤‡ä»½</li><li><strong>æ¡å¸¦åŒ–</strong>ï¼šæ”¯æŒå¤šç£ç›˜å¹¶è¡ŒI&#x2F;O</li></ul><h3 id="LVM-vs-ä¼ ç»Ÿåˆ†åŒºå¯¹æ¯”"><a href="#LVM-vs-ä¼ ç»Ÿåˆ†åŒºå¯¹æ¯”" class="headerlink" title="LVM vs ä¼ ç»Ÿåˆ†åŒºå¯¹æ¯”"></a>LVM vs ä¼ ç»Ÿåˆ†åŒºå¯¹æ¯”</h3><table><thead><tr><th>ç‰¹æ€§</th><th>ä¼ ç»Ÿåˆ†åŒº</th><th>LVM</th></tr></thead><tbody><tr><td>å¤§å°è°ƒæ•´</td><td>å›°éš¾ï¼Œé€šå¸¸éœ€è¦é‡å»º</td><td>åœ¨çº¿åŠ¨æ€è°ƒæ•´</td></tr><tr><td>è·¨ç£ç›˜</td><td>ä¸æ”¯æŒ</td><td>æ”¯æŒè·¨å¤šä¸ªç‰©ç†ç£ç›˜</td></tr><tr><td>å¿«ç…§</td><td>ä¸æ”¯æŒ</td><td>æ”¯æŒCoWå¿«ç…§</td></tr><tr><td>æ€§èƒ½</td><td>å•ç£ç›˜æ€§èƒ½</td><td>æ”¯æŒæ¡å¸¦åŒ–æå‡æ€§èƒ½</td></tr><tr><td>ç®¡ç†å¤æ‚åº¦</td><td>ç®€å•</td><td>ä¸­ç­‰ï¼Œä½†åŠŸèƒ½å¼ºå¤§</td></tr></tbody></table><h2 id="å®æ–½æ–¹æ¡ˆè¯¦ç»†æ­¥éª¤"><a href="#å®æ–½æ–¹æ¡ˆè¯¦ç»†æ­¥éª¤" class="headerlink" title="å®æ–½æ–¹æ¡ˆè¯¦ç»†æ­¥éª¤"></a>å®æ–½æ–¹æ¡ˆè¯¦ç»†æ­¥éª¤</h2><h3 id="é˜¶æ®µä¸€ï¼šLVMåŸºç¡€è®¾æ–½æ„å»º"><a href="#é˜¶æ®µä¸€ï¼šLVMåŸºç¡€è®¾æ–½æ„å»º" class="headerlink" title="é˜¶æ®µä¸€ï¼šLVMåŸºç¡€è®¾æ–½æ„å»º"></a>é˜¶æ®µä¸€ï¼šLVMåŸºç¡€è®¾æ–½æ„å»º</h3><h4 id="1-1-åˆ›å»ºç‰©ç†å·"><a href="#1-1-åˆ›å»ºç‰©ç†å·" class="headerlink" title="1.1 åˆ›å»ºç‰©ç†å·"></a>1.1 åˆ›å»ºç‰©ç†å·</h4><p>é¦–å…ˆå°†NVMe1n1ç£ç›˜è½¬æ¢ä¸ºLVMç‰©ç†å·ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç‰©ç†å·ï¼Œå†™å…¥LVMå…ƒæ•°æ®</span></span><br><span class="line">pvcreate /dev/nvme1n1</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯PVåˆ›å»ºç»“æœ</span></span><br><span class="line">pvdisplay /dev/nvme1n1</span><br></pre></td></tr></table></figure><p>ç‰©ç†å·åˆ›å»ºè¿‡ç¨‹ä¸­ï¼ŒLVMä¼šåœ¨ç£ç›˜å¼€å¤´å†™å…¥ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ul><li>LVMæ ‡ç­¾ï¼ˆLVM2_memberï¼‰</li><li>ç‰©ç†å·UUID</li><li>å·ç»„åç§°</li><li>PEå¤§å°å’Œæ•°é‡</li></ul><h4 id="1-2-åˆ›å»ºå·ç»„"><a href="#1-2-åˆ›å»ºå·ç»„" class="headerlink" title="1.2 åˆ›å»ºå·ç»„"></a>1.2 åˆ›å»ºå·ç»„</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºå·ç»„ï¼Œå°†PVåŠ å…¥å­˜å‚¨æ± </span></span><br><span class="line">vgcreate data_vg /dev/nvme1n1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å·ç»„ä¿¡æ¯</span></span><br><span class="line">vgdisplay data_vg</span><br></pre></td></tr></table></figure><p>å·ç»„åˆ›å»ºåçš„å…³é”®å‚æ•°ï¼š</p><ul><li><strong>PE Size</strong>: 4.00 MiBï¼ˆé»˜è®¤ï¼‰</li><li><strong>Total PE</strong>: çº¦915,707ä¸ªPE</li><li><strong>Allocatable</strong>: æ˜¯å¦å¯åˆ†é…ç©ºé—´</li></ul><h4 id="1-3-åˆ›å»ºé€»è¾‘å·"><a href="#1-3-åˆ›å»ºé€»è¾‘å·" class="headerlink" title="1.3 åˆ›å»ºé€»è¾‘å·"></a>1.3 åˆ›å»ºé€»è¾‘å·</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºé€»è¾‘å·ï¼Œä½¿ç”¨æ‰€æœ‰å¯ç”¨ç©ºé—´</span></span><br><span class="line">lvcreate -l 100%FREE -n data1_lv data_vg</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯é€»è¾‘å·çŠ¶æ€</span></span><br><span class="line">lvdisplay /dev/data_vg/data1_lv</span><br></pre></td></tr></table></figure><p>å…³é”®å‚æ•°è¯´æ˜ï¼š</p><ul><li><code>-l 100%FREE</code>: ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„é€»è¾‘åˆ†åŒºå•å…ƒ</li><li><code>-n data1_lv</code>: æŒ‡å®šé€»è¾‘å·åç§°</li><li><code>data_vg</code>: ç›®æ ‡å·ç»„åç§°</li></ul><h4 id="1-4-æ–‡ä»¶ç³»ç»Ÿåˆ›å»º"><a href="#1-4-æ–‡ä»¶ç³»ç»Ÿåˆ›å»º" class="headerlink" title="1.4 æ–‡ä»¶ç³»ç»Ÿåˆ›å»º"></a>1.4 æ–‡ä»¶ç³»ç»Ÿåˆ›å»º</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºext4æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">mkfs.ext4 /dev/data_vg/data1_lv</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¼˜åŒ–å‚æ•°ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line">mkfs.ext4 -b 4096 -E stride=32,stripe-width=64 /dev/data_vg/data1_lv</span><br></pre></td></tr></table></figure><h3 id="é˜¶æ®µäºŒï¼šæ•°æ®è¿ç§»ç­–ç•¥ä¸å®æ–½"><a href="#é˜¶æ®µäºŒï¼šæ•°æ®è¿ç§»ç­–ç•¥ä¸å®æ–½" class="headerlink" title="é˜¶æ®µäºŒï¼šæ•°æ®è¿ç§»ç­–ç•¥ä¸å®æ–½"></a>é˜¶æ®µäºŒï¼šæ•°æ®è¿ç§»ç­–ç•¥ä¸å®æ–½</h3><h4 id="2-1-è¿ç§»å‡†å¤‡å·¥ä½œ"><a href="#2-1-è¿ç§»å‡†å¤‡å·¥ä½œ" class="headerlink" title="2.1 è¿ç§»å‡†å¤‡å·¥ä½œ"></a>2.1 è¿ç§»å‡†å¤‡å·¥ä½œ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæŒ‚è½½ç‚¹</span></span><br><span class="line"><span class="built_in">mkdir</span> /data1</span><br><span class="line">mount /dev/data_vg/data1_lv /data1</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç›®æ ‡ç›®å½•ç»“æ„</span></span><br><span class="line"><span class="built_in">mkdir</span> /data1/data_backup</span><br><span class="line"><span class="built_in">mkdir</span> /data1/home_backup</span><br></pre></td></tr></table></figure><h4 id="2-2-æ•°æ®å®Œæ•´æ€§è¿ç§»"><a href="#2-2-æ•°æ®å®Œæ•´æ€§è¿ç§»" class="headerlink" title="2.2 æ•°æ®å®Œæ•´æ€§è¿ç§»"></a>2.2 æ•°æ®å®Œæ•´æ€§è¿ç§»</h4><p>ä½¿ç”¨rsyncè¿›è¡Œå¢é‡åŒæ­¥ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è¿ç§»/dataæ•°æ®ï¼Œä¿æŒæ‰€æœ‰å±æ€§</span></span><br><span class="line"><span class="built_in">nohup</span> rsync -avxHAX --progress \</span><br><span class="line">    --exclude=<span class="string">&#x27;lost+found&#x27;</span> \</span><br><span class="line">    /data/ /data1/data_backup/ \</span><br><span class="line">    &gt; /data1/data_backup.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿ç§»/homeæ•°æ®ï¼ˆç¡®ä¿æ²¡æœ‰ç”¨æˆ·ç™»é™†ï¼Œå·²ç™»é™†ç”¨æˆ·è¯·è¸¢å‡ºï¼‰</span></span><br><span class="line"><span class="built_in">nohup</span> rsync -avxHAX --progress \</span><br><span class="line">    --exclude=<span class="string">&#x27;lost+found&#x27;</span> \</span><br><span class="line">    /home/ /data1/home_backup/ \</span><br><span class="line">    &gt; /data1/home_backup.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><p>rsyncå‚æ•°è¯¦è§£ï¼š</p><ul><li><code>-a</code>: å½’æ¡£æ¨¡å¼ï¼Œä¿æŒæƒé™ã€æ—¶é—´æˆ³ç­‰</li><li><code>-v</code>: è¯¦ç»†è¾“å‡º</li><li><code>-x</code>: ä¸è·¨æ–‡ä»¶ç³»ç»Ÿ</li><li><code>-H</code>: ä¿æŒç¡¬é“¾æ¥</li><li><code>-A</code>: ä¿æŒACL</li><li><code>-X</code>: ä¿æŒæ‰©å±•å±æ€§</li><li><code>--progress</code>: æ˜¾ç¤ºè¿›åº¦</li></ul><h4 id="2-3-æ•°æ®å®Œæ•´æ€§éªŒè¯"><a href="#2-3-æ•°æ®å®Œæ•´æ€§éªŒè¯" class="headerlink" title="2.3 æ•°æ®å®Œæ•´æ€§éªŒè¯"></a>2.3 æ•°æ®å®Œæ•´æ€§éªŒè¯</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ¯”è¾ƒæ–‡ä»¶æ•°é‡</span></span><br><span class="line">find /data -<span class="built_in">type</span> f | <span class="built_in">wc</span> -l</span><br><span class="line">find /data1/data_backup -<span class="built_in">type</span> f | <span class="built_in">wc</span> -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¯”è¾ƒæ€»å¤§å°</span></span><br><span class="line"><span class="built_in">du</span> -sh /data</span><br><span class="line"><span class="built_in">du</span> -sh /data1/data_backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨æ ¡éªŒå’ŒéªŒè¯ï¼ˆå¯é€‰ï¼Œè€—æ—¶è¾ƒé•¿ï¼‰</span></span><br><span class="line">find /data -<span class="built_in">type</span> f -<span class="built_in">exec</span> <span class="built_in">md5sum</span> &#123;&#125; \; | <span class="built_in">sort</span> &gt; /tmp/original.md5</span><br><span class="line"><span class="built_in">cd</span> /data1/data_backup</span><br><span class="line">find . -<span class="built_in">type</span> f -<span class="built_in">exec</span> <span class="built_in">md5sum</span> &#123;&#125; \; | <span class="built_in">sort</span> &gt; /tmp/backup.md5</span><br><span class="line">diff /tmp/original.md5 /tmp/backup.md5</span><br></pre></td></tr></table></figure><h3 id="é˜¶æ®µä¸‰ï¼šç³»ç»Ÿåˆ‡æ¢ä¸è¿›ç¨‹å¤„ç†"><a href="#é˜¶æ®µä¸‰ï¼šç³»ç»Ÿåˆ‡æ¢ä¸è¿›ç¨‹å¤„ç†" class="headerlink" title="é˜¶æ®µä¸‰ï¼šç³»ç»Ÿåˆ‡æ¢ä¸è¿›ç¨‹å¤„ç†"></a>é˜¶æ®µä¸‰ï¼šç³»ç»Ÿåˆ‡æ¢ä¸è¿›ç¨‹å¤„ç†</h3><h4 id="3-1-è¿›ç¨‹æ’æŸ¥ä¸å¤„ç†"><a href="#3-1-è¿›ç¨‹æ’æŸ¥ä¸å¤„ç†" class="headerlink" title="3.1 è¿›ç¨‹æ’æŸ¥ä¸å¤„ç†"></a>3.1 è¿›ç¨‹æ’æŸ¥ä¸å¤„ç†</h4><p>åœ¨å¸è½½åŸåˆ†åŒºå‰ï¼Œå¿…é¡»ç¡®ä¿æ²¡æœ‰è¿›ç¨‹å ç”¨ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥æ‰¾å ç”¨/dataçš„è¿›ç¨‹</span></span><br><span class="line">lsof +D /data</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹è¾“å‡ºåˆ†æ</span></span><br><span class="line">COMMAND       PID USER   FD   TYPE DEVICE   SIZE/OFF     NODE NAME</span><br><span class="line">sftp-serv 1528862 root    3r   REG  259,3 8776906927 11273975 /data/opt/...</span><br></pre></td></tr></table></figure><p>å‘ç°SFTPè¿›ç¨‹æ­£åœ¨ä¼ è¾“å¤§æ–‡ä»¶ï¼Œè¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆâ€é™æ€æ–‡ä»¶â€ä¼šæœ‰è¿›ç¨‹å ç”¨ã€‚</p><h4 id="3-2-ä¼˜é›…åœæ­¢æœåŠ¡"><a href="#3-2-ä¼˜é›…åœæ­¢æœåŠ¡" class="headerlink" title="3.2 ä¼˜é›…åœæ­¢æœåŠ¡"></a>3.2 ä¼˜é›…åœæ­¢æœåŠ¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åœæ­¢ç›¸å…³æœåŠ¡</span></span><br><span class="line">systemctl stop docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼ºåˆ¶ç»ˆæ­¢å ç”¨è¿›ç¨‹ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰</span></span><br><span class="line">fuser -km /data</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…å•ç‹¬ç»ˆæ­¢ç‰¹å®šè¿›ç¨‹</span></span><br><span class="line"><span class="built_in">kill</span> -15 1528862  <span class="comment"># æ¸©å’Œç»ˆæ­¢</span></span><br><span class="line"><span class="built_in">kill</span> -9 1528862   <span class="comment"># å¼ºåˆ¶ç»ˆæ­¢</span></span><br></pre></td></tr></table></figure><h4 id="3-3-å®‰å…¨å¸è½½ä¸åˆ‡æ¢"><a href="#3-3-å®‰å…¨å¸è½½ä¸åˆ‡æ¢" class="headerlink" title="3.3 å®‰å…¨å¸è½½ä¸åˆ‡æ¢"></a>3.3 å®‰å…¨å¸è½½ä¸åˆ‡æ¢</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¤‡ä»½fstab</span></span><br><span class="line"><span class="built_in">cp</span> /etc/fstab /etc/fstab.backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸è½½åŸåˆ†åŒº</span></span><br><span class="line">umount /data</span><br><span class="line"><span class="comment"># å¦‚æœbusyï¼Œä½¿ç”¨æ‡’å¸è½½</span></span><br><span class="line">umount -l /data</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å‘½ååŸç›®å½•ï¼ˆä¿ç•™å¤‡ä»½ï¼‰</span></span><br><span class="line"><span class="built_in">mv</span> /data /data.old</span><br><span class="line"><span class="built_in">mv</span> /home /home.old</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè½¯é“¾æ¥</span></span><br><span class="line"><span class="built_in">ln</span> -s /data1/data_backup /data</span><br><span class="line"><span class="built_in">ln</span> -s /data1/home_backup /home</span><br></pre></td></tr></table></figure><h3 id="é˜¶æ®µå››ï¼šå­˜å‚¨æ± æ‰©å±•"><a href="#é˜¶æ®µå››ï¼šå­˜å‚¨æ± æ‰©å±•" class="headerlink" title="é˜¶æ®µå››ï¼šå­˜å‚¨æ± æ‰©å±•"></a>é˜¶æ®µå››ï¼šå­˜å‚¨æ± æ‰©å±•</h3><h4 id="4-1-ç¬¬äºŒå—ç£ç›˜å¤„ç†"><a href="#4-1-ç¬¬äºŒå—ç£ç›˜å¤„ç†" class="headerlink" title="4.1 ç¬¬äºŒå—ç£ç›˜å¤„ç†"></a>4.1 ç¬¬äºŒå—ç£ç›˜å¤„ç†</h4><p>NVMe0n1å·²æœ‰åˆ†åŒºè¡¨ï¼Œéœ€è¦æ¸…ç†ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ¸…é™¤åˆ†åŒºè¡¨å’Œæ–‡ä»¶ç³»ç»Ÿç­¾å</span></span><br><span class="line">wipefs -a /dev/nvme0n1</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºç¤ºä¾‹</span></span><br><span class="line">/dev/nvme0n1: 8 bytes were erased at offset 0x00000200 (gpt): 45 46 49 20 50 41 52 54</span><br><span class="line">/dev/nvme0n1: 8 bytes were erased at offset 0x37e3ee55e00 (gpt): 45 46 49 20 50 41 52 54</span><br><span class="line">/dev/nvme0n1: 2 bytes were erased at offset 0x000001fe (PMBR): 55 aa</span><br></pre></td></tr></table></figure><h4 id="4-2-æ‰©å±•LVMå­˜å‚¨æ± "><a href="#4-2-æ‰©å±•LVMå­˜å‚¨æ± " class="headerlink" title="4.2 æ‰©å±•LVMå­˜å‚¨æ± "></a>4.2 æ‰©å±•LVMå­˜å‚¨æ± </h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å°†æ–°ç£ç›˜åŠ å…¥ç‰©ç†å·</span></span><br><span class="line">pvcreate /dev/nvme0n1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰©å±•å·ç»„</span></span><br><span class="line">vgextend data_vg /dev/nvme0n1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰©å±•é€»è¾‘å·</span></span><br><span class="line">lvextend -l +100%FREE /dev/data_vg/data1_lv</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰©å±•æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">resize2fs /dev/data_vg/data1_lv</span><br></pre></td></tr></table></figure><h4 id="4-3-éªŒè¯æ‰©å±•ç»“æœ"><a href="#4-3-éªŒè¯æ‰©å±•ç»“æœ" class="headerlink" title="4.3 éªŒè¯æ‰©å±•ç»“æœ"></a>4.3 éªŒè¯æ‰©å±•ç»“æœ</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å­˜å‚¨çŠ¶æ€</span></span><br><span class="line">pvdisplay</span><br><span class="line">vgdisplay data_vg</span><br><span class="line">lvdisplay /dev/data_vg/data1_lv</span><br><span class="line"><span class="built_in">df</span> -Th</span><br></pre></td></tr></table></figure><h3 id="é˜¶æ®µäº”ï¼šç³»ç»Ÿé…ç½®ä¸éªŒè¯"><a href="#é˜¶æ®µäº”ï¼šç³»ç»Ÿé…ç½®ä¸éªŒè¯" class="headerlink" title="é˜¶æ®µäº”ï¼šç³»ç»Ÿé…ç½®ä¸éªŒè¯"></a>é˜¶æ®µäº”ï¼šç³»ç»Ÿé…ç½®ä¸éªŒè¯</h3><h4 id="5-1-æ›´æ–°ç³»ç»Ÿé…ç½®"><a href="#5-1-æ›´æ–°ç³»ç»Ÿé…ç½®" class="headerlink" title="5.1 æ›´æ–°ç³»ç»Ÿé…ç½®"></a>5.1 æ›´æ–°ç³»ç»Ÿé…ç½®</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–°fstabï¼Œæ·»åŠ æ–°æŒ‚è½½é¡¹</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/dev/data_vg/data1_lv /data1 ext4 defaults 0 2&quot;</span> &gt;&gt; /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯fstabè¯­æ³•</span></span><br><span class="line">mount -a</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;åœ¨ä¼ä¸šçº§LinuxæœåŠ¡å™¨ç®¡ç†ä¸­ï¼Œå­˜å‚¨æ‰©å±•å’Œæ•°æ®è¿ç§»æ˜¯è¿ç»´å·¥ç¨‹å¸ˆç»å¸¸é¢ä¸´çš„æŒ‘æˆ˜ã€‚æœ¬æ–‡å°†è¯¦ç»†è®°å½•ä¸€æ¬¡çœŸå®çš„ç”Ÿäº§ç¯å¢ƒå­˜å‚¨é‡æ„é¡¹ç›®ï¼šå°†åˆ†æ•£åœ¨å¤šä¸ªä¼ ç»Ÿåˆ†åŒºçš„æ•°æ®ç»Ÿä¸€è¿ç§»åˆ°LVMï¼ˆLogical Volume Managerï¼‰ç®¡ç†çš„å¤§å®¹é‡å­˜å‚¨ä¸­ï¼Œå®ç°å­˜å‚¨çš„ç»Ÿä¸€ç®¡ç†å’ŒåŠ¨æ€æ‰©å±•ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="https://freemankevin.uk/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://freemankevin.uk/tags/Linux/"/>
    
    <category term="LVM" scheme="https://freemankevin.uk/tags/LVM/"/>
    
    <category term="æ•°æ®è¿ç§»" scheme="https://freemankevin.uk/tags/%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"/>
    
  </entry>
  
  <entry>
    <title>Harbor å¤šæ¶æ„é•œåƒç®¡ç†å®Œæ•´æŒ‡å—</title>
    <link href="https://freemankevin.uk/2025/08/13/docker-manifest/"/>
    <id>https://freemankevin.uk/2025/08/13/docker-manifest/</id>
    <published>2025-08-13T02:40:00.000Z</published>
    <updated>2025-10-21T03:34:40.407Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨ç°ä»£å®¹å™¨åŒ–ç¯å¢ƒä¸­ï¼Œå¤šæ¶æ„æ”¯æŒå˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚éšç€ ARM64 æ¶æ„åœ¨æœåŠ¡å™¨å’Œè¾¹ç¼˜è®¾å¤‡ä¸­çš„æ™®åŠï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºå’Œç®¡ç†æ”¯æŒå¤šç§ CPU æ¶æ„çš„å®¹å™¨é•œåƒã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ Harbor ç§æœ‰é•œåƒä»“åº“ä¸­ç®¡ç†å¤šæ¶æ„é•œåƒï¼ŒåŒ…æ‹¬é…ç½®ã€æ¨é€å’Œåˆ›å»º manifest åˆ—è¡¨çš„å®Œæ•´æµç¨‹ã€‚</p><span id="more"></span><h2 id="ç¯å¢ƒè¯´æ˜"><a href="#ç¯å¢ƒè¯´æ˜" class="headerlink" title="ç¯å¢ƒè¯´æ˜"></a>ç¯å¢ƒè¯´æ˜</h2><ul><li><strong>Harbor ç‰ˆæœ¬</strong>: è‡ªå»º Harbor ç§æœ‰ä»“åº“</li><li><strong>éƒ¨ç½²æ–¹å¼</strong>: HTTPS æ¨¡å¼ï¼Œä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œ443 ç«¯å£</li><li><strong>Docker ç‰ˆæœ¬</strong>: æ”¯æŒ manifest åŠŸèƒ½çš„ç‰ˆæœ¬</li><li><strong>ç›®æ ‡æ¶æ„</strong>: AMD64 å’Œ ARM64</li></ul><h2 id="é—®é¢˜èƒŒæ™¯"><a href="#é—®é¢˜èƒŒæ™¯" class="headerlink" title="é—®é¢˜èƒŒæ™¯"></a>é—®é¢˜èƒŒæ™¯</h2><p>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬é‡åˆ°äº†ä»¥ä¸‹æŒ‘æˆ˜ï¼š</p><ol><li>éœ€è¦å°†å•æ¶æ„é•œåƒè½¬æ¢ä¸ºå¤šæ¶æ„é•œåƒ</li><li>Harbor ä½¿ç”¨è‡ªç­¾å HTTPS è¯ä¹¦ï¼Œéœ€è¦æ­£ç¡®é…ç½® Docker å®¢æˆ·ç«¯</li><li>Docker manifest åŠŸèƒ½éœ€è¦ç‰¹å®šçš„é…ç½®å’Œæ“ä½œæµç¨‹</li><li>éœ€è¦æ‰¹é‡å¤„ç†å¤šä¸ªç‰ˆæœ¬çš„é•œåƒ</li></ol><h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><h3 id="1-Harbor-è¯ä¹¦é…ç½®"><a href="#1-Harbor-è¯ä¹¦é…ç½®" class="headerlink" title="1. Harbor è¯ä¹¦é…ç½®"></a>1. Harbor è¯ä¹¦é…ç½®</h3><h4 id="é—®é¢˜ç°è±¡"><a href="#é—®é¢˜ç°è±¡" class="headerlink" title="é—®é¢˜ç°è±¡"></a>é—®é¢˜ç°è±¡</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Get <span class="string">&quot;http://110.1.20.3/v2/&quot;</span>: dial tcp 110.1.20.3:80: connect: connection refused</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé”™è¯¯è¡¨æ˜ Docker å®¢æˆ·ç«¯å°è¯•ä½¿ç”¨ HTTP åè®®è¿æ¥ Harborï¼Œä½† Harbor å®é™…è¿è¡Œåœ¨ HTTPS æ¨¡å¼ã€‚</p><h4 id="è§£å†³æ­¥éª¤"><a href="#è§£å†³æ­¥éª¤" class="headerlink" title="è§£å†³æ­¥éª¤"></a>è§£å†³æ­¥éª¤</h4><p><strong>Step 1: é…ç½®å®¢æˆ·ç«¯è¯ä¹¦</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºè¯ä¹¦ç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/docker/certs.d/110.1.20.3/</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶ Harbor CA è¯ä¹¦å’ŒæœåŠ¡å™¨è¯ä¹¦</span></span><br><span class="line">\<span class="built_in">cp</span> -rvf /data/opt/installharbor/certs/&#123;ca.crt,harbor.crt&#125; /etc/docker/certs.d/110.1.20.3/</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™</span></span><br><span class="line"><span class="built_in">cd</span> /etc/docker/certs.d/110.1.20.3/</span><br><span class="line"><span class="built_in">chmod</span> 644 ca.crt harbor.crt</span><br></pre></td></tr></table></figure><p><strong>Step 2: é…ç½® Docker daemon</strong></p><p>ç¼–è¾‘ <code>/etc/docker/daemon.json</code>ï¼š</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;https://docker.m.daocloud.io&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;http://docker.1panel.live&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;https://docker.agsv.top&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;https://docker.agsvpt.work&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;https://dockerpull.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;https://dockerproxy.cn&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;debug&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;110.1.20.3&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ip-forward&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ipv6&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;live-restore&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log-driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;json-file&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log-level&quot;</span><span class="punctuation">:</span> <span class="string">&quot;warn&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;max-size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;100m&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max-file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;selinux-enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;experimental&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;storage-driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;overlay2&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data-root&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/data/docker_dir&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;default-ulimits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;nofile&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nofile&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Hard&quot;</span><span class="punctuation">:</span> <span class="number">65536</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Soft&quot;</span><span class="punctuation">:</span> <span class="number">65536</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;exec-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;native.cgroupdriver=systemd&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>å…³é”®é…ç½®è¯´æ˜ï¼š</strong></p><ul><li><code>&quot;experimental&quot;: true</code> - å¯ç”¨ manifest åŠŸèƒ½</li><li><code>&quot;insecure-registries&quot;: [&quot;110.1.20.3&quot;]</code> - ä¿¡ä»»è‡ªç­¾åè¯ä¹¦</li></ul><p><strong>Step 3: é‡å¯æœåŠ¡</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é‡å¯ Docker</span></span><br><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯ Harborï¼ˆåŒå°æœºå™¨éƒ¨ç½²éœ€è¦ï¼‰</span></span><br><span class="line"><span class="built_in">cd</span> /data/opt/installharbor/</span><br><span class="line">bash install.sh</span><br></pre></td></tr></table></figure><h3 id="2-å¸¸è§è¯ä¹¦é—®é¢˜è§£å†³"><a href="#2-å¸¸è§è¯ä¹¦é—®é¢˜è§£å†³" class="headerlink" title="2. å¸¸è§è¯ä¹¦é—®é¢˜è§£å†³"></a>2. å¸¸è§è¯ä¹¦é—®é¢˜è§£å†³</h3><h4 id="é—®é¢˜1ï¼šè¯ä¹¦æ–‡ä»¶æ‰©å±•åé”™è¯¯"><a href="#é—®é¢˜1ï¼šè¯ä¹¦æ–‡ä»¶æ‰©å±•åé”™è¯¯" class="headerlink" title="é—®é¢˜1ï¼šè¯ä¹¦æ–‡ä»¶æ‰©å±•åé”™è¯¯"></a>é—®é¢˜1ï¼šè¯ä¹¦æ–‡ä»¶æ‰©å±•åé”™è¯¯</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">missing key ca.key for client certificate ca.cert. CA certificates must use the extension .crt</span><br></pre></td></tr></table></figure><p><strong>è§£å†³æ–¹æ³•ï¼š</strong></p><ul><li>Docker è¦æ±‚ CA è¯ä¹¦å¿…é¡»ä½¿ç”¨ <code>.crt</code> æ‰©å±•å</li><li>å®¢æˆ·ç«¯è¯ä¹¦ç›®å½•ä¸åº”åŒ…å«ç§é’¥æ–‡ä»¶ï¼ˆ<code>.key</code> æ–‡ä»¶ï¼‰</li></ul><p><strong>æ­£ç¡®çš„è¯ä¹¦ç›®å½•ç»“æ„ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/docker/certs.d/110.1.20.3/</span><br><span class="line">â”œâ”€â”€ ca.crt          # CA è¯ä¹¦ï¼ˆå¿…éœ€ï¼‰</span><br><span class="line">â””â”€â”€ harbor.crt      # Harbor æœåŠ¡å™¨è¯ä¹¦ï¼ˆå¯é€‰ï¼‰</span><br></pre></td></tr></table></figure><h4 id="é—®é¢˜2ï¼šDocker-daemon-é…ç½®é”™è¯¯"><a href="#é—®é¢˜2ï¼šDocker-daemon-é…ç½®é”™è¯¯" class="headerlink" title="é—®é¢˜2ï¼šDocker daemon é…ç½®é”™è¯¯"></a>é—®é¢˜2ï¼šDocker daemon é…ç½®é”™è¯¯</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">json: cannot unmarshal string into Go struct field Config.experimental of type bool</span><br></pre></td></tr></table></figure><p><strong>è§£å†³æ–¹æ³•ï¼š</strong></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é”™è¯¯å†™æ³•</span></span><br><span class="line"><span class="attr">&quot;experimental&quot;</span><span class="punctuation">:</span> <span class="string">&quot;enabled&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­£ç¡®å†™æ³•</span></span><br><span class="line"><span class="attr">&quot;experimental&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br></pre></td></tr></table></figure><h3 id="3-å¤šæ¶æ„é•œåƒç®¡ç†è„šæœ¬"><a href="#3-å¤šæ¶æ„é•œåƒç®¡ç†è„šæœ¬" class="headerlink" title="3. å¤šæ¶æ„é•œåƒç®¡ç†è„šæœ¬"></a>3. å¤šæ¶æ„é•œåƒç®¡ç†è„šæœ¬</h3><p>åˆ›å»ºè‡ªåŠ¨åŒ–è„šæœ¬ <code>pushImages.sh</code> æ¥æ‰¹é‡å¤„ç†é•œåƒï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># ===================================</span></span><br><span class="line"><span class="comment"># æ‰¹é‡å¤„ç†ï¼šæ‰“ tag + æ¨é€ + åˆ›å»ºå¤šæ¶æ„ manifest</span></span><br><span class="line"><span class="comment"># æ”¯æŒ HTTPS Harbor è‡ªç­¾åè¯ä¹¦</span></span><br><span class="line"><span class="comment"># ===================================</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># Harbor é…ç½®</span></span><br><span class="line">HARBOR_HOST=<span class="string">&quot;110.1.20.3&quot;</span></span><br><span class="line">REPO_PREFIX=<span class="string">&quot;<span class="variable">$&#123;HARBOR_HOST&#125;</span>/library&quot;</span></span><br><span class="line">VERSIONS=(<span class="string">&quot;3.11.3&quot;</span> <span class="string">&quot;3.10.1&quot;</span> <span class="string">&quot;3.9.2&quot;</span> <span class="string">&quot;3.8.5&quot;</span>)</span><br><span class="line">ARCHES=(<span class="string">&quot;amd64&quot;</span> <span class="string">&quot;arm64&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¯å¦åˆ é™¤æ—§æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line">DELETE_OLD_TAGS=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸš€ å¼€å§‹å¤„ç†é•œåƒæ ‡ç­¾ä¸å¤šæ¶æ„æ¸…å•...&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸ“¡ Harbor åœ°å€: https://<span class="variable">$&#123;HARBOR_HOST&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ç™»å½•çŠ¶æ€</span></span><br><span class="line"><span class="keyword">if</span> ! docker login https://<span class="variable">$&#123;HARBOR_HOST&#125;</span> 2&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;âš ï¸  Docker æœªç™»å½•åˆ° Harborï¼Œè¯·å…ˆç™»å½•ï¼š&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;   docker login https://<span class="variable">$&#123;HARBOR_HOST&#125;</span>&quot;</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. å…ˆä¸ºæ‰€æœ‰é•œåƒæ‰“æ–°æ ‡ç­¾å¹¶æ¨é€</span></span><br><span class="line"><span class="keyword">for</span> version <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;VERSIONS[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">for</span> <span class="built_in">arch</span> <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;ARCHES[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    OLD_TAG=<span class="string">&quot;<span class="variable">$&#123;REPO_PREFIX&#125;</span>/java-gdal-local-<span class="variable">$&#123;arch&#125;</span>:<span class="variable">$&#123;version&#125;</span>&quot;</span></span><br><span class="line">    NEW_TAG=<span class="string">&quot;<span class="variable">$&#123;REPO_PREFIX&#125;</span>/java-gdal-local:<span class="variable">$&#123;version&#125;</span>-<span class="variable">$&#123;arch&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> docker inspect <span class="string">&quot;<span class="variable">$OLD_TAG</span>&quot;</span> &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;ğŸ·ï¸  æ‰“æ ‡ç­¾: <span class="variable">$OLD_TAG</span> -&gt; <span class="variable">$NEW_TAG</span>&quot;</span></span><br><span class="line">      docker tag <span class="string">&quot;<span class="variable">$OLD_TAG</span>&quot;</span> <span class="string">&quot;<span class="variable">$NEW_TAG</span>&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;ğŸ“¤ æ¨é€: <span class="variable">$NEW_TAG</span>&quot;</span></span><br><span class="line">      docker push <span class="string">&quot;<span class="variable">$NEW_TAG</span>&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$DELETE_OLD_TAGS</span>&quot;</span> = <span class="literal">true</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;ğŸ—‘ï¸  åˆ é™¤æ—§æ ‡ç­¾: <span class="variable">$OLD_TAG</span>&quot;</span></span><br><span class="line">        docker rmi <span class="string">&quot;<span class="variable">$OLD_TAG</span>&quot;</span> || <span class="literal">true</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;âš ï¸  é•œåƒä¸å­˜åœ¨ï¼Œè·³è¿‡: <span class="variable">$OLD_TAG</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. ä¸ºæ¯ä¸ªç‰ˆæœ¬åˆ›å»ºå¤šæ¶æ„ manifest</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸ”§ å¼€å§‹åˆ›å»ºå¤šæ¶æ„ manifest...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> version <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;VERSIONS[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">  MANIFEST_TAG=<span class="string">&quot;<span class="variable">$&#123;REPO_PREFIX&#125;</span>/java-gdal-local:<span class="variable">$&#123;version&#125;</span>&quot;</span></span><br><span class="line">  TAG_AMD64=<span class="string">&quot;<span class="variable">$&#123;REPO_PREFIX&#125;</span>/java-gdal-local:<span class="variable">$&#123;version&#125;</span>-amd64&quot;</span></span><br><span class="line">  TAG_ARM64=<span class="string">&quot;<span class="variable">$&#123;REPO_PREFIX&#125;</span>/java-gdal-local:<span class="variable">$&#123;version&#125;</span>-arm64&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;ğŸ“¦ åˆ›å»ºå¤šæ¶æ„é•œåƒæ¸…å•: <span class="variable">$MANIFEST_TAG</span>&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§ manifest</span></span><br><span class="line">  docker manifest <span class="built_in">rm</span> <span class="string">&quot;<span class="variable">$MANIFEST_TAG</span>&quot;</span> 2&gt;/dev/null || <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># åˆ›å»º manifest</span></span><br><span class="line">  docker manifest create <span class="string">&quot;<span class="variable">$MANIFEST_TAG</span>&quot;</span> \</span><br><span class="line">    --amend <span class="string">&quot;<span class="variable">$TAG_AMD64</span>&quot;</span> \</span><br><span class="line">    --amend <span class="string">&quot;<span class="variable">$TAG_ARM64</span>&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æ·»åŠ å¹³å°ä¿¡æ¯ï¼ˆå…³é”®æ­¥éª¤ï¼‰</span></span><br><span class="line">  docker manifest annotate <span class="string">&quot;<span class="variable">$MANIFEST_TAG</span>&quot;</span> <span class="string">&quot;<span class="variable">$TAG_AMD64</span>&quot;</span> --os linux --<span class="built_in">arch</span> amd64</span><br><span class="line">  docker manifest annotate <span class="string">&quot;<span class="variable">$MANIFEST_TAG</span>&quot;</span> <span class="string">&quot;<span class="variable">$TAG_ARM64</span>&quot;</span> --os linux --<span class="built_in">arch</span> arm64</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æ¨é€ manifest</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;ğŸ“¤ æ¨é€å¤šæ¶æ„é•œåƒ: <span class="variable">$MANIFEST_TAG</span>&quot;</span></span><br><span class="line">  docker manifest push <span class="string">&quot;<span class="variable">$MANIFEST_TAG</span>&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;âœ… å®Œæˆ: <span class="variable">$MANIFEST_TAG</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸ‰ æ‰€æœ‰æ“ä½œå®Œæˆï¼&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ä½ ç°åœ¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ‹‰å–ï¼š&quot;</span></span><br><span class="line"><span class="keyword">for</span> version <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;VERSIONS[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;   docker pull <span class="variable">$&#123;HARBOR_HOST&#125;</span>/library/java-gdal-local:<span class="variable">$&#123;version&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="4-æ‰‹åŠ¨æ“ä½œæµç¨‹"><a href="#4-æ‰‹åŠ¨æ“ä½œæµç¨‹" class="headerlink" title="4. æ‰‹åŠ¨æ“ä½œæµç¨‹"></a>4. æ‰‹åŠ¨æ“ä½œæµç¨‹</h3><p>å¦‚æœéœ€è¦æ‰‹åŠ¨åˆ›å»ºå¤šæ¶æ„é•œåƒï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤ï¼š</p><p><strong>Step 1: ç™»å½• Harbor</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker login 110.1.20.3</span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line">docker login -u admin -p Harbor12345@Gmail.com 110.1.20.3</span><br></pre></td></tr></table></figure><p><strong>Step 2: æ¨é€å•æ¶æ„é•œåƒ</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¸ºç°æœ‰é•œåƒæ‰“æ–°æ ‡ç­¾</span></span><br><span class="line">docker tag 110.1.20.3/library/java-gdal-local-amd64:3.8.5 \</span><br><span class="line">           110.1.20.3/library/java-gdal-local:3.8.5-amd64</span><br><span class="line"></span><br><span class="line">docker tag 110.1.20.3/library/java-gdal-local-arm64:3.8.5 \</span><br><span class="line">           110.1.20.3/library/java-gdal-local:3.8.5-arm64</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨é€é•œåƒ</span></span><br><span class="line">docker push 110.1.20.3/library/java-gdal-local:3.8.5-amd64</span><br><span class="line">docker push 110.1.20.3/library/java-gdal-local:3.8.5-arm64</span><br></pre></td></tr></table></figure><p><strong>Step 3: åˆ›å»ºå¤šæ¶æ„ manifest</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º manifest</span></span><br><span class="line">docker manifest create 110.1.20.3/library/java-gdal-local:3.8.5 \</span><br><span class="line">  --amend 110.1.20.3/library/java-gdal-local:3.8.5-amd64 \</span><br><span class="line">  --amend 110.1.20.3/library/java-gdal-local:3.8.5-arm64</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ å¹³å°ä¿¡æ¯ï¼ˆé‡è¦ï¼ï¼‰</span></span><br><span class="line">docker manifest annotate 110.1.20.3/library/java-gdal-local:3.8.5 \</span><br><span class="line">  110.1.20.3/library/java-gdal-local:3.8.5-amd64 --os linux --<span class="built_in">arch</span> amd64</span><br><span class="line"></span><br><span class="line">docker manifest annotate 110.1.20.3/library/java-gdal-local:3.8.5 \</span><br><span class="line">  110.1.20.3/library/java-gdal-local:3.8.5-arm64 --os linux --<span class="built_in">arch</span> arm64</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨é€ manifestï¼ˆæ³¨æ„ï¼šä½¿ç”¨ manifest pushï¼Œä¸æ˜¯æ™®é€š pushï¼‰</span></span><br><span class="line">docker manifest push 110.1.20.3/library/java-gdal-local:3.8.5</span><br></pre></td></tr></table></figure><p><strong>Step 4: éªŒè¯ç»“æœ</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ manifest ä¿¡æ¯</span></span><br><span class="line">docker manifest inspect 110.1.20.3/library/java-gdal-local:3.8.5</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•æ‹‰å–ï¼ˆä¼šæ ¹æ®å½“å‰å¹³å°è‡ªåŠ¨é€‰æ‹©æ¶æ„ï¼‰</span></span><br><span class="line">docker pull 110.1.20.3/library/java-gdal-local:3.8.5</span><br></pre></td></tr></table></figure><h3 id="5-æ•…éšœæ’é™¤"><a href="#5-æ•…éšœæ’é™¤" class="headerlink" title="5. æ•…éšœæ’é™¤"></a>5. æ•…éšœæ’é™¤</h3><h4 id="å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ³•"><a href="#å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ³•" class="headerlink" title="å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ³•"></a>å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ³•</h4><p><strong>1. è¯ä¹¦ç›¸å…³é”™è¯¯</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">x509: certificate signed by unknown authority</span><br></pre></td></tr></table></figure><p><strong>è§£å†³ï¼š</strong> ç¡®ä¿æ­£ç¡®é…ç½®äº† CA è¯ä¹¦æˆ–ä½¿ç”¨ <code>insecure-registries</code></p><p><strong>2. Manifest æ¨é€é”™è¯¯</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tag does not exist: 110.1.20.3/library/java-gdal-local:3.8.5</span><br></pre></td></tr></table></figure><p><strong>è§£å†³ï¼š</strong> ä½¿ç”¨ <code>docker manifest push</code> è€Œä¸æ˜¯ <code>docker push</code></p><p><strong>3. å®éªŒæ€§åŠŸèƒ½æœªå¯ç”¨</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker manifest is only supported when experimental cli features are enabled</span><br></pre></td></tr></table></figure><p><strong>è§£å†³ï¼š</strong> åœ¨ <code>daemon.json</code> ä¸­è®¾ç½® <code>&quot;experimental&quot;: true</code></p><h4 id="æ£€æŸ¥æ¸…å•"><a href="#æ£€æŸ¥æ¸…å•" class="headerlink" title="æ£€æŸ¥æ¸…å•"></a>æ£€æŸ¥æ¸…å•</h4><ul><li><input disabled="" type="checkbox"> Docker daemon é…ç½®äº† <code>&quot;experimental&quot;: true</code></li><li><input disabled="" type="checkbox"> è¯ä¹¦æ–‡ä»¶ä½¿ç”¨æ­£ç¡®çš„æ‰©å±•åï¼ˆ<code>.crt</code>ï¼‰</li><li><input disabled="" type="checkbox"> è¯ä¹¦ç›®å½•ä¸åŒ…å«ç§é’¥æ–‡ä»¶</li><li><input disabled="" type="checkbox"> å·²æ­£ç¡®ç™»å½• Harbor</li><li><input disabled="" type="checkbox"> å•æ¶æ„é•œåƒå·²æˆåŠŸæ¨é€</li><li><input disabled="" type="checkbox"> ä½¿ç”¨ <code>docker manifest push</code> æ¨é€ manifest</li></ul><h2 id="å®Œæ•´é…ç½®è„šæœ¬"><a href="#å®Œæ•´é…ç½®è„šæœ¬" class="headerlink" title="å®Œæ•´é…ç½®è„šæœ¬"></a>å®Œæ•´é…ç½®è„šæœ¬</h2><p>å°†æ‰€æœ‰é…ç½®æ­¥éª¤æ•´åˆæˆä¸€ä¸ªè„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Harbor å¤šæ¶æ„é•œåƒé…ç½®è„šæœ¬</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸ”§ é…ç½® Harbor å¤šæ¶æ„é•œåƒæ”¯æŒ...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. é…ç½®å®¢æˆ·ç«¯è¯ä¹¦</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸ“œ é…ç½®å®¢æˆ·ç«¯è¯ä¹¦...&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/docker/certs.d/110.1.20.3/</span><br><span class="line">\<span class="built_in">cp</span> -rvf /data/opt/installharbor/certs/&#123;ca.crt,harbor.crt&#125; /etc/docker/certs.d/110.1.20.3/</span><br><span class="line"><span class="built_in">cd</span> /etc/docker/certs.d/110.1.20.3/</span><br><span class="line"><span class="built_in">chmod</span> 644 ca.crt harbor.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. é‡å¯ Docker</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸ”„ é‡å¯ Docker æœåŠ¡...&quot;</span></span><br><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. é‡å¯ Harborï¼ˆåŒå°æœºå™¨ä¸Šéœ€è¦ï¼‰</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸ”„ é‡å¯ Harbor...&quot;</span></span><br><span class="line"><span class="built_in">cd</span> /data/opt/installharbor/</span><br><span class="line">bash install.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. ç­‰å¾…æœåŠ¡å¯åŠ¨</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;â³ ç­‰å¾…æœåŠ¡å¯åŠ¨...&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> 30</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. æµ‹è¯•é…ç½®</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸ§ª æµ‹è¯•é…ç½®...&quot;</span></span><br><span class="line">docker login 110.1.20.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. åˆ›å»ºæµ‹è¯• manifest</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸ“¦ åˆ›å»ºæµ‹è¯• manifest...&quot;</span></span><br><span class="line">docker manifest create 110.1.20.3/library/java-gdal-local:3.8.5 \</span><br><span class="line">  110.1.20.3/library/java-gdal-local:3.8.5-amd64 \</span><br><span class="line">  110.1.20.3/library/java-gdal-local:3.8.5-arm64</span><br><span class="line"></span><br><span class="line">docker manifest annotate 110.1.20.3/library/java-gdal-local:3.8.5 \</span><br><span class="line">  110.1.20.3/library/java-gdal-local:3.8.5-amd64 --os linux --<span class="built_in">arch</span> amd64</span><br><span class="line"></span><br><span class="line">docker manifest annotate 110.1.20.3/library/java-gdal-local:3.8.5 \</span><br><span class="line">  110.1.20.3/library/java-gdal-local:3.8.5-arm64 --os linux --<span class="built_in">arch</span> arm64</span><br><span class="line"></span><br><span class="line">docker manifest push 110.1.20.3/library/java-gdal-local:3.8.5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. éªŒè¯ç»“æœ</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;âœ… éªŒè¯ç»“æœ...&quot;</span></span><br><span class="line">docker manifest inspect 110.1.20.3/library/java-gdal-local:3.8.5</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ğŸ‰ é…ç½®å®Œæˆï¼&quot;</span></span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡æœ¬æ–‡çš„é…ç½®å’Œè„šæœ¬ï¼Œæˆ‘ä»¬æˆåŠŸè§£å†³äº†åœ¨è‡ªå»º Harbor ä¸­ç®¡ç†å¤šæ¶æ„é•œåƒçš„é—®é¢˜ã€‚å…³é”®è¦ç‚¹åŒ…æ‹¬ï¼š</p><ol><li><strong>æ­£ç¡®é…ç½® HTTPS è¯ä¹¦</strong>ï¼šä½¿ç”¨æ­£ç¡®çš„æ–‡ä»¶åå’Œæƒé™</li><li><strong>å¯ç”¨å®éªŒæ€§åŠŸèƒ½</strong>ï¼šDocker manifest éœ€è¦å®éªŒæ€§åŠŸèƒ½æ”¯æŒ</li><li><strong>ç†è§£ manifest æ“ä½œ</strong>ï¼šåŒºåˆ† <code>docker push</code> å’Œ <code>docker manifest push</code></li><li><strong>è‡ªåŠ¨åŒ–æµç¨‹</strong>ï¼šä½¿ç”¨è„šæœ¬æ‰¹é‡å¤„ç†å¤šä¸ªç‰ˆæœ¬å’Œæ¶æ„</li></ol><p>è¿™å¥—æ–¹æ¡ˆå¯ä»¥å¸®åŠ©å›¢é˜Ÿé«˜æ•ˆåœ°ç®¡ç†å¤šæ¶æ„å®¹å™¨é•œåƒï¼Œæ”¯æŒåœ¨ä¸åŒ CPU æ¶æ„çš„ç¯å¢ƒä¸­æ— ç¼éƒ¨ç½²åº”ç”¨ã€‚</p><h2 id="å‚è€ƒèµ„æº"><a href="#å‚è€ƒèµ„æº" class="headerlink" title="å‚è€ƒèµ„æº"></a>å‚è€ƒèµ„æº</h2><ul><li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vYnVpbGQvYnVpbGRpbmcvbXVsdGktcGxhdGZvcm0v">Docker Multi-platform images<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vZW5naW5lL3JlZmVyZW5jZS9jb21tYW5kbGluZS9tYW5pZmVzdC8=">Docker manifest command<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9nb2hhcmJvci5pby9kb2NzLw==">Harbor Documentation<i class="fa fa-external-link-alt"></i></span></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;åœ¨ç°ä»£å®¹å™¨åŒ–ç¯å¢ƒä¸­ï¼Œå¤šæ¶æ„æ”¯æŒå˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚éšç€ ARM64 æ¶æ„åœ¨æœåŠ¡å™¨å’Œè¾¹ç¼˜è®¾å¤‡ä¸­çš„æ™®åŠï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºå’Œç®¡ç†æ”¯æŒå¤šç§ CPU æ¶æ„çš„å®¹å™¨é•œåƒã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ Harbor ç§æœ‰é•œåƒä»“åº“ä¸­ç®¡ç†å¤šæ¶æ„é•œåƒï¼ŒåŒ…æ‹¬é…ç½®ã€æ¨é€å’Œåˆ›å»º manifest åˆ—è¡¨çš„å®Œæ•´æµç¨‹ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Docker" scheme="https://freemankevin.uk/categories/Docker/"/>
    
    
    <category term="Docker" scheme="https://freemankevin.uk/tags/Docker/"/>
    
    <category term="Harbor" scheme="https://freemankevin.uk/tags/Harbor/"/>
    
    <category term="Manifest" scheme="https://freemankevin.uk/tags/Manifest/"/>
    
    <category term="Multi-Architecture" scheme="https://freemankevin.uk/tags/Multi-Architecture/"/>
    
  </entry>
  
  <entry>
    <title>MinIO ç«™ç‚¹å¤åˆ¶éƒ¨ç½²ä¸æµ‹è¯•ï¼šåŒæ­¥ä¸æ•…éšœæ¢å¤</title>
    <link href="https://freemankevin.uk/2025/05/13/docker-minio/"/>
    <id>https://freemankevin.uk/2025/05/13/docker-minio/</id>
    <published>2025-05-13T08:38:00.000Z</published>
    <updated>2025-10-21T03:34:40.408Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MinIO æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„åˆ†å¸ƒå¼å¯¹è±¡å­˜å‚¨ç³»ç»Ÿï¼Œå…¶ç«™ç‚¹å¤åˆ¶ï¼ˆSite Replicationï¼‰åŠŸèƒ½æ”¯æŒè·¨é›†ç¾¤çš„æ•°æ®å’Œå…ƒæ•°æ®åŒæ­¥ã€‚æœ¬æ–‡è®°å½•äº†å¦‚ä½•ä½¿ç”¨ Docker Compose éƒ¨ç½² MinIO ç«™ç‚¹å¤åˆ¶é›†ç¾¤ï¼Œé…ç½®ä¸¤ä¸ª MinIO å®ä¾‹ï¼Œå¹¶è¿›è¡ŒåŒæ­¥æµ‹è¯•å’Œæ•…éšœæ¢å¤æµ‹è¯•ã€‚æµ‹è¯•ç¯å¢ƒåŸºäº 20T ç£ç›˜ï¼Œé€‚ç”¨äºéœ€è¦é«˜å¯ç”¨æ€§å’Œç¾éš¾æ¢å¤çš„åœºæ™¯ã€‚</p><span id="more"></span><h2 id="MinIO-ç«™ç‚¹å¤åˆ¶ç®€ä»‹"><a href="#MinIO-ç«™ç‚¹å¤åˆ¶ç®€ä»‹" class="headerlink" title="MinIO ç«™ç‚¹å¤åˆ¶ç®€ä»‹"></a>MinIO ç«™ç‚¹å¤åˆ¶ç®€ä»‹</h2><p>MinIO çš„ç«™ç‚¹å¤åˆ¶æ˜¯ä¸€ç§é›†ç¾¤çº§åˆ«çš„åŒå‘åŒæ­¥æœºåˆ¶ï¼Œå¯åŒæ­¥æ•°æ®ï¼ˆæ¡¶ã€å¯¹è±¡ï¼‰å’Œå…ƒæ•°æ®ï¼ˆç”¨æˆ·ã€ç­–ç•¥ã€é…ç½®ï¼‰ã€‚å…¶ä¸»è¦ç‰¹æ€§åŒ…æ‹¬ï¼š</p><ul><li><strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼šå¯¹è±¡æ•°æ®è¿‘å®æ—¶åŒæ­¥ã€‚</li><li><strong>ä¸¥æ ¼ä¸€è‡´æ€§</strong>ï¼šå…ƒæ•°æ®ä¿æŒå®Œå…¨ä¸€è‡´ã€‚</li><li><strong>é«˜å¯ç”¨æ€§</strong>ï¼šä»»ä¸€é›†ç¾¤æ•…éšœæ—¶ï¼Œå¦ä¸€ä¸ªé›†ç¾¤å¯ç»§ç»­æä¾›æœåŠ¡ã€‚</li></ul><p>æœ¬æ–‡å°†éƒ¨ç½²ä¸¤ä¸ª MinIO å®ä¾‹ï¼ˆSITE1 å’Œ SITE2ï¼‰ï¼Œé€šè¿‡ <code>minio-mc</code> å®¹å™¨é…ç½®ç«™ç‚¹å¤åˆ¶ï¼Œå¹¶æµ‹è¯•åŒæ­¥å’Œæ•…éšœæ¢å¤ã€‚</p><h2 id="ç¯å¢ƒä¸é…ç½®"><a href="#ç¯å¢ƒä¸é…ç½®" class="headerlink" title="ç¯å¢ƒä¸é…ç½®"></a>ç¯å¢ƒä¸é…ç½®</h2><h3 id="ç¡¬ä»¶ä¸ç½‘ç»œ"><a href="#ç¡¬ä»¶ä¸ç½‘ç»œ" class="headerlink" title="ç¡¬ä»¶ä¸ç½‘ç»œ"></a>ç¡¬ä»¶ä¸ç½‘ç»œ</h3><ul><li><strong>æœåŠ¡å™¨</strong>ï¼šä¸¤å°æœåŠ¡å™¨ï¼ˆMinIO1: <code>192.168.199.145</code>ï¼ŒMinIO2: <code>192.168.199.147</code>ï¼‰ã€‚</li><li><strong>ç£ç›˜</strong>ï¼šæ¯å°æœåŠ¡å™¨æŒ‚è½½ 20T ç£ç›˜ã€‚</li><li><strong>ç½‘ç»œ</strong>ï¼š1Gbps å¸¦å®½ï¼ŒRTT &lt; 20msã€‚</li><li><strong>æ“ä½œç³»ç»Ÿ</strong>ï¼šLinuxï¼ˆæ”¯æŒ Dockerï¼‰ã€‚</li></ul><h3 id="Docker-Compose-é…ç½®"><a href="#Docker-Compose-é…ç½®" class="headerlink" title="Docker Compose é…ç½®"></a>Docker Compose é…ç½®</h3><p>ä»¥ä¸‹æ˜¯ MinIO å’Œ <code>minio-mc</code> æœåŠ¡çš„ Docker Compose é…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;$&#123;MINIO_IMAGE&#125;&quot;</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">4096M</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">middleware</span> </span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;$&#123;MINIO_PORT&#125;:9000&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;$&#123;MINIO_CONSOLE_PORT&#125;:9001&quot;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">server</span> <span class="string">/data</span> <span class="string">--console-address</span> <span class="string">&quot;:9001&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_USER:</span> <span class="string">&quot;$&#123;MINIO_ROOT_USER&#125;&quot;</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_PASSWORD:</span> <span class="string">&quot;$&#123;MINIO_ROOT_PASSWORD&#125;&quot;</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:9000/minio/health/live&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/minio/data:/data</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">minio-mc:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">minio/mc:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">minio-mc</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">middleware</span> </span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SITE1_URL:</span> <span class="string">&quot;$&#123;SITE1_URL&#125;&quot;</span></span><br><span class="line">      <span class="attr">SITE2_URL:</span> <span class="string">&quot;$&#123;SITE2_URL&#125;&quot;</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_USER:</span> <span class="string">&quot;$&#123;MINIO_ROOT_USER&#125;&quot;</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_PASSWORD:</span> <span class="string">&quot;$&#123;MINIO_ROOT_PASSWORD&#125;&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./site-replication.sh:/site-replication.sh</span></span><br><span class="line">    <span class="attr">entrypoint:</span> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;/site-replication.sh&quot;</span>]</span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD-SHELL&quot;</span>, <span class="string">&quot;mc --version &gt;/dev/null 2&gt;&amp;1&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">middleware:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><h3 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h3><p>ç¯å¢ƒå˜é‡å­˜å‚¨åœ¨ <code>.env</code> æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># MinIO</span></span><br><span class="line">MINIO_PORT=9000</span><br><span class="line">MINIO_CONSOLE_PORT=9001</span><br><span class="line">MINIO_ROOT_USER=<span class="string">&quot;admin&quot;</span></span><br><span class="line">MINIO_ROOT_PASSWORD=<span class="string">&quot;Admin@123.com&quot;</span></span><br><span class="line">MINIO_IMAGE=<span class="string">&quot;minio/minio:RELEASE.2025-04-22T22-12-26Z&quot;</span></span><br><span class="line">SITE1_URL=<span class="string">&quot;http://192.168.145:9000&quot;</span></span><br><span class="line">SITE2_URL=<span class="string">&quot;http://192.168.147:9000&quot;</span></span><br></pre></td></tr></table></figure><h3 id="ç«™ç‚¹å¤åˆ¶è„šæœ¬"><a href="#ç«™ç‚¹å¤åˆ¶è„šæœ¬" class="headerlink" title="ç«™ç‚¹å¤åˆ¶è„šæœ¬"></a>ç«™ç‚¹å¤åˆ¶è„šæœ¬</h3><p><code>site-replication.sh</code> ç”¨äºé…ç½®ç«™ç‚¹å¤åˆ¶ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸¥æ ¼æ¨¡å¼ï¼šé”™è¯¯ã€æœªå®šä¹‰å˜é‡ã€ç®¡é“å¤±è´¥æ—¶é€€å‡º</span></span><br><span class="line"><span class="built_in">set</span> -euo pipefail</span><br><span class="line"></span><br><span class="line"><span class="comment"># é¢œè‰²å®šä¹‰</span></span><br><span class="line">RED=<span class="string">&#x27;\033[0;31m&#x27;</span></span><br><span class="line">GREEN=<span class="string">&#x27;\033[0;32m&#x27;</span></span><br><span class="line">CYAN=<span class="string">&#x27;\033[1;36m&#x27;</span></span><br><span class="line">YELLOW=<span class="string">&#x27;\033[1;33m&#x27;</span></span><br><span class="line">BLUE=<span class="string">&#x27;\033[0;34m&#x27;</span></span><br><span class="line">MAGENTA=<span class="string">&#x27;\033[0;35m&#x27;</span></span><br><span class="line">RESET=<span class="string">&#x27;\033[0m&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´ä¸°å¯Œçš„å›¾æ ‡é›†</span></span><br><span class="line">ICON_INFO=<span class="string">&quot;ğŸŒ&quot;</span></span><br><span class="line">ICON_SUCCESS=<span class="string">&quot;âœ¨&quot;</span></span><br><span class="line">ICON_WARNING=<span class="string">&quot;âš ï¸&quot;</span></span><br><span class="line">ICON_ERROR=<span class="string">&quot;ğŸ’¥&quot;</span></span><br><span class="line">ICON_DEBUG=<span class="string">&quot;ğŸ&quot;</span></span><br><span class="line">ICON_WAIT=<span class="string">&quot;â³&quot;</span></span><br><span class="line">ICON_CLEAN=<span class="string">&quot;ğŸ§¹&quot;</span></span><br><span class="line">ICON_CONFIG=<span class="string">&quot;âš™ï¸&quot;</span></span><br><span class="line">ICON_NETWORK=<span class="string">&quot;ğŸ“¡&quot;</span></span><br><span class="line">ICON_START=<span class="string">&quot;ğŸš€&quot;</span></span><br><span class="line">ICON_READY=<span class="string">&quot;âœ…&quot;</span></span><br><span class="line">ICON_FINISH=<span class="string">&quot;ğŸ‰&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¢å¼ºç‰ˆæ—¥å¿—å‡½æ•°ï¼ˆä¼˜åŒ–é¢œè‰²å¤„ç†ï¼‰</span></span><br><span class="line"><span class="function"><span class="title">log</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> level=<span class="variable">$1</span> message=<span class="variable">$2</span></span><br><span class="line">  <span class="built_in">local</span> color icon timestamp</span><br><span class="line">  timestamp=$(<span class="built_in">date</span> -u <span class="string">&#x27;+%H:%M:%S&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">case</span> <span class="variable">$level</span> <span class="keyword">in</span></span><br><span class="line">    INFO)    color=<span class="string">&quot;<span class="variable">$GREEN</span>&quot;</span>  icon=<span class="string">&quot;<span class="variable">$ICON_INFO</span>&quot;</span> ;;</span><br><span class="line">    SUCCESS) color=<span class="string">&quot;<span class="variable">$GREEN</span>&quot;</span>  icon=<span class="string">&quot;<span class="variable">$ICON_SUCCESS</span>&quot;</span> ;;</span><br><span class="line">    WARN)    color=<span class="string">&quot;<span class="variable">$YELLOW</span>&quot;</span> icon=<span class="string">&quot;<span class="variable">$ICON_WARNING</span>&quot;</span> ;;</span><br><span class="line">    ERROR)   color=<span class="string">&quot;<span class="variable">$RED</span>&quot;</span>    icon=<span class="string">&quot;<span class="variable">$ICON_ERROR</span>&quot;</span> ;;</span><br><span class="line">    DEBUG)   color=<span class="string">&quot;<span class="variable">$BLUE</span>&quot;</span>   icon=<span class="string">&quot;<span class="variable">$ICON_DEBUG</span>&quot;</span> ;;</span><br><span class="line">    WAIT)    color=<span class="string">&quot;<span class="variable">$MAGENTA</span>&quot;</span> icon=<span class="string">&quot;<span class="variable">$ICON_WAIT</span>&quot;</span> ;;</span><br><span class="line">    *)       color=<span class="string">&quot;<span class="variable">$CYAN</span>&quot;</span>   icon=<span class="string">&quot;<span class="variable">$ICON_INFO</span>&quot;</span> ;;</span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ç›´æ¥è¾“å‡ºæ¶ˆæ¯ï¼Œé¿å…åµŒå¥—æ ¼å¼åŒ–é—®é¢˜</span></span><br><span class="line">  <span class="built_in">printf</span> <span class="string">&quot;<span class="variable">$&#123;color&#125;</span>%s %-7s\t%s<span class="variable">$&#123;RESET&#125;</span>\n&quot;</span> <span class="string">&quot;<span class="variable">$timestamp</span> <span class="variable">$icon</span>&quot;</span> <span class="string">&quot;[<span class="variable">$level</span>]&quot;</span> <span class="string">&quot;<span class="variable">$message</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç®€æ´æ ‡é¢˜æ ·å¼ï¼ˆæ”¹ä¸º === æ ‡é¢˜ === å½¢å¼ï¼‰</span></span><br><span class="line"><span class="function"><span class="title">header</span></span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$2</span>&quot;</span> = <span class="string">&quot;MinIO ç«™ç‚¹å¤åˆ¶åˆå§‹åŒ–&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;\n\n<span class="variable">$&#123;MAGENTA&#125;</span>â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—\nâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•\nâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     \nâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     \nâ–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—\nâ•šâ•â•     â•šâ•â•â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â• â•šâ•â•â•â•â•â•     â•šâ•â•     â•šâ•â• â•šâ•â•â•â•â•â•\n\n&gt;&gt; %s %s<span class="variable">$&#123;RESET&#125;</span>\n&quot;</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;\n&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;\n<span class="variable">$&#123;CYAN&#125;</span>[ TASK %d ] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n&gt;&gt; %s %s<span class="variable">$&#123;RESET&#125;</span>\n&quot;</span> <span class="string">&quot;<span class="variable">$task_number</span>&quot;</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;\n&quot;</span></span><br><span class="line">    task_number=$((task_number + <span class="number">1</span>))</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–ä»»åŠ¡è®¡æ•°å™¨</span></span><br><span class="line">task_number=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç­‰å¾…æœåŠ¡å°±ç»ªï¼ˆåˆå¹¶ä¸ºä¸€ä¸ªä»»åŠ¡ï¼‰</span></span><br><span class="line"><span class="function"><span class="title">wait_for_services</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> retries=15 delay=2 attempt=1</span><br><span class="line">  <span class="built_in">local</span> spinner=(<span class="string">&quot;â£¾&quot;</span> <span class="string">&quot;â£½&quot;</span> <span class="string">&quot;â£»&quot;</span> <span class="string">&quot;â¢¿&quot;</span> <span class="string">&quot;â¡¿&quot;</span> <span class="string">&quot;â£Ÿ&quot;</span> <span class="string">&quot;â£¯&quot;</span> <span class="string">&quot;â£·&quot;</span>)</span><br><span class="line">  <span class="built_in">local</span> all_ready=0</span><br><span class="line"></span><br><span class="line">  header <span class="string">&quot;<span class="variable">$ICON_WAIT</span>&quot;</span> <span class="string">&quot;ç­‰å¾… MinIO æœåŠ¡å°±ç»ª&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> site <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;!SITES[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">local</span> <span class="built_in">alias</span>=<span class="string">&quot;HEALTHCHECK_<span class="variable">$site</span>&quot;</span></span><br><span class="line">    <span class="built_in">local</span> url=<span class="string">&quot;<span class="variable">$&#123;SITES[$site]&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">local</span> attempt=1</span><br><span class="line">    <span class="built_in">local</span> all_ready=0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> INFO <span class="string">&quot;æ£€æŸ¥æœåŠ¡: <span class="variable">$url</span>&quot;</span></span><br><span class="line">    <span class="keyword">while</span> [ <span class="variable">$attempt</span> -le <span class="variable">$retries</span> ]; <span class="keyword">do</span></span><br><span class="line">      <span class="keyword">if</span> /usr/bin/mc <span class="built_in">alias</span> <span class="built_in">set</span> <span class="string">&quot;<span class="variable">$alias</span>&quot;</span> <span class="string">&quot;<span class="variable">$url</span>&quot;</span> <span class="string">&quot;<span class="variable">$MINIO_ACCESS_KEY</span>&quot;</span> <span class="string">&quot;<span class="variable">$MINIO_SECRET_KEY</span>&quot;</span> &gt;/dev/null 2&gt;&amp;1 &amp;&amp; \</span><br><span class="line">         /usr/bin/mc <span class="built_in">ls</span> <span class="string">&quot;<span class="variable">$alias</span>&quot;</span> &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> SUCCESS <span class="string">&quot;æœåŠ¡å·²å°±ç»ª: <span class="variable">$url</span>&quot;</span></span><br><span class="line">        all_ready=1</span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$site</span>&quot;</span> = <span class="string">&quot;SITE1&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">          <span class="built_in">printf</span> <span class="string">&quot;<span class="variable">$&#123;CYAN&#125;</span>%s<span class="variable">$&#123;RESET&#125;</span>\n&quot;</span> <span class="string">&quot;<span class="subst">$(for i in $(seq 1 61)</span>; do printf &quot;</span>-<span class="string">&quot;; done)&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">      <span class="built_in">printf</span> <span class="string">&quot;\r%-80s&quot;</span> <span class="string">&quot; &quot;</span></span><br><span class="line">      <span class="built_in">printf</span> <span class="string">&quot;\r<span class="variable">$&#123;YELLOW&#125;</span>%s å°è¯• %2d/%-2d æ£€æŸ¥æœåŠ¡ %s ä¸­...<span class="variable">$&#123;RESET&#125;</span>&quot;</span> \</span><br><span class="line">        <span class="string">&quot;<span class="variable">$&#123;spinner[$((attempt % <span class="variable">$&#123;#spinner[@]&#125;</span>))]&#125;</span>&quot;</span> \</span><br><span class="line">        <span class="variable">$attempt</span> <span class="variable">$retries</span> <span class="string">&quot;<span class="variable">$url</span>&quot;</span></span><br><span class="line">      <span class="built_in">sleep</span> <span class="variable">$delay</span></span><br><span class="line">      ((attempt++))</span><br><span class="line">      delay=$((delay * <span class="number">2</span> &gt; <span class="number">8</span> ? <span class="number">8</span> : delay * <span class="number">2</span>))</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$all_ready</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">log</span> ERROR <span class="string">&quot;æœåŠ¡ <span class="variable">$url</span> åœ¨ <span class="variable">$retries</span> æ¬¡å°è¯•åä»æœªå°±ç»ª&quot;</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®åˆ«åï¼ˆä¼˜åŒ–é¢œè‰²æ ¼å¼ï¼‰</span></span><br><span class="line"><span class="function"><span class="title">configure_aliases</span></span>() &#123;</span><br><span class="line">  header <span class="string">&quot;<span class="variable">$ICON_CONFIG</span>&quot;</span> <span class="string">&quot;é…ç½® MinIO ç«™ç‚¹åˆ«å&quot;</span></span><br><span class="line">  <span class="keyword">for</span> site <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;!SITES[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">local</span> url=<span class="string">&quot;<span class="variable">$&#123;SITES[$site]&#125;</span>&quot;</span></span><br><span class="line">    /usr/bin/mc <span class="built_in">alias</span> remove <span class="string">&quot;<span class="variable">$site</span>&quot;</span> 2&gt;/dev/null || <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> /usr/bin/mc <span class="built_in">alias</span> <span class="built_in">set</span> <span class="string">&quot;<span class="variable">$site</span>&quot;</span> <span class="string">&quot;<span class="variable">$url</span>&quot;</span> <span class="string">&quot;<span class="variable">$MINIO_ACCESS_KEY</span>&quot;</span> <span class="string">&quot;<span class="variable">$MINIO_SECRET_KEY</span>&quot;</span> &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">log</span> SUCCESS <span class="string">&quot;åˆ«åé…ç½®æˆåŠŸ: <span class="variable">$&#123;site&#125;</span> â†’ <span class="variable">$&#123;url&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">log</span> ERROR <span class="string">&quot;æ— æ³•é…ç½®åˆ«å: <span class="variable">$site</span> â†’ <span class="variable">$url</span>&quot;</span></span><br><span class="line">      <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥å¤åˆ¶é…ç½®çŠ¶æ€</span></span><br><span class="line"><span class="function"><span class="title">check_replication_status</span></span>() &#123;</span><br><span class="line">  /usr/bin/mc admin replicate info SITE1 2&gt;&amp;1 | grep -q <span class="string">&quot;SiteReplication enabled&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…é™¤åŸå¤åˆ¶é…ç½®</span></span><br><span class="line"><span class="function"><span class="title">cleanup_old_replication</span></span>() &#123;</span><br><span class="line">  header <span class="string">&quot;<span class="variable">$ICON_CLEAN</span>&quot;</span> <span class="string">&quot;æ¸…ç†åŸæœ‰å¤åˆ¶é…ç½®&quot;</span></span><br><span class="line">  <span class="keyword">for</span> site <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;!SITES[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">log</span> INFO <span class="string">&quot;æ­£åœ¨æ¸…ç† <span class="variable">$site</span> çš„å¤åˆ¶é…ç½®...&quot;</span></span><br><span class="line">    <span class="keyword">if</span> /usr/bin/mc admin replicate <span class="built_in">rm</span> --all <span class="string">&quot;<span class="variable">$site</span>&quot;</span> --force 2&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">log</span> SUCCESS <span class="string">&quot;æˆåŠŸæ¸…ç† <span class="variable">$site</span> çš„é…ç½®&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">log</span> WARN <span class="string">&quot;<span class="variable">$site</span> æ— é…ç½®å¯æ¸…ç†æˆ–æ¸…ç†å¤±è´¥&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="built_in">sleep</span> 2</span><br><span class="line">  <span class="keyword">if</span> check_replication_status; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> ERROR <span class="string">&quot;å¤åˆ¶é…ç½®ä»å­˜åœ¨ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">log</span> SUCCESS <span class="string">&quot;æ‰€æœ‰ç«™ç‚¹å¤åˆ¶é…ç½®å·²æ¸…ç†å®Œæˆ&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯é çš„bucketåˆ é™¤å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="title">delete_all_buckets</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> site=<span class="variable">$1</span></span><br><span class="line">  <span class="built_in">log</span> WARN <span class="string">&quot;å³å°†æ¸…ç©º <span class="variable">$&#123;site&#125;</span> çš„æ‰€æœ‰bucket...&quot;</span></span><br><span class="line">  <span class="built_in">local</span> buckets</span><br><span class="line">  buckets=$(/usr/bin/mc <span class="built_in">ls</span> <span class="string">&quot;<span class="variable">$site</span>&quot;</span> --json | jq -r .key | <span class="built_in">tr</span> -d <span class="string">&#x27;/&#x27;</span> | grep -v <span class="string">&#x27;^$&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$buckets</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> INFO <span class="string">&quot;æ²¡æœ‰ bucket éœ€è¦åˆ é™¤&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$buckets</span>&quot;</span> | <span class="keyword">while</span> <span class="built_in">read</span> -r bucket; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">log</span> INFO <span class="string">&quot;æ­£åœ¨åˆ é™¤ <span class="variable">$&#123;site&#125;</span>/<span class="variable">$&#123;bucket&#125;</span>...&quot;</span></span><br><span class="line">    <span class="keyword">if</span> /usr/bin/mc rb --force <span class="string">&quot;<span class="variable">$&#123;site&#125;</span>/<span class="variable">$&#123;bucket&#125;</span>&quot;</span> &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">log</span> SUCCESS <span class="string">&quot;åˆ é™¤æˆåŠŸ: <span class="variable">$&#123;site&#125;</span>/<span class="variable">$&#123;bucket&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">log</span> ERROR <span class="string">&quot;åˆ é™¤å¤±è´¥: <span class="variable">$&#123;site&#125;</span>/<span class="variable">$&#123;bucket&#125;</span>&quot;</span></span><br><span class="line">      <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="keyword">if</span> /usr/bin/mc <span class="built_in">ls</span> <span class="string">&quot;<span class="variable">$site</span>&quot;</span> | grep -q .; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> ERROR <span class="string">&quot;<span class="variable">$&#123;site&#125;</span> ä¸­ä»æœ‰bucketå­˜åœ¨&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">log</span> SUCCESS <span class="string">&quot;<span class="variable">$&#123;site&#125;</span> å·²å®Œå…¨æ¸…ç©º&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å¤åˆ¶é…ç½®</span></span><br><span class="line"><span class="function"><span class="title">setup_replication</span></span>() &#123;</span><br><span class="line">  header <span class="string">&quot;<span class="variable">$ICON_NETWORK</span>&quot;</span> <span class="string">&quot;è®¾ç½®ç«™ç‚¹å¤åˆ¶&quot;</span></span><br><span class="line">  <span class="built_in">local</span> retries=5 delay=2 attempt=1</span><br><span class="line">  <span class="built_in">local</span> site_list=(<span class="string">&quot;<span class="variable">$&#123;!SITES[@]&#125;</span>&quot;</span>)</span><br><span class="line">  <span class="keyword">while</span> [ <span class="variable">$attempt</span> -le <span class="variable">$retries</span> ]; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">log</span> WAIT <span class="string">&quot;å°è¯•é…ç½®å¤åˆ¶ (<span class="variable">$&#123;attempt&#125;</span>/<span class="variable">$&#123;retries&#125;</span>)...&quot;</span></span><br><span class="line">    output=$(/usr/bin/mc admin replicate add <span class="string">&quot;<span class="variable">$&#123;site_list[@]&#125;</span>&quot;</span> 2&gt;&amp;1)</span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">log</span> SUCCESS <span class="string">&quot;ç«™ç‚¹å¤åˆ¶é…ç½®æˆåŠŸ!&quot;</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$output</span> == *<span class="string">&quot;only one cluster may have data&quot;</span>* ]]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">log</span> WARN <span class="string">&quot;æ£€æµ‹åˆ° SITE2 ä¸­å·²æœ‰æ•°æ®ï¼Œè¿åå¤åˆ¶è¦æ±‚&quot;</span></span><br><span class="line">      <span class="keyword">if</span> ! delete_all_buckets <span class="string">&quot;SITE2&quot;</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> ERROR <span class="string">&quot;æ¸…ç©º SITE2 å¤±è´¥ï¼Œæ— æ³•ç»§ç»­&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">      <span class="built_in">log</span> INFO <span class="string">&quot;ç­‰å¾… <span class="variable">$&#123;delay&#125;</span> ç§’è®©ç³»ç»Ÿå®Œæˆæ¸…ç†...&quot;</span></span><br><span class="line">      <span class="built_in">sleep</span> <span class="variable">$delay</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">log</span> ERROR <span class="string">&quot;å¤åˆ¶é…ç½®å¤±è´¥: <span class="subst">$(echo <span class="string">&quot;<span class="variable">$output</span>&quot;</span> | head -n1)</span>&quot;</span></span><br><span class="line">      <span class="built_in">log</span> DEBUG <span class="string">&quot;å®Œæ•´é”™è¯¯: <span class="variable">$output</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    ((attempt++))</span><br><span class="line">    delay=$((delay * <span class="number">2</span> &gt; <span class="number">8</span> ? <span class="number">8</span> : delay * <span class="number">2</span>))</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="built_in">log</span> ERROR <span class="string">&quot;ç»è¿‡ <span class="variable">$&#123;retries&#125;</span> æ¬¡å°è¯•åä»æ— æ³•é…ç½®å¤åˆ¶&quot;</span></span><br><span class="line">  <span class="built_in">return</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¼˜åŒ–çŠ¶æ€éªŒè¯è¡¨æ ¼</span></span><br><span class="line"><span class="function"><span class="title">verify_status</span></span>() &#123;</span><br><span class="line">  header <span class="string">&quot;<span class="variable">$ICON_NETWORK</span>&quot;</span> <span class="string">&quot;å¤åˆ¶çŠ¶æ€éªŒè¯&quot;</span></span><br><span class="line">  <span class="keyword">for</span> site <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;!SITES[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>%s [SUCCESS]   æŸ¥è¯¢æˆåŠŸ: %s â†’ %s<span class="variable">$&#123;RESET&#125;</span>\n&quot;</span> <span class="string">&quot;<span class="variable">$ICON_SUCCESS</span>&quot;</span> <span class="string">&quot;<span class="variable">$site</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;SITES[$site]&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">&quot;<span class="variable">$&#123;CYAN&#125;</span>%s<span class="variable">$&#123;RESET&#125;</span>\n&quot;</span> <span class="string">&quot;<span class="subst">$(for i in $(seq 1 160)</span>; do printf &quot;</span>-<span class="string">&quot;; done)&quot;</span></span><br><span class="line">    status_output=$(/usr/bin/mc admin replicate info <span class="string">&quot;<span class="variable">$site</span>&quot;</span> 2&gt;&amp;1)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$status_output</span>&quot;</span> | grep -q <span class="string">&quot;SiteReplication enabled&quot;</span>; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">printf</span> <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>%s<span class="variable">$&#123;RESET&#125;</span>\n&quot;</span> <span class="string">&quot;<span class="variable">$status_output</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">printf</span> <span class="string">&quot;<span class="variable">$&#123;RED&#125;</span>%s<span class="variable">$&#123;RESET&#125;</span>\n&quot;</span> <span class="string">&quot;<span class="variable">$status_output</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸»æµç¨‹æ§åˆ¶</span></span><br><span class="line"><span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">  : <span class="string">&quot;<span class="variable">$&#123;SITE1_URL:?éœ€è¦ SITE1_URL ç¯å¢ƒå˜é‡&#125;</span>&quot;</span></span><br><span class="line">  : <span class="string">&quot;<span class="variable">$&#123;SITE2_URL:?éœ€è¦ SITE2_URL ç¯å¢ƒå˜é‡&#125;</span>&quot;</span></span><br><span class="line">  : <span class="string">&quot;<span class="variable">$&#123;MINIO_ACCESS_KEY:?éœ€è¦ MINIO_ACCESS_KEY ç¯å¢ƒå˜é‡&#125;</span>&quot;</span></span><br><span class="line">  : <span class="string">&quot;<span class="variable">$&#123;MINIO_SECRET_KEY:?éœ€è¦ MINIO_SECRET_KEY ç¯å¢ƒå˜é‡&#125;</span>&quot;</span></span><br><span class="line">  <span class="built_in">declare</span> -A SITES=([<span class="string">&quot;SITE1&quot;</span>]=<span class="string">&quot;<span class="variable">$SITE1_URL</span>&quot;</span> [<span class="string">&quot;SITE2&quot;</span>]=<span class="string">&quot;<span class="variable">$SITE2_URL</span>&quot;</span>)</span><br><span class="line">  header <span class="string">&quot;<span class="variable">$ICON_START</span>&quot;</span> <span class="string">&quot;MinIO ç«™ç‚¹å¤åˆ¶åˆå§‹åŒ–&quot;</span></span><br><span class="line">  wait_for_services</span><br><span class="line">  configure_aliases || <span class="built_in">exit</span> 1</span><br><span class="line">  cleanup_old_replication || <span class="built_in">exit</span> 1</span><br><span class="line">  setup_replication || <span class="built_in">exit</span> 1</span><br><span class="line">  verify_status</span><br><span class="line">  header <span class="string">&quot;<span class="variable">$ICON_FINISH</span>&quot;</span> <span class="string">&quot;MinIO ç«™ç‚¹å¤åˆ¶å·²å°±ç»ª&quot;</span></span><br><span class="line">  <span class="built_in">log</span> SUCCESS <span class="string">&quot;æ‰€æœ‰é…ç½®å·²å®Œæˆï¼ŒæœåŠ¡è¿è¡Œä¸­...&quot;</span></span><br><span class="line">  <span class="built_in">log</span> INFO <span class="string">&quot;æŒ‰ Ctrl+C åœæ­¢æœåŠ¡&quot;</span></span><br><span class="line">  <span class="built_in">exec</span> <span class="built_in">tail</span> -f /dev/null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">trap</span> <span class="string">&#x27;log INFO &quot;æ”¶åˆ°ç»ˆæ­¢ä¿¡å·ï¼Œæ­£åœ¨å…³é—­...&quot;; exit 0&#x27;</span> SIGTERM SIGINT</span><br><span class="line">main</span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²æ­¥éª¤"><a href="#éƒ¨ç½²æ­¥éª¤" class="headerlink" title="éƒ¨ç½²æ­¥éª¤"></a>éƒ¨ç½²æ­¥éª¤</h2><h3 id="å‡†å¤‡ç¯å¢ƒ"><a href="#å‡†å¤‡ç¯å¢ƒ" class="headerlink" title="å‡†å¤‡ç¯å¢ƒ"></a>å‡†å¤‡ç¯å¢ƒ</h3><ol><li>åˆ›å»ºç›®å½•ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /data/opt/installmiddleware/data/minio/data</span><br></pre></td></tr></table></figure></li><li>è®¾ç½®ç£ç›˜æƒé™ï¼š<br>ç¡®ä¿ 20T ç£ç›˜æŒ‚è½½åˆ° <code>/data</code>ï¼Œå¹¶èµ‹äºˆæƒé™ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chown</span> -R 1000:1000 ./data/minio/data</span><br></pre></td></tr></table></figure></li><li>ä¿å­˜é…ç½®ï¼š<ul><li>ä¿å­˜ <code>docker-compose.yml</code> å’Œ <code>.env</code> æ–‡ä»¶ã€‚</li><li>ä¿å­˜ <code>site-replication.sh</code>ï¼Œè®¾ç½®å¯æ‰§è¡Œæƒé™ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x site-replication.sh</span><br></pre></td></tr></table></figure></li></ul></li></ol><h3 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h3><p>åœ¨ MinIO1 å’Œ MinIO2 æœåŠ¡å™¨ä¸Šåˆ†åˆ«éƒ¨ç½² MinIO å®ä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/opt/installmiddleware</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><h3 id="é…ç½®ç«™ç‚¹å¤åˆ¶"><a href="#é…ç½®ç«™ç‚¹å¤åˆ¶" class="headerlink" title="é…ç½®ç«™ç‚¹å¤åˆ¶"></a>é…ç½®ç«™ç‚¹å¤åˆ¶</h3><ul><li><code>minio-mc</code> å®¹å™¨è‡ªåŠ¨è¿è¡Œ <code>site-replication.sh</code>ï¼Œé…ç½®ç«™ç‚¹å¤åˆ¶ã€‚</li><li>æ£€æŸ¥æ—¥å¿—ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker logs --<span class="built_in">tail</span> 100 minio-mc</span><br></pre></td></tr></table></figure>é¢„æœŸè¾“å‡ºï¼š<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Configuring aliases for SITE1 and SITE2...</span><br><span class="line">Adding site replication between SITE1 and SITE2...</span><br><span class="line">Site replication configured successfully!</span><br></pre></td></tr></table></figure></li></ul><h2 id="åŒæ­¥æµ‹è¯•"><a href="#åŒæ­¥æµ‹è¯•" class="headerlink" title="åŒæ­¥æµ‹è¯•"></a>åŒæ­¥æµ‹è¯•</h2><h3 id="æµ‹è¯•ç›®æ ‡"><a href="#æµ‹è¯•ç›®æ ‡" class="headerlink" title="æµ‹è¯•ç›®æ ‡"></a>æµ‹è¯•ç›®æ ‡</h3><p>éªŒè¯ MinIO1 åˆ›å»ºçš„æ¡¶å’Œä¸Šä¼ çš„å¯¹è±¡æ˜¯å¦è‡ªåŠ¨åŒæ­¥åˆ° MinIO2ã€‚</p><h3 id="æµ‹è¯•æ­¥éª¤"><a href="#æµ‹è¯•æ­¥éª¤" class="headerlink" title="æµ‹è¯•æ­¥éª¤"></a>æµ‹è¯•æ­¥éª¤</h3><ol><li>åœ¨ MinIO1 åˆ›å»ºæ¡¶ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it minio-mc bash</span><br><span class="line">mc mb SITE1/test-bucket</span><br></pre></td></tr></table></figure></li><li>ä¸Šä¼ æµ‹è¯•æ–‡ä»¶ï¼š<ul><li>åˆ›å»ºæ–‡ä»¶ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hello, MinIO!&quot;</span> &gt; test.txt</span><br></pre></td></tr></table></figure></li><li>ä¸Šä¼ åˆ° MinIO1ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mc <span class="built_in">cp</span> test.txt SITE1/test-bucket</span><br></pre></td></tr></table></figure></li></ul></li><li>éªŒè¯ MinIO2 åŒæ­¥ï¼š<ul><li>æ£€æŸ¥æ¡¶ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mc <span class="built_in">ls</span> SITE2</span><br></pre></td></tr></table></figure>é¢„æœŸè¾“å‡ºï¼š<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[2025-05-13 16:40:00 CST]     0B test-bucket/</span><br></pre></td></tr></table></figure></li><li>æ£€æŸ¥æ–‡ä»¶ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mc <span class="built_in">ls</span> SITE2/test-bucket</span><br></pre></td></tr></table></figure>é¢„æœŸè¾“å‡ºï¼š<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[2025-05-13 16:40:10 CST]    14B test.txt</span><br></pre></td></tr></table></figure></li></ul></li><li>è®¿é—® MinIO2 æ§åˆ¶å°ï¼š<ul><li>æ‰“å¼€ <code>http://192.168.199.147:9000</code>ï¼Œç™»å½•ï¼ˆ<code>admin</code>&#x2F;<code>Admin@123.com</code>ï¼‰ã€‚</li><li>ç¡®è®¤ <code>test-bucket</code> å’Œ <code>test.txt</code> å­˜åœ¨ã€‚</li></ul></li></ol><h3 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h3><p>æ¡¶å’Œæ–‡ä»¶æˆåŠŸåŒæ­¥ï¼Œè¯´æ˜ç«™ç‚¹å¤åˆ¶æ­£å¸¸ï¼ŒåŒæ­¥å»¶è¿Ÿé€šå¸¸åœ¨æ¯«ç§’çº§ï¼ˆRTT &lt; 20msï¼‰ã€‚</p><h2 id="æ•…éšœæ¢å¤æµ‹è¯•"><a href="#æ•…éšœæ¢å¤æµ‹è¯•" class="headerlink" title="æ•…éšœæ¢å¤æµ‹è¯•"></a>æ•…éšœæ¢å¤æµ‹è¯•</h2><h3 id="æµ‹è¯•ç›®æ ‡-1"><a href="#æµ‹è¯•ç›®æ ‡-1" class="headerlink" title="æµ‹è¯•ç›®æ ‡"></a>æµ‹è¯•ç›®æ ‡</h3><p>æ¨¡æ‹Ÿ MinIO1 æ•…éšœï¼ŒéªŒè¯ MinIO2 çš„æœåŠ¡å¯ç”¨æ€§ï¼Œå¹¶æµ‹è¯• MinIO1 æ¢å¤åçš„åŒæ­¥ã€‚</p><h3 id="æµ‹è¯•æ­¥éª¤-1"><a href="#æµ‹è¯•æ­¥éª¤-1" class="headerlink" title="æµ‹è¯•æ­¥éª¤"></a>æµ‹è¯•æ­¥éª¤</h3><ol><li>åœæ­¢ MinIO1ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose stop minio</span><br></pre></td></tr></table></figure></li><li>æ£€æŸ¥ç«™ç‚¹å¤åˆ¶çŠ¶æ€ï¼š<ul><li>åœ¨ <code>minio-mc</code> å®¹å™¨ä¸­ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mc admin replicate status SITE2</span><br></pre></td></tr></table></figure>é¢„æœŸè¾“å‡ºï¼ˆåŸºäºå®é™…æµ‹è¯•ï¼‰ï¼š<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Bucket replication status:</span><br><span class="line">â—  0/1 Buckets in sync</span><br><span class="line">Bucket          | SITE1           | SITE2          </span><br><span class="line">test            |                 | âœ—  in-sync     </span><br><span class="line">...</span><br><span class="line">Object replication status:</span><br><span class="line">Link:          â— offline 5 seconds (total downtime: 4 minutes 30 seconds)</span><br><span class="line">Errors:        0 in last 1 minute; 1 in last 1hr</span><br></pre></td></tr></table></figure></li></ul></li><li>éªŒè¯ MinIO2 æœåŠ¡ï¼š<ul><li>ä¸Šä¼ æ–°æ–‡ä»¶ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;MinIO2 test&quot;</span> &gt; test2.txt</span><br><span class="line">mc <span class="built_in">cp</span> test2.txt SITE2/test-bucket</span><br></pre></td></tr></table></figure></li><li>æ£€æŸ¥ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mc <span class="built_in">ls</span> SITE2/test-bucket</span><br></pre></td></tr></table></figure>é¢„æœŸè¾“å‡ºï¼š<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[2025-05-13 16:45:00 CST]    14B test.txt</span><br><span class="line">[2025-05-13 16:45:10 CST]    12B test2.txt</span><br></pre></td></tr></table></figure></li></ul></li><li>æ¢å¤ MinIO1ï¼š<ul><li>å¯åŠ¨ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose start minio</span><br></pre></td></tr></table></figure></li><li>éªŒè¯å¥åº·ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -f http://192.168.199.145:9000/minio/health/live</span><br></pre></td></tr></table></figure></li></ul></li><li>é‡æ–°åŒæ­¥ï¼š<ul><li>è§¦å‘å¢é‡åŒæ­¥ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mc admin replicate resync start SITE2 SITE1</span><br></pre></td></tr></table></figure></li><li>æ£€æŸ¥çŠ¶æ€ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mc admin replicate status SITE2</span><br></pre></td></tr></table></figure>é¢„æœŸè¾“å‡ºï¼š<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Site Replication Status:</span><br><span class="line">- Site: SITE1 (http://192.168.199.145:9000) - Online</span><br><span class="line">- Site: SITE2 (http://192.168.199.147:9000) - Online</span><br><span class="line">Replication Status: Active</span><br></pre></td></tr></table></figure></li></ul></li><li>éªŒè¯ MinIO1 åŒæ­¥ï¼š<ul><li>æ£€æŸ¥ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mc <span class="built_in">ls</span> SITE1/test-bucket</span><br></pre></td></tr></table></figure>é¢„æœŸè¾“å‡ºï¼š<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[2025-05-13 16:45:00 CST]    14B test.txt</span><br><span class="line">[2025-05-13 16:45:10 CST]    12B test2.txt</span><br></pre></td></tr></table></figure></li></ul></li></ol><h3 id="æµ‹è¯•ç»“æœ-1"><a href="#æµ‹è¯•ç»“æœ-1" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h3><ul><li>MinIO1 æ•…éšœæœŸé—´ï¼ŒMinIO2 æ­£å¸¸æä¾›æœåŠ¡ã€‚</li><li>MinIO1 æ¢å¤åï¼Œå¢é‡æ•°æ®ï¼ˆ<code>test2.txt</code>ï¼‰åŒæ­¥æˆåŠŸï¼Œç«™ç‚¹å¤åˆ¶æ¢å¤æ­£å¸¸ã€‚</li></ul><h2 id="æ³¨æ„äº‹é¡¹ä¸ä¼˜åŒ–å»ºè®®"><a href="#æ³¨æ„äº‹é¡¹ä¸ä¼˜åŒ–å»ºè®®" class="headerlink" title="æ³¨æ„äº‹é¡¹ä¸ä¼˜åŒ–å»ºè®®"></a>æ³¨æ„äº‹é¡¹ä¸ä¼˜åŒ–å»ºè®®</h2><h3 id="ç£ç›˜ä¸è™šæ‹ŸåŒ–"><a href="#ç£ç›˜ä¸è™šæ‹ŸåŒ–" class="headerlink" title="ç£ç›˜ä¸è™šæ‹ŸåŒ–"></a>ç£ç›˜ä¸è™šæ‹ŸåŒ–</h3><ul><li>20T ç£ç›˜ï¼ˆè™šæ‹ŸåŒ–å 18Tï¼‰å¯èƒ½å—è™šæ‹ŸåŒ–å½±å“ï¼Œå»ºè®®ç›´é€šç£ç›˜ï¼š<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/dev/sdb:/data</span></span><br></pre></td></tr></table></figure></li><li>å®šæœŸæ£€æŸ¥ç£ç›˜å¥åº·ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">smartctl -a /dev/sdb</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç½‘ç»œ"><a href="#ç½‘ç»œ" class="headerlink" title="ç½‘ç»œ"></a>ç½‘ç»œ</h3><ul><li>ç¡®ä¿ RTT &lt; 20msï¼Œå¸¦å®½ â‰¥ 1Gbpsã€‚</li><li>æ£€æŸ¥é˜²ç«å¢™ï¼š<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ufw allow from 192.168.199.0/24 to any port 9000</span><br></pre></td></tr></table></figure></li></ul><h3 id="å®‰å…¨æ€§"><a href="#å®‰å…¨æ€§" class="headerlink" title="å®‰å…¨æ€§"></a>å®‰å…¨æ€§</h3><ul><li>æ›¿æ¢é»˜è®¤å‡­æ®ï¼ˆ<code>admin</code>&#x2F;<code>Admin@123.com</code>ï¼‰ã€‚</li><li>å¯ç”¨ TLSï¼š<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">environment:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">MINIO_SERVER_URL=https://192.168.199.145:9000</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="ç›‘æ§"><a href="#ç›‘æ§" class="headerlink" title="ç›‘æ§"></a>ç›‘æ§</h3><ul><li>å¯ç”¨ Prometheusï¼š<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">environment:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">MINIO_PROMETHEUS_AUTH_TYPE=public</span></span><br></pre></td></tr></table></figure></li><li>ä½¿ç”¨ Grafana ç›‘æ§èŠ‚ç‚¹çŠ¶æ€ï¼ˆ<code>minio_node_up</code>ï¼‰å’Œå¤åˆ¶å»¶è¿Ÿï¼ˆ<code>minio_replication_last_hour_latency_millis</code>ï¼‰ã€‚</li></ul><h3 id="é¢„ç®—"><a href="#é¢„ç®—" class="headerlink" title="é¢„ç®—"></a>é¢„ç®—</h3><ul><li>ç«™ç‚¹å¤åˆ¶éœ€è¦ä¸¤å°æœåŠ¡å™¨ï¼ˆçº¦ 14000-25000 å…ƒï¼‰ã€‚è‹¥é¢„ç®—æœ‰é™ï¼Œå¯è€ƒè™‘å•å‘ä¸»ä»å¤åˆ¶ï¼ˆçº¦ 7000-13000 å…ƒï¼‰ã€‚</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡ Docker Compose å’Œ <code>site-replication.sh</code>ï¼Œæˆ‘ä»¬éƒ¨ç½²äº† MinIO ç«™ç‚¹å¤åˆ¶é›†ç¾¤ï¼Œå®ç°äº† MinIO1 å’Œ MinIO2 çš„æ•°æ®å’Œå…ƒæ•°æ®åŒæ­¥ã€‚åŒæ­¥æµ‹è¯•éªŒè¯äº†æ¡¶å’Œå¯¹è±¡çš„è‡ªåŠ¨åŒæ­¥ï¼Œæ•…éšœæ¢å¤æµ‹è¯•ç¡®è®¤äº† MinIO2 çš„é«˜å¯ç”¨æ€§å’Œ MinIO1 æ¢å¤åçš„å¢é‡åŒæ­¥ã€‚è¯¥æ–¹æ¡ˆç»“åˆ 20T ç£ç›˜çš„å­˜å‚¨å®¹é‡ï¼Œé€‚ç”¨äºé«˜å¯ç”¨æ€§åœºæ™¯ã€‚</p><p>å¦‚éœ€è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆå¦‚ webhook é€šçŸ¥ã€Flask API é›†æˆï¼‰ï¼Œè¯·å‚è€ƒ MinIO æ–‡æ¡£ï¼š<span class="exturl" data-url="aHR0cHM6Ly9taW4uaW8vZG9jcy9taW5pby9saW51eC9vcGVyYXRpb25zL2luc3RhbGwtZGVwbG95LW1hbmFnZS9tdWx0aS1zaXRlLXJlcGxpY2F0aW9uLmh0bWw=">Site Replication<i class="fa fa-external-link-alt"></i></span>ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; MinIO æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„åˆ†å¸ƒå¼å¯¹è±¡å­˜å‚¨ç³»ç»Ÿï¼Œå…¶ç«™ç‚¹å¤åˆ¶ï¼ˆSite Replicationï¼‰åŠŸèƒ½æ”¯æŒè·¨é›†ç¾¤çš„æ•°æ®å’Œå…ƒæ•°æ®åŒæ­¥ã€‚æœ¬æ–‡è®°å½•äº†å¦‚ä½•ä½¿ç”¨ Docker Compose éƒ¨ç½² MinIO ç«™ç‚¹å¤åˆ¶é›†ç¾¤ï¼Œé…ç½®ä¸¤ä¸ª MinIO å®ä¾‹ï¼Œå¹¶è¿›è¡ŒåŒæ­¥æµ‹è¯•å’Œæ•…éšœæ¢å¤æµ‹è¯•ã€‚æµ‹è¯•ç¯å¢ƒåŸºäº 20T ç£ç›˜ï¼Œé€‚ç”¨äºéœ€è¦é«˜å¯ç”¨æ€§å’Œç¾éš¾æ¢å¤çš„åœºæ™¯ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Development" scheme="https://freemankevin.uk/categories/Development/"/>
    
    
    <category term="Docker" scheme="https://freemankevin.uk/tags/Docker/"/>
    
    <category term="MinIO" scheme="https://freemankevin.uk/tags/MinIO/"/>
    
    <category term="SITE Replication" scheme="https://freemankevin.uk/tags/SITE-Replication/"/>
    
    <category term="High Availability" scheme="https://freemankevin.uk/tags/High-Availability/"/>
    
    <category term="Error Recovery" scheme="https://freemankevin.uk/tags/Error-Recovery/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åœ¨ Docker ç¯å¢ƒä¸­éƒ¨ç½² VLLM</title>
    <link href="https://freemankevin.uk/2025/05/12/docker-vllm/"/>
    <id>https://freemankevin.uk/2025/05/12/docker-vllm/</id>
    <published>2025-05-12T09:14:25.000Z</published>
    <updated>2025-10-21T03:34:40.408Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æœ¬æŒ‡å—å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ Windows å’Œ Linux ç³»ç»Ÿä¸Šä½¿ç”¨ Docker éƒ¨ç½² vLLM å¤§æ¨¡å‹æœåŠ¡ï¼Œå¹¶æä¾›è·¨å¹³å°æµ‹è¯•æ–¹æ¡ˆã€‚</p><span id="more"></span><h2 id="ç³»ç»Ÿè¦æ±‚"><a href="#ç³»ç»Ÿè¦æ±‚" class="headerlink" title="ç³»ç»Ÿè¦æ±‚"></a>ç³»ç»Ÿè¦æ±‚</h2><h3 id="ç¡¬ä»¶è¦æ±‚"><a href="#ç¡¬ä»¶è¦æ±‚" class="headerlink" title="ç¡¬ä»¶è¦æ±‚"></a>ç¡¬ä»¶è¦æ±‚</h3><ul><li>NVIDIA GPU (å»ºè®® RTX 3060 æˆ–æ›´é«˜)</li><li>æ˜¾å­˜è¦æ±‚:<ul><li>Qwen&#x2F;Qwen3-0.6B: è‡³å°‘ 8GB ï¼ˆæœ¬åœ°æµ‹è¯•ï¼‰</li><li>Qwen&#x2F;QwQ-32B: è‡³å°‘ 64GBï¼ˆç”Ÿäº§ä½¿ç”¨ï¼‰</li></ul></li><li>å†…å­˜: 16GB æˆ–æ›´é«˜</li></ul><h3 id="è½¯ä»¶è¦æ±‚"><a href="#è½¯ä»¶è¦æ±‚" class="headerlink" title="è½¯ä»¶è¦æ±‚"></a>è½¯ä»¶è¦æ±‚</h3><ul><li>æ“ä½œç³»ç»Ÿ:<ul><li>Windows 10&#x2F;11 (ä¸“ä¸šç‰ˆ&#x2F;ä¼ä¸šç‰ˆ)</li><li>Linux (Ubuntu 20.04+&#x2F;CentOS 7+)</li></ul></li><li>Docker Engine 20.10+</li><li>NVIDIA é©±åŠ¨ 535+</li><li>NVIDIA Container Toolkit</li></ul><h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><h3 id="1-å®‰è£…å¿…è¦ç»„ä»¶"><a href="#1-å®‰è£…å¿…è¦ç»„ä»¶" class="headerlink" title="1. å®‰è£…å¿…è¦ç»„ä»¶"></a>1. å®‰è£…å¿…è¦ç»„ä»¶</h3><p><strong>Windows ç¯å¢ƒ:</strong></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… WSL2 (Windows å­ç³»ç»Ÿ)</span></span><br><span class="line">wsl <span class="literal">--install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… Docker Desktop</span></span><br><span class="line"><span class="comment"># ä» https://www.docker.com/products/docker-desktop ä¸‹è½½å®‰è£…</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… NVIDIA é©±åŠ¨å’Œ CUDA</span></span><br><span class="line"><span class="comment"># ä» https://developer.nvidia.com/cuda-downloads ä¸‹è½½</span></span><br></pre></td></tr></table></figure><p><strong>Linux ç¯å¢ƒ:</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… Docker</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install docker-ce docker-ce-cli containerd.io</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… NVIDIA Container Toolkit</span></span><br><span class="line">distribution=$(. /etc/os-release;<span class="built_in">echo</span> $ID<span class="variable">$VERSION_ID</span>) \</span><br><span class="line">   &amp;&amp; curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | <span class="built_in">sudo</span> apt-key add - \</span><br><span class="line">   &amp;&amp; curl -s -L https://nvidia.github.io/nvidia-docker/<span class="variable">$distribution</span>/nvidia-docker.list | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/nvidia-docker.list</span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y nvidia-docker2</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart docker</span><br></pre></td></tr></table></figure><h3 id="2-éªŒè¯ç¯å¢ƒ"><a href="#2-éªŒè¯ç¯å¢ƒ" class="headerlink" title="2. éªŒè¯ç¯å¢ƒ"></a>2. éªŒè¯ç¯å¢ƒ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># éªŒè¯ Docker å®‰è£…</span></span><br><span class="line">docker --version</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯ NVIDIA æ”¯æŒ</span></span><br><span class="line">docker run --<span class="built_in">rm</span> --gpus all nvidia/cuda:11.0.3-base-ubuntu20.04 nvidia-smi</span><br></pre></td></tr></table></figure><h2 id="Docker-éƒ¨ç½²"><a href="#Docker-éƒ¨ç½²" class="headerlink" title="Docker éƒ¨ç½²"></a>Docker éƒ¨ç½²</h2><h3 id="1-åˆ›å»º-docker-compose-yml-æ–‡ä»¶"><a href="#1-åˆ›å»º-docker-compose-yml-æ–‡ä»¶" class="headerlink" title="1. åˆ›å»º docker-compose.yml æ–‡ä»¶"></a>1. åˆ›å»º docker-compose.yml æ–‡ä»¶</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># version: &#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">vllm:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">vllm/vllm-openai:latest</span></span><br><span class="line">    <span class="attr">runtime:</span> <span class="string">nvidia</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">vllm</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span> </span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">reservations:</span></span><br><span class="line">          <span class="attr">devices:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">driver:</span> <span class="string">nvidia</span></span><br><span class="line">              <span class="attr">capabilities:</span> [<span class="string">gpu</span>]</span><br><span class="line">              <span class="attr">count:</span> <span class="string">all</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">$HOME/.cache/huggingface:/root/.cache/huggingface</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;28000:8000&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HF_HOME=/root/.cache/huggingface</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--model</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Qwen/Qwen3-0.6B</span> <span class="comment"># æˆ– Qwen/QwQ-32B</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--gpu-memory-utilization</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;0.8&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--trust-remote-code</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--max-num-seqs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;256&quot;</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD-SHELL&quot;</span>, <span class="string">&quot;curl -f http://localhost:8000/health || exit 1&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">60s</span></span><br></pre></td></tr></table></figure><p><strong>Windows ç”¨æˆ·æ³¨æ„</strong>:</p><ul><li>å°† <code>$HOME/.cache/huggingface</code> æ›¿æ¢ä¸º <code>C:/Users/Devops/.cache/huggingface</code></li><li>ç¡®ä¿è·¯å¾„ä½¿ç”¨æ­£æ–œæ  <code>/</code> è€Œéåæ–œæ  <code>\</code></li></ul><h3 id="2-å¯åŠ¨æœåŠ¡"><a href="#2-å¯åŠ¨æœåŠ¡" class="headerlink" title="2. å¯åŠ¨æœåŠ¡"></a>2. å¯åŠ¨æœåŠ¡</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½ vLLM é•œåƒ</span></span><br><span class="line">docker pull vllm/vllm-openai:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨æœåŠ¡</span></span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><h3 id="3-éªŒè¯æœåŠ¡"><a href="#3-éªŒè¯æœåŠ¡" class="headerlink" title="3. éªŒè¯æœåŠ¡"></a>3. éªŒè¯æœåŠ¡</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥å®¹å™¨çŠ¶æ€</span></span><br><span class="line">docker ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ—¥å¿—</span></span><br><span class="line">docker logs vllm</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¥åº·æ£€æŸ¥</span></span><br><span class="line">curl http://localhost:28000/health</span><br></pre></td></tr></table></figure><h2 id="æ¨¡å‹ä¸‹è½½ä¸ç®¡ç†"><a href="#æ¨¡å‹ä¸‹è½½ä¸ç®¡ç†" class="headerlink" title="æ¨¡å‹ä¸‹è½½ä¸ç®¡ç†"></a>æ¨¡å‹ä¸‹è½½ä¸ç®¡ç†</h2><h3 id="1-æ‰‹åŠ¨ä¸‹è½½æ¨¡å‹-å¯é€‰"><a href="#1-æ‰‹åŠ¨ä¸‹è½½æ¨¡å‹-å¯é€‰" class="headerlink" title="1. æ‰‹åŠ¨ä¸‹è½½æ¨¡å‹ (å¯é€‰)"></a>1. æ‰‹åŠ¨ä¸‹è½½æ¨¡å‹ (å¯é€‰)</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… huggingface_hub</span></span><br><span class="line">pip install huggingface_hub</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½æ¨¡å‹ (å¯åœ¨å®¿ä¸»æœºæ‰§è¡Œ)</span></span><br><span class="line">huggingface-cli download Qwen/Qwen3-0.6B </span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨¡å‹é»˜è®¤å­˜æ”¾åœ¨ç”¨æˆ·å®¶ç›®å½•ä¸‹ï¼Œæ¯”å¦‚:</span></span><br><span class="line"><span class="comment"># C:/Users/Devops/.cache/huggingface/hub/models--Qwen--Qwen3-0.6B</span></span><br></pre></td></tr></table></figure><h3 id="2-ä½¿ç”¨-vLLM-è‡ªåŠ¨ä¸‹è½½"><a href="#2-ä½¿ç”¨-vLLM-è‡ªåŠ¨ä¸‹è½½" class="headerlink" title="2. ä½¿ç”¨ vLLM è‡ªåŠ¨ä¸‹è½½"></a>2. ä½¿ç”¨ vLLM è‡ªåŠ¨ä¸‹è½½</h3><p>vLLM ä¼šåœ¨é¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨ä¸‹è½½æ¨¡å‹ï¼Œä½†å»ºè®®æå‰ä¸‹è½½ä»¥é¿å…è¶…æ—¶ã€‚</p><h2 id="æœåŠ¡æµ‹è¯•"><a href="#æœåŠ¡æµ‹è¯•" class="headerlink" title="æœåŠ¡æµ‹è¯•"></a>æœåŠ¡æµ‹è¯•</h2><h3 id="1-ä½¿ç”¨-curl-æµ‹è¯•"><a href="#1-ä½¿ç”¨-curl-æµ‹è¯•" class="headerlink" title="1. ä½¿ç”¨ curl æµ‹è¯•"></a>1. ä½¿ç”¨ curl æµ‹è¯•</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl http://localhost:28000/v1/completions \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">      &quot;model&quot;: &quot;Qwen/Qwen3-0.6B&quot;,</span></span><br><span class="line"><span class="string">      &quot;prompt&quot;: &quot;ä½ å¥½ï¼Œä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±&quot;,</span></span><br><span class="line"><span class="string">      &quot;max_tokens&quot;: 100</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="2-ä½¿ç”¨-HTML-æµ‹è¯•ç•Œé¢"><a href="#2-ä½¿ç”¨-HTML-æµ‹è¯•ç•Œé¢" class="headerlink" title="2. ä½¿ç”¨ HTML æµ‹è¯•ç•Œé¢"></a>2. ä½¿ç”¨ HTML æµ‹è¯•ç•Œé¢</h3><p>åˆ›å»º <code>vllm-test.html</code> æ–‡ä»¶ï¼š</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>vLLM æµ‹è¯•ç•Œé¢<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;input&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;4&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;50&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;è¾“å…¥æç¤ºè¯...&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;generate()&quot;</span>&gt;</span>ç”Ÿæˆ<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pre</span> <span class="attr">id</span>=<span class="string">&quot;output&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">generate</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> input = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;input&quot;</span>).<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;http://localhost:28000/v1/completions&quot;</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">headers</span>: &#123; <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span> &#125;,</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">model</span>: <span class="string">&quot;Qwen/Qwen3-0.6B&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">prompt</span>: input,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">max_tokens</span>: <span class="number">100</span></span></span><br><span class="line"><span class="language-javascript">          &#125;)</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> result = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;output&quot;</span>).<span class="property">textContent</span> = result.<span class="property">choices</span>[<span class="number">0</span>].<span class="property">text</span>;</span></span><br><span class="line"><span class="language-javascript">      &#125; <span class="keyword">catch</span> (error) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;output&quot;</span>).<span class="property">textContent</span> = <span class="string">&quot;é”™è¯¯: &quot;</span> + error.<span class="property">message</span>;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="è·¨å¹³å°æµ‹è¯•æ–¹æ¡ˆ"><a href="#è·¨å¹³å°æµ‹è¯•æ–¹æ¡ˆ" class="headerlink" title="è·¨å¹³å°æµ‹è¯•æ–¹æ¡ˆ"></a>è·¨å¹³å°æµ‹è¯•æ–¹æ¡ˆ</h2><h3 id="Windows-ç¯å¢ƒæµ‹è¯•"><a href="#Windows-ç¯å¢ƒæµ‹è¯•" class="headerlink" title="Windows ç¯å¢ƒæµ‹è¯•"></a>Windows ç¯å¢ƒæµ‹è¯•</h3><ol><li><p><strong>æµè§ˆå™¨å®‰å…¨é™åˆ¶</strong>:</p><ul><li>Chrome&#x2F;Firefox é»˜è®¤é˜»æ­¢è·¨åŸŸè¯·æ±‚</li><li>è§£å†³æ–¹æ¡ˆ:<ul><li>ä½¿ç”¨ <code>file:///</code> åè®®ç›´æ¥æ‰“å¼€ HTML æ–‡ä»¶</li><li>æˆ–ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ Chrome ç¦ç”¨å®‰å…¨é™åˆ¶:<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">chrome.exe <span class="literal">--user-data-dir</span>=<span class="string">&quot;C:/Temp&quot;</span> <span class="literal">--disable-web-security</span></span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p><strong>æ›¿ä»£æ–¹æ¡ˆ</strong>:</p><ul><li>ä½¿ç”¨ Postman æˆ– Insomnia æµ‹è¯• API</li><li>ä½¿ç”¨ Python è„šæœ¬æµ‹è¯•:<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"></span><br><span class="line">client = OpenAI(base_url=<span class="string">&quot;http://localhost:28000/v1&quot;</span>, api_key=<span class="string">&quot;token-abc123&quot;</span>)</span><br><span class="line"></span><br><span class="line">completion = client.completions.create(</span><br><span class="line">    model=<span class="string">&quot;Qwen/Qwen3-0.6B&quot;</span>,</span><br><span class="line">    prompt=<span class="string">&quot;ä½ å¥½ï¼Œä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±&quot;</span>,</span><br><span class="line">    max_tokens=<span class="number">100</span></span><br><span class="line">)</span><br><span class="line"><span class="built_in">print</span>(completion.choices[<span class="number">0</span>].text)</span><br></pre></td></tr></table></figure></li></ul></li></ol><h3 id="Linux-ç¯å¢ƒæµ‹è¯•"><a href="#Linux-ç¯å¢ƒæµ‹è¯•" class="headerlink" title="Linux ç¯å¢ƒæµ‹è¯•"></a>Linux ç¯å¢ƒæµ‹è¯•</h3><ol><li><p><strong>æµè§ˆå™¨æµ‹è¯•</strong>:</p><ul><li>å¯ç›´æ¥ä½¿ç”¨ Firefox æ‰“å¼€ HTML æ–‡ä»¶</li><li>æˆ–éƒ¨ç½²ç®€å• HTTP æœåŠ¡å™¨:<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 -m http.server 8000</span><br></pre></td></tr></table></figure>ç„¶åè®¿é—® <code>http://localhost:8000/vllm-test.html</code></li></ul></li><li><p><strong>å‘½ä»¤è¡Œæµ‹è¯•</strong>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ httpie å·¥å…·</span></span><br><span class="line">http POST http://localhost:28000/v1/completions \</span><br><span class="line">  model=<span class="string">&quot;Qwen/Qwen3-0.6B&quot;</span> \</span><br><span class="line">  prompt=<span class="string">&quot;ä½ å¥½&quot;</span> \</span><br><span class="line">  max_tokens:=50</span><br></pre></td></tr></table></figure></li></ol><h2 id="å¸¸è§é—®é¢˜è§£å†³"><a href="#å¸¸è§é—®é¢˜è§£å†³" class="headerlink" title="å¸¸è§é—®é¢˜è§£å†³"></a>å¸¸è§é—®é¢˜è§£å†³</h2><h3 id="1-æ¨¡å‹ä¸‹è½½å¤±è´¥"><a href="#1-æ¨¡å‹ä¸‹è½½å¤±è´¥" class="headerlink" title="1. æ¨¡å‹ä¸‹è½½å¤±è´¥"></a>1. æ¨¡å‹ä¸‹è½½å¤±è´¥</h3><p><strong>ç—‡çŠ¶</strong>: å®¹å™¨æ—¥å¿—æ˜¾ç¤ºä¸‹è½½è¶…æ—¶æˆ–å¤±è´¥</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>:</p><ul><li>æ‰‹åŠ¨ä¸‹è½½æ¨¡å‹åˆ°ç¼“å­˜ç›®å½•</li><li>è®¾ç½® HTTP ä»£ç†:<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">environment:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">HF_HUB_ENABLE_HF_TRANSFER=1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">http_proxy=http://your-proxy:port</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">https_proxy=http://your-proxy:port</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="2-GPU-å†…å­˜ä¸è¶³"><a href="#2-GPU-å†…å­˜ä¸è¶³" class="headerlink" title="2. GPU å†…å­˜ä¸è¶³"></a>2. GPU å†…å­˜ä¸è¶³</h3><p><strong>ç—‡çŠ¶</strong>: CUDA out of memory é”™è¯¯</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>:</p><ul><li>é™ä½ <code>--gpu-memory-utilization</code> å€¼ (å¦‚ 0.5)</li><li>ä½¿ç”¨æ›´å°æ¨¡å‹ (å¦‚ Qwen3-0.6B æ›¿ä»£ QwQ-32B)</li><li>æ·»åŠ  <code>--enforce-eager</code> å‚æ•°å‡å°‘å†…å­˜å ç”¨</li></ul><h3 id="3-è·¨åŸŸé—®é¢˜-CORS"><a href="#3-è·¨åŸŸé—®é¢˜-CORS" class="headerlink" title="3. è·¨åŸŸé—®é¢˜ (CORS)"></a>3. è·¨åŸŸé—®é¢˜ (CORS)</h3><p><strong>ç—‡çŠ¶</strong>: HTML æµ‹è¯•ç•Œé¢æ— æ³•è®¿é—® API</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>:</p><ul><li>å¯åŠ¨ vLLM æ—¶æ·»åŠ  CORS å‚æ•°:<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">command:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--model</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Qwen/Qwen3-0.6B</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--cors-allow-origins</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure></li><li>æˆ–ä½¿ç”¨ Nginx åå‘ä»£ç†é…ç½® CORS</li></ul><h3 id="4-Windows-è·¯å¾„é—®é¢˜"><a href="#4-Windows-è·¯å¾„é—®é¢˜" class="headerlink" title="4. Windows è·¯å¾„é—®é¢˜"></a>4. Windows è·¯å¾„é—®é¢˜</h3><p><strong>ç—‡çŠ¶</strong>: å·æŒ‚è½½å¤±è´¥</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>:</p><ul><li>ä½¿ç”¨ç»å¯¹è·¯å¾„å¹¶ç¡®ä¿ Docker Desktop å·²å¯ç”¨ â€œShared Drivesâ€</li><li>ç¤ºä¾‹:<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">C:/Users/Devops/.cache/huggingface:/root/.cache/huggingface</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="æ€§èƒ½ä¼˜åŒ–å»ºè®®"><a href="#æ€§èƒ½ä¼˜åŒ–å»ºè®®" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–å»ºè®®"></a>æ€§èƒ½ä¼˜åŒ–å»ºè®®</h2><ol><li><p><strong>é‡åŒ–</strong>:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">command:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--model</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Qwen/Qwen3-0.6B</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--quantization</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">awq</span>  <span class="comment"># æˆ– gptq</span></span><br></pre></td></tr></table></figure></li><li><p><strong>æ‰¹å¤„ç†ä¼˜åŒ–</strong>:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">command:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--max-num-batched-tokens</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;4096&quot;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å¹¶è¡Œæ¨ç†</strong>:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">command:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--tensor-parallel-size</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;2&quot;</span>  <span class="comment"># ä½¿ç”¨2ä¸ªGPU</span></span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; æœ¬æŒ‡å—å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ Windows å’Œ Linux ç³»ç»Ÿä¸Šä½¿ç”¨ Docker éƒ¨ç½² vLLM å¤§æ¨¡å‹æœåŠ¡ï¼Œå¹¶æä¾›è·¨å¹³å°æµ‹è¯•æ–¹æ¡ˆã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Development" scheme="https://freemankevin.uk/categories/Development/"/>
    
    
    <category term="Docker" scheme="https://freemankevin.uk/tags/Docker/"/>
    
    <category term="VLLM" scheme="https://freemankevin.uk/tags/VLLM/"/>
    
    <category term="OPenAI" scheme="https://freemankevin.uk/tags/OPenAI/"/>
    
    <category term="LLM" scheme="https://freemankevin.uk/tags/LLM/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ Cloudflare Tunnel å®‰å…¨æš´éœ²æœ¬åœ°æœåŠ¡åˆ°å…¬ç½‘</title>
    <link href="https://freemankevin.uk/2025/04/23/Cloudflare-Tunnel/"/>
    <id>https://freemankevin.uk/2025/04/23/Cloudflare-Tunnel/</id>
    <published>2025-04-23T07:14:25.000Z</published>
    <updated>2025-10-21T03:34:40.403Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Cloudflare Tunnel æ˜¯ä¸€ç§å¼ºå¤§çš„åå‘éš§é“æœåŠ¡ï¼Œå…è®¸ç”¨æˆ·å°†æœ¬åœ°æœåŠ¡å™¨æˆ–å†…éƒ¨ç½‘ç»œèµ„æºå®‰å…¨æš´éœ²åˆ°å…¬ç½‘ï¼Œè€Œæ— éœ€å¼€æ”¾é˜²ç«å¢™ç«¯å£æˆ–æ‹¥æœ‰å…¬ç½‘ IP åœ°å€ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç» Cloudflare Tunnel çš„å·¥ä½œåŸç†ã€åŠŸèƒ½ç‰¹ç‚¹ã€ä½¿ç”¨åœºæ™¯ï¼Œå¹¶ç»“åˆå®é™…æ“ä½œæ­¥éª¤ï¼Œå±•ç¤ºå¦‚ä½•é€šè¿‡ Cloudflare Tunnel å°†æœ¬åœ°æœåŠ¡æ˜ å°„åˆ°å…¬ç½‘åŸŸåã€‚</p><span id="more"></span><h2 id="ä»€ä¹ˆæ˜¯-Cloudflare-Tunnelï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-Cloudflare-Tunnelï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ Cloudflare Tunnelï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ Cloudflare Tunnelï¼Ÿ</h2><p>Cloudflare Tunnel æ˜¯ Cloudflare æä¾›çš„ä¸€é¡¹æœåŠ¡ï¼Œé€šè¿‡è¿è¡Œè½»é‡çº§å®¢æˆ·ç«¯ <code>cloudflared</code>ï¼Œåœ¨æœ¬åœ°è®¾å¤‡ä¸ Cloudflare å…¨çƒç½‘ç»œä¹‹é—´å»ºç«‹å®‰å…¨çš„å‡ºç«™è¿æ¥ï¼ˆoutbound-onlyï¼‰ã€‚å¤–éƒ¨ç”¨æˆ·å¯ä»¥é€šè¿‡ Cloudflare çš„ç½‘ç»œè®¿é—®ä½ çš„æœ¬åœ°æœåŠ¡ï¼Œè€Œæ— éœ€ç›´æ¥æš´éœ²æœåŠ¡å™¨çš„ IP æˆ–ç«¯å£ã€‚</p><h3 id="å·¥ä½œåŸç†"><a href="#å·¥ä½œåŸç†" class="headerlink" title="å·¥ä½œåŸç†"></a>å·¥ä½œåŸç†</h3><ol><li><strong>å®‰è£…å®¢æˆ·ç«¯</strong>ï¼šåœ¨æœ¬åœ°æœåŠ¡å™¨æˆ–è®¾å¤‡ä¸Šå®‰è£… <code>cloudflared</code>ï¼Œè¿™æ˜¯ Cloudflare æä¾›çš„éš§é“å®ˆæŠ¤è¿›ç¨‹ã€‚</li><li><strong>åˆ›å»ºéš§é“</strong>ï¼šä½¿ç”¨ <code>cloudflared</code> åˆ›å»ºä¸€ä¸ªéš§é“ï¼Œä¸ Cloudflare è¾¹ç¼˜ç½‘ç»œå»ºç«‹è¿æ¥ï¼Œæ— éœ€å…¬ç½‘ IPã€‚</li><li><strong>è·¯ç”±æµé‡</strong>ï¼šåœ¨ Cloudflare ä»ªè¡¨ç›˜ä¸­é…ç½®åŸŸåæˆ–å­åŸŸåï¼Œå¤–éƒ¨è¯·æ±‚é€šè¿‡ Cloudflare è½¬å‘åˆ°æœ¬åœ°æœåŠ¡ã€‚</li><li><strong>å®‰å…¨æ€§ä¿éšœ</strong>ï¼šæ‰€æœ‰æµé‡ç»è¿‡ Cloudflare çš„åŠ å¯†ï¼Œæ”¯æŒ HTTPSï¼Œå¹¶å¯ç»“åˆ Cloudflare Access æ·»åŠ èº«ä»½éªŒè¯ã€‚</li></ol><h3 id="ä¸»è¦ç‰¹ç‚¹"><a href="#ä¸»è¦ç‰¹ç‚¹" class="headerlink" title="ä¸»è¦ç‰¹ç‚¹"></a>ä¸»è¦ç‰¹ç‚¹</h3><ul><li><strong>æ— éœ€ç«¯å£è½¬å‘</strong>ï¼šæ— éœ€é…ç½®è·¯ç”±å™¨æˆ–å¼€æ”¾é˜²ç«å¢™ç«¯å£ï¼Œé€‚åˆå®¶åº­ç½‘ç»œæˆ–å—é™ç¯å¢ƒã€‚</li><li><strong>å…è´¹åŸºç¡€æœåŠ¡</strong>ï¼šåŸºæœ¬åŠŸèƒ½ï¼ˆå¦‚åˆ›å»ºéš§é“ã€ç»‘å®šåŸŸåï¼‰å…è´¹ï¼Œé€‚åˆä¸ªäººç”¨æˆ·æˆ–å°å‹é¡¹ç›®ã€‚</li><li><strong>å®‰å…¨æ€§å¢å¼º</strong>ï¼šæä¾› DDoS é˜²æŠ¤ã€SSL&#x2F;TLS åŠ å¯†ï¼Œæµé‡é€šè¿‡ Cloudflare å…¨çƒç½‘ç»œã€‚</li><li><strong>çµæ´»æ€§</strong>ï¼šæ”¯æŒå¤šç§åè®®ï¼ˆå¦‚ HTTPã€SSHã€RDPï¼‰ï¼Œå¯æš´éœ²ç½‘é¡µæœåŠ¡ã€è¿œç¨‹æ¡Œé¢æˆ–æ¸¸æˆæœåŠ¡å™¨ã€‚</li></ul><h3 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h3><ul><li><strong>è¿œç¨‹è®¿é—®æœ¬åœ°æœåŠ¡</strong>ï¼šå¦‚åœ¨å®¶è¿è¡Œ NASï¼Œæƒ³é€šè¿‡å…¬ç½‘è®¿é—®æ–‡ä»¶ç®¡ç†ç•Œé¢ã€‚</li><li><strong>å¼€å‘æµ‹è¯•</strong>ï¼šå¿«é€Ÿå°†æœ¬åœ°å¼€å‘ç¯å¢ƒæš´éœ²åˆ°å…¬ç½‘ï¼Œæµ‹è¯• webhook æˆ–ç¬¬ä¸‰æ–¹å›è°ƒã€‚</li><li><strong>æ›¿ä»£ VPN</strong>ï¼šç›¸æ¯”ä¼ ç»Ÿ VPNï¼ŒCloudflare Tunnel é…ç½®ç®€å•ï¼Œé€‚åˆå¿«é€Ÿéƒ¨ç½²ã€‚</li></ul><h3 id="å¯¹æ¯”-ngrok"><a href="#å¯¹æ¯”-ngrok" class="headerlink" title="å¯¹æ¯” ngrok"></a>å¯¹æ¯” ngrok</h3><p>ä¸ç±»ä¼¼çš„åå‘éš§é“å·¥å…· ngrok ç›¸æ¯”ï¼ŒCloudflare Tunnel æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p><ul><li><strong>æˆæœ¬</strong>ï¼šngrok å…è´¹ç‰ˆæœ‰ä¸¥æ ¼çš„æ—¶é•¿ï¼ˆ2å°æ—¶æ–­å¼€ï¼‰å’Œè¿æ¥é™åˆ¶ï¼Œè€Œ Cloudflare Tunnel å…è´¹ç‰ˆæ›´å®½æ¾ã€‚</li><li><strong>åŸŸå</strong>ï¼šngrok å…è´¹ç‰ˆæä¾›éšæœºåŸŸåï¼ŒCloudflare æ”¯æŒè‡ªå®šä¹‰åŸŸåã€‚</li><li><strong>å®‰å…¨æ€§</strong>ï¼šCloudflare æä¾›é¢å¤–çš„ DDoS é˜²æŠ¤å’Œå…¨çƒ CDN åŠ é€Ÿã€‚</li></ul><h2 id="å®è·µï¼šä½¿ç”¨-Cloudflare-Tunnel-æš´éœ²æœ¬åœ°æœåŠ¡"><a href="#å®è·µï¼šä½¿ç”¨-Cloudflare-Tunnel-æš´éœ²æœ¬åœ°æœåŠ¡" class="headerlink" title="å®è·µï¼šä½¿ç”¨ Cloudflare Tunnel æš´éœ²æœ¬åœ°æœåŠ¡"></a>å®è·µï¼šä½¿ç”¨ Cloudflare Tunnel æš´éœ²æœ¬åœ°æœåŠ¡</h2><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°†é€šè¿‡å®é™…æ“ä½œï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ Cloudflare Tunnel å°†æœ¬åœ°è¿è¡Œçš„ç½‘é¡µæœåŠ¡ï¼ˆ<code>http://localhost:19000</code>ï¼‰æ˜ å°„åˆ°å…¬ç½‘åŸŸå <code>share.freemankevin.uk</code>ã€‚</p><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><ol><li>æ³¨å†Œ Cloudflare è´¦å·ï¼šç™»å½• Cloudflare ä»ªè¡¨ç›˜ï¼Œæ·»åŠ ä½ çš„åŸŸåå¹¶ç¡®ä¿ DNS æ‰˜ç®¡åœ¨ Cloudflareã€‚</li><li>å®‰è£… <code>cloudflared</code>ï¼š<ul><li>åœ¨ Windows ä¸Šï¼Œä¸‹è½½ <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXJzLmNsb3VkZmxhcmUuY29tL2Nsb3VkZmxhcmUtb25lL2Nvbm5lY3Rpb25zL2Nvbm5lY3QtYXBwcy9pbnN0YWxsLWFuZC1zZXR1cC9pbnN0YWxsYXRpb24v">cloudflared.exe<i class="fa fa-external-link-alt"></i></span>ï¼ˆå®˜æ–¹ä¸‹è½½åœ°å€ï¼‰ã€‚</li><li>å°† <code>cloudflared.exe</code> æ”¾ç½®åœ¨åˆé€‚ç›®å½•ï¼ˆå¦‚ <code>C:\cloudflared\</code>ï¼‰ã€‚</li></ul></li></ol><h3 id="å®‰è£…-Cloudflare-Tunnel-æœåŠ¡"><a href="#å®‰è£…-Cloudflare-Tunnel-æœåŠ¡" class="headerlink" title="å®‰è£… Cloudflare Tunnel æœåŠ¡"></a>å®‰è£… Cloudflare Tunnel æœåŠ¡</h3><p>è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å®‰è£… <code>cloudflared</code> æœåŠ¡å¹¶ç»‘å®š Cloudflare è´¦æˆ·ï¼š</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">cloudflared.exe service install eyJhIjoiMjc0YzhmYzViSa2kih1k3MzVhNjBjNWQ1MTkzOWQyMDEiLCJ0IjoiMDEwNDI5MmEtNzEwYS00NTBkLWI3OGYtOTNjZTExYjhmYTZlIiwicyI6Ik56Um1ZVGcyT0dRdE9XUm1OaTAwWkRJM0xUbGxZemN0TWpKbFlUWmhabiJzTlRRMiJ9</span><br></pre></td></tr></table></figure><blockquote><p><strong>æ³¨æ„</strong>ï¼š<code>eyJh...</code> æ˜¯ Cloudflare æä¾›çš„è®¤è¯ä»¤ç‰Œï¼Œè¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ä»¤ç‰Œï¼ˆä» Cloudflare ä»ªè¡¨ç›˜è·å–ï¼‰ã€‚</p></blockquote><p>æˆåŠŸåï¼Œ<code>cloudflared</code> å°†ä½œä¸ºç³»ç»ŸæœåŠ¡è¿è¡Œã€‚</p><h3 id="åˆ›å»ºéš§é“"><a href="#åˆ›å»ºéš§é“" class="headerlink" title="åˆ›å»ºéš§é“"></a>åˆ›å»ºéš§é“</h3><p>åˆ›å»ºåä¸º <code>share</code> çš„éš§é“ï¼š</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">cloudflared tunnel create share</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç±»ä¼¼ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tunnel credentials written to C:\Users\Devops\.cloudflared\ab9d567c-00c0-46f3-83b7-680ei8b2f3f6.json. cloudflared chose this file based on where your origin certificate was found. Keep this file secret. To revoke these credentials, delete the tunnel.</span><br><span class="line"></span><br><span class="line">Created tunnel share with id ab9d567c-00c0-46f3-83b7-680ei8b2f3f6</span><br></pre></td></tr></table></figure><p>è¿™ä¼šç”Ÿæˆä¸€ä¸ªéš§é“ IDï¼ˆ<code>ab9d567c-00c0-46f3-83b7-680ei8b2f3f6</code>ï¼‰å’Œå‡­è¯æ–‡ä»¶ï¼ˆ<code>ab9d567c-00c0-46f3-83b7-680ei8b2f3f6.json</code>ï¼‰ã€‚è¯·å¦¥å–„ä¿å­˜å‡­è¯æ–‡ä»¶ï¼Œé¿å…æ³„éœ²ã€‚</p><h3 id="é…ç½®éš§é“"><a href="#é…ç½®éš§é“" class="headerlink" title="é…ç½®éš§é“"></a>é…ç½®éš§é“</h3><p>åˆ›å»ºé…ç½®æ–‡ä»¶ <code>config.yml</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tunnel:</span> <span class="string">share</span></span><br><span class="line"><span class="attr">credentials-file:</span> <span class="string">C:\Users\Devops\.cloudflared\ab9d567c-00c0-46f3-83b7-680ei8b2f3f6.json</span></span><br><span class="line"><span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostname:</span> <span class="string">share.freemankevin.uk</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">http://localhost:19000</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">service:</span> <span class="string">http_status:404</span></span><br></pre></td></tr></table></figure><ul><li><code>tunnel</code>ï¼šæŒ‡å®šéš§é“åç§°ï¼ˆ<code>share</code>ï¼‰ã€‚</li><li><code>credentials-file</code>ï¼šæŒ‡å®šå‡­è¯æ–‡ä»¶è·¯å¾„ã€‚</li><li><code>ingress</code>ï¼šå®šä¹‰è·¯ç”±è§„åˆ™ï¼Œå°† <code>share.freemankevin.uk</code> çš„è¯·æ±‚è½¬å‘åˆ°æœ¬åœ° <code>http://localhost:19000</code>ï¼Œå…¶ä»–è¯·æ±‚è¿”å› 404ã€‚</li></ul><p>å°† <code>config.yml</code> ä¿å­˜åˆ° <code>C:\Users\Devops\.cloudflared\</code> ç›®å½•ã€‚</p><h3 id="é…ç½®-DNS-è®°å½•"><a href="#é…ç½®-DNS-è®°å½•" class="headerlink" title="é…ç½® DNS è®°å½•"></a>é…ç½® DNS è®°å½•</h3><p>åœ¨ Cloudflare ä»ªè¡¨ç›˜ä¸­ï¼Œæ·»åŠ  CNAME è®°å½•ï¼š</p><table><thead><tr><th>ç±»å‹</th><th>åç§°</th><th>ç›®æ ‡</th></tr></thead><tbody><tr><td>CNAME</td><td>share</td><td>ab9d567c-00c0-46f3-83b7-680ei8b2f3f6.cfargotunnel.com</td></tr></tbody></table><p>æˆ–è€…ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨é…ç½® DNSï¼š</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">cloudflared tunnel route dns share share.freemankevin.uk</span><br></pre></td></tr></table></figure><h3 id="è¿è¡Œéš§é“"><a href="#è¿è¡Œéš§é“" class="headerlink" title="è¿è¡Œéš§é“"></a>è¿è¡Œéš§é“</h3><p>è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨éš§é“ï¼š</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">cloudflared tunnel <span class="literal">--config</span> C:\Users\Devops\.cloudflared\config.yml <span class="literal">--origin-ca-pool</span> C:\Users\Devops\.cloudflared\ca<span class="literal">-certificates</span>.pem <span class="literal">--logfile</span> C:\Users\Devops\.cloudflared\cloudflared.log run share</span><br></pre></td></tr></table></figure><p>å‚æ•°è¯´æ˜ï¼š</p><ul><li><code>--config</code>ï¼šæŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ã€‚</li><li><code>--origin-ca-pool</code>ï¼šæŒ‡å®š CA è¯ä¹¦è·¯å¾„ï¼ˆå¯é€‰ï¼Œé€šå¸¸ç”¨äºä¼ä¸šç¯å¢ƒï¼‰ã€‚</li><li><code>--logfile</code>ï¼šæŒ‡å®šæ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼Œä¾¿äºè°ƒè¯•ã€‚</li></ul><p>å¯åŠ¨åï¼Œ<code>share.freemankevin.uk</code> å°†å¯é€šè¿‡å…¬ç½‘è®¿é—®ï¼Œå¹¶æŒ‡å‘æœ¬åœ° <code>http://localhost:19000</code> çš„æœåŠ¡ã€‚</p><h3 id="æµ‹è¯•è®¿é—®"><a href="#æµ‹è¯•è®¿é—®" class="headerlink" title="æµ‹è¯•è®¿é—®"></a>æµ‹è¯•è®¿é—®</h3><p>åœ¨æµè§ˆå™¨ä¸­è®¿é—® <code>https://share.freemankevin.uk</code>ï¼Œç¡®è®¤æ˜¯å¦èƒ½æ­£å¸¸è®¿é—®æœ¬åœ°æœåŠ¡ã€‚å¦‚æœæ— æ³•è®¿é—®ï¼Œæ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š</p><ol><li>ç¡®ä¿æœ¬åœ°æœåŠ¡ï¼ˆ<code>http://localhost:19000</code>ï¼‰æ­£åœ¨è¿è¡Œã€‚</li><li>æ£€æŸ¥ Cloudflare ä»ªè¡¨ç›˜ä¸­çš„ DNS è®°å½•æ˜¯å¦æ­£ç¡®ã€‚</li><li>æŸ¥çœ‹ <code>cloudflared</code> æ—¥å¿—ï¼ˆ<code>C:\Users\Devops\.cloudflared\cloudflared.log</code>ï¼‰ä»¥æ’æŸ¥é”™è¯¯ã€‚</li></ol><h3 id="æ·»åŠ ç³»ç»ŸæœåŠ¡"><a href="#æ·»åŠ ç³»ç»ŸæœåŠ¡" class="headerlink" title="æ·»åŠ ç³»ç»ŸæœåŠ¡"></a>æ·»åŠ ç³»ç»ŸæœåŠ¡</h3><p>ä¸ºäº†æ–¹ä¾¿å¯åŠ¨å’Œç®¡ç†éš§é“ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢çš„éš§é“å…±äº«æœåŠ¡æ·»åŠ åˆ°ç³»ç»ŸæœåŠ¡ä¸­ï¼š</p><h4 id="æ·»åŠ æœåŠ¡"><a href="#æ·»åŠ æœåŠ¡" class="headerlink" title="æ·»åŠ æœåŠ¡"></a>æ·»åŠ æœåŠ¡</h4><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä»¥ç®¡ç†å‘˜èº«ä»½æ‰“å¼€ PowerShell</span></span><br><span class="line"><span class="comment"># åˆ›å»ºç³»ç»ŸæœåŠ¡</span></span><br><span class="line"><span class="built_in">sc</span> create CloudflaredTunnel binPath= <span class="string">&quot;C:\Program Files (x86)\cloudflared\cloudflared.exe tunnel --config C:\Users\Devops\.cloudflared\config.yml run share&quot;</span> <span class="built_in">start</span>= auto DisplayName= <span class="string">&quot;Cloudflare Tunnel Service&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®æœåŠ¡æè¿°</span></span><br><span class="line"><span class="built_in">sc</span> description CloudflaredTunnel <span class="string">&quot;Cloudflare Tunnel for secure remote access&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æ•…éšœæ¢å¤ï¼ˆè‡ªåŠ¨é‡å¯ï¼‰</span></span><br><span class="line"><span class="built_in">sc</span> failure CloudflaredTunnel reset= <span class="number">30</span> actions= restart/<span class="number">5000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨æœåŠ¡</span></span><br><span class="line"><span class="built_in">sc</span> <span class="built_in">start</span> CloudflaredTunnel</span><br></pre></td></tr></table></figure><p>æ·»åŠ åï¼Œ<code>cloudflared</code> å°†ä½œä¸ºç³»ç»ŸæœåŠ¡è¿è¡Œï¼Œæ— éœ€æ‰‹åŠ¨å¯åŠ¨ã€‚</p><h4 id="å¸è½½æœåŠ¡"><a href="#å¸è½½æœåŠ¡" class="headerlink" title="å¸è½½æœåŠ¡"></a>å¸è½½æœåŠ¡</h4><p>å¦‚æœä¸å†éœ€è¦è¯¥æœåŠ¡ï¼Œå¯ä»¥å¸è½½ï¼š</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sc</span> delete CloudflaredTunnel</span><br></pre></td></tr></table></figure><h2 id="å…è´¹ç‰ˆé™åˆ¶"><a href="#å…è´¹ç‰ˆé™åˆ¶" class="headerlink" title="å…è´¹ç‰ˆé™åˆ¶"></a>å…è´¹ç‰ˆé™åˆ¶</h2><ul><li><strong>å¸¦å®½</strong>ï¼šCloudflare Tunnel å…è´¹ç‰ˆæ²¡æœ‰æ˜ç¡®çš„å¸¦å®½é™åˆ¶ï¼Œä½†å¯èƒ½å¯¹æ»¥ç”¨è¡Œä¸ºè¿›è¡Œé™åˆ¶ã€‚</li><li><strong>åŠŸèƒ½</strong>ï¼šé«˜çº§åŠŸèƒ½ï¼ˆå¦‚è´Ÿè½½å‡è¡¡ã€Zero Trust ç­–ç•¥ï¼‰éœ€è¦ä»˜è´¹è®¡åˆ’ã€‚</li><li><strong>åŸŸå</strong>ï¼šéœ€ä½¿ç”¨ Cloudflare æ‰˜ç®¡çš„åŸŸåï¼ˆå¯å…è´¹æ³¨å†Œæˆ–è¿ç§»ç°æœ‰åŸŸåï¼‰ã€‚</li></ul><h2 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h2><h3 id="éš§é“æ— æ³•è¿æ¥ï¼Ÿ"><a href="#éš§é“æ— æ³•è¿æ¥ï¼Ÿ" class="headerlink" title="éš§é“æ— æ³•è¿æ¥ï¼Ÿ"></a>éš§é“æ— æ³•è¿æ¥ï¼Ÿ</h3><ul><li>æ£€æŸ¥ <code>cloudflared</code> æ˜¯å¦æ­£å¸¸è¿è¡Œï¼ŒæŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ã€‚</li><li>ç¡®ä¿ç½‘ç»œå…è®¸ <code>cloudflared</code> çš„å‡ºç«™è¿æ¥ï¼ˆç«¯å£ 443ï¼‰ã€‚</li></ul><h3 id="DNS-é…ç½®å¤±è´¥ï¼Ÿ"><a href="#DNS-é…ç½®å¤±è´¥ï¼Ÿ" class="headerlink" title="DNS é…ç½®å¤±è´¥ï¼Ÿ"></a>DNS é…ç½®å¤±è´¥ï¼Ÿ</h3><ul><li>ç¡®è®¤åŸŸåå·²æ­£ç¡®æ‰˜ç®¡åœ¨ Cloudflareã€‚</li><li>æ£€æŸ¥ CNAME è®°å½•æ˜¯å¦æŒ‡å‘æ­£ç¡®çš„éš§é“åœ°å€ã€‚</li></ul><h3 id="å¦‚ä½•åœæ­¢éš§é“ï¼Ÿ"><a href="#å¦‚ä½•åœæ­¢éš§é“ï¼Ÿ" class="headerlink" title="å¦‚ä½•åœæ­¢éš§é“ï¼Ÿ"></a>å¦‚ä½•åœæ­¢éš§é“ï¼Ÿ</h3><ul><li>æŒ‰ <code>Ctrl+C</code> åœæ­¢ <code>cloudflared</code> è¿›ç¨‹ã€‚</li><li>æˆ–åˆ é™¤éš§é“ï¼š<code>cloudflared tunnel delete share</code>ã€‚</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Cloudflare Tunnel æ˜¯ä¸€ä¸ªç®€å•ã€å®‰å…¨ä¸”å…è´¹çš„å·¥å…·ï¼Œé€‚åˆå°†æœ¬åœ°æœåŠ¡æš´éœ²åˆ°å…¬ç½‘ã€‚é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œä½ å¯ä»¥è½»æ¾å°†æœ¬åœ°ç½‘é¡µæœåŠ¡æ˜ å°„åˆ°è‡ªå®šä¹‰åŸŸåï¼Œå¹¶äº«å— Cloudflare æä¾›çš„åŠ å¯†å’Œ DDoS é˜²æŠ¤ã€‚ç›¸æ¯” ngrokï¼ŒCloudflare Tunnel åœ¨æˆæœ¬ã€çµæ´»æ€§å’Œå®‰å…¨æ€§ä¸Šæ›´å…·ä¼˜åŠ¿ï¼Œéå¸¸é€‚åˆä¸ªäººå¼€å‘è€…ã€å®¶åº­ç”¨æˆ·æˆ–å°å‹é¡¹ç›®ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Cloudflare Tunnel æ˜¯ä¸€ç§å¼ºå¤§çš„åå‘éš§é“æœåŠ¡ï¼Œå…è®¸ç”¨æˆ·å°†æœ¬åœ°æœåŠ¡å™¨æˆ–å†…éƒ¨ç½‘ç»œèµ„æºå®‰å…¨æš´éœ²åˆ°å…¬ç½‘ï¼Œè€Œæ— éœ€å¼€æ”¾é˜²ç«å¢™ç«¯å£æˆ–æ‹¥æœ‰å…¬ç½‘ IP åœ°å€ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç» Cloudflare Tunnel çš„å·¥ä½œåŸç†ã€åŠŸèƒ½ç‰¹ç‚¹ã€ä½¿ç”¨åœºæ™¯ï¼Œå¹¶ç»“åˆå®é™…æ“ä½œæ­¥éª¤ï¼Œå±•ç¤ºå¦‚ä½•é€šè¿‡ Cloudflare Tunnel å°†æœ¬åœ°æœåŠ¡æ˜ å°„åˆ°å…¬ç½‘åŸŸåã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Development" scheme="https://freemankevin.uk/categories/Development/"/>
    
    
    <category term="Cloudflare" scheme="https://freemankevin.uk/tags/Cloudflare/"/>
    
    <category term="Intranet penetration" scheme="https://freemankevin.uk/tags/Intranet-penetration/"/>
    
    <category term="DevOps" scheme="https://freemankevin.uk/tags/DevOps/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨ Docker ç¯å¢ƒä¸­éƒ¨ç½² Nexus ä»“åº“</title>
    <link href="https://freemankevin.uk/2025/04/22/docker-nexus/"/>
    <id>https://freemankevin.uk/2025/04/22/docker-nexus/</id>
    <published>2025-04-22T07:14:25.000Z</published>
    <updated>2025-10-21T03:34:40.408Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Nexusæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ä»“åº“ç®¡ç†å·¥å…·ï¼Œç”¨äºæ‰˜ç®¡Mavenå·¥ä»¶ã€Dockeré•œåƒç­‰ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨Dockerç¯å¢ƒä¸­éƒ¨ç½²Nexusä»“åº“ç®¡ç†å™¨ï¼Œå¹¶é›†æˆPostgreSQLæ•°æ®åº“ã€å¿«ç…§æ¸…ç†æœåŠ¡å’Œæ•°æ®åº“å¤‡ä»½æœåŠ¡ã€‚</p><span id="more"></span><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><h3 id="ç›®å½•ç»“æ„åˆ›å»º"><a href="#ç›®å½•ç»“æ„åˆ›å»º" class="headerlink" title="ç›®å½•ç»“æ„åˆ›å»º"></a>ç›®å½•ç»“æ„åˆ›å»º</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºNexusæ•°æ®ç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> -p ./nexus/sonatype-work</span><br><span class="line"><span class="built_in">chmod</span> -R 755 ./nexus/sonatype-work</span><br><span class="line"><span class="built_in">chown</span> -R 200:200 ./nexus/sonatype-work</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºNexuså¯†é’¥ç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> -p ./nexus/secret</span><br><span class="line"><span class="built_in">cat</span> &gt; ./nexus/secret/nexus-secrets.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;active&quot;: &quot;nexus-key&quot;,</span></span><br><span class="line"><span class="string">  &quot;keys&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;id&quot;: &quot;nexus-key&quot;,</span></span><br><span class="line"><span class="string">      &quot;key&quot;: &quot;$(openssl rand -base64 32)&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®æƒé™</span></span><br><span class="line"><span class="built_in">chmod</span> 600 ./nexus/secret/nexus-secrets.json</span><br><span class="line"><span class="built_in">chown</span> 200:200 ./nexus/secret/nexus-secrets.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºPostgreSQLç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> -p ./postgres/data ./postgres/dbbackups</span><br><span class="line"><span class="built_in">chmod</span> -R 755 ./postgres/data ./postgres/dbbackups</span><br><span class="line"><span class="built_in">chown</span> -R 101:103 ./postgres/data ./postgres/dbbackups</span><br></pre></td></tr></table></figure><h3 id="ç¯å¢ƒå˜é‡é…ç½®"><a href="#ç¯å¢ƒå˜é‡é…ç½®" class="headerlink" title="ç¯å¢ƒå˜é‡é…ç½®"></a>ç¯å¢ƒå˜é‡é…ç½®</h3><p>åˆ›å»º<code>.env</code>æ–‡ä»¶ï¼š</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Nexusé…ç½®</span></span><br><span class="line"><span class="attr">NEXUS_PORT</span>=<span class="number">8081</span></span><br><span class="line"><span class="attr">NEXUS_IMAGE</span>=sonatype/nexus3:<span class="number">3.79</span>.<span class="number">0</span></span><br><span class="line"><span class="attr">NEXUS_PASS</span>=Admin@gmail.<span class="number">123</span>.com</span><br><span class="line"><span class="attr">HEALTHCHECK_PORT</span>=<span class="number">8000</span></span><br><span class="line"><span class="attr">NEXUS_URL</span>=http://<span class="number">192.168</span>.<span class="number">1.100</span>:<span class="number">8081</span></span><br><span class="line"><span class="attr">NEXUS_USER</span>=admin</span><br><span class="line"><span class="attr">REPOSITORY_NAME</span>=maven-snapshots</span><br><span class="line"></span><br><span class="line"><span class="comment"># PostgreSQLé…ç½®</span></span><br><span class="line"><span class="attr">POSTGRES_PORT</span>=<span class="number">5432</span></span><br><span class="line"><span class="attr">POSTGRES_USER</span>=nexus</span><br><span class="line"><span class="attr">POSTGRES_PASS</span>=Nexus@gmail.<span class="number">123</span>.com</span><br><span class="line"><span class="attr">POSTGRES_DB</span>=nexus</span><br><span class="line"><span class="attr">POSTGRES_IMAGE</span>=kartoza/postgis:<span class="number">17</span>-<span class="number">3.5</span></span><br><span class="line"><span class="attr">POSTGRES_BACKUP_IMAGE</span>=kartoza/pg-backup:<span class="number">17</span>-<span class="number">3.5</span></span><br></pre></td></tr></table></figure><h2 id="Docker-Composeé…ç½®"><a href="#Docker-Composeé…ç½®" class="headerlink" title="Docker Composeé…ç½®"></a>Docker Composeé…ç½®</h2><p>åˆ›å»º<code>docker-compose.yaml</code>æ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#version: &#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nexus:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;$&#123;NEXUS_IMAGE&#125;&quot;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nexus</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">8192M</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;$&#123;NEXUS_PORT&#125;:8081&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">middleware</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">INSTALL4J_ADD_VM_PARAMS:</span> <span class="string">&quot;-Xms2g -Xmx2g -XX:MaxDirectMemorySize=2g -Djava.util.prefs.userRoot=/opt/sonatype/sonatype-work -Dnexus.datastore.enabled=true -Dnexus.datastore.nexus.jdbcUrl=jdbc:postgresql://postgres:5432/nexus?gssEncMode=disable -Dnexus.datastore.nexus.username=nexus -Dnexus.datastore.nexus.password=Nexus@gmail.123.com -Dnexus.datastore.nexus.advanced=maximumPoolSize=50 -Dkaraf.data=/opt/sonatype/sonatype-work -Dkaraf.etc=/opt/sonatype/sonatype-work/etc&quot;</span></span><br><span class="line">      <span class="attr">NEXUS_SECURITY_RANDOMPASSWORD:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="attr">NEXUS_SECRETS_KEY_FILE:</span> <span class="string">/opt/sonatype/sonatype-work/etc/nexus-secrets.json</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:8081/service/rest/v1/status&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">120s</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nexus/secret/nexus-secrets.json:/opt/sonatype/sonatype-work/etc/nexus-secrets.json:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nexus/sonatype-work:/opt/sonatype/sonatype-work</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nexus-cleanup:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ghcr.io/freemankevin/clean-snapshots/nexus-cleanup:sha-afbc846</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nexus-cleanup</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">NEXUS_URL:</span> <span class="string">&quot;$&#123;NEXUS_URL&#125;&quot;</span></span><br><span class="line">      <span class="attr">NEXUS_USER:</span> <span class="string">&quot;$&#123;NEXUS_USER:-admin&#125;&quot;</span></span><br><span class="line">      <span class="attr">NEXUS_PASS:</span> <span class="string">&quot;$&#123;NEXUS_PASS&#125;&quot;</span></span><br><span class="line">      <span class="attr">REPOSITORY_NAME:</span> <span class="string">&quot;$&#123;REPOSITORY_NAME:-maven-snapshots&#125;&quot;</span></span><br><span class="line">      <span class="attr">RETAIN_COUNT:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">      <span class="attr">DRY_RUN:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="attr">LOG_LEVEL:</span> <span class="string">&quot;INFO&quot;</span></span><br><span class="line">      <span class="attr">SCHEDULE_TIME:</span> <span class="string">&quot;03:00&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nexus/nexus-cleanup-logs:/var/log</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;$&#123;HEALTHCHECK_PORT&#125;:8000&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:8000/health&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="attr">nexus:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;$&#123;POSTGRES_IMAGE&#125;&quot;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">8192M</span>  </span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;$&#123;POSTGRES_PORT&#125;:5432&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">middleware</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">&quot;$&#123;POSTGRES_DB&#125;&quot;</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">&quot;$&#123;POSTGRES_USER&#125;&quot;</span></span><br><span class="line">      <span class="attr">POSTGRES_PASS:</span> <span class="string">&quot;$&#123;POSTGRES_PASS&#125;&quot;</span></span><br><span class="line">      <span class="attr">POSTGRES_INITDB_ARGS:</span> <span class="string">&quot;--encoding=UTF8&quot;</span></span><br><span class="line">      <span class="attr">ALLOW_IP_RANGE:</span> <span class="string">&quot;0.0.0.0/0&quot;</span></span><br><span class="line">      <span class="attr">POSTGRES_MULTIPLE_EXTENSIONS:</span> <span class="string">&quot;postgis,hstore,postgis_topology,postgis_raster,pgrouting,pg_trgm&quot;</span></span><br><span class="line">      <span class="attr">RUN_AS_ROOT:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD-SHELL&quot;</span>, <span class="string">&quot;PGPASSWORD=$&#123;POSTGRES_PASS&#125; pg_isready -h localhost -U $&#123;POSTGRES_USER&#125;&quot;</span>]</span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./postgres/data:/var/lib/postgresql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./postgres/dbbackups:/backups</span></span><br><span class="line">      <span class="comment">#- ./init-postgres.sql:/docker-entrypoint-initdb.d/init.sql</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">postgres-backup:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;$&#123;POSTGRES_BACKUP_IMAGE&#125;&quot;</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">4096M</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">postgres-backup</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">postgres-backups</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">middleware</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">DUMPPREFIX:</span> <span class="string">PG_db</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">&quot;$&#123;POSTGRES_USER&#125;&quot;</span></span><br><span class="line">      <span class="attr">POSTGRES_PASS:</span> <span class="string">&quot;$&#123;POSTGRES_PASS&#125;&quot;</span></span><br><span class="line">      <span class="attr">POSTGRES_PORT:</span> <span class="string">&quot;5432&quot;</span></span><br><span class="line">      <span class="attr">POSTGRES_HOST:</span> <span class="string">&quot;postgres&quot;</span></span><br><span class="line">      <span class="attr">CRON_SCHEDULE:</span> <span class="string">&quot;0 2 * * *&quot;</span></span><br><span class="line">      <span class="attr">REMOVE_BEFORE:</span> <span class="string">&quot;15&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./postgres/dbbackups:/backups</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="attr">postgres:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">middleware:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><h2 id="æœåŠ¡éƒ¨ç½²"><a href="#æœåŠ¡éƒ¨ç½²" class="headerlink" title="æœåŠ¡éƒ¨ç½²"></a>æœåŠ¡éƒ¨ç½²</h2><h3 id="åŠ è½½Dockeré•œåƒï¼ˆç¦»çº¿ç¯å¢ƒï¼‰"><a href="#åŠ è½½Dockeré•œåƒï¼ˆç¦»çº¿ç¯å¢ƒï¼‰" class="headerlink" title="åŠ è½½Dockeré•œåƒï¼ˆç¦»çº¿ç¯å¢ƒï¼‰"></a>åŠ è½½Dockeré•œåƒï¼ˆç¦»çº¿ç¯å¢ƒï¼‰</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker load -i images/nexus_3.79.0_amd64.tar.gz</span><br><span class="line">docker load -i images/nexus-cleanup.tar.gz</span><br><span class="line">docker load -i images/pg-v17-3.5.tar.gz</span><br><span class="line">docker load -i images/pg-backup-v17-3.5.tar.gz</span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><p>éªŒè¯æœåŠ¡çŠ¶æ€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose ps</span><br></pre></td></tr></table></figure><h2 id="å¯†ç é‡ç½®"><a href="#å¯†ç é‡ç½®" class="headerlink" title="å¯†ç é‡ç½®"></a>å¯†ç é‡ç½®</h2><p>å¦‚æœéœ€è¦é‡ç½®ç®¡ç†å‘˜å¯†ç ï¼š</p><ol><li>è¿›å…¥PostgreSQLå®¹å™¨ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it postgres bash</span><br></pre></td></tr></table></figure><ol start="2"><li>æ‰§è¡ŒSQLï¼š</li></ol><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--- å°†é»˜è®¤admin å¯†ç æ”¹ä¸º admin123</span></span><br><span class="line"><span class="keyword">UPDATE</span> security_user </span><br><span class="line"><span class="keyword">SET</span> password<span class="operator">=</span><span class="string">&#x27;$shiro1$SHA-512$1024$NE+wqQq/TmjZMvfI7ENh/g==$V4yPw8T64UQ6GfJfxYq2hLsVrBY8D1v+bktfOxGdt4b/9BthpWPNUy/CBk6V9iA0nHpzYzJFWO8v/tZFtES8CA==&#x27;</span>, </span><br><span class="line">status<span class="operator">=</span><span class="string">&#x27;active&#x27;</span> </span><br><span class="line"><span class="keyword">WHERE</span> id<span class="operator">=</span><span class="string">&#x27;admin&#x27;</span>;</span><br></pre></td></tr></table></figure><ol start="3"><li>é‡å¯æœåŠ¡ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose restart nexus</span><br></pre></td></tr></table></figure><h2 id="ç›‘æ§ä¸éªŒè¯"><a href="#ç›‘æ§ä¸éªŒè¯" class="headerlink" title="ç›‘æ§ä¸éªŒè¯"></a>ç›‘æ§ä¸éªŒè¯</h2><h3 id="æœåŠ¡å¥åº·æ£€æŸ¥"><a href="#æœåŠ¡å¥åº·æ£€æŸ¥" class="headerlink" title="æœåŠ¡å¥åº·æ£€æŸ¥"></a>æœåŠ¡å¥åº·æ£€æŸ¥</h3><ul><li>Nexus: <code>curl http://localhost:18080/service/rest/v1/status</code></li><li>Cleanup: <code>curl http://localhost:8000/health</code></li><li>PostgreSQL: <code>docker exec postgres pg_isready -U nexus</code></li></ul><h3 id="æ—¥å¿—æ£€æŸ¥"><a href="#æ—¥å¿—æ£€æŸ¥" class="headerlink" title="æ—¥å¿—æ£€æŸ¥"></a>æ—¥å¿—æ£€æŸ¥</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker logs nexus</span><br><span class="line"><span class="built_in">tail</span> -f ./nexus/nexus-cleanup-logs/cleanup.log</span><br></pre></td></tr></table></figure><h2 id="æ€§èƒ½ä¼˜åŒ–å»ºè®®"><a href="#æ€§èƒ½ä¼˜åŒ–å»ºè®®" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–å»ºè®®"></a>æ€§èƒ½ä¼˜åŒ–å»ºè®®</h2><ol><li><p><strong>JVMè°ƒä¼˜</strong>ï¼š</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line">-Xms4g -Xmx4g -XX:<span class="attr">MaxDirectMemorySize</span>=<span class="number">4</span>g</span><br></pre></td></tr></table></figure></li><li><p><strong>PostgreSQLé…ç½®</strong>ï¼š</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">max_connections</span> = <span class="number">200</span></span><br><span class="line"><span class="attr">work_mem</span> = <span class="number">16</span>MB</span><br></pre></td></tr></table></figure></li><li><p><strong>æ¸…ç†ç­–ç•¥</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">RETAIN_COUNT:</span> <span class="string">&quot;5&quot;</span></span><br><span class="line"><span class="attr">SCHEDULE_TIME:</span> <span class="string">&quot;02:00&quot;</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="å¸¸è§é—®é¢˜æ’æŸ¥"><a href="#å¸¸è§é—®é¢˜æ’æŸ¥" class="headerlink" title="å¸¸è§é—®é¢˜æ’æŸ¥"></a>å¸¸è§é—®é¢˜æ’æŸ¥</h2><table><thead><tr><th>é—®é¢˜</th><th>è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td>Nexuså¯åŠ¨å¤±è´¥</td><td>æ£€æŸ¥JVMå†…å­˜è®¾ç½®</td></tr><tr><td>PostgreSQLè¿æ¥é”™è¯¯</td><td>éªŒè¯.envæ–‡ä»¶å‡­æ®</td></tr><tr><td>æ¸…ç†æœåŠ¡ä¸å·¥ä½œ</td><td>æ£€æŸ¥NEXUS_URLé…ç½®</td></tr></tbody></table><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†Nexusåœ¨Dockerç¯å¢ƒä¸­çš„å®Œæ•´éƒ¨ç½²æ–¹æ¡ˆï¼ŒåŒ…å«æ•°æ®åº“é›†æˆã€è‡ªåŠ¨æ¸…ç†å’Œå¤‡ä»½åŠŸèƒ½ã€‚è¯¥æ–¹æ¡ˆé€‚åˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Œå¯æ ¹æ®å®é™…éœ€æ±‚è¿›è¡Œè°ƒæ•´ä¼˜åŒ–ã€‚</p><p><strong>ç›¸å…³èµ„æº</strong>ï¼š</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9oZWxwLnNvbmF0eXBlLmNvbS9yZXBvbWFuYWdlcjM=">Nexuså®˜æ–¹æ–‡æ¡£<i class="fa fa-external-link-alt"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy9jdXJyZW50L3J1bnRpbWUtY29uZmlnLmh0bWw=">PostgreSQLæœ€ä½³å®è·µ<i class="fa fa-external-link-alt"></i></span></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Nexusæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ä»“åº“ç®¡ç†å·¥å…·ï¼Œç”¨äºæ‰˜ç®¡Mavenå·¥ä»¶ã€Dockeré•œåƒç­‰ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨Dockerç¯å¢ƒä¸­éƒ¨ç½²Nexusä»“åº“ç®¡ç†å™¨ï¼Œå¹¶é›†æˆPostgreSQLæ•°æ®åº“ã€å¿«ç…§æ¸…ç†æœåŠ¡å’Œæ•°æ®åº“å¤‡ä»½æœåŠ¡ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Development" scheme="https://freemankevin.uk/categories/Development/"/>
    
    
    <category term="Docker" scheme="https://freemankevin.uk/tags/Docker/"/>
    
    <category term="PostgreSQL" scheme="https://freemankevin.uk/tags/PostgreSQL/"/>
    
    <category term="Nexus" scheme="https://freemankevin.uk/tags/Nexus/"/>
    
    <category term="Maven" scheme="https://freemankevin.uk/tags/Maven/"/>
    
  </entry>
  
  <entry>
    <title>Vim å¸¸ç”¨é…ç½®è¯´æ˜æ–‡æ¡£</title>
    <link href="https://freemankevin.uk/2025/03/05/vim/"/>
    <id>https://freemankevin.uk/2025/03/05/vim/</id>
    <published>2025-03-05T06:30:00.000Z</published>
    <updated>2025-10-21T03:34:40.421Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; å½“å‰æ–‡æ¡£ä¸º Vim ç¼–è¾‘å™¨çš„å¸¸ç”¨é…ç½®è¯´æ˜ï¼Œé€‚ç”¨äº Linux å’Œ Mac ç¯å¢ƒã€‚é…ç½®é¡¹æ—¨åœ¨æå‡ä»£ç ç¼–è¾‘ä½“éªŒï¼ŒåŒ…æ‹¬è¯­æ³•é«˜äº®ã€æ–‡ä»¶ç±»å‹æ£€æµ‹ã€ç²˜è´´ä¼˜åŒ–ç­‰åŠŸèƒ½ã€‚é…ç½®æ–‡ä»¶é€šå¸¸ä½äº <code>~/.vimrc</code>ï¼ˆLinux&#x2F;Macï¼‰ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯é€šè¿‡ <code>vim ~/.vimrc</code> åˆ›å»ºã€‚</p><span id="more"></span><h2 id="é…ç½®å†…å®¹"><a href="#é…ç½®å†…å®¹" class="headerlink" title="é…ç½®å†…å®¹"></a>é…ç½®å†…å®¹</h2><p>ä»¥ä¸‹æ˜¯æ¨èçš„ Vim é…ç½®é¡¹åŠå…¶è¯´æ˜ï¼š</p><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="comment">&quot; å¯ç”¨è¯­æ³•é«˜äº®</span></span><br><span class="line"><span class="keyword">syntax</span> <span class="keyword">on</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; å¯ç”¨æ–‡ä»¶ç±»å‹æ£€æµ‹</span></span><br><span class="line"><span class="keyword">filetype</span> <span class="keyword">on</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; å¯ç”¨æ–‡ä»¶ç±»å‹æ’ä»¶å’Œè‡ªåŠ¨ç¼©è¿›ï¼ˆåŸºäºæ–‡ä»¶ç±»å‹ï¼‰</span></span><br><span class="line"><span class="keyword">filetype</span> plugin <span class="built_in">indent</span> <span class="keyword">on</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; è®¾ç½®é»˜è®¤é¢œè‰²æ–¹æ¡ˆ</span></span><br><span class="line"><span class="keyword">colorscheme</span> default</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; ç¦ç”¨è‡ªåŠ¨ç¼©è¿›</span></span><br><span class="line"><span class="keyword">set</span> noautoindent</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; ç¦ç”¨æ™ºèƒ½ç¼©è¿›</span></span><br><span class="line"><span class="keyword">set</span> nosmartindent</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; ç¦ç”¨åœ¨æ’å…¥æ³¨é‡Šæ—¶è‡ªåŠ¨æ·»åŠ æ³¨é‡Šå­—ç¬¦</span></span><br><span class="line"><span class="keyword">set</span> formatoptions-=r</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; ç¦ç”¨åœ¨æŒ‰ &#x27;o&#x27; æˆ– &#x27;O&#x27; æ—¶è‡ªåŠ¨æ·»åŠ æ³¨é‡Š</span></span><br><span class="line"><span class="keyword">set</span> formatoptions-=<span class="keyword">o</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; ç¦ç”¨è‡ªåŠ¨æ¢è¡Œï¼Œä¿æŒåŸå§‹è¡Œé•¿</span></span><br><span class="line"><span class="keyword">set</span> textwidth=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; å¯ç”¨ç²˜è´´æ¨¡å¼ï¼Œé˜²æ­¢è‡ªåŠ¨æ ¼å¼åŒ–ï¼ˆå»ºè®®ä¸´æ—¶ä½¿ç”¨ï¼‰</span></span><br><span class="line"><span class="keyword">set</span> paste</span><br></pre></td></tr></table></figure><h3 id="é…ç½®é¡¹è¯¦ç»†è¯´æ˜"><a href="#é…ç½®é¡¹è¯¦ç»†è¯´æ˜" class="headerlink" title="é…ç½®é¡¹è¯¦ç»†è¯´æ˜"></a>é…ç½®é¡¹è¯¦ç»†è¯´æ˜</h3><ol><li><p><strong><code>syntax on</code></strong></p><ul><li><strong>åŠŸèƒ½</strong>: å¯ç”¨è¯­æ³•é«˜äº®ï¼Œæ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºä¸åŒé¢œè‰²ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>: æé«˜ä»£ç å¯è¯»æ€§ï¼Œé€‚ç”¨äºç¼–ç¨‹è¯­è¨€ï¼ˆå¦‚ Pythonã€YAMLï¼‰ã€‚</li><li><strong>æ³¨æ„</strong>: éœ€ç»ˆç«¯æ”¯æŒé¢œè‰²è¾“å‡ºï¼ˆLinux&#x2F;Mac é€šå¸¸æ”¯æŒï¼‰ã€‚</li></ul></li><li><p><strong><code>filetype on</code></strong></p><ul><li><strong>åŠŸèƒ½</strong>: å¯ç”¨æ–‡ä»¶ç±»å‹æ£€æµ‹ï¼ŒåŸºäºæ–‡ä»¶æ‰©å±•åæˆ–å†…å®¹è‡ªåŠ¨è¯†åˆ«ç±»å‹ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>: ç¡®ä¿ Vim æ­£ç¡®åŠ è½½ç‰¹å®šæ–‡ä»¶ç±»å‹çš„è®¾ç½®ã€‚</li><li><strong>æ³¨æ„</strong>: ä¸ <code>filetype plugin indent on</code> é…åˆä½¿ç”¨ã€‚</li></ul></li><li><p><strong><code>filetype plugin indent on</code></strong></p><ul><li><strong>åŠŸèƒ½</strong>: å¯ç”¨æ–‡ä»¶ç±»å‹æ’ä»¶å’ŒåŸºäºç±»å‹çš„è‡ªåŠ¨ç¼©è¿›ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>: ä¸ºä¸åŒè¯­è¨€æä¾›å®šåˆ¶åŒ–ç¼©è¿›è§„åˆ™ï¼ˆå¦‚ Python ä½¿ç”¨ 4 ç©ºæ ¼ï¼‰ã€‚</li><li><strong>æ³¨æ„</strong>: å¦‚æœç¦ç”¨ç¼©è¿›ï¼ˆè§ä¸‹æ–‡ï¼‰ï¼Œå¯èƒ½éœ€è°ƒæ•´æ­¤é¡¹ã€‚</li></ul></li><li><p><strong><code>colorscheme default</code></strong></p><ul><li><strong>åŠŸèƒ½</strong>: è®¾ç½®é»˜è®¤é¢œè‰²æ–¹æ¡ˆï¼Œæ§åˆ¶è¯­æ³•é«˜äº®çš„é¢œè‰²ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>: æä¾›åŸºç¡€è§†è§‰æ•ˆæœï¼Œå¯æ›¿æ¢ä¸ºå…¶ä»–æ–¹æ¡ˆï¼ˆå¦‚ <code>colorscheme desert</code>ï¼‰ã€‚</li><li><strong>æ³¨æ„</strong>: éœ€å®‰è£…å¯¹åº”é¢œè‰²æ–¹æ¡ˆæ–‡ä»¶ï¼ˆé€šå¸¸é»˜è®¤å·²åŒ…å«ï¼‰ã€‚</li></ul></li><li><p><strong><code>set noautoindent</code></strong></p><ul><li><strong>åŠŸèƒ½</strong>: ç¦ç”¨è‡ªåŠ¨ç¼©è¿›ï¼Œé˜²æ­¢æ–°è¡Œç»§æ‰¿ä¸Šä¸€è¡Œçš„ç¼©è¿›ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>: ç²˜è´´ä»£ç æ—¶ä¿æŒåŸæ ¼å¼ï¼Œé¿å…æ„å¤–ç¼©è¿›ã€‚</li></ul></li><li><p><strong><code>set nosmartindent</code></strong></p><ul><li><strong>åŠŸèƒ½</strong>: ç¦ç”¨æ™ºèƒ½ç¼©è¿›ï¼Œé˜²æ­¢æ ¹æ®è¯­æ³•è‡ªåŠ¨è°ƒæ•´ç¼©è¿›ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>: ä¸ <code>noautoindent</code> é…åˆï¼Œé€‚åˆç²˜è´´å¤§æ®µæ–‡æœ¬ã€‚</li></ul></li><li><p><strong><code>set formatoptions-=r</code></strong></p><ul><li><strong>åŠŸèƒ½</strong>: ç¦ç”¨åœ¨æ’å…¥æ¨¡å¼ä¸‹è¾“å…¥æ³¨é‡Šæ—¶è‡ªåŠ¨æ·»åŠ æ³¨é‡Šå­—ç¬¦ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>: é˜²æ­¢åœ¨å¤šè¡Œæ³¨é‡Šä¸­æ„å¤–æ·»åŠ å¤šä½™ <code>*</code> æˆ– <code>#</code>ã€‚</li></ul></li><li><p><strong><code>set formatoptions-=o</code></strong></p><ul><li><strong>åŠŸèƒ½</strong>: ç¦ç”¨åœ¨æŒ‰ <code>o</code> æˆ– <code>O</code>ï¼ˆæ–°è¡Œï¼‰æ—¶è‡ªåŠ¨æ·»åŠ æ³¨é‡Šã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>: ä¿æŒæ‰‹åŠ¨æ§åˆ¶æ³¨é‡Šæ ¼å¼ã€‚</li></ul></li><li><p><strong><code>set textwidth=0</code></strong></p><ul><li><strong>åŠŸèƒ½</strong>: ç¦ç”¨è‡ªåŠ¨æ¢è¡Œï¼Œä¿æŒåŸå§‹è¡Œé•¿ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>: ç²˜è´´é•¿è¡Œä»£ç æˆ–æ–‡æ¡£æ—¶é¿å…æˆªæ–­ã€‚</li></ul></li><li><p><strong><code>set paste</code></strong></p><ul><li><strong>åŠŸèƒ½</strong>: å¯ç”¨ç²˜è´´æ¨¡å¼ï¼Œç¦ç”¨è‡ªåŠ¨æ ¼å¼åŒ–å’Œç¼©è¿›ã€‚</li><li><strong>é€‚ç”¨åœºæ™¯</strong>: ç²˜è´´å¤–éƒ¨ä»£ç æ—¶ä¿æŒåŸæ ·ã€‚</li><li><strong>æ³¨æ„</strong>: å»ºè®®ä¸´æ—¶å¯ç”¨ï¼ˆ<code>:set paste</code>ï¼‰ï¼Œç²˜è´´åå…³é—­ï¼ˆ<code>:set nopaste</code>ï¼‰ï¼Œå¦åˆ™å¯èƒ½å½±å“æ­£å¸¸ç¼–è¾‘ã€‚</li></ul></li></ol><h2 id="å†²çªåˆ†æ"><a href="#å†²çªåˆ†æ" class="headerlink" title="å†²çªåˆ†æ"></a>å†²çªåˆ†æ</h2><p>ä»¥ä¸‹æ˜¯é…ç½®é¡¹ä¸­å¯èƒ½å‘ç”Ÿçš„å†²çªåŠè§£å†³æ–¹æ³•ï¼š</p><ol><li><p><strong><code>noautoindent</code>ã€<code>nosmartindent</code> ä¸ <code>filetype plugin indent on</code> çš„å†²çª</strong></p><ul><li><strong>é—®é¢˜</strong>: <code>filetype plugin indent on</code> å¯ç”¨åŸºäºæ–‡ä»¶ç±»å‹çš„è‡ªåŠ¨ç¼©è¿›ï¼Œè€Œ <code>noautoindent</code> å’Œ <code>nosmartindent</code> è¯•å›¾ç¦ç”¨æ‰€æœ‰è‡ªåŠ¨ç¼©è¿›ï¼Œå¯¼è‡´è¡Œä¸ºä¸ä¸€è‡´ã€‚</li><li><strong>å½±å“</strong>: å¯èƒ½å¯¼è‡´ç¼©è¿›è§„åˆ™å¤±æ•ˆæˆ–æ··ä¹±ï¼Œå°¤å…¶åœ¨æ‰“å¼€æ–°æ–‡ä»¶æ—¶ã€‚</li><li><strong>è§£å†³</strong>: å¦‚æœç›®æ ‡æ˜¯ç¦ç”¨ç¼©è¿›ï¼ˆä¾‹å¦‚ä¸ºç²˜è´´ä¼˜åŒ–ï¼‰ï¼Œå»ºè®®ç§»é™¤ <code>filetype plugin indent on</code> æˆ–ä»…ä¿ç•™ <code>filetype on</code> å’Œ <code>syntax on</code>ã€‚</li></ul></li><li><p><strong><code>set paste</code> çš„å…¨å±€å½±å“</strong></p><ul><li><strong>é—®é¢˜</strong>: <code>set paste</code> æ˜¯ä¸€ä¸ªå…¨å±€è®¾ç½®ï¼Œä¼šç¦ç”¨ç¼©è¿›ã€è‡ªåŠ¨è¡¥å…¨ç­‰æ’ä»¶åŠŸèƒ½ï¼Œé•¿æœŸå¯ç”¨å¯èƒ½å¹²æ‰°æ­£å¸¸ç¼–è¾‘ã€‚</li><li><strong>å½±å“</strong>: å½±å“ <code>filetype plugin indent on</code> çš„æ•ˆæœï¼Œç”šè‡³å¯èƒ½ä¸è‡ªå®šä¹‰é”®ç›˜æ˜ å°„å†²çªã€‚</li><li><strong>è§£å†³</strong>: æ”¹ä¸ºä¸´æ—¶ä½¿ç”¨ï¼Œæ·»åŠ å¿«æ·é”®åˆ‡æ¢ï¼š<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">nnoremap</span> <span class="symbol">&lt;F2&gt;</span> :<span class="keyword">set</span> paste!<span class="symbol">&lt;CR&gt;</span></span><br></pre></td></tr></table></figure>ç²˜è´´æ—¶æŒ‰ <code>F2</code> å¯ç”¨ï¼Œç²˜è´´åå†æ¬¡æŒ‰ <code>F2</code> å…³é—­ã€‚</li></ul></li><li><p><strong><code>cindent</code>ï¼ˆæœªåŒ…å«ä½†å¯èƒ½ç›¸å…³ï¼‰çš„æ½œåœ¨å†²çª</strong></p><ul><li><strong>é—®é¢˜</strong>: å¦‚æœæ·»åŠ  <code>set cindent</code>ï¼ˆå¯ç”¨ C é£æ ¼ç¼©è¿›ï¼‰ï¼Œä¼šä¸ <code>noautoindent</code> å’Œ <code>nosmartindent</code> å†²çªï¼Œå› ä¸º <code>cindent</code> å°è¯•åº”ç”¨ç¼©è¿›è§„åˆ™ã€‚</li><li><strong>å½±å“</strong>: ç¼©è¿›è¡Œä¸ºä¸å¯é¢„æµ‹ï¼Œå¯èƒ½å¯¼è‡´ä»£ç æ ¼å¼æ··ä¹±ã€‚</li><li><strong>è§£å†³</strong>: é¿å…åŒæ—¶ä½¿ç”¨ <code>cindent</code> å’Œ <code>noautoindent</code>&#x2F;<code>nosmartindent</code>ã€‚å¦‚æœéœ€è¦ C é£æ ¼ç¼©è¿›ï¼Œç§»é™¤å‰ä¸¤è€…ã€‚</li></ul></li></ol><h2 id="ä¼˜åŒ–é…ç½®å»ºè®®"><a href="#ä¼˜åŒ–é…ç½®å»ºè®®" class="headerlink" title="ä¼˜åŒ–é…ç½®å»ºè®®"></a>ä¼˜åŒ–é…ç½®å»ºè®®</h2><p>æ ¹æ®ä¸Šè¿°åˆ†æï¼Œä¼˜åŒ–åçš„ <code>~/.vimrc</code> é…ç½®å¦‚ä¸‹ï¼Œå…¼é¡¾è¯­æ³•é«˜äº®å’Œç²˜è´´ä¼˜åŒ–ï¼š</p><figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="comment">&quot; å¯ç”¨è¯­æ³•é«˜äº®å’Œæ–‡ä»¶ç±»å‹æ£€æµ‹</span></span><br><span class="line"><span class="keyword">syntax</span> <span class="keyword">on</span></span><br><span class="line"><span class="keyword">filetype</span> <span class="keyword">on</span></span><br><span class="line"><span class="comment">&quot; ç¦ç”¨åŸºäºæ–‡ä»¶ç±»å‹çš„è‡ªåŠ¨ç¼©è¿›æ’ä»¶ï¼ˆé¿å…ä¸ç²˜è´´å†²çªï¼‰</span></span><br><span class="line"><span class="comment">&quot; filetype plugin indent on</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; è®¾ç½®é»˜è®¤é¢œè‰²æ–¹æ¡ˆ</span></span><br><span class="line"><span class="keyword">colorscheme</span> default</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; ç¦ç”¨è‡ªåŠ¨ç¼©è¿›å’Œæ™ºèƒ½ç¼©è¿›ï¼ˆé€‚åˆç²˜è´´ï¼‰</span></span><br><span class="line"><span class="keyword">set</span> noautoindent</span><br><span class="line"><span class="keyword">set</span> nosmartindent</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; ç¦ç”¨è‡ªåŠ¨æ³¨é‡Šæ ¼å¼</span></span><br><span class="line"><span class="keyword">set</span> formatoptions-=r</span><br><span class="line"><span class="keyword">set</span> formatoptions-=<span class="keyword">o</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; ç¦ç”¨è‡ªåŠ¨æ¢è¡Œ</span></span><br><span class="line"><span class="keyword">set</span> textwidth=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; ç²˜è´´æ¨¡å¼å»ºè®®ä¸´æ—¶å¯ç”¨ï¼Œæ·»åŠ å¿«æ·é”®åˆ‡æ¢</span></span><br><span class="line"><span class="comment">&quot; set paste</span></span><br><span class="line"><span class="keyword">nnoremap</span> <span class="symbol">&lt;F2&gt;</span> :<span class="keyword">set</span> paste!<span class="symbol">&lt;CR&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨è¯´æ˜"><a href="#ä½¿ç”¨è¯´æ˜" class="headerlink" title="ä½¿ç”¨è¯´æ˜"></a>ä½¿ç”¨è¯´æ˜</h3><ul><li><strong>ä¿å­˜é…ç½®</strong>: å°†ä¸Šè¿°å†…å®¹å†™å…¥ <code>~/.vimrc</code>ï¼Œè¿è¡Œ <code>source ~/.vimrc</code> åº”ç”¨ã€‚</li><li><strong>æµ‹è¯•</strong>: æ‰“å¼€æ–‡ä»¶ï¼ˆ<code>vim test.yaml</code>ï¼‰ï¼ŒæŒ‰ <code>F2</code> è¿›å…¥ç²˜è´´æ¨¡å¼ï¼Œç²˜è´´å†…å®¹ï¼Œæ£€æŸ¥æ ¼å¼ã€‚</li><li><strong>è‡ªå®šä¹‰</strong>: æ ¹æ®éœ€æ±‚è°ƒæ•´é¢œè‰²æ–¹æ¡ˆæˆ–æ·»åŠ å…¶ä»–æ’ä»¶ã€‚</li></ul><h2 id="å…¼å®¹æ€§æ³¨æ„"><a href="#å…¼å®¹æ€§æ³¨æ„" class="headerlink" title="å…¼å®¹æ€§æ³¨æ„"></a>å…¼å®¹æ€§æ³¨æ„</h2><ul><li><strong>Linux&#x2F;Mac</strong>: é…ç½®é€‚ç”¨äºå¤§å¤šæ•°ç»ˆç«¯ï¼ˆéœ€æ”¯æŒ ANSI é¢œè‰²ï¼‰ã€‚è‹¥æ— é¢œè‰²ï¼Œæ£€æŸ¥ <code>TERM</code> å˜é‡ï¼ˆ<code>echo $TERM</code> åº”ä¸º <code>xterm</code> æˆ– <code>xterm-256color</code>ï¼‰ã€‚</li><li><strong>æ’ä»¶</strong>: è‹¥ä½¿ç”¨æ’ä»¶ï¼ˆå¦‚ NERDTreeï¼‰ï¼Œå¯èƒ½éœ€é¢å¤–é…ç½®ï¼Œé¿å…ä¸ <code>paste</code> å†²çªã€‚</li><li><strong>æ›´æ–°</strong>: å®šæœŸæ›´æ–° Vimï¼ˆ<code>sudo apt update &amp;&amp; sudo apt install vim</code> æˆ– <code>brew install vim</code>ï¼‰ä»¥è·å–æœ€æ–°åŠŸèƒ½ã€‚</li></ul><hr><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æ­¤é…ç½®ä¼˜åŒ–äº†è¯­æ³•é«˜äº®å’Œç²˜è´´ä½“éªŒï¼Œæ¶ˆé™¤äº† <code>noautoindent</code>&#x2F;<code>nosmartindent</code> ä¸ <code>filetype plugin indent on</code> çš„å†²çªï¼Œå¹¶å»ºè®®ä¸´æ—¶ç®¡ç† <code>paste</code> æ¨¡å¼ã€‚å®‰è£…åæµ‹è¯•æ•ˆæœï¼Œè‹¥æœ‰ç‰¹å®šéœ€æ±‚ï¼ˆå¦‚æ”¯æŒç‰¹å®šè¯­è¨€ï¼‰ï¼Œå¯è¿›ä¸€æ­¥æ‰©å±•é…ç½®ã€‚å¦‚éœ€æ›´å¤šå¸®åŠ©ï¼Œè¯·æä¾›ä½¿ç”¨åé¦ˆï¼</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; å½“å‰æ–‡æ¡£ä¸º Vim ç¼–è¾‘å™¨çš„å¸¸ç”¨é…ç½®è¯´æ˜ï¼Œé€‚ç”¨äº Linux å’Œ Mac ç¯å¢ƒã€‚é…ç½®é¡¹æ—¨åœ¨æå‡ä»£ç ç¼–è¾‘ä½“éªŒï¼ŒåŒ…æ‹¬è¯­æ³•é«˜äº®ã€æ–‡ä»¶ç±»å‹æ£€æµ‹ã€ç²˜è´´ä¼˜åŒ–ç­‰åŠŸèƒ½ã€‚é…ç½®æ–‡ä»¶é€šå¸¸ä½äº &lt;code&gt;~/.vimrc&lt;/code&gt;ï¼ˆLinux&amp;#x2F;Macï¼‰ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯é€šè¿‡ &lt;code&gt;vim ~/.vimrc&lt;/code&gt; åˆ›å»ºã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="https://freemankevin.uk/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://freemankevin.uk/tags/Linux/"/>
    
    <category term="VIM" scheme="https://freemankevin.uk/tags/VIM/"/>
    
  </entry>
  
  <entry>
    <title>äºŒè¿›åˆ¶æ–¹å¼éƒ¨ç½²Kubernetes é›†ç¾¤</title>
    <link href="https://freemankevin.uk/2025/02/08/k8s-binary/"/>
    <id>https://freemankevin.uk/2025/02/08/k8s-binary/</id>
    <published>2025-02-08T08:23:25.000Z</published>
    <updated>2025-10-21T03:34:40.412Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æœ¬æ–‡è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨äºŒè¿›åˆ¶æ–¹å¼åœ¨ Debian ç³»ç»Ÿä¸Šæ­å»ºä¸€ä¸ªç”Ÿäº§çº§åˆ«çš„é«˜å¯ç”¨ Kubernetes é›†ç¾¤ã€‚</p><span id="more"></span><hr><h1 id="éƒ¨ç½²è§„åˆ’"><a href="#éƒ¨ç½²è§„åˆ’" class="headerlink" title="éƒ¨ç½²è§„åˆ’"></a>éƒ¨ç½²è§„åˆ’</h1><h2 id="æœåŠ¡å™¨æ¸…å•"><a href="#æœåŠ¡å™¨æ¸…å•" class="headerlink" title="æœåŠ¡å™¨æ¸…å•"></a>æœåŠ¡å™¨æ¸…å•</h2><table><thead><tr><th>è§’è‰²</th><th>ä¸»æœºå</th><th>IPåœ°å€</th><th>é…ç½®</th><th>ç³»ç»Ÿ</th></tr></thead><tbody><tr><td>LB-1</td><td>lb1.k8s.com</td><td>192.168.171.134</td><td>2C4G</td><td>Debian 12</td></tr><tr><td>LB-2</td><td>lb2.k8s.com</td><td>192.168.171.135</td><td>2C4G</td><td>Debian 12</td></tr><tr><td>VIP</td><td>-</td><td>192.168.171.133</td><td>-</td><td>-</td></tr><tr><td>ETCD-1</td><td>etcd1.k8s.com</td><td>192.168.171.136</td><td>4C8G</td><td>Debian 12</td></tr><tr><td>ETCD-2</td><td>etcd2.k8s.com</td><td>192.168.171.137</td><td>4C8G</td><td>Debian 12</td></tr><tr><td>ETCD-3</td><td>etcd3.k8s.com</td><td>192.168.171.138</td><td>4C8G</td><td>Debian 12</td></tr><tr><td>Master-1</td><td>master1.k8s.com</td><td>192.168.171.136</td><td>4C8G</td><td>Debian 12</td></tr><tr><td>Master-2</td><td>master2.k8s.com</td><td>192.168.171.137</td><td>4C8G</td><td>Debian 12</td></tr><tr><td>Master-3</td><td>master3.k8s.com</td><td>192.168.171.138</td><td>4C8G</td><td>Debian 12</td></tr><tr><td>Worker-1</td><td>worker1.k8s.com</td><td>192.168.171.139</td><td>8C16G</td><td>Debian 12</td></tr><tr><td>Harbor</td><td>harbor.k8s.com</td><td>192.168.171.50</td><td>4C8G</td><td>Debian 12</td></tr><tr><td>NFS</td><td>nfs.k8s.com</td><td>192.168.171.140</td><td>4C8G</td><td>Debian 12</td></tr></tbody></table><h2 id="ç½‘ç»œè§„åˆ’"><a href="#ç½‘ç»œè§„åˆ’" class="headerlink" title="ç½‘ç»œè§„åˆ’"></a>ç½‘ç»œè§„åˆ’</h2><ul><li>èŠ‚ç‚¹ç½‘æ®µ: 192.168.171.0&#x2F;24</li><li>Pod ç½‘æ®µ: 10.244.0.0&#x2F;16</li><li>Service ç½‘æ®µ: 10.96.0.0&#x2F;12</li><li>DNS æœåŠ¡: CoreDNS</li></ul><h2 id="ç»„ä»¶ç‰ˆæœ¬"><a href="#ç»„ä»¶ç‰ˆæœ¬" class="headerlink" title="ç»„ä»¶ç‰ˆæœ¬"></a>ç»„ä»¶ç‰ˆæœ¬</h2><ul><li>Kubernetes: v1.27.8</li><li>Etcd: v3.5.9</li><li>Docker: 24.0.7</li><li>Containerd: 1.7.6</li><li>Calico: v3.26.1</li><li>CoreDNS: v1.10.1</li><li>Harbor: v2.9.1</li></ul><hr><h1 id="ç³»ç»Ÿåˆå§‹åŒ–"><a href="#ç³»ç»Ÿåˆå§‹åŒ–" class="headerlink" title="ç³»ç»Ÿåˆå§‹åŒ–"></a>ç³»ç»Ÿåˆå§‹åŒ–</h1><h2 id="æ·»åŠ è½¯ä»¶æº"><a href="#æ·»åŠ è½¯ä»¶æº" class="headerlink" title="æ·»åŠ è½¯ä»¶æº"></a>æ·»åŠ è½¯ä»¶æº</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¤‡ä»½åŸå§‹æºæ–‡ä»¶</span></span><br><span class="line">cp /etc/apt/sources.list /etc/apt/sources.list.bak</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¸…ç†å¹¶é…ç½®æ–°çš„è½¯ä»¶æº</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ é™¤æ³¨é‡Šè¡Œå’Œç©ºè¡Œ</span></span><br><span class="line">sed -i &#x27;/^#/d; /^$/d&#x27; /etc/apt/sources.list</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ³¨é‡Šæ‰åŸå§‹è¡Œ</span></span><br><span class="line">sed -i &#x27;s/^deb cdrom:\[Debian GNU\/Linux.*$/#&amp;/&#x27; /etc/apt/sources.list</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ é™¤æ—§çš„å®‰å…¨æº</span></span><br><span class="line">sed -i &#x27;/^deb http:\/\/security.debian.org\/debian-security/d&#x27; /etc/apt/sources.list</span><br><span class="line">sed -i &#x27;/^deb-src http:\/\/security.debian.org\/debian-security/d&#x27; /etc/apt/sources.list</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ æ¸…åæº</span></span><br><span class="line">cat &gt; /etc/apt/sources.list &lt;&lt; EOF</span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free</span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free</span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free</span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æºç é•œåƒï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">deb-src http://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">deb-src http://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">deb-src http://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">deb-src http://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="ç³»ç»Ÿæ›´æ–°"><a href="#ç³»ç»Ÿæ›´æ–°" class="headerlink" title="ç³»ç»Ÿæ›´æ–°"></a>ç³»ç»Ÿæ›´æ–°</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•</span></span><br><span class="line">apt update </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å‡çº§æ‰€æœ‰å·²å®‰è£…çš„è½¯ä»¶åŒ…</span></span><br><span class="line">apt upgrade -y </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£…é‡è¦çš„ç³»ç»Ÿæ›´æ–°ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰</span></span><br><span class="line">apt dist-upgrade -y</span><br></pre></td></tr></table></figure><h2 id="åŸºç¡€å·¥å…·å®‰è£…"><a href="#åŸºç¡€å·¥å…·å®‰è£…" class="headerlink" title="åŸºç¡€å·¥å…·å®‰è£…"></a>åŸºç¡€å·¥å…·å®‰è£…</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£…åŸºç¡€å·¥å…·åŒ…</span></span><br><span class="line">apt update</span><br><span class="line">apt install -y \</span><br><span class="line">    # ç³»ç»Ÿå·¥å…·</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    vim \</span><br><span class="line">    net-tools \</span><br><span class="line">    sudo \</span><br><span class="line">    telnet \</span><br><span class="line">    ufw \</span><br><span class="line">    iotop \</span><br><span class="line">    rsync \</span><br><span class="line">    unzip \</span><br><span class="line">    iputils-ping \</span><br><span class="line">    gawk \</span><br><span class="line">    sed \</span><br><span class="line">    cron \</span><br><span class="line">    gnupg \</span><br><span class="line">    locales \</span><br><span class="line">    curl \</span><br><span class="line">    wget \</span><br><span class="line">    tree \</span><br><span class="line">    htop \</span><br><span class="line">    nmon \</span><br><span class="line">    lsof \</span><br><span class="line">    # ç½‘ç»œå·¥å…·</span><br><span class="line">    nfs-common \</span><br><span class="line">    sshpass \</span><br><span class="line">    software-properties-common \</span><br><span class="line">    # ç³»ç»Ÿç›‘æ§</span><br><span class="line">    sysstat \</span><br><span class="line">    # æ–‡æœ¬å¤„ç†</span><br><span class="line">    jq \</span><br><span class="line">    # ç‰ˆæœ¬æ§åˆ¶</span><br><span class="line">    git</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¸…ç†ä¸éœ€è¦çš„åŒ…</span></span><br><span class="line">apt autoremove -y</span><br></pre></td></tr></table></figure><h2 id="ç³»ç»Ÿè¯­è¨€é…ç½®"><a href="#ç³»ç»Ÿè¯­è¨€é…ç½®" class="headerlink" title="ç³»ç»Ÿè¯­è¨€é…ç½®"></a>ç³»ç»Ÿè¯­è¨€é…ç½®</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆè‹±æ–‡è¯­è¨€ç¯å¢ƒ</span></span><br><span class="line">locale-gen en_US.UTF-8</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®ç³»ç»Ÿé»˜è®¤è¯­è¨€</span></span><br><span class="line">cat &gt; /etc/default/locale &lt;&lt; EOF</span><br><span class="line">LC_ALL=en_US.utf8</span><br><span class="line">LANG=en_US.utf8</span><br><span class="line">LANGUAGE=en_US.utf8</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®è¯­è¨€ç”Ÿæˆ</span></span><br><span class="line">sed -i &#x27;s/^zh_CN.UTF-8 UTF-8/#zh_CN.UTF-8 UTF-8/&#x27; /etc/locale.gen</span><br><span class="line">sed -i &#x27;s/#en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/&#x27; /etc/locale.gen</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡æ–°ç”Ÿæˆè¯­è¨€æ–‡ä»¶</span></span><br><span class="line">locale-gen</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line">echo &quot;export LANG=en_US.utf8&quot; &gt;&gt; /etc/profile</span><br><span class="line">echo &quot;export LANGUAGE=en_US.utf8&quot; &gt;&gt; /etc/profile</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><h2 id="SSHè¿œç¨‹è®¿é—®é…ç½®"><a href="#SSHè¿œç¨‹è®¿é—®é…ç½®" class="headerlink" title="SSHè¿œç¨‹è®¿é—®é…ç½®"></a>SSHè¿œç¨‹è®¿é—®é…ç½®</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®SSHå…è®¸rootç™»å½•</span></span><br><span class="line">sed -ri &#x27;s/#PermitRootLogin prohibit-password/PermitRootLogin yes/&#x27; /etc/ssh/sshd_config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åŠ å¼ºSSHå®‰å…¨é…ç½®</span></span><br><span class="line">cat &gt;&gt; /etc/ssh/sshd_config &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">SSHè®¤è¯é…ç½®</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åŒæ—¶å¯ç”¨å¯†ç å’Œå¯†é’¥è®¤è¯ï¼Œä¾¿äºåˆå§‹åŒ–åçš„ç®¡ç†</span></span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">PubkeyAuthentication yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®SSHåè®®ç‰ˆæœ¬</span></span><br><span class="line">Protocol 2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é™åˆ¶æœ€å¤§è®¤è¯å°è¯•æ¬¡æ•°</span></span><br><span class="line">MaxAuthTries 3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¦ç”¨ç©ºå¯†ç </span></span><br><span class="line">PermitEmptyPasswords no</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®ç™»å½•è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">LoginGraceTime 60</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯ç”¨ä¸¥æ ¼æ¨¡å¼</span></span><br><span class="line">StrictModes yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰å…¨åŠ å›ºå»ºè®®ï¼ˆç­‰ç³»ç»Ÿå®Œå…¨é…ç½®å¥½åå¯ä»¥è€ƒè™‘å¯ç”¨ï¼‰ï¼š</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1. ç¦ç”¨å¯†ç è®¤è¯ï¼Œåªä½¿ç”¨å¯†é’¥è®¤è¯</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">PasswordAuthentication no</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. é™åˆ¶å…è®¸ç™»å½•çš„ç”¨æˆ·</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AllowUsers your-user-name</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. æ›´æ”¹é»˜è®¤ç«¯å£</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Port 2222</span></span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡å¯SSHæœåŠ¡</span></span><br><span class="line">systemctl restart ssh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯é…ç½®</span></span><br><span class="line">egrep &#x27;^PermitRootLogin&#x27; /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><h2 id="Shellç¯å¢ƒä¼˜åŒ–"><a href="#Shellç¯å¢ƒä¼˜åŒ–" class="headerlink" title="Shellç¯å¢ƒä¼˜åŒ–"></a>Shellç¯å¢ƒä¼˜åŒ–</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®.bashrc</span></span><br><span class="line">cat &gt;&gt; ~/.bashrc &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®å‘½ä»¤åˆ«å</span></span><br><span class="line">alias ll=&#x27;ls -l&#x27;</span><br><span class="line">alias la=&#x27;ls -A&#x27;</span><br><span class="line">alias l=&#x27;ls -CF&#x27;</span><br><span class="line">alias vi=&#x27;vim&#x27;</span><br><span class="line">alias cls=&#x27;clear&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®å‘½ä»¤å†å²è®°å½•</span></span><br><span class="line">HISTSIZE=5000</span><br><span class="line">HISTFILESIZE=10000</span><br><span class="line">HISTTIMEFORMAT=&quot;%F %T &quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®PS1æç¤ºç¬¦</span></span><br><span class="line">PS1=&#x27;\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ &#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯ç”¨é¢œè‰²æ”¯æŒ</span></span><br><span class="line">export LS_OPTIONS=&#x27;--color=auto&#x27;</span><br><span class="line">eval &quot;$(dircolors)&quot;</span><br><span class="line">alias ls=&#x27;ls $LS_OPTIONS&#x27;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åº”ç”¨æ–°é…ç½®</span></span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure><h2 id="ç½‘ç»œé…ç½®ï¼ˆå¯é€‰ï¼‰"><a href="#ç½‘ç»œé…ç½®ï¼ˆå¯é€‰ï¼‰" class="headerlink" title="ç½‘ç»œé…ç½®ï¼ˆå¯é€‰ï¼‰"></a>ç½‘ç»œé…ç½®ï¼ˆå¯é€‰ï¼‰</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®é™æ€IP</span></span><br><span class="line">cat &gt; /etc/network/interfaces &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This file describes the network interfaces available on your system</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">and how to activate them. For more information, see interfaces(5).</span></span><br><span class="line"></span><br><span class="line">source /etc/network/interfaces.d/*</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The loopback network interface</span></span><br><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The primary network interface</span></span><br><span class="line">auto ens32</span><br><span class="line">iface ens32 inet static</span><br><span class="line">    address 192.168.171.136</span><br><span class="line">    netmask 255.255.255.0</span><br><span class="line">    gateway 192.168.171.2</span><br><span class="line">    # DNSé…ç½®</span><br><span class="line">    dns-nameservers 8.8.8.8 8.8.4.4</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="ç³»ç»Ÿä¼˜åŒ–"><a href="#ç³»ç»Ÿä¼˜åŒ–" class="headerlink" title="ç³»ç»Ÿä¼˜åŒ–"></a>ç³»ç»Ÿä¼˜åŒ–</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å…³é—­swap</span></span><br><span class="line">swapoff -a</span><br><span class="line">sed -i &#x27;/swap/d&#x27; /etc/fstab</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®ç³»ç»Ÿé™åˆ¶</span></span><br><span class="line">cat &gt; /etc/security/limits.conf &lt;&lt; EOF</span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 65535</span><br><span class="line">* soft nproc 65535</span><br><span class="line">* hard nproc 65535</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¼˜åŒ–å†…æ ¸å‚æ•°</span></span><br><span class="line">cat &gt; /etc/sysctl.d/99-sysctl.conf &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç³»ç»Ÿçº§åˆ«çš„æœ€å¤§æ–‡ä»¶å¥æŸ„æ•°</span></span><br><span class="line">fs.file-max = 2097152</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">TCPè¿æ¥å‚æ•°ä¼˜åŒ–</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8192</span><br><span class="line">net.core.somaxconn = 32768</span><br><span class="line">net.ipv4.tcp_timestamps = 1</span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å†…å­˜å‚æ•°ä¼˜åŒ–</span></span><br><span class="line">vm.swappiness = 0</span><br><span class="line">vm.overcommit_memory = 1</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åº”ç”¨å†…æ ¸å‚æ•°</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><h2 id="ç³»ç»ŸæœåŠ¡ä¼˜åŒ–"><a href="#ç³»ç»ŸæœåŠ¡ä¼˜åŒ–" class="headerlink" title="ç³»ç»ŸæœåŠ¡ä¼˜åŒ–"></a>ç³»ç»ŸæœåŠ¡ä¼˜åŒ–</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¦ç”¨ä¸éœ€è¦çš„æœåŠ¡</span></span><br><span class="line">systemctl stop rpcbind</span><br><span class="line">systemctl disable rpcbind</span><br><span class="line">apt autoremove rpcbind -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®é˜²ç«å¢™ï¼ˆUFWï¼‰</span></span><br><span class="line">ufw default deny incoming</span><br><span class="line">ufw default allow outgoing</span><br><span class="line">ufw allow ssh</span><br><span class="line">ufw allow 80/tcp</span><br><span class="line">ufw allow 443/tcp</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ ¹æ®éœ€è¦æ·»åŠ å…¶ä»–ç«¯å£</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯ç”¨é˜²ç«å¢™</span></span><br><span class="line">ufw --force enable</span><br></pre></td></tr></table></figure><h2 id="å®Œæˆåˆå§‹åŒ–"><a href="#å®Œæˆåˆå§‹åŒ–" class="headerlink" title="å®Œæˆåˆå§‹åŒ–"></a>å®Œæˆåˆå§‹åŒ–</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åŒæ­¥æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">sync</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡å¯ç³»ç»Ÿä½¿æ‰€æœ‰æ›´æ”¹ç”Ÿæ•ˆ</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><h2 id="è‡ªåŠ¨åŒ–éƒ¨ç½²"><a href="#è‡ªåŠ¨åŒ–éƒ¨ç½²" class="headerlink" title="è‡ªåŠ¨åŒ–éƒ¨ç½²"></a>è‡ªåŠ¨åŒ–éƒ¨ç½²</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºä¸€ä¸ªåˆå§‹åŒ–è„šæœ¬</span></span><br><span class="line">cat &gt; init-debian.sh &lt;&lt; &#x27;EOF&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Debianç³»ç»Ÿåˆå§‹åŒ–è„šæœ¬</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä½¿ç”¨æ–¹æ³•: ./init-debian.sh</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ·</span></span><br><span class="line">if [ &quot;$(id -u)&quot; != &quot;0&quot; ]; then</span><br><span class="line">   echo &quot;æ­¤è„šæœ¬å¿…é¡»ä»¥rootæƒé™è¿è¡Œ&quot; </span><br><span class="line">   exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿™é‡Œæ”¾å…¥ä¸Šè¿°æ‰€æœ‰é…ç½®æ­¥éª¤</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">...</span></span><br><span class="line"></span><br><span class="line">echo &quot;ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œè¯·é‡å¯æœåŠ¡å™¨&quot;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ æ‰§è¡Œæƒé™</span></span><br><span class="line">chmod +x init-debian.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿è¡Œè„šæœ¬</span></span><br><span class="line">./init-debian.sh</span><br></pre></td></tr></table></figure><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><ol><li>åœ¨æ‰§è¡Œåˆå§‹åŒ–æ“ä½œå‰ï¼Œå»ºè®®å…ˆå¤‡ä»½é‡è¦æ•°æ®</li><li>ä¿®æ”¹ç½‘ç»œé…ç½®æ—¶éœ€è¦ç‰¹åˆ«å°å¿ƒï¼Œé”™è¯¯çš„é…ç½®å¯èƒ½å¯¼è‡´æ— æ³•è¿œç¨‹è®¿é—®</li><li>é˜²ç«å¢™è§„åˆ™è¦æ ¹æ®å®é™…éœ€æ±‚é…ç½®</li><li>å»ºè®®ä¿å­˜ä¸€ä»½é…ç½®æ–‡ä»¶çš„å¤‡ä»½</li><li>åˆå§‹åŒ–å®Œæˆåè¦åŠæ—¶ä¿®æ”¹rootå¯†ç å’ŒSSHé…ç½®</li></ol><h2 id="æ•…éšœæ’é™¤"><a href="#æ•…éšœæ’é™¤" class="headerlink" title="æ•…éšœæ’é™¤"></a>æ•…éšœæ’é™¤</h2><p>å¦‚æœåœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li>æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ï¼š<code>journalctl -xe</code></li><li>æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š<code>systemctl status &lt;æœåŠ¡å&gt;</code></li><li>æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼š<code>ping -c 4 8.8.8.8</code></li><li>éªŒè¯è½¯ä»¶æºå¯ç”¨æ€§ï¼š<code>apt update</code></li></ol><hr><h1 id="é«˜å¯ç”¨è´Ÿè½½å‡è¡¡éƒ¨ç½²"><a href="#é«˜å¯ç”¨è´Ÿè½½å‡è¡¡éƒ¨ç½²" class="headerlink" title="é«˜å¯ç”¨è´Ÿè½½å‡è¡¡éƒ¨ç½²"></a>é«˜å¯ç”¨è´Ÿè½½å‡è¡¡éƒ¨ç½²</h1><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…åŸºç¡€å·¥å…·</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y \</span><br><span class="line">    psmisc \</span><br><span class="line">    curl \</span><br><span class="line">    wget \</span><br><span class="line">    net-tools \</span><br><span class="line">    ipvsadm \</span><br><span class="line">    ipset</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥ç½‘ç»œé…ç½®</span></span><br><span class="line">ip a</span><br></pre></td></tr></table></figure><h2 id="Keepalived-éƒ¨ç½²"><a href="#Keepalived-éƒ¨ç½²" class="headerlink" title="Keepalived éƒ¨ç½²"></a>Keepalived éƒ¨ç½²</h2><h3 id="å®‰è£…-Keepalived"><a href="#å®‰è£…-Keepalived" class="headerlink" title="å®‰è£… Keepalived"></a>å®‰è£… Keepalived</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨æ‰€æœ‰è´Ÿè½½å‡è¡¡èŠ‚ç‚¹ä¸Šå®‰è£…</span></span><br><span class="line">apt install -y keepalived</span><br></pre></td></tr></table></figure><h3 id="é…ç½®å¥åº·æ£€æŸ¥è„šæœ¬"><a href="#é…ç½®å¥åº·æ£€æŸ¥è„šæœ¬" class="headerlink" title="é…ç½®å¥åº·æ£€æŸ¥è„šæœ¬"></a>é…ç½®å¥åº·æ£€æŸ¥è„šæœ¬</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºå¥åº·æ£€æŸ¥è„šæœ¬</span></span><br><span class="line">cat &gt; /etc/keepalived/check_apiserver.sh &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">API_URL=&quot;https://192.168.171.133:6443/healthz&quot;</span><br><span class="line">TIMEOUT=3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥APIæœåŠ¡å™¨å¥åº·çŠ¶æ€</span></span><br><span class="line">if curl -k -s --connect-timeout $&#123;TIMEOUT&#125; $&#123;API_URL&#125; | grep -q &quot;ok&quot;; then</span><br><span class="line">    exit 0</span><br><span class="line">else</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ æ‰§è¡Œæƒé™</span></span><br><span class="line">chmod +x /etc/keepalived/check_apiserver.sh</span><br></pre></td></tr></table></figure><h3 id="ä¸»èŠ‚ç‚¹é…ç½®"><a href="#ä¸»èŠ‚ç‚¹é…ç½®" class="headerlink" title="ä¸»èŠ‚ç‚¹é…ç½®"></a>ä¸»èŠ‚ç‚¹é…ç½®</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®ä¸»èŠ‚ç‚¹çš„keepalived</span></span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">    script_user root</span><br><span class="line">    enable_script_security</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HAProxyè¿›ç¨‹æ£€æŸ¥</span></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script &quot;/usr/bin/killall -0 haproxy&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight 2</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">APIæœåŠ¡å™¨å¥åº·æ£€æŸ¥</span></span><br><span class="line">vrrp_script check_apiserver &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_apiserver.sh&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens192                # æ ¹æ®å®é™…ç½‘å¡åä¿®æ”¹</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 101</span><br><span class="line">    advert_int 1</span><br><span class="line">    </span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH    # å»ºè®®ä¿®æ”¹å¯†ç </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.171.133             # VIPåœ°å€</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    # ä½¿ç”¨å•æ’­æ¨¡å¼ï¼ˆæ¨èï¼‰</span><br><span class="line">    unicast_src_ip 192.168.171.134  # æœ¬æœºIPï¼ˆLB-1ï¼‰</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">        192.168.171.135             # å¯¹ç«¯IPï¼ˆLB-2ï¼‰</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    # é…ç½®è¿½è¸ªè„šæœ¬</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_apiserver</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="å¤‡èŠ‚ç‚¹é…ç½®"><a href="#å¤‡èŠ‚ç‚¹é…ç½®" class="headerlink" title="å¤‡èŠ‚ç‚¹é…ç½®"></a>å¤‡èŠ‚ç‚¹é…ç½®</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®å¤‡èŠ‚ç‚¹çš„keepalived</span></span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">    script_user root</span><br><span class="line">    enable_script_security</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script &quot;/usr/bin/killall -0 haproxy&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight 2</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_apiserver &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_apiserver.sh&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens192                # æ ¹æ®å®é™…ç½‘å¡åä¿®æ”¹</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    </span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH    # ä¸ä¸»èŠ‚ç‚¹ä¿æŒä¸€è‡´</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.171.133             # VIPåœ°å€</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    unicast_src_ip 192.168.171.135  # æœ¬æœºIPï¼ˆLB-2ï¼‰</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">        192.168.171.134             # å¯¹ç«¯IPï¼ˆLB-1ï¼‰</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_apiserver</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•</span></span><br><span class="line">keepalived -t -f /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯</span></span><br><span class="line">systemctl start keepalived</span><br><span class="line">systemctl enable keepalived</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥æœåŠ¡çŠ¶æ€</span></span><br><span class="line">systemctl status keepalived</span><br></pre></td></tr></table></figure><h2 id="HAProxy-éƒ¨ç½²"><a href="#HAProxy-éƒ¨ç½²" class="headerlink" title="HAProxy éƒ¨ç½²"></a>HAProxy éƒ¨ç½²</h2><h3 id="å®‰è£…-HAProxy"><a href="#å®‰è£…-HAProxy" class="headerlink" title="å®‰è£… HAProxy"></a>å®‰è£… HAProxy</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨æ‰€æœ‰è´Ÿè½½å‡è¡¡èŠ‚ç‚¹ä¸Šå®‰è£…</span></span><br><span class="line">apt install -y haproxy</span><br></pre></td></tr></table></figure><h3 id="é…ç½®-HAProxy"><a href="#é…ç½®-HAProxy" class="headerlink" title="é…ç½® HAProxy"></a>é…ç½® HAProxy</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¤‡ä»½åŸé…ç½®</span></span><br><span class="line">cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºæ–°é…ç½®</span></span><br><span class="line">cat &gt; /etc/haproxy/haproxy.cfg &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Global settings</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---------------------------------------------------------------------</span></span><br><span class="line">global</span><br><span class="line">    log /dev/log local0</span><br><span class="line">    log /dev/log local1 notice</span><br><span class="line">    daemon</span><br><span class="line">    maxconn 100000</span><br><span class="line">    user haproxy</span><br><span class="line">    group haproxy</span><br><span class="line">    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Default settings</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---------------------------------------------------------------------</span></span><br><span class="line">defaults</span><br><span class="line">    log     global</span><br><span class="line">    mode    tcp</span><br><span class="line">    option  dontlognull</span><br><span class="line">    timeout connect 5000ms</span><br><span class="line">    timeout client  50000ms</span><br><span class="line">    timeout server  50000ms</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Statistics settings</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---------------------------------------------------------------------</span></span><br><span class="line">listen stats</span><br><span class="line">    bind *:9090</span><br><span class="line">    mode http</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /stats</span><br><span class="line">    stats refresh 30s</span><br><span class="line">    stats auth admin:Admin@123.com    # è®¿é—®ç»Ÿè®¡é¡µé¢çš„ç”¨æˆ·åå’Œå¯†ç </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Frontend configuration <span class="keyword">for</span> API server</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---------------------------------------------------------------------</span></span><br><span class="line">frontend k8s-apiserver</span><br><span class="line">    bind *:6443</span><br><span class="line">    mode tcp</span><br><span class="line">    option tcplog</span><br><span class="line">    default_backend k8s-apiserver</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---------------------------------------------------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Backend configuration <span class="keyword">for</span> API server</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---------------------------------------------------------------------</span></span><br><span class="line">backend k8s-apiserver</span><br><span class="line">    mode tcp</span><br><span class="line">    option tcp-check</span><br><span class="line">    balance roundrobin</span><br><span class="line">    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line">    server master1 192.168.171.136:6443 check</span><br><span class="line">    server master2 192.168.171.137:6443 check</span><br><span class="line">    server master3 192.168.171.138:6443 check</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨æœåŠ¡-1"><a href="#å¯åŠ¨æœåŠ¡-1" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•</span></span><br><span class="line">haproxy -f /etc/haproxy/haproxy.cfg -c</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯</span></span><br><span class="line">systemctl start haproxy</span><br><span class="line">systemctl enable haproxy</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥æœåŠ¡çŠ¶æ€</span></span><br><span class="line">systemctl status haproxy</span><br></pre></td></tr></table></figure><h2 id="éªŒè¯éƒ¨ç½²"><a href="#éªŒè¯éƒ¨ç½²" class="headerlink" title="éªŒè¯éƒ¨ç½²"></a>éªŒè¯éƒ¨ç½²</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥VIPæ˜¯å¦ç”Ÿæ•ˆ</span></span><br><span class="line">ip a | grep 192.168.1.110</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥HAProxyç»Ÿè®¡é¡µé¢</span></span><br><span class="line">curl -u admin:Admin@123.com http://localhost:9090/stats</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æµ‹è¯•APIæœåŠ¡å™¨è®¿é—®</span></span><br><span class="line">curl -k https://192.168.171.133:6443/healthz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æµ‹è¯•æ•…éšœè½¬ç§»</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1. åœ¨ä¸»èŠ‚ç‚¹ä¸Šåœæ­¢HAProxy</span></span><br><span class="line">systemctl stop haproxy</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. è§‚å¯ŸVIPæ˜¯å¦æ¼‚ç§»åˆ°å¤‡èŠ‚ç‚¹</span></span><br><span class="line">ip a</span><br></pre></td></tr></table></figure><h2 id="æ•…éšœæ’é™¤-1"><a href="#æ•…éšœæ’é™¤-1" class="headerlink" title="æ•…éšœæ’é™¤"></a>æ•…éšœæ’é™¤</h2><ol><li>Keepalived æ•…éšœæ’æŸ¥ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥æ—¥å¿—</span></span><br><span class="line">journalctl -u keepalived -f</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥é…ç½®</span></span><br><span class="line">keepalived -t -f /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥ç½‘ç»œæ¥å£</span></span><br><span class="line">ip a</span><br></pre></td></tr></table></figure><ol start="2"><li>HAProxy æ•…éšœæ’æŸ¥ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥æ—¥å¿—</span></span><br><span class="line">journalctl -u haproxy -f</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥é…ç½®</span></span><br><span class="line">haproxy -f /etc/haproxy/haproxy.cfg -c</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥ç«¯å£ç›‘å¬</span></span><br><span class="line">netstat -ntlp | grep haproxy</span><br></pre></td></tr></table></figure><h2 id="æ³¨æ„äº‹é¡¹-1"><a href="#æ³¨æ„äº‹é¡¹-1" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><ol><li><p>ç½‘ç»œé…ç½®ï¼š</p><ul><li>ç¡®ä¿é˜²ç«å¢™å…è®¸VRRPåè®®ï¼ˆç«¯å£112ï¼‰</li><li>å…è®¸HAProxyç›‘å¬ç«¯å£ï¼ˆ6443, 9090ï¼‰</li><li>æ£€æŸ¥ç½‘å¡åç§°æ˜¯å¦æ­£ç¡®</li></ul></li><li><p>å®‰å…¨å»ºè®®ï¼š</p><ul><li>ä¿®æ”¹Keepalivedè®¤è¯å¯†ç </li><li>æ›´æ”¹HAProxyç»Ÿè®¡é¡µé¢çš„è®¿é—®å‡­æ®</li><li>é™åˆ¶HAProxyç»Ÿè®¡é¡µé¢çš„è®¿é—®IP</li></ul></li><li><p>ç»´æŠ¤å»ºè®®ï¼š</p><ul><li>å®šæœŸæ£€æŸ¥æœåŠ¡çŠ¶æ€</li><li>ç›‘æ§æ—¥å¿—ä¿¡æ¯</li><li>å®šæœŸæµ‹è¯•æ•…éšœè½¬ç§»åŠŸèƒ½</li></ul></li><li><p>æ€§èƒ½ä¼˜åŒ–ï¼š</p><ul><li>æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´HAProxyçš„è¿æ¥æ•°é™åˆ¶</li><li>é€‚å½“è°ƒæ•´è¶…æ—¶æ—¶é—´</li><li>ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ</li></ul></li></ol><hr><h1 id="ETCD-é›†ç¾¤éƒ¨ç½²"><a href="#ETCD-é›†ç¾¤éƒ¨ç½²" class="headerlink" title="ETCD é›†ç¾¤éƒ¨ç½²"></a>ETCD é›†ç¾¤éƒ¨ç½²</h1><h2 id="ç¯å¢ƒå‡†å¤‡-1"><a href="#ç¯å¢ƒå‡†å¤‡-1" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><h3 id="ä¸»æœºé…ç½®"><a href="#ä¸»æœºé…ç½®" class="headerlink" title="ä¸»æœºé…ç½®"></a>ä¸»æœºé…ç½®</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹ä¸»æœºå</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨ etcd1 ä¸Šæ‰§è¡Œ</span></span><br><span class="line">hostnamectl set-hostname etcd1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨ etcd2 ä¸Šæ‰§è¡Œ</span></span><br><span class="line">hostnamectl set-hostname etcd2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨ etcd3 ä¸Šæ‰§è¡Œ</span></span><br><span class="line">hostnamectl set-hostname etcd3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½® hosts è§£æ</span></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.171.136 etcd1</span><br><span class="line">192.168.171.137 etcd2</span><br><span class="line">192.168.171.138 etcd3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="é…ç½®å…å¯†ç™»å½•"><a href="#é…ç½®å…å¯†ç™»å½•" class="headerlink" title="é…ç½®å…å¯†ç™»å½•"></a>é…ç½®å…å¯†ç™»å½•</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨ etcd1 ä¸Šæ‰§è¡Œ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆå¯†é’¥å¯¹</span></span><br><span class="line">ssh-keygen -t rsa -b 2048 -N &quot;&quot; -f ~/.ssh/id_rsa</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ†å‘å…¬é’¥</span></span><br><span class="line">for host in etcd1 etcd2 etcd3; do</span><br><span class="line">    sshpass -p &#x27;your_password&#x27; ssh-copy-id -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa.pub &quot;root@$host&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="é…ç½®ç¯å¢ƒå˜é‡"><a href="#é…ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="é…ç½®ç¯å¢ƒå˜é‡"></a>é…ç½®ç¯å¢ƒå˜é‡</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span></span><br><span class="line">cat &gt;&gt; /etc/profile &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ETCD API ç‰ˆæœ¬</span></span><br><span class="line">export ETCDCTL_API=3</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><h2 id="ç»„ä»¶å®‰è£…"><a href="#ç»„ä»¶å®‰è£…" class="headerlink" title="ç»„ä»¶å®‰è£…"></a>ç»„ä»¶å®‰è£…</h2><h3 id="å®‰è£…-CFSSL-å·¥å…·"><a href="#å®‰è£…-CFSSL-å·¥å…·" class="headerlink" title="å®‰è£… CFSSL å·¥å…·"></a>å®‰è£… CFSSL å·¥å…·</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£… CFSSLï¼ˆä¸‹è½½åœ°å€ï¼šhttps://github.com/cloudflare/cfssl/releasesï¼‰</span></span><br><span class="line">cp cfssl_1.6.3_linux_amd64 /usr/local/bin/cfssl</span><br><span class="line">cp cfssljson_1.6.3_linux_amd64 /usr/local/bin/cfssljson</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ æ‰§è¡Œæƒé™</span></span><br><span class="line">chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯å®‰è£…</span></span><br><span class="line">cfssl version</span><br><span class="line">cfssljson -version</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…-ETCD"><a href="#å®‰è£…-ETCD" class="headerlink" title="å®‰è£… ETCD"></a>å®‰è£… ETCD</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line">export ETCD_VER=v3.5.9</span><br><span class="line">export DOWNLOAD_URL=&quot;https://github.com/etcd-io/etcd/releases/download&quot;</span><br><span class="line">export INSTALL_DIR=&quot;/usr/local/bin&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸‹è½½ ETCD äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">wget $&#123;DOWNLOAD_URL&#125;/$&#123;ETCD_VER&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯ä¸‹è½½æ–‡ä»¶å®Œæ•´æ€§</span></span><br><span class="line">wget $&#123;DOWNLOAD_URL&#125;/$&#123;ETCD_VER&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz.asc</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¦‚æœéœ€è¦éªŒè¯ç­¾å</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">gpg --verify etcd-<span class="variable">$&#123;ETCD_VER&#125;</span>-linux-amd64.tar.gz.asc</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è§£å‹å®‰è£…åŒ…</span></span><br><span class="line">tar -xzf etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz -C /tmp/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶åˆ°å®‰è£…ç›®å½•</span></span><br><span class="line">cp /tmp/etcd-$&#123;ETCD_VER&#125;-linux-amd64/etcd* $&#123;INSTALL_DIR&#125;/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¸…ç†ä¸´æ—¶æ–‡ä»¶</span></span><br><span class="line">rm -rf /tmp/etcd-$&#123;ETCD_VER&#125;-linux-amd64* etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz*</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºæ•°æ®ç›®å½•</span></span><br><span class="line">mkdir -p /data/etcd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯å®‰è£…</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;INSTALL_DIR&#125;/etcd --version</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;INSTALL_DIR&#125;/etcdctl version</span></span><br></pre></td></tr></table></figure><h2 id="é…ç½®-TLS-è¯ä¹¦"><a href="#é…ç½®-TLS-è¯ä¹¦" class="headerlink" title="é…ç½® TLS è¯ä¹¦"></a>é…ç½® TLS è¯ä¹¦</h2><h3 id="åˆ›å»ºè¯ä¹¦é…ç½®"><a href="#åˆ›å»ºè¯ä¹¦é…ç½®" class="headerlink" title="åˆ›å»ºè¯ä¹¦é…ç½®"></a>åˆ›å»ºè¯ä¹¦é…ç½®</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨ etcd1 ä¸Šæ‰§è¡Œ</span></span><br><span class="line">mkdir -p /etc/etcd/ssl</span><br><span class="line">cd /etc/etcd/ssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»º CA é…ç½®æ–‡ä»¶</span></span><br><span class="line">cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;signing&quot;: &#123;</span><br><span class="line">        &quot;default&quot;: &#123;</span><br><span class="line">            &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;profiles&quot;: &#123;</span><br><span class="line">            &quot;server&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;876000h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;client&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;876000h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;peer&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;876000h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»º CA è¯ä¹¦è¯·æ±‚æ–‡ä»¶</span></span><br><span class="line">cat &gt; etcd-ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 4096</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºå®¢æˆ·ç«¯è¯ä¹¦è¯·æ±‚æ–‡ä»¶</span></span><br><span class="line">cat &gt; client-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;client&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºæœåŠ¡ç«¯è¯ä¹¦è¯·æ±‚æ–‡ä»¶</span></span><br><span class="line">cat &gt; etcd-server-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd-server&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;192.168.171.136&quot;,</span><br><span class="line">        &quot;192.168.171.137&quot;,</span><br><span class="line">        &quot;192.168.171.138&quot;,</span><br><span class="line">        &quot;127.0.0.1&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;etcd-cluster&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºå¯¹ç­‰è¯ä¹¦è¯·æ±‚æ–‡ä»¶</span></span><br><span class="line">cat &gt; etcd-peer-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd-peer&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;192.168.171.136&quot;,</span><br><span class="line">        &quot;192.168.171.137&quot;,</span><br><span class="line">        &quot;192.168.171.138&quot;,</span><br><span class="line">        &quot;127.0.0.1&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;etcd-cluster&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Beijing&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="ç”Ÿæˆè¯ä¹¦"><a href="#ç”Ÿæˆè¯ä¹¦" class="headerlink" title="ç”Ÿæˆè¯ä¹¦"></a>ç”Ÿæˆè¯ä¹¦</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨ etcd1 ä¸Šæ‰§è¡Œ</span></span><br><span class="line">cd /etc/etcd/ssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆ CA è¯ä¹¦</span></span><br><span class="line">cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare etcd-ca</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦</span></span><br><span class="line">cfssl gencert \</span><br><span class="line">    -ca=etcd-ca.pem \</span><br><span class="line">    -ca-key=etcd-ca-key.pem \</span><br><span class="line">    -config=ca-config.json \</span><br><span class="line">    -profile=client client-csr.json | cfssljson -bare client</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”ŸæˆæœåŠ¡ç«¯è¯ä¹¦</span></span><br><span class="line">cfssl gencert \</span><br><span class="line">    -ca=etcd-ca.pem \</span><br><span class="line">    -ca-key=etcd-ca-key.pem \</span><br><span class="line">    -config=ca-config.json \</span><br><span class="line">    -profile=server etcd-server-csr.json | cfssljson -bare etcd-server</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆå¯¹ç­‰è¯ä¹¦</span></span><br><span class="line">cfssl gencert \</span><br><span class="line">    -ca=etcd-ca.pem \</span><br><span class="line">    -ca-key=etcd-ca-key.pem \</span><br><span class="line">    -config=ca-config.json \</span><br><span class="line">    -profile=peer etcd-peer-csr.json | cfssljson -bare etcd-peer</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ†å‘è¯ä¹¦åˆ°å…¶ä»–èŠ‚ç‚¹</span></span><br><span class="line">for host in etcd2 etcd3; do</span><br><span class="line">    ssh $host &quot;mkdir -p /etc/etcd/ssl&quot;</span><br><span class="line">    scp /etc/etcd/ssl/* $host:/etc/etcd/ssl/</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="é…ç½®-ETCD-æœåŠ¡"><a href="#é…ç½®-ETCD-æœåŠ¡" class="headerlink" title="é…ç½® ETCD æœåŠ¡"></a>é…ç½® ETCD æœåŠ¡</h2><h3 id="åˆ›å»ºæœåŠ¡é…ç½®æ–‡ä»¶"><a href="#åˆ›å»ºæœåŠ¡é…ç½®æ–‡ä»¶" class="headerlink" title="åˆ›å»ºæœåŠ¡é…ç½®æ–‡ä»¶"></a>åˆ›å»ºæœåŠ¡é…ç½®æ–‡ä»¶</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨ etcd1 ä¸Šæ‰§è¡Œ</span></span><br><span class="line">cat &gt; /lib/systemd/system/etcd.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Before=kube-apiserver.service</span><br><span class="line">Documentation=https://github.com/coreos</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/data/etcd/</span><br><span class="line">ExecStart=/usr/local/bin/etcd \\</span><br><span class="line">  --name=etcd1 \\</span><br><span class="line">  --cert-file=/etc/etcd/ssl/etcd-server.pem \\</span><br><span class="line">  --key-file=/etc/etcd/ssl/etcd-server-key.pem \\</span><br><span class="line">  --peer-cert-file=/etc/etcd/ssl/etcd-peer.pem \\</span><br><span class="line">  --peer-key-file=/etc/etcd/ssl/etcd-peer-key.pem \\</span><br><span class="line">  --trusted-ca-file=/etc/etcd/ssl/etcd-ca.pem \\</span><br><span class="line">  --peer-trusted-ca-file=/etc/etcd/ssl/etcd-ca.pem \\</span><br><span class="line">  --initial-advertise-peer-urls=https://192.168.171.136:2380 \\</span><br><span class="line">  --listen-peer-urls=https://192.168.171.136:2380 \\</span><br><span class="line">  --listen-client-urls=https://192.168.171.136:2379 \\</span><br><span class="line">  --advertise-client-urls=https://192.168.171.136:2379 \\</span><br><span class="line">  --initial-cluster-token=etcd-cluster-0 \\</span><br><span class="line">  --initial-cluster=etcd1=https://192.168.171.136:2380,etcd2=https://192.168.171.137:2380,etcd3=https://192.168.171.138:2380 \\</span><br><span class="line">  --initial-cluster-state=new \\</span><br><span class="line">  --data-dir=/data/etcd \\</span><br><span class="line">  --snapshot-count=50000 \\</span><br><span class="line">  --auto-compaction-retention=1 \\</span><br><span class="line">  --max-request-bytes=10485760 \\</span><br><span class="line">  --quota-backend-bytes=8589934592</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=15</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">OOMScoreAdjust=-999</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ†å‘åˆ°å…¶ä»–èŠ‚ç‚¹å¹¶ä¿®æ”¹é…ç½®</span></span><br><span class="line">for host in etcd2 etcd3; do</span><br><span class="line">    scp /lib/systemd/system/etcd.service $host:/lib/systemd/system/</span><br><span class="line">    ssh $host &quot;sed -i &#x27;s/etcd1/$host/g; s/192.168.171.136/192.168.171.$(expr 136 + $(echo $host | cut -c5))/g&#x27; /lib/systemd/system/etcd.service&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨æœåŠ¡-2"><a href="#å¯åŠ¨æœåŠ¡-2" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºæ•°æ®ç›®å½•</span></span><br><span class="line">mkdir -p /data/etcd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡è½½æœåŠ¡é…ç½®</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯</span></span><br><span class="line">systemctl enable --now etcd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹æœåŠ¡çŠ¶æ€</span></span><br><span class="line">systemctl status etcd</span><br></pre></td></tr></table></figure><h2 id="é›†ç¾¤éªŒè¯"><a href="#é›†ç¾¤éªŒè¯" class="headerlink" title="é›†ç¾¤éªŒè¯"></a>é›†ç¾¤éªŒè¯</h2><h3 id="é…ç½®å‘½ä»¤åˆ«å"><a href="#é…ç½®å‘½ä»¤åˆ«å" class="headerlink" title="é…ç½®å‘½ä»¤åˆ«å"></a>é…ç½®å‘½ä»¤åˆ«å</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span></span><br><span class="line">cat &gt;&gt; ~/.bashrc &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ETCD é›†ç¾¤æ“ä½œåˆ«å</span></span><br><span class="line">alias etcdctl=&#x27;etcdctl \\</span><br><span class="line">    --endpoints=192.168.171.136:2379,192.168.171.137:2379,192.168.171.138:2379 \\</span><br><span class="line">    --cacert=/etc/etcd/ssl/etcd-ca.pem \\</span><br><span class="line">    --cert=/etc/etcd/ssl/etcd-server.pem \\</span><br><span class="line">    --key=/etc/etcd/ssl/etcd-server-key.pem&#x27;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure><h3 id="æ£€æŸ¥é›†ç¾¤çŠ¶æ€"><a href="#æ£€æŸ¥é›†ç¾¤çŠ¶æ€" class="headerlink" title="æ£€æŸ¥é›†ç¾¤çŠ¶æ€"></a>æ£€æŸ¥é›†ç¾¤çŠ¶æ€</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹é›†ç¾¤æˆå‘˜</span></span><br><span class="line">etcdctl member list -w table</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶æ€</span></span><br><span class="line">etcdctl endpoint health -w table</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å†™å…¥æµ‹è¯•æ•°æ®</span></span><br><span class="line">etcdctl put test &quot;hello etcd&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¯»å–æµ‹è¯•æ•°æ®</span></span><br><span class="line">etcdctl get test</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ é™¤æµ‹è¯•æ•°æ®</span></span><br><span class="line">etcdctl del test</span><br></pre></td></tr></table></figure><h2 id="é›†ç¾¤å¤‡ä»½"><a href="#é›†ç¾¤å¤‡ä»½" class="headerlink" title="é›†ç¾¤å¤‡ä»½"></a>é›†ç¾¤å¤‡ä»½</h2><h3 id="é…ç½®è‡ªåŠ¨å¤‡ä»½"><a href="#é…ç½®è‡ªåŠ¨å¤‡ä»½" class="headerlink" title="é…ç½®è‡ªåŠ¨å¤‡ä»½"></a>é…ç½®è‡ªåŠ¨å¤‡ä»½</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºå¤‡ä»½ç›®å½•</span></span><br><span class="line">mkdir -p /data/etcd-backups</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºå¤‡ä»½è„šæœ¬</span></span><br><span class="line">cat &gt; /data/etcd-backups/etcd-backup.sh &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¤‡ä»½é…ç½®</span></span><br><span class="line">BACKUP_DIR=&quot;/data/etcd-backups&quot;</span><br><span class="line">DATE=\$(date +%Y%m%d%H%M%S)</span><br><span class="line">LOG_FILE=&quot;\$&#123;BACKUP_DIR&#125;/backup-\$&#123;DATE&#125;.log&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¤‡ä»½å‘½ä»¤</span></span><br><span class="line">/usr/local/bin/etcdctl \\</span><br><span class="line">    --endpoints=192.168.171.136:2379 \\</span><br><span class="line">    --cacert=/etc/etcd/ssl/etcd-ca.pem \\</span><br><span class="line">    --cert=/etc/etcd/ssl/etcd-server.pem \\</span><br><span class="line">    --key=/etc/etcd/ssl/etcd-server-key.pem \\</span><br><span class="line">    snapshot save \$&#123;BACKUP_DIR&#125;/backup-\$&#123;DATE&#125;.db &gt; \$&#123;LOG_FILE&#125; 2&gt;&amp;1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¸…ç†æ—§å¤‡ä»½</span></span><br><span class="line">find \$&#123;BACKUP_DIR&#125; -name &quot;backup-*.db&quot; -mtime +7 -delete</span><br><span class="line">find \$&#123;BACKUP_DIR&#125; -name &quot;backup-*.log&quot; -mtime +7 -delete</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ æ‰§è¡Œæƒé™</span></span><br><span class="line">chmod +x /data/etcd-backups/etcd-backup.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ å®šæ—¶ä»»åŠ¡</span></span><br><span class="line">echo &quot;0 2 * * * /data/etcd-backups/etcd-backup.sh&quot; &gt;&gt; /var/spool/cron/crontabs/root</span><br></pre></td></tr></table></figure><h2 id="æ•…éšœæ’é™¤-2"><a href="#æ•…éšœæ’é™¤-2" class="headerlink" title="æ•…éšœæ’é™¤"></a>æ•…éšœæ’é™¤</h2><h3 id="å¸¸è§é—®é¢˜æ’æŸ¥"><a href="#å¸¸è§é—®é¢˜æ’æŸ¥" class="headerlink" title="å¸¸è§é—®é¢˜æ’æŸ¥"></a>å¸¸è§é—®é¢˜æ’æŸ¥</h3><ol><li>è¯ä¹¦é—®é¢˜ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ</span></span><br><span class="line">openssl x509 -in /etc/etcd/ssl/etcd-server.pem -text -noout | grep -A2 Validity</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥è¯ä¹¦æƒé™</span></span><br><span class="line">ls -l /etc/etcd/ssl/</span><br></pre></td></tr></table></figure><ol start="2"><li>ç½‘ç»œé—®é¢˜ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥ç«¯å£ç›‘å¬</span></span><br><span class="line">netstat -ntlp | grep etcd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥ç«¯å£è¿é€šæ€§</span></span><br><span class="line">for port in 2379 2380; do</span><br><span class="line">    for host in 192.168.171.136 192.168.171.137 192.168.171.138; do</span><br><span class="line">        echo &quot;Testing $host:$port...&quot;</span><br><span class="line">        nc -zv $host $port</span><br><span class="line">    done</span><br><span class="line">done</span><br></pre></td></tr></table></figure><ol start="3"><li>æ—¥å¿—æ’æŸ¥ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹å®æ—¶æ—¥å¿—</span></span><br><span class="line">journalctl -u etcd -f</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹é”™è¯¯æ—¥å¿—</span></span><br><span class="line">journalctl -u etcd -p err</span><br></pre></td></tr></table></figure><h2 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h2><ol><li>ç³»ç»Ÿå‚æ•°ä¼˜åŒ–ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è°ƒæ•´ç³»ç»Ÿé™åˆ¶</span></span><br><span class="line">cat &gt;&gt; /etc/security/limits.conf &lt;&lt; EOF</span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è°ƒæ•´å†…æ ¸å‚æ•°</span></span><br><span class="line">cat &gt;&gt; /etc/sysctl.conf &lt;&lt; EOF</span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65000</span><br><span class="line">net.core.somaxconn = 32768</span><br><span class="line">net.core.netdev_max_backlog = 16384</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8096</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><ol start="2"><li>ETCD å‚æ•°ä¼˜åŒ–ï¼š</li></ol><ul><li>é€‚å½“è°ƒæ•´ <code>--snapshot-count</code></li><li>æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ <code>--quota-backend-bytes</code></li><li>é…ç½®åˆé€‚çš„ <code>--auto-compaction-retention</code></li></ul><h2 id="æ³¨æ„äº‹é¡¹-2"><a href="#æ³¨æ„äº‹é¡¹-2" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><ol><li><p>å®‰å…¨å»ºè®®ï¼š</p><ul><li>å®šæœŸæ›´æ–°è¯ä¹¦</li><li>é™åˆ¶è®¿é—®æƒé™</li><li>é…ç½®é˜²ç«å¢™è§„åˆ™</li></ul></li><li><p>ç»´æŠ¤å»ºè®®ï¼š</p><ul><li>å®šæœŸå¤‡ä»½æ•°æ®</li><li>ç›‘æ§é›†ç¾¤çŠ¶æ€</li><li>åŠæ—¶æ¸…ç†å†å²æ•°æ®</li></ul></li><li><p>æ€§èƒ½å»ºè®®ï¼š</p><ul><li>ä½¿ç”¨ SSD å­˜å‚¨</li><li>ç‹¬ç«‹çš„ç£ç›˜ç©ºé—´</li><li>è¶³å¤Ÿçš„å†…å­˜é…ç½®</li></ul></li><li><p>é«˜å¯ç”¨å»ºè®®ï¼š</p><ul><li>èŠ‚ç‚¹è·¨æœºæ¶éƒ¨ç½²</li><li>é…ç½®ç›‘æ§å‘Šè­¦</li><li>å®šæœŸè¿›è¡Œæ•…éšœæ¼”ç»ƒ</li></ul></li></ol><hr><h1 id="Harbor-ç§æœ‰é•œåƒä»“åº“éƒ¨ç½²"><a href="#Harbor-ç§æœ‰é•œåƒä»“åº“éƒ¨ç½²" class="headerlink" title="Harbor ç§æœ‰é•œåƒä»“åº“éƒ¨ç½²"></a>Harbor ç§æœ‰é•œåƒä»“åº“éƒ¨ç½²</h1><h2 id="ç¯å¢ƒå‡†å¤‡-2"><a href="#ç¯å¢ƒå‡†å¤‡-2" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><h3 id="DNS-é…ç½®"><a href="#DNS-é…ç½®" class="headerlink" title="DNS é…ç½®"></a>DNS é…ç½®</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®æœ¬åœ°è§£æ</span></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.171.50 harbor.k8s.com</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹ä¸»æœºå</span></span><br><span class="line">hostnamectl set-hostname harbor.k8s.com</span><br></pre></td></tr></table></figure><h3 id="å­˜å‚¨é…ç½®"><a href="#å­˜å‚¨é…ç½®" class="headerlink" title="å­˜å‚¨é…ç½®"></a>å­˜å‚¨é…ç½®</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£… LVM å·¥å…·</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y lvm2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºç‰©ç†å·</span></span><br><span class="line">pvcreate /dev/sdb1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºå·ç»„</span></span><br><span class="line">vgcreate data_vg /dev/sdb1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºé€»è¾‘å·</span></span><br><span class="line">lvcreate -l +100%FREE -n data_lv data_vg</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ ¼å¼åŒ–é€»è¾‘å·</span></span><br><span class="line">mkfs.ext4 /dev/data_vg/data_lv</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¸…ç†æ—§é…ç½®</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">sed -i <span class="string">&#x27;/\/data/d&#x27;</span> /etc/fstab</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®æŒ‚è½½</span></span><br><span class="line">echo &quot;/dev/data_vg/data_lv /data ext4 defaults 0 0&quot; &gt;&gt; /etc/fstab</span><br><span class="line">mkdir -p /data</span><br><span class="line">mount -a</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯æŒ‚è½½</span></span><br><span class="line">df -h /data</span><br></pre></td></tr></table></figure><h2 id="Docker-ç¯å¢ƒé…ç½®"><a href="#Docker-ç¯å¢ƒé…ç½®" class="headerlink" title="Docker ç¯å¢ƒé…ç½®"></a>Docker ç¯å¢ƒé…ç½®</h2><h3 id="å®‰è£…-Docker"><a href="#å®‰è£…-Docker" class="headerlink" title="å®‰è£… Docker"></a>å®‰è£… Docker</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£…ä¾èµ–åŒ…</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg \</span><br><span class="line">    lsb-release</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ  Docker å®˜æ–¹ GPG å¯†é’¥</span></span><br><span class="line">curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ  Docker è½¯ä»¶æº</span></span><br><span class="line">echo &quot;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable&quot; | tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£… Docker</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure><h3 id="é…ç½®-Docker"><a href="#é…ç½®-Docker" class="headerlink" title="é…ç½® Docker"></a>é…ç½® Docker</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»º Docker é…ç½®ç›®å½•</span></span><br><span class="line">mkdir -p /etc/docker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½® Docker daemon</span></span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt; &#x27;EOF&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://ustc-edu-cn.mirror.aliyuncs.com&quot;],</span><br><span class="line">  &quot;debug&quot;: false,</span><br><span class="line">  &quot;ip-forward&quot;: true,</span><br><span class="line">  &quot;ipv6&quot;: false,</span><br><span class="line">  &quot;live-restore&quot;: true,</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-level&quot;: &quot;warn&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;100m&quot;,</span><br><span class="line">    &quot;max-file&quot;: &quot;2&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;selinux-enabled&quot;: false,</span><br><span class="line">  &quot;experimental&quot;: true,</span><br><span class="line">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">  &quot;metrics-addr&quot;: &quot;0.0.0.0:9323&quot;,</span><br><span class="line">  &quot;data-root&quot;: &quot;/data/docker&quot;,</span><br><span class="line">  &quot;default-ulimits&quot;: &#123;</span><br><span class="line">    &quot;nofile&quot;: &#123;</span><br><span class="line">      &quot;Name&quot;: &quot;nofile&quot;,</span><br><span class="line">      &quot;Hard&quot;: 65536,</span><br><span class="line">      &quot;Soft&quot;: 65536</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡å¯ Docker æœåŠ¡</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…-Docker-Compose"><a href="#å®‰è£…-Docker-Compose" class="headerlink" title="å®‰è£… Docker Compose"></a>å®‰è£… Docker Compose</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸‹è½½ Docker Compose</span></span><br><span class="line">COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep &#x27;tag_name&#x27; | cut -d\&quot; -f4)</span><br><span class="line">curl -L &quot;https://github.com/docker/compose/releases/download/$&#123;COMPOSE_VERSION&#125;/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ æ‰§è¡Œæƒé™</span></span><br><span class="line">chmod +x /usr/local/bin/docker-compose</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯å®‰è£…</span></span><br><span class="line">docker-compose version</span><br></pre></td></tr></table></figure><h2 id="Harbor-éƒ¨ç½²"><a href="#Harbor-éƒ¨ç½²" class="headerlink" title="Harbor éƒ¨ç½²"></a>Harbor éƒ¨ç½²</h2><h3 id="ä¸‹è½½-Harbor"><a href="#ä¸‹è½½-Harbor" class="headerlink" title="ä¸‹è½½ Harbor"></a>ä¸‹è½½ Harbor</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½® Harbor ç‰ˆæœ¬</span></span><br><span class="line">export HARBOR_VERSION=&quot;v2.9.1&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸‹è½½ Harbor å®‰è£…åŒ…</span></span><br><span class="line">wget https://github.com/goharbor/harbor/releases/download/$&#123;HARBOR_VERSION&#125;/harbor-offline-installer-$&#123;HARBOR_VERSION&#125;.tgz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è§£å‹å®‰è£…åŒ…</span></span><br><span class="line">tar xzvf harbor-offline-installer-$&#123;HARBOR_VERSION&#125;.tgz -C /data</span><br></pre></td></tr></table></figure><h3 id="é…ç½®-Harbor"><a href="#é…ç½®-Harbor" class="headerlink" title="é…ç½® Harbor"></a>é…ç½® Harbor</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºé…ç½®æ–‡ä»¶</span></span><br><span class="line">cp /data/harbor/harbor.yml.tmpl /data/harbor/harbor.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹é…ç½®æ–‡ä»¶</span></span><br><span class="line">cat &gt; /data/harbor/harbor.yml &lt;&lt; EOF</span><br><span class="line">hostname: harbor.k8s.com</span><br><span class="line">https:</span><br><span class="line">  certificate: /data/harbor/ssl/harbor.k8s.com.crt</span><br><span class="line">  private_key: /data/harbor/ssl/harbor.k8s.com.key</span><br><span class="line">harbor_admin_password: Harbor@123.com</span><br><span class="line">data_volume: /data/harbor/harbor-data</span><br><span class="line">log:</span><br><span class="line">  location: /data/harbor/harbor-logs</span><br><span class="line">  level: info</span><br><span class="line">  local:</span><br><span class="line">    rotate_count: 50</span><br><span class="line">    rotate_size: 200M</span><br><span class="line">database:</span><br><span class="line">  password: root123</span><br><span class="line">  max_idle_conns: 100</span><br><span class="line">  max_open_conns: 900</span><br><span class="line">storage_service:</span><br><span class="line">  ca_bundle: /etc/ssl/certs/ca-certificates.crt</span><br><span class="line">  redirect:</span><br><span class="line">    disabled: false</span><br><span class="line">  cache:</span><br><span class="line">    enabled: true</span><br><span class="line">    expire_hours: 24</span><br><span class="line">trivy:</span><br><span class="line">  enabled: true</span><br><span class="line">  ignore_unfixed: false</span><br><span class="line">  skip_update: false</span><br><span class="line">  offline_scan: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="é…ç½®-TLS-è¯ä¹¦-1"><a href="#é…ç½®-TLS-è¯ä¹¦-1" class="headerlink" title="é…ç½® TLS è¯ä¹¦"></a>é…ç½® TLS è¯ä¹¦</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºè¯ä¹¦ç›®å½•</span></span><br><span class="line">mkdir -p /data/harbor/ssl</span><br><span class="line">cd /data/harbor/ssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆ CA ç§é’¥å’Œè¯ä¹¦</span></span><br><span class="line">openssl genrsa -out ca.key 4096</span><br><span class="line">openssl req -x509 -new -nodes -sha512 -days 3650 \</span><br><span class="line">    -subj &quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.k8s.com&quot; \</span><br><span class="line">    -key ca.key \</span><br><span class="line">    -out ca.crt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”ŸæˆæœåŠ¡å™¨ç§é’¥</span></span><br><span class="line">openssl genrsa -out harbor.k8s.com.key 4096</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚</span></span><br><span class="line">openssl req -sha512 -new \</span><br><span class="line">    -subj &quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.k8s.com&quot; \</span><br><span class="line">    -key harbor.k8s.com.key \</span><br><span class="line">    -out harbor.k8s.com.csr</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®è¯ä¹¦æ‰©å±•ä¿¡æ¯</span></span><br><span class="line">cat &gt; v3.ext &lt;&lt; EOF</span><br><span class="line">authorityKeyIdentifier=keyid,issuer</span><br><span class="line">basicConstraints=CA:FALSE</span><br><span class="line">keyUsage=digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span><br><span class="line">extendedKeyUsage=serverAuth</span><br><span class="line">subjectAltName=@alt_names</span><br><span class="line"></span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1=harbor.k8s.com</span><br><span class="line">DNS.2=harbor</span><br><span class="line">IP.1=192.168.171.50</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦</span></span><br><span class="line">openssl x509 -req -sha512 -days 3650 \</span><br><span class="line">    -extfile v3.ext \</span><br><span class="line">    -CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">    -in harbor.k8s.com.csr \</span><br><span class="line">    -out harbor.k8s.com.crt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦</span></span><br><span class="line">openssl x509 -inform PEM -in harbor.k8s.com.crt -out harbor.k8s.com.cert</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½® Docker è¯ä¹¦</span></span><br><span class="line">mkdir -p /etc/docker/certs.d/harbor.k8s.com/</span><br><span class="line">cp ca.crt /etc/docker/certs.d/harbor.k8s.com/</span><br><span class="line">cp harbor.k8s.com.cert /etc/docker/certs.d/harbor.k8s.com/</span><br><span class="line">cp harbor.k8s.com.key /etc/docker/certs.d/harbor.k8s.com/</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…-Harbor"><a href="#å®‰è£…-Harbor" class="headerlink" title="å®‰è£… Harbor"></a>å®‰è£… Harbor</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /data/harbor</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£… Harbor</span></span><br><span class="line">./prepare --with-trivy</span><br><span class="line">./install.sh --with-trivy</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯å®‰è£…</span></span><br><span class="line">docker ps</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æµ‹è¯•ç™»å½•</span></span><br><span class="line">docker login -u admin -p &#x27;Harbor@123.com&#x27; harbor.k8s.com</span><br></pre></td></tr></table></figure><h2 id="å®¢æˆ·ç«¯é…ç½®"><a href="#å®¢æˆ·ç«¯é…ç½®" class="headerlink" title="å®¢æˆ·ç«¯é…ç½®"></a>å®¢æˆ·ç«¯é…ç½®</h2><h3 id="é…ç½®-Docker-å®¢æˆ·ç«¯"><a href="#é…ç½®-Docker-å®¢æˆ·ç«¯" class="headerlink" title="é…ç½® Docker å®¢æˆ·ç«¯"></a>é…ç½® Docker å®¢æˆ·ç«¯</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¤åˆ¶è¯ä¹¦åˆ°å®¢æˆ·ç«¯</span></span><br><span class="line">mkdir -p /etc/docker/certs.d/harbor.k8s.com/</span><br><span class="line">scp harbor-server:/etc/docker/certs.d/harbor.k8s.com/* /etc/docker/certs.d/harbor.k8s.com/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡å¯ Docker æœåŠ¡</span></span><br><span class="line">systemctl restart docker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æµ‹è¯•ç™»å½•</span></span><br><span class="line">docker login harbor.k8s.com</span><br></pre></td></tr></table></figure><h2 id="ç»´æŠ¤ç®¡ç†"><a href="#ç»´æŠ¤ç®¡ç†" class="headerlink" title="ç»´æŠ¤ç®¡ç†"></a>ç»´æŠ¤ç®¡ç†</h2><h3 id="å¤‡ä»½é…ç½®"><a href="#å¤‡ä»½é…ç½®" class="headerlink" title="å¤‡ä»½é…ç½®"></a>å¤‡ä»½é…ç½®</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºå¤‡ä»½è„šæœ¬</span></span><br><span class="line">cat &gt; /data/harbor/backup.sh &lt;&lt; &#x27;EOF&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">BACKUP_DIR=&quot;/data/harbor/backups&quot;</span><br><span class="line">DATE=$(date +%Y%m%d_%H%M%S)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºå¤‡ä»½ç›®å½•</span></span><br><span class="line">mkdir -p $&#123;BACKUP_DIR&#125;/$&#123;DATE&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœæ­¢æœåŠ¡</span></span><br><span class="line">cd /data/harbor</span><br><span class="line">docker-compose down</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¤‡ä»½æ•°æ®</span></span><br><span class="line">tar czf $&#123;BACKUP_DIR&#125;/$&#123;DATE&#125;/harbor_data.tar.gz /data/harbor/harbor-data</span><br><span class="line">tar czf $&#123;BACKUP_DIR&#125;/$&#123;DATE&#125;/harbor_config.tar.gz /data/harbor/harbor.yml /data/harbor/ssl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯åŠ¨æœåŠ¡</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¸…ç†æ—§å¤‡ä»½</span></span><br><span class="line">find $&#123;BACKUP_DIR&#125; -type d -mtime +7 -exec rm -rf &#123;&#125; \;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®°å½•å¤‡ä»½æ—¥å¿—</span></span><br><span class="line">echo &quot;Backup completed at $(date &#x27;+%Y-%m-%d %H:%M:%S&#x27;)&quot; &gt;&gt; /data/harbor/harbor-logs/backup.log</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ æ‰§è¡Œæƒé™</span></span><br><span class="line">chmod +x /data/harbor/backup.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºæ—¥å¿—ç›®å½•</span></span><br><span class="line">mkdir -p /data/harbor/harbor-logs</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ åˆ° root ç”¨æˆ·çš„å®šæ—¶ä»»åŠ¡</span></span><br><span class="line">(crontab -l 2&gt;/dev/null; echo &quot;0 2 * * * /data/harbor/backup.sh &gt; /dev/null 2&gt;&amp;1&quot;) | crontab -</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯å®šæ—¶ä»»åŠ¡</span></span><br><span class="line">crontab -l</span><br></pre></td></tr></table></figure><h3 id="ç›‘æ§é…ç½®"><a href="#ç›‘æ§é…ç½®" class="headerlink" title="ç›‘æ§é…ç½®"></a>ç›‘æ§é…ç½®</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºç›‘æ§è„šæœ¬</span></span><br><span class="line">cat &gt; /data/harbor/monitor.sh &lt;&lt; &#x27;EOF&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥ Harbor æœåŠ¡çŠ¶æ€</span></span><br><span class="line">check_harbor() &#123;</span><br><span class="line">    local containers=$(docker ps --format &#x27;&#123;&#123;.Names&#125;&#125;&#x27; | grep &#x27;^harbor-&#x27;)</span><br><span class="line">    if [ $(echo &quot;$containers&quot; | wc -l) -lt 7 ]; then</span><br><span class="line">        echo &quot;Warning: Some Harbor containers are not running&quot;</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line">    return 0</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥å­˜å‚¨ç©ºé—´</span></span><br><span class="line">check_storage() &#123;</span><br><span class="line">    local usage=$(df -h /data | awk &#x27;NR==2 &#123;print $5&#125;&#x27; | sed &#x27;s/%//&#x27;)</span><br><span class="line">    if [ $usage -gt 80 ]; then</span><br><span class="line">        echo &quot;Warning: Storage usage is above 80%&quot;</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line">    return 0</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸»æ£€æŸ¥é€»è¾‘</span></span><br><span class="line">main() &#123;</span><br><span class="line">    check_harbor || echo &quot;Harbor service check failed&quot;</span><br><span class="line">    check_storage || echo &quot;Storage check failed&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod +x /data/harbor/monitor.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ åˆ° crontab</span></span><br><span class="line">echo &quot;*/5 * * * * /data/harbor/monitor.sh &gt;&gt; /data/harbor/harbor-logs/monitor.log 2&gt;&amp;1&quot; &gt;&gt; /var/spool/cron/crontabs/root</span><br></pre></td></tr></table></figure><h2 id="æ•…éšœæ’é™¤-3"><a href="#æ•…éšœæ’é™¤-3" class="headerlink" title="æ•…éšœæ’é™¤"></a>æ•…éšœæ’é™¤</h2><h3 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h3><ol><li>è¯ä¹¦é—®é¢˜ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ</span></span><br><span class="line">openssl x509 -in /data/harbor/ssl/harbor.k8s.com.crt -text -noout | grep -A2 Validity</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥è¯ä¹¦é…ç½®</span></span><br><span class="line">ls -l /etc/docker/certs.d/harbor.k8s.com/</span><br></pre></td></tr></table></figure><ol start="2"><li>å­˜å‚¨é—®é¢˜ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥å­˜å‚¨ç©ºé—´</span></span><br><span class="line">df -h /data</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥ Docker å­˜å‚¨</span></span><br><span class="line">docker system df</span><br></pre></td></tr></table></figure><ol start="3"><li>æœåŠ¡é—®é¢˜ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥æœåŠ¡çŠ¶æ€</span></span><br><span class="line">cd /data/harbor</span><br><span class="line">docker-compose ps</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹æœåŠ¡æ—¥å¿—</span></span><br><span class="line">docker-compose logs</span><br></pre></td></tr></table></figure><h2 id="æ€§èƒ½ä¼˜åŒ–-1"><a href="#æ€§èƒ½ä¼˜åŒ–-1" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h2><ol><li>ç³»ç»Ÿä¼˜åŒ–ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è°ƒæ•´ç³»ç»Ÿé™åˆ¶</span></span><br><span class="line">cat &gt;&gt; /etc/security/limits.conf &lt;&lt; EOF</span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 65535</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è°ƒæ•´å†…æ ¸å‚æ•°</span></span><br><span class="line">cat &gt;&gt; /etc/sysctl.conf &lt;&lt; EOF</span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65000</span><br><span class="line">net.core.somaxconn = 32768</span><br><span class="line">fs.file-max = 1000000</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><ol start="2"><li>Docker ä¼˜åŒ–ï¼š</li></ol><ul><li>é…ç½®åˆé€‚çš„æ—¥å¿—è½®è½¬ç­–ç•¥</li><li>ä½¿ç”¨é«˜æ€§èƒ½å­˜å‚¨</li><li>å®šæœŸæ¸…ç†æœªä½¿ç”¨çš„é•œåƒå’Œå®¹å™¨</li></ul><h2 id="æ³¨æ„äº‹é¡¹-3"><a href="#æ³¨æ„äº‹é¡¹-3" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><ol><li><p>å®‰å…¨å»ºè®®ï¼š</p><ul><li>åŠæ—¶æ›´æ–°ç³»ç»Ÿå’Œç»„ä»¶</li><li>å®šæœŸè½®æ¢å¯†ç å’Œè¯ä¹¦</li><li>é™åˆ¶è®¿é—®æƒé™</li><li>é…ç½®é˜²ç«å¢™è§„åˆ™</li></ul></li><li><p>ç»´æŠ¤å»ºè®®ï¼š</p><ul><li>å®šæœŸå¤‡ä»½æ•°æ®</li><li>ç›‘æ§ç³»ç»Ÿèµ„æº</li><li>åŠæ—¶æ¸…ç†åƒåœ¾æ•°æ®</li><li>ä¿æŒæ—¥å¿—åˆ†æ</li></ul></li><li><p>é«˜å¯ç”¨å»ºè®®ï¼š</p><ul><li>é…ç½®è´Ÿè½½å‡è¡¡</li><li>å®ç°æ•°æ®å¤‡ä»½</li><li>ç›‘æ§å‘Šè­¦é…ç½®</li><li>æ•…éšœæ¢å¤æ¼”ç»ƒ</li></ul></li></ol><hr><h1 id="Kubernetes-é›†ç¾¤ç¯å¢ƒéƒ¨ç½²"><a href="#Kubernetes-é›†ç¾¤ç¯å¢ƒéƒ¨ç½²" class="headerlink" title="Kubernetes é›†ç¾¤ç¯å¢ƒéƒ¨ç½²"></a>Kubernetes é›†ç¾¤ç¯å¢ƒéƒ¨ç½²</h1><h2 id="ç¯å¢ƒå‡†å¤‡-3"><a href="#ç¯å¢ƒå‡†å¤‡-3" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><h3 id="ä¸»æœºé…ç½®-1"><a href="#ä¸»æœºé…ç½®-1" class="headerlink" title="ä¸»æœºé…ç½®"></a>ä¸»æœºé…ç½®</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®ä¸»æœºå</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Master èŠ‚ç‚¹</span></span><br><span class="line">hostnamectl set-hostname master1.k8s.com</span><br><span class="line">hostnamectl set-hostname master2.k8s.com</span><br><span class="line">hostnamectl set-hostname master3.k8s.com</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Worker èŠ‚ç‚¹</span></span><br><span class="line">hostnamectl set-hostname worker1.k8s.com</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½® DNS è§£æ</span></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.171.136 etcd1</span><br><span class="line">192.168.171.50  harbor harbor.k8s.com</span><br><span class="line">192.168.171.136 master1 master1.k8s.com</span><br><span class="line">192.168.171.137 master2 master2.k8s.com</span><br><span class="line">192.168.171.138 master3 master3.k8s.com</span><br><span class="line">192.168.171.139 worker1 worker1.k8s.com</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®å…å¯†ç™»å½•</span></span><br><span class="line">ssh-keygen -t rsa -b 2048 -N &quot;&quot; -f ~/.ssh/id_rsa</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ†å‘å…¬é’¥</span></span><br><span class="line">for host in harbor etcd1 master&#123;1..3&#125; worker1; do</span><br><span class="line">    sshpass -p &#x27;your_password&#x27; ssh-copy-id -o StrictHostKeyChecking=no root@$&#123;host&#125;</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ†å‘hostsæ–‡ä»¶</span></span><br><span class="line">for host in master&#123;2..3&#125; worker1; do</span><br><span class="line">    scp /etc/hosts $&#123;host&#125;:/etc/</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="ç³»ç»Ÿé…ç½®"><a href="#ç³»ç»Ÿé…ç½®" class="headerlink" title="ç³»ç»Ÿé…ç½®"></a>ç³»ç»Ÿé…ç½®</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å…³é—­ swap</span></span><br><span class="line">swapoff -a</span><br><span class="line">sed -i &#x27;/swap/d&#x27; /etc/fstab</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åŠ è½½å†…æ ¸æ¨¡å—</span></span><br><span class="line">cat &gt; /etc/modules-load.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">overlay</span><br><span class="line">br_netfilter</span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åŠ è½½æ¨¡å—</span></span><br><span class="line">modprobe overlay</span><br><span class="line">modprobe br_netfilter</span><br><span class="line">modprobe ip_vs</span><br><span class="line">modprobe ip_vs_rr</span><br><span class="line">modprobe ip_vs_wrr</span><br><span class="line">modprobe ip_vs_sh</span><br><span class="line">modprobe nf_conntrack</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ›´æ–°å†…æ ¸è®¾ç½®</span></span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables  = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.ipv4.ip_forward                 = 1</span><br><span class="line">vm.swappiness                       = 0</span><br><span class="line">fs.file-max                         = 1000000</span><br><span class="line">net.ipv4.ip_local_port_range       = 1024 65000</span><br><span class="line">net.ipv4.tcp_tw_reuse              = 1</span><br><span class="line">net.ipv4.tcp_fin_timeout           = 30</span><br><span class="line">net.core.somaxconn                 = 32768</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure><h2 id="ç»„ä»¶å®‰è£…-1"><a href="#ç»„ä»¶å®‰è£…-1" class="headerlink" title="ç»„ä»¶å®‰è£…"></a>ç»„ä»¶å®‰è£…</h2><h3 id="å®¹å™¨è¿è¡Œæ—¶"><a href="#å®¹å™¨è¿è¡Œæ—¶" class="headerlink" title="å®¹å™¨è¿è¡Œæ—¶"></a>å®¹å™¨è¿è¡Œæ—¶</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£… containerd</span></span><br><span class="line">export CONTAINERD_VERSION=&quot;1.7.6&quot;</span><br><span class="line">wget https://github.com/containerd/containerd/releases/download/v$&#123;CONTAINERD_VERSION&#125;/containerd-$&#123;CONTAINERD_VERSION&#125;-linux-amd64.tar.gz</span><br><span class="line">tar Cxzvf /usr/local containerd-$&#123;CONTAINERD_VERSION&#125;-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½® containerd æœåŠ¡</span></span><br><span class="line">wget https://raw.githubusercontent.com/containerd/containerd/main/containerd.service -O /usr/local/lib/systemd/system/containerd.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆé»˜è®¤é…ç½®</span></span><br><span class="line">mkdir -p /etc/containerd</span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹é…ç½®</span></span><br><span class="line">sed -i &#x27;s|/var/lib/containerd|/data/containerd|g&#x27; /etc/containerd/config.toml</span><br><span class="line">sed -i &#x27;s|k8s.gcr.io/pause:3.6|registry.aliyuncs.com/google_containers/pause:3.9|g&#x27; /etc/containerd/config.toml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ é•œåƒä»“åº“é…ç½®</span></span><br><span class="line">cat &gt;&gt; /etc/containerd/config.toml &lt;&lt; EOF</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]</span><br><span class="line">        endpoint = [&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;http://hub-mirror.c.163.com&quot;]</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;gcr.io&quot;]</span><br><span class="line">        endpoint = [&quot;https://gcr.mirrors.ustc.edu.cn&quot;]</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;k8s.gcr.io&quot;]</span><br><span class="line">        endpoint = [&quot;https://gcr.mirrors.ustc.edu.cn/google-containers/&quot;]</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;quay.io&quot;]</span><br><span class="line">        endpoint = [&quot;https://quay.mirrors.ustc.edu.cn&quot;]</span><br><span class="line">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;harbor.k8s.com&quot;]</span><br><span class="line">        endpoint = [&quot;https://harbor.k8s.com&quot;]</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯åŠ¨æœåŠ¡</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable --now containerd</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…-CNI-æ’ä»¶"><a href="#å®‰è£…-CNI-æ’ä»¶" class="headerlink" title="å®‰è£… CNI æ’ä»¶"></a>å®‰è£… CNI æ’ä»¶</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸‹è½½å¹¶å®‰è£… CNI æ’ä»¶</span></span><br><span class="line">CNI_VERSION=&quot;v1.2.0&quot;</span><br><span class="line">wget https://github.com/containernetworking/plugins/releases/download/$&#123;CNI_VERSION&#125;/cni-plugins-linux-amd64-$&#123;CNI_VERSION&#125;.tgz</span><br><span class="line">mkdir -p /opt/cni/bin</span><br><span class="line">tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-$&#123;CNI_VERSION&#125;.tgz</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…-nerdctl"><a href="#å®‰è£…-nerdctl" class="headerlink" title="å®‰è£… nerdctl"></a>å®‰è£… nerdctl</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸‹è½½å¹¶å®‰è£… nerdctl</span></span><br><span class="line">NERDCTL_VERSION=&quot;1.6.2&quot;</span><br><span class="line">wget https://github.com/containerd/nerdctl/releases/download/v$&#123;NERDCTL_VERSION&#125;/nerdctl-full-$&#123;NERDCTL_VERSION&#125;-linux-amd64.tar.gz</span><br><span class="line">tar Cxzvf /usr/local nerdctl-full-$&#123;NERDCTL_VERSION&#125;-linux-amd64.tar.gz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®åˆ«å</span></span><br><span class="line">cat &gt;&gt; /etc/profile &lt;&lt; EOF</span><br><span class="line">alias docker=&#x27;nerdctl --namespace k8s.io&#x27;</span><br><span class="line">alias docker-compose=&#x27;nerdctl compose&#x27;</span><br><span class="line">alias crictl=&#x27;crictl --runtime-endpoint unix:///var/run/containerd/containerd.sock&#x27;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½® nerdctl</span></span><br><span class="line">mkdir -p /etc/nerdctl</span><br><span class="line">cat &gt; /etc/nerdctl/nerdctl.toml &lt;&lt; EOF</span><br><span class="line">namespace = &quot;k8s.io&quot;</span><br><span class="line">insecure_registry = true</span><br><span class="line">cni_path = &quot;/opt/cni/bin/&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…-Kubernetes-ç»„ä»¶"><a href="#å®‰è£…-Kubernetes-ç»„ä»¶" class="headerlink" title="å®‰è£… Kubernetes ç»„ä»¶"></a>å®‰è£… Kubernetes ç»„ä»¶</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ  Kubernetes è½¯ä»¶æº</span></span><br><span class="line">curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -</span><br><span class="line">cat &gt; /etc/apt/sources.list.d/kubernetes.list &lt;&lt; EOF</span><br><span class="line">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£…æŒ‡å®šç‰ˆæœ¬</span></span><br><span class="line">export KUBE_VERSION=&quot;1.27.8&quot;</span><br><span class="line">apt update</span><br><span class="line">apt install -y kubelet=$&#123;KUBE_VERSION&#125;-00 kubeadm=$&#123;KUBE_VERSION&#125;-00 kubectl=$&#123;KUBE_VERSION&#125;-00</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é”å®šç‰ˆæœ¬</span></span><br><span class="line">apt-mark hold kubelet kubeadm kubectl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯ç”¨è‡ªåŠ¨è¡¥å…¨</span></span><br><span class="line">apt install -y bash-completion</span><br><span class="line">echo &#x27;source &lt;(kubectl completion bash)&#x27; &gt;&gt; ~/.bashrc</span><br><span class="line">source ~/.bashrc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é¢„æ‹‰å–é•œåƒ</span></span><br><span class="line">kubeadm config images pull --kubernetes-version=v$&#123;KUBE_VERSION&#125; \</span><br><span class="line">    --image-repository=&#x27;registry.aliyuncs.com/google_containers&#x27;</span><br></pre></td></tr></table></figure><h2 id="è¯ä¹¦é…ç½®"><a href="#è¯ä¹¦é…ç½®" class="headerlink" title="è¯ä¹¦é…ç½®"></a>è¯ä¹¦é…ç½®</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºè¯ä¹¦ç›®å½•</span></span><br><span class="line">mkdir -p /etc/kubernetes/pki/etcd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¤åˆ¶ ETCD è¯ä¹¦</span></span><br><span class="line">scp etcd1:/etc/etcd/ssl/etcd-ca.pem /etc/kubernetes/pki/etcd/</span><br><span class="line">scp etcd1:/etc/etcd/ssl/client.pem /etc/kubernetes/pki/apiserver-etcd-client.pem</span><br><span class="line">scp etcd1:/etc/etcd/ssl/client-key.pem /etc/kubernetes/pki/apiserver-etcd-client-key.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¤åˆ¶ Harbor è¯ä¹¦</span></span><br><span class="line">mkdir -p /etc/tls/harbor/</span><br><span class="line">scp -r harbor:/etc/docker/certs.d/harbor.k8s.com /etc/tls/harbor/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ›´æ–°ç³»ç»Ÿè¯ä¹¦</span></span><br><span class="line">cp /etc/tls/harbor/harbor.k8s.com/ca.crt /usr/local/share/ca-certificates/</span><br><span class="line">cp /etc/tls/harbor/harbor.k8s.com/harbor.k8s.com.cert /usr/local/share/ca-certificates/</span><br><span class="line">update-ca-certificates</span><br></pre></td></tr></table></figure><h2 id="ç³»ç»Ÿä¼˜åŒ–-1"><a href="#ç³»ç»Ÿä¼˜åŒ–-1" class="headerlink" title="ç³»ç»Ÿä¼˜åŒ–"></a>ç³»ç»Ÿä¼˜åŒ–</h2><h3 id="æ€§èƒ½è°ƒä¼˜"><a href="#æ€§èƒ½è°ƒä¼˜" class="headerlink" title="æ€§èƒ½è°ƒä¼˜"></a>æ€§èƒ½è°ƒä¼˜</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è°ƒæ•´ç³»ç»Ÿé™åˆ¶</span></span><br><span class="line">cat &gt;&gt; /etc/security/limits.conf &lt;&lt; EOF</span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br><span class="line">* soft nproc 65536</span><br><span class="line">* hard nproc 65536</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è°ƒæ•´å†…æ ¸å‚æ•°</span></span><br><span class="line">cat &gt;&gt; /etc/sysctl.conf &lt;&lt; EOF</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 8192</span><br><span class="line">net.core.somaxconn = 32768</span><br><span class="line">net.ipv4.tcp_timestamps = 1</span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><h3 id="å®‰å…¨åŠ å›º"><a href="#å®‰å…¨åŠ å›º" class="headerlink" title="å®‰å…¨åŠ å›º"></a>å®‰å…¨åŠ å›º</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¦ç”¨ä¸å¿…è¦çš„æœåŠ¡</span></span><br><span class="line">systemctl stop apparmor</span><br><span class="line">systemctl disable apparmor</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®é˜²ç«å¢™è§„åˆ™</span></span><br><span class="line">ufw allow 6443/tcp  # Kubernetes API</span><br><span class="line">ufw allow 2379/tcp  # etcd client API</span><br><span class="line">ufw allow 2380/tcp  # etcd peer API</span><br><span class="line">ufw allow 10250/tcp # Kubelet API</span><br><span class="line">ufw allow 10251/tcp # kube-scheduler</span><br><span class="line">ufw allow 10252/tcp # kube-controller-manager</span><br></pre></td></tr></table></figure><h2 id="éªŒè¯éƒ¨ç½²-1"><a href="#éªŒè¯éƒ¨ç½²-1" class="headerlink" title="éªŒè¯éƒ¨ç½²"></a>éªŒè¯éƒ¨ç½²</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯æ¨¡å—åŠ è½½</span></span><br><span class="line">lsmod | grep -e br_netfilter -e overlay -e ip_vs</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯ç«¯å£</span></span><br><span class="line">netstat -ntlp | grep -e containerd -e kubelet</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯é•œåƒ</span></span><br><span class="line">crictl images</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯ Kubernetes ç»„ä»¶</span></span><br><span class="line">systemctl status kubelet</span><br><span class="line">kubectl version --client</span><br><span class="line">kubeadm version</span><br></pre></td></tr></table></figure><h2 id="æ³¨æ„äº‹é¡¹-4"><a href="#æ³¨æ„äº‹é¡¹-4" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><ol><li><p>ç½‘ç»œè¦æ±‚ï¼š</p><ul><li>èŠ‚ç‚¹é—´ç½‘ç»œäº’é€š</li><li>å¯è®¿é—®å¤–ç½‘ï¼ˆç”¨äºä¸‹è½½ç»„ä»¶ï¼‰</li><li>é˜²ç«å¢™å¼€æ”¾å¿…è¦ç«¯å£</li></ul></li><li><p>å®‰å…¨å»ºè®®ï¼š</p><ul><li>åŠæ—¶æ›´æ–°ç³»ç»Ÿå’Œç»„ä»¶</li><li>ä½¿ç”¨æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬</li><li>é…ç½®é€‚å½“çš„å®‰å…¨ç­–ç•¥</li></ul></li><li><p>ç»´æŠ¤å»ºè®®ï¼š</p><ul><li>å®šæœŸæ£€æŸ¥ç³»ç»Ÿèµ„æº</li><li>ç›‘æ§å…³é”®ç»„ä»¶çŠ¶æ€</li><li>ä¿æŒæ—¥å¿—åˆ†æå’Œå®¡è®¡</li></ul></li></ol><hr><h1 id="Kubernetes-é›†ç¾¤éƒ¨ç½²"><a href="#Kubernetes-é›†ç¾¤éƒ¨ç½²" class="headerlink" title="Kubernetes é›†ç¾¤éƒ¨ç½²"></a>Kubernetes é›†ç¾¤éƒ¨ç½²</h1><h2 id="åˆå§‹åŒ–é…ç½®"><a href="#åˆå§‹åŒ–é…ç½®" class="headerlink" title="åˆå§‹åŒ–é…ç½®"></a>åˆå§‹åŒ–é…ç½®</h2><h3 id="åˆ›å»ºé›†ç¾¤é…ç½®æ–‡ä»¶"><a href="#åˆ›å»ºé›†ç¾¤é…ç½®æ–‡ä»¶" class="headerlink" title="åˆ›å»ºé›†ç¾¤é…ç½®æ–‡ä»¶"></a>åˆ›å»ºé›†ç¾¤é…ç½®æ–‡ä»¶</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨ master1 èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆé»˜è®¤é…ç½®</span></span><br><span class="line">kubeadm config print init-defaults &gt; kubeadm-init.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹é…ç½®æ–‡ä»¶</span></span><br><span class="line">cat &gt; kubeadm-init.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 192.168.171.136</span><br><span class="line">  bindPort: 6443</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: unix:///var/run/containerd/containerd.sock</span><br><span class="line">  taints:</span><br><span class="line">    - effect: NoSchedule</span><br><span class="line">      key: node-role.kubernetes.io/control-plane</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta3</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns:</span><br><span class="line">  type: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  external:</span><br><span class="line">    endpoints:</span><br><span class="line">      - https://192.168.171.136:2379</span><br><span class="line">      - https://192.168.171.137:2379</span><br><span class="line">      - https://192.168.171.138:2379</span><br><span class="line">    caFile: /etc/kubernetes/pki/etcd/etcd-ca.pem</span><br><span class="line">    certFile: /etc/kubernetes/pki/apiserver-etcd-client.pem</span><br><span class="line">    keyFile: /etc/kubernetes/pki/apiserver-etcd-client-key.pem</span><br><span class="line">kubernetesVersion: 1.27.8</span><br><span class="line">imageRepository: registry.aliyuncs.com/google_containers</span><br><span class="line">networking:</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">  podSubnet: 10.244.0.0/16</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">mode: ipvs</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="é›†ç¾¤åˆå§‹åŒ–"><a href="#é›†ç¾¤åˆå§‹åŒ–" class="headerlink" title="é›†ç¾¤åˆå§‹åŒ–"></a>é›†ç¾¤åˆå§‹åŒ–</h2><h3 id="åˆå§‹åŒ–ä¸»èŠ‚ç‚¹"><a href="#åˆå§‹åŒ–ä¸»èŠ‚ç‚¹" class="headerlink" title="åˆå§‹åŒ–ä¸»èŠ‚ç‚¹"></a>åˆå§‹åŒ–ä¸»èŠ‚ç‚¹</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨ master1 èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆå§‹åŒ–é›†ç¾¤</span></span><br><span class="line">kubeadm init --config=kubeadm-init.yaml --upload-certs</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½® kubectl</span></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line">echo &quot;export KUBECONFIG=/etc/kubernetes/admin.conf&quot; &gt;&gt; /etc/profile</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ èŠ‚ç‚¹"><a href="#æ·»åŠ èŠ‚ç‚¹" class="headerlink" title="æ·»åŠ èŠ‚ç‚¹"></a>æ·»åŠ èŠ‚ç‚¹</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨å…¶ä»– master èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åŠ å…¥æ§åˆ¶å¹³é¢èŠ‚ç‚¹</span></span><br><span class="line">kubeadm join 192.168.171.136:6443 --token &lt;token&gt; \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:&lt;hash&gt; \</span><br><span class="line">    --control-plane --certificate-key &lt;key&gt; \</span><br><span class="line">    --cri-socket=unix:///var/run/containerd/containerd.sock</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨ worker èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åŠ å…¥å·¥ä½œèŠ‚ç‚¹</span></span><br><span class="line">kubeadm join 192.168.171.136:6443 --token &lt;token&gt; \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:&lt;hash&gt; \</span><br><span class="line">    --cri-socket=unix:///var/run/containerd/containerd.sock</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line">echo &quot;export KUBECONFIG=/etc/kubernetes/admin.conf&quot; &gt;&gt; /etc/profile</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><h3 id="èŠ‚ç‚¹æ ‡ç­¾ç®¡ç†"><a href="#èŠ‚ç‚¹æ ‡ç­¾ç®¡ç†" class="headerlink" title="èŠ‚ç‚¹æ ‡ç­¾ç®¡ç†"></a>èŠ‚ç‚¹æ ‡ç­¾ç®¡ç†</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ  worker æ ‡ç­¾</span></span><br><span class="line">kubectl label nodes worker1.k8s.com node-role.kubernetes.io/worker=</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ æ±¡ç‚¹</span></span><br><span class="line">kubectl taint nodes master1.k8s.com node-role.kubernetes.io/control-plane=:NoSchedule</span><br><span class="line">kubectl taint nodes master2.k8s.com node-role.kubernetes.io/control-plane=:NoSchedule</span><br><span class="line">kubectl taint nodes master3.k8s.com node-role.kubernetes.io/control-plane=:NoSchedule</span><br></pre></td></tr></table></figure><h2 id="ç½‘ç»œé…ç½®"><a href="#ç½‘ç»œé…ç½®" class="headerlink" title="ç½‘ç»œé…ç½®"></a>ç½‘ç»œé…ç½®</h2><h3 id="å®‰è£…-Calico"><a href="#å®‰è£…-Calico" class="headerlink" title="å®‰è£… Calico"></a>å®‰è£… Calico</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ  Helm ä»“åº“</span></span><br><span class="line">helm repo add projectcalico https://docs.tigera.io/calico/charts</span><br><span class="line">helm repo update</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºé…ç½®æ–‡ä»¶</span></span><br><span class="line">cat &gt; calico-values.yaml &lt;&lt; EOF</span><br><span class="line">installation:</span><br><span class="line">  cni:</span><br><span class="line">    type: Calico</span><br><span class="line">  ipPools:</span><br><span class="line">  - cidr: 10.244.0.0/16</span><br><span class="line">    encapsulation: IPIP</span><br><span class="line">    natOutgoing: true</span><br><span class="line">    nodeSelector: all()</span><br><span class="line">  registry: docker.io</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£… Calico</span></span><br><span class="line">helm install calico projectcalico/tigera-operator -f calico-values.yaml</span><br></pre></td></tr></table></figure><h3 id="CoreDNS-é…ç½®"><a href="#CoreDNS-é…ç½®" class="headerlink" title="CoreDNS é…ç½®"></a>CoreDNS é…ç½®</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½® CoreDNS</span></span><br><span class="line">kubectl -n kube-system get cm coredns -o yaml &gt; coredns-cm.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹é…ç½®</span></span><br><span class="line">cat &gt; coredns-cm.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        health &#123;</span><br><span class="line">           lameduck 5s</span><br><span class="line">        &#125;</span><br><span class="line">        hosts &#123;</span><br><span class="line">          192.168.171.50 harbor.k8s.com</span><br><span class="line">          fallthrough</span><br><span class="line">        &#125;</span><br><span class="line">        ready</span><br><span class="line">        kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span><br><span class="line">           pods insecure</span><br><span class="line">           fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">           ttl 30</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :9153</span><br><span class="line">        forward . /etc/resolv.conf &#123;</span><br><span class="line">           max_concurrent 1000</span><br><span class="line">        &#125;</span><br><span class="line">        cache 30</span><br><span class="line">        loop</span><br><span class="line">        reload</span><br><span class="line">        loadbalance</span><br><span class="line">    &#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åº”ç”¨é…ç½®</span></span><br><span class="line">kubectl apply -f coredns-cm.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡å¯ CoreDNS</span></span><br><span class="line">kubectl -n kube-system delete pod -l k8s-app=kube-dns</span><br></pre></td></tr></table></figure><h2 id="ç»„ä»¶é…ç½®"><a href="#ç»„ä»¶é…ç½®" class="headerlink" title="ç»„ä»¶é…ç½®"></a>ç»„ä»¶é…ç½®</h2><h3 id="æš´éœ²ç»„ä»¶ç«¯å£"><a href="#æš´éœ²ç»„ä»¶ç«¯å£" class="headerlink" title="æš´éœ²ç»„ä»¶ç«¯å£"></a>æš´éœ²ç»„ä»¶ç«¯å£</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨æ‰€æœ‰ master èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹ kube-scheduler é…ç½®</span></span><br><span class="line">sed -i &#x27;s/- --bind-address=127.0.0.1/- --bind-address=0.0.0.0/&#x27; /etc/kubernetes/manifests/kube-scheduler.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹ kube-controller-manager é…ç½®</span></span><br><span class="line">sed -i &#x27;s/- --bind-address=127.0.0.1/- --bind-address=0.0.0.0/&#x27; /etc/kubernetes/manifests/kube-controller-manager.yaml</span><br></pre></td></tr></table></figure><h2 id="é›†ç¾¤éªŒè¯-1"><a href="#é›†ç¾¤éªŒè¯-1" class="headerlink" title="é›†ç¾¤éªŒè¯"></a>é›†ç¾¤éªŒè¯</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯é›†ç¾¤çŠ¶æ€</span></span><br><span class="line">kubectl get nodes</span><br><span class="line">kubectl get pods -A</span><br><span class="line">kubectl cluster-info</span><br><span class="line">kubectl get componentstatuses</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯ç½‘ç»œ</span></span><br><span class="line">kubectl run test-nginx --image=nginx</span><br><span class="line">kubectl expose pod test-nginx --port=80 --type=NodePort</span><br><span class="line">curl http://&lt;node-ip&gt;:&lt;node-port&gt;</span><br></pre></td></tr></table></figure><h2 id="ç»´æŠ¤æ“ä½œ"><a href="#ç»´æŠ¤æ“ä½œ" class="headerlink" title="ç»´æŠ¤æ“ä½œ"></a>ç»´æŠ¤æ“ä½œ</h2><h3 id="è¯ä¹¦æ›´æ–°"><a href="#è¯ä¹¦æ›´æ–°" class="headerlink" title="è¯ä¹¦æ›´æ–°"></a>è¯ä¹¦æ›´æ–°</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹è¯ä¹¦è¿‡æœŸæ—¶é—´</span></span><br><span class="line">kubeadm certs check-expiration</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ›´æ–°è¯ä¹¦</span></span><br><span class="line">kubeadm certs renew all</span><br></pre></td></tr></table></figure><h3 id="é›†ç¾¤å‡çº§"><a href="#é›†ç¾¤å‡çº§" class="headerlink" title="é›†ç¾¤å‡çº§"></a>é›†ç¾¤å‡çº§</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å‡çº§ kubeadm</span></span><br><span class="line">apt-mark unhold kubeadm</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y kubeadm=&lt;version&gt;</span><br><span class="line">apt-mark hold kubeadm</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å‡çº§æ§åˆ¶å¹³é¢</span></span><br><span class="line">kubeadm upgrade plan</span><br><span class="line">kubeadm upgrade apply v&lt;version&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å‡çº§ kubelet å’Œ kubectl</span></span><br><span class="line">apt-mark unhold kubelet kubectl</span><br><span class="line">apt-get install -y kubelet=&lt;version&gt; kubectl=&lt;version&gt;</span><br><span class="line">apt-mark hold kubelet kubectl</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure><h2 id="æ•…éšœå¤„ç†"><a href="#æ•…éšœå¤„ç†" class="headerlink" title="æ•…éšœå¤„ç†"></a>æ•…éšœå¤„ç†</h2><h3 id="é‡ç½®èŠ‚ç‚¹"><a href="#é‡ç½®èŠ‚ç‚¹" class="headerlink" title="é‡ç½®èŠ‚ç‚¹"></a>é‡ç½®èŠ‚ç‚¹</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¸…ç†èŠ‚ç‚¹</span></span><br><span class="line">kubeadm reset</span><br><span class="line">iptables -F &amp;&amp; iptables -X</span><br><span class="line">iptables -t nat -F &amp;&amp; iptables -t nat -X</span><br><span class="line">iptables -t mangle -F &amp;&amp; iptables -t mangle -X</span><br><span class="line">ipvsadm --clear</span><br><span class="line">rm -rf /etc/kubernetes/ /var/lib/kubelet/ /var/lib/etcd/</span><br></pre></td></tr></table></figure><h3 id="å¸¸è§é—®é¢˜æ’æŸ¥-1"><a href="#å¸¸è§é—®é¢˜æ’æŸ¥-1" class="headerlink" title="å¸¸è§é—®é¢˜æ’æŸ¥"></a>å¸¸è§é—®é¢˜æ’æŸ¥</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹ç»„ä»¶æ—¥å¿—</span></span><br><span class="line">journalctl -xeu kubelet</span><br><span class="line">kubectl logs -n kube-system &lt;pod-name&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥ç½‘ç»œ</span></span><br><span class="line">kubectl exec -it &lt;pod-name&gt; -- ping &lt;service-name&gt;</span><br><span class="line">kubectl get endpoints &lt;service-name&gt;</span><br></pre></td></tr></table></figure><h2 id="æ³¨æ„äº‹é¡¹-5"><a href="#æ³¨æ„äº‹é¡¹-5" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><ol><li><p>é«˜å¯ç”¨é…ç½®ï¼š</p><ul><li>è‡³å°‘éƒ¨ç½²ä¸‰ä¸ª master èŠ‚ç‚¹</li><li>ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨</li><li>é…ç½®å¤–éƒ¨ etcd é›†ç¾¤</li></ul></li><li><p>å®‰å…¨å»ºè®®ï¼š</p><ul><li>åŠæ—¶æ›´æ–°ç»„ä»¶ç‰ˆæœ¬</li><li>é…ç½®ç½‘ç»œç­–ç•¥</li><li>ä½¿ç”¨ RBAC æ§åˆ¶è®¿é—®</li><li>å®šæœŸå¤‡ä»½ etcd æ•°æ®</li></ul></li><li><p>æ€§èƒ½ä¼˜åŒ–ï¼š</p><ul><li>åˆç†é…ç½®èµ„æºé™åˆ¶</li><li>ä¼˜åŒ–ç½‘ç»œé…ç½®</li><li>ç›‘æ§ç³»ç»Ÿæ€§èƒ½</li></ul></li><li><p>è¿ç»´å»ºè®®ï¼š</p><ul><li>å®æ–½ç›‘æ§å‘Šè­¦</li><li>å®šæœŸè¿›è¡Œå¤‡ä»½</li><li>åˆ¶å®šæ•…éšœæ¢å¤é¢„æ¡ˆ</li><li>ä¿æŒæ–‡æ¡£æ›´æ–°</li></ul></li></ol><hr><h1 id="NFS-StorageClass-éƒ¨ç½²"><a href="#NFS-StorageClass-éƒ¨ç½²" class="headerlink" title="NFS StorageClass éƒ¨ç½²"></a>NFS StorageClass éƒ¨ç½²</h1><h2 id="å­˜å‚¨æœåŠ¡å™¨é…ç½®"><a href="#å­˜å‚¨æœåŠ¡å™¨é…ç½®" class="headerlink" title="å­˜å‚¨æœåŠ¡å™¨é…ç½®"></a>å­˜å‚¨æœåŠ¡å™¨é…ç½®</h2><h3 id="å®‰è£…-NFS-æœåŠ¡"><a href="#å®‰è£…-NFS-æœåŠ¡" class="headerlink" title="å®‰è£… NFS æœåŠ¡"></a>å®‰è£… NFS æœåŠ¡</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£… NFS æœåŠ¡å™¨</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y nfs-kernel-server</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºå…±äº«ç›®å½•</span></span><br><span class="line">mkdir -p /data/ifs/kubernetes</span><br><span class="line">chown -R nobody:nogroup /data/ifs/kubernetes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®å…±äº«æƒé™</span></span><br><span class="line">cat &gt;&gt; /etc/exports &lt;&lt; EOF</span><br><span class="line">/data/ifs/kubernetes 192.168.171.0/24(no_root_squash,rw,sync,no_subtree_check)</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯åŠ¨æœåŠ¡</span></span><br><span class="line">systemctl enable --now nfs-kernel-server</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯é…ç½®</span></span><br><span class="line">exportfs -av</span><br></pre></td></tr></table></figure><h3 id="é…ç½®é˜²ç«å¢™"><a href="#é…ç½®é˜²ç«å¢™" class="headerlink" title="é…ç½®é˜²ç«å¢™"></a>é…ç½®é˜²ç«å¢™</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å…è®¸ NFS ç›¸å…³ç«¯å£</span></span><br><span class="line">ufw allow 2049/tcp  # NFS</span><br><span class="line">ufw allow 111/tcp   # portmapper</span><br><span class="line">ufw allow 111/udp</span><br><span class="line">ufw allow 32765:32768/tcp  # NFS åŠ¨æ€ç«¯å£</span><br><span class="line">ufw allow 32765:32768/udp</span><br></pre></td></tr></table></figure><h2 id="å®¢æˆ·ç«¯é…ç½®-1"><a href="#å®¢æˆ·ç«¯é…ç½®-1" class="headerlink" title="å®¢æˆ·ç«¯é…ç½®"></a>å®¢æˆ·ç«¯é…ç½®</h2><h3 id="å®‰è£…-NFS-å®¢æˆ·ç«¯"><a href="#å®‰è£…-NFS-å®¢æˆ·ç«¯" class="headerlink" title="å®‰è£… NFS å®¢æˆ·ç«¯"></a>å®‰è£… NFS å®¢æˆ·ç«¯</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨æ‰€æœ‰ Kubernetes èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install -y nfs-common</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½® NFS æœåŠ¡å™¨è§£æ</span></span><br><span class="line">echo &quot;192.168.171.140 nfs.k8s.com&quot; &gt;&gt; /etc/hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯ NFS æŒ‚è½½</span></span><br><span class="line">showmount -e nfs.k8s.com</span><br></pre></td></tr></table></figure><h2 id="StorageClass-éƒ¨ç½²"><a href="#StorageClass-éƒ¨ç½²" class="headerlink" title="StorageClass éƒ¨ç½²"></a>StorageClass éƒ¨ç½²</h2><h3 id="å®‰è£…-NFS-Provisioner"><a href="#å®‰è£…-NFS-Provisioner" class="headerlink" title="å®‰è£… NFS Provisioner"></a>å®‰è£… NFS Provisioner</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºå‘½åç©ºé—´</span></span><br><span class="line">kubectl create namespace nfs-provisioner</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»º ServiceAccount</span></span><br><span class="line">cat &gt; rbac.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">  namespace: nfs-provisioner</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [&quot;&quot;]</span><br><span class="line">    resources: [&quot;nodes&quot;]</span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">  - apiGroups: [&quot;&quot;]</span><br><span class="line">    resources: [&quot;persistentvolumes&quot;]</span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;]</span><br><span class="line">  - apiGroups: [&quot;&quot;]</span><br><span class="line">    resources: [&quot;persistentvolumeclaims&quot;]</span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;update&quot;]</span><br><span class="line">  - apiGroups: [&quot;storage.k8s.io&quot;]</span><br><span class="line">    resources: [&quot;storageclasses&quot;]</span><br><span class="line">    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">  - apiGroups: [&quot;&quot;]</span><br><span class="line">    resources: [&quot;events&quot;]</span><br><span class="line">    verbs: [&quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f rbac.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»º Deployment</span></span><br><span class="line">cat &gt; deployment.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">  namespace: nfs-provisioner</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nfs-client-provisioner</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nfs-client-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nfs-client-provisioner</span><br><span class="line">      containers:</span><br><span class="line">        - name: nfs-client-provisioner</span><br><span class="line">          image: registry.aliyuncs.com/google_containers/sig-storage/nfs-subdir-external-provisioner:v4.0.2</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: nfs-client-root</span><br><span class="line">              mountPath: /persistentvolumes</span><br><span class="line">          env:</span><br><span class="line">            - name: PROVISIONER_NAME</span><br><span class="line">              value: k8s-sigs.io/nfs-subdir-external-provisioner</span><br><span class="line">            - name: NFS_SERVER</span><br><span class="line">              value: nfs.k8s.com</span><br><span class="line">            - name: NFS_PATH</span><br><span class="line">              value: /data/ifs/kubernetes</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nfs-client-root</span><br><span class="line">          nfs:</span><br><span class="line">            server: nfs.k8s.com</span><br><span class="line">            path: /data/ifs/kubernetes</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f deployment.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»º StorageClass</span></span><br><span class="line">cat &gt; storageclass.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client</span><br><span class="line">  annotations:</span><br><span class="line">    storageclass.kubernetes.io/is-default-class: &quot;true&quot;</span><br><span class="line">provisioner: k8s-sigs.io/nfs-subdir-external-provisioner</span><br><span class="line">parameters:</span><br><span class="line">  archiveOnDelete: &quot;false&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f storageclass.yaml</span><br></pre></td></tr></table></figure><h3 id="éªŒè¯éƒ¨ç½²-2"><a href="#éªŒè¯éƒ¨ç½²-2" class="headerlink" title="éªŒè¯éƒ¨ç½²"></a>éªŒè¯éƒ¨ç½²</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºæµ‹è¯• PVC</span></span><br><span class="line">cat &gt; test-claim.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: test-claim</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 1Mi</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f test-claim.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºæµ‹è¯• Pod</span></span><br><span class="line">cat &gt; test-pod.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: test-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: test-pod</span><br><span class="line">      image: busybox</span><br><span class="line">      command:</span><br><span class="line">        - &quot;/bin/sh&quot;</span><br><span class="line">      args:</span><br><span class="line">        - &quot;-c&quot;</span><br><span class="line">        - &quot;touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1&quot;</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - name: nfs-pvc</span><br><span class="line">          mountPath: &quot;/mnt&quot;</span><br><span class="line">  restartPolicy: &quot;Never&quot;</span><br><span class="line">  volumes:</span><br><span class="line">    - name: nfs-pvc</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: test-claim</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl apply -f test-pod.yaml</span><br></pre></td></tr></table></figure><h2 id="ç›‘æ§é…ç½®-1"><a href="#ç›‘æ§é…ç½®-1" class="headerlink" title="ç›‘æ§é…ç½®"></a>ç›‘æ§é…ç½®</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºç›‘æ§è„šæœ¬</span></span><br><span class="line">cat &gt; /usr/local/bin/monitor-nfs.sh &lt;&lt; &#x27;EOF&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥ NFS æœåŠ¡çŠ¶æ€</span></span><br><span class="line">check_nfs_service() &#123;</span><br><span class="line">    if ! systemctl is-active --quiet nfs-kernel-server; then</span><br><span class="line">        echo &quot;NFS service is not running&quot;</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line">    return 0</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥å­˜å‚¨ç©ºé—´</span></span><br><span class="line">check_storage() &#123;</span><br><span class="line">    local usage=$(df -h /data/ifs/kubernetes | awk &#x27;NR==2 &#123;print $5&#125;&#x27; | sed &#x27;s/%//&#x27;)</span><br><span class="line">    if [ $usage -gt 80 ]; then</span><br><span class="line">        echo &quot;Storage usage is above 80%&quot;</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line">    return 0</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥ NFS æŒ‚è½½ç‚¹</span></span><br><span class="line">check_mounts() &#123;</span><br><span class="line">    if ! mountpoint -q /data/ifs/kubernetes; then</span><br><span class="line">        echo &quot;NFS directory is not mounted&quot;</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line">    return 0</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸»æ£€æŸ¥é€»è¾‘</span></span><br><span class="line">main() &#123;</span><br><span class="line">    check_nfs_service || echo &quot;NFS service check failed&quot;</span><br><span class="line">    check_storage || echo &quot;Storage check failed&quot;</span><br><span class="line">    check_mounts || echo &quot;Mount check failed&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod +x /usr/local/bin/monitor-nfs.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ åˆ° crontab</span></span><br><span class="line">(crontab -l 2&gt;/dev/null; echo &quot;*/5 * * * * /usr/local/bin/monitor-nfs.sh &gt;&gt; /var/log/nfs-monitor.log 2&gt;&amp;1&quot;) | crontab -</span><br></pre></td></tr></table></figure><h2 id="æ³¨æ„äº‹é¡¹-6"><a href="#æ³¨æ„äº‹é¡¹-6" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><ol><li><p>æ€§èƒ½ä¼˜åŒ–ï¼š</p><ul><li>ä½¿ç”¨ SSD å­˜å‚¨</li><li>è°ƒæ•´ NFS ç¼“å­˜å‚æ•°</li><li>é…ç½®åˆé€‚çš„ç½‘ç»œå¸¦å®½</li></ul></li><li><p>å®‰å…¨å»ºè®®ï¼š</p><ul><li>é™åˆ¶ NFS è®¿é—®IP</li><li>é…ç½®é˜²ç«å¢™è§„åˆ™</li><li>å®šæœŸæ›´æ–°ç³»ç»Ÿ</li></ul></li><li><p>ç»´æŠ¤å»ºè®®ï¼š</p><ul><li>å®šæœŸå¤‡ä»½æ•°æ®</li><li>ç›‘æ§å­˜å‚¨ä½¿ç”¨é‡</li><li>åŠæ—¶æ¸…ç†æ— ç”¨æ•°æ®</li></ul></li><li><p>é«˜å¯ç”¨å»ºè®®ï¼š</p><ul><li>é…ç½® NFS æœåŠ¡å™¨é›†ç¾¤</li><li>ä½¿ç”¨ç½‘ç»œå­˜å‚¨å¤‡ä»½</li><li>é…ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»</li></ul></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; æœ¬æ–‡è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨äºŒè¿›åˆ¶æ–¹å¼åœ¨ Debian ç³»ç»Ÿä¸Šæ­å»ºä¸€ä¸ªç”Ÿäº§çº§åˆ«çš„é«˜å¯ç”¨ Kubernetes é›†ç¾¤ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Kubernetes" scheme="https://freemankevin.uk/categories/Kubernetes/"/>
    
    
    <category term="Debian" scheme="https://freemankevin.uk/tags/Debian/"/>
    
    <category term="Harbor" scheme="https://freemankevin.uk/tags/Harbor/"/>
    
    <category term="Kubernetes" scheme="https://freemankevin.uk/tags/Kubernetes/"/>
    
    <category term="ETCD" scheme="https://freemankevin.uk/tags/ETCD/"/>
    
    <category term="NFS" scheme="https://freemankevin.uk/tags/NFS/"/>
    
  </entry>
  
  <entry>
    <title>Maven ç§æœ‰ä»“åº“ä½¿ç”¨è§„èŒƒ</title>
    <link href="https://freemankevin.uk/2025/02/07/maven-nexus/"/>
    <id>https://freemankevin.uk/2025/02/07/maven-nexus/</id>
    <published>2025-02-07T08:17:25.000Z</published>
    <updated>2025-10-21T03:34:40.416Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Mavenç§æœ‰ä»“åº“(Nexus)æ˜¯ä¼ä¸šè¿›è¡Œä¾èµ–ç®¡ç†çš„é‡è¦åŸºç¡€è®¾æ–½ã€‚ç„¶è€Œåœ¨å®é™…ä½¿ç”¨ä¸­,å›¢é˜Ÿå¸¸å¸¸å› é…ç½®æ··ä¹±å¯¼è‡´è·¨å›¢é˜Ÿåä½œå›°éš¾,ä¾èµ–é—®é¢˜é¢‘å‘ã€‚æ¯”å¦‚æœ¬åœ°æ„å»ºæˆ–æ‰“åŒ…æ—¶å‡ºç°å¼‚å¸¸,å…¬æœ‰äº‘ä»“åº“ä¸ç§æœ‰ä»“åº“æ··ç”¨å¯¼è‡´ç¼“å­˜å¤±æ•ˆ,è¿™äº›éƒ½å¢åŠ äº†ä¸å¿…è¦çš„æ²Ÿé€šä¸æ’æŸ¥æˆæœ¬ã€‚ä¸ºæ­¤,æˆ‘ä»¬éœ€è¦ç»Ÿä¸€è§„èŒƒé…ç½®,æ˜ç¡®ä¾èµ–ç®¡ç†æµç¨‹,åŒ…æ‹¬æ‹‰å–ä¾èµ–ã€ä¸Šä¼ ç§æœ‰åŒ…ç­‰æ ‡å‡†æ“ä½œæ–¹å¼ã€‚é€šè¿‡è§„èŒƒåŒ–ç®¡ç†,ä¸ä»…å¯ä»¥æ–¹ä¾¿é¡¹ç›®äº¤æ¥å’Œæ–°äººä¸Šæ‰‹,è¿˜èƒ½å……åˆ†å‘æŒ¥ç§æœ‰ä»“åº“çš„ç¼“å­˜åŠ é€Ÿä½œç”¨,æå‡å›¢é˜Ÿæ•´ä½“å¼€å‘æ•ˆç‡ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»Mavenç§æœ‰ä»“åº“çš„æœ€ä½³å®è·µ,å¸®åŠ©å›¢é˜Ÿå»ºç«‹èµ·é«˜æ•ˆçš„ä¾èµ–ç®¡ç†ä½“ç³»ã€‚</p><span id="more"></span><h2 id="ä¿®æ”¹Mavené…ç½®"><a href="#ä¿®æ”¹Mavené…ç½®" class="headerlink" title="ä¿®æ”¹Mavené…ç½®"></a>ä¿®æ”¹Mavené…ç½®</h2><h3 id="ä¿®æ”¹settingsé…ç½®"><a href="#ä¿®æ”¹settingsé…ç½®" class="headerlink" title="ä¿®æ”¹settingsé…ç½®"></a>ä¿®æ”¹settingsé…ç½®</h3><p>ç§æœ‰ä»“åº“Nexusä¿¡æ¯ç¤ºä¾‹:</p><ul><li>NexusæœåŠ¡åœ°å€: <code>http://nexus.your-company.com:8081/</code></li><li>å¼€å‘è€…è´¦å·: <code>developer/your-password</code></li><li>Mavenå…¬å…±ä»“åº“åœ°å€: <code>http://nexus.your-company.com:8081/repository/maven-public/</code></li><li>Mavenç§æœ‰åŒ…-ç¨³å®šç‰ˆæœ¬-ä¸Šä¼ åœ°å€: <code>http://nexus.your-company.com:8081/repository/maven-releases/</code></li><li>Mavenç§æœ‰åŒ…-å¼€å‘ç‰ˆæœ¬-ä¸Šä¼ åœ°å€: <code>http://nexus.your-company.com:8081/repository/maven-snapshots/</code></li></ul><p>éœ€è¦ä¿®æ”¹settings.xmlé…ç½®æ–‡ä»¶,ä½¿å…¶å®Œå…¨é€šè¿‡ä¼ä¸šå†…ç½‘Nexusè®¿é—®ä¾èµ–,è€Œä¸æ˜¯ç›´æ¥è®¿é—®å…¬ç½‘ä»“åº“ã€‚è¿™æ ·å¯ä»¥:</p><ol><li>é¦–æ¬¡ä½¿ç”¨æ—¶,Nexusä¼šä»å…¬ç½‘æ‹‰å–å¹¶ç¼“å­˜ä¾èµ–</li><li>åç»­ä½¿ç”¨æ—¶ç›´æ¥ä»Nexusè·å–ç¼“å­˜çš„ä¾èµ–,åŠ å¿«æ„å»ºé€Ÿåº¦</li><li>ç»Ÿä¸€ç®¡ç†å›¢é˜Ÿä½¿ç”¨çš„ä¾èµ–ç‰ˆæœ¬</li></ol><p>settings.xmlç¤ºä¾‹é…ç½®:</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://nexus.your-company.com:8081/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven-releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">username</span>&gt;</span>$&#123;NEXUS_USERNAME&#125;<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">password</span>&gt;</span>$&#123;NEXUS_PASSWORD&#125;<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">username</span>&gt;</span>$&#123;NEXUS_USERNAME&#125;<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">password</span>&gt;</span>$&#123;NEXUS_PASSWORD&#125;<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="å…¬ç½‘åŒ…æ”¯æŒ"><a href="#å…¬ç½‘åŒ…æ”¯æŒ" class="headerlink" title="å…¬ç½‘åŒ…æ”¯æŒ"></a>å…¬ç½‘åŒ…æ”¯æŒ</h4><p>å¦‚æœåœ¨ä½¿ç”¨å†…ç½‘Mavenå…¬å…±ä»“åº“æ—¶æ— æ³•æ‹‰å–æŸäº›å…¬ç½‘ä¾èµ–åŒ…:</p><ol><li>å¯ä»¥è”ç³»Nexusç®¡ç†å‘˜æ·»åŠ æ‰€éœ€çš„å…¬ç½‘ä»“åº“æº</li><li>é»˜è®¤åº”è¯¥å·²é…ç½®äº†ä¸»æµå…¬å…±ä»“åº“(å¦‚Mavenä¸­å¤®ä»“åº“ã€é˜¿é‡Œäº‘Mavenä»“åº“ç­‰)</li><li>å¦‚éœ€æ·»åŠ å…¶ä»–å†·é—¨ä»“åº“æº,è¯·æä¾›ä»“åº“åœ°å€ç»™ç®¡ç†å‘˜ç»Ÿä¸€é…ç½®</li></ol><h4 id="å†…ç½‘ç§æœ‰åŒ…æ”¯æŒ"><a href="#å†…ç½‘ç§æœ‰åŒ…æ”¯æŒ" class="headerlink" title="å†…ç½‘ç§æœ‰åŒ…æ”¯æŒ"></a>å†…ç½‘ç§æœ‰åŒ…æ”¯æŒ</h4><p>å¦‚æœæ— æ³•æ‹‰å–å†…ç½‘ç§æœ‰åŒ…:</p><ol><li>ä¼˜å…ˆè”ç³»åŒ…çš„å¼€å‘å›¢é˜Ÿ,ç¡®è®¤æ˜¯å¦å·²ä¸Šä¼ åˆ°ç§æœ‰ä»“åº“</li><li>å¦‚æœªä¸Šä¼ ,è¯·å¼€å‘å›¢é˜Ÿå…ˆå®Œæˆä¸Šä¼ </li></ol><p>ä¸Šä¼ ç§æœ‰åŒ…åˆ°releasesä»“åº“:</p><ol><li>é€šè¿‡Nexus Web UIä¸Šä¼ </li><li>é€‰æ‹© <code>hosted</code> ç±»å‹çš„ä»“åº“æ‰èƒ½ä¸Šä¼ æˆåŠŸ</li></ol><h4 id="æ‰¹é‡ä¸Šä¼ åŒ…åˆ°ç§åº“"><a href="#æ‰¹é‡ä¸Šä¼ åŒ…åˆ°ç§åº“" class="headerlink" title="æ‰¹é‡ä¸Šä¼ åŒ…åˆ°ç§åº“"></a>æ‰¹é‡ä¸Šä¼ åŒ…åˆ°ç§åº“</h4><p>å¯¹äºéœ€è¦æ‰¹é‡ä¸Šä¼ çš„åœºæ™¯:</p><ol><li>å¯ä»¥ä½¿ç”¨maven-deployæ’ä»¶ä¸Šä¼ :</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mvn deploy:deploy-file \</span><br><span class="line">    -Durl=http://nexus.your-company.com:8081/repository/maven-snapshots \</span><br><span class="line">    -DrepositoryId=snapshots \</span><br><span class="line">    -Dfile=your-artifact.jar \</span><br><span class="line">    -DgroupId=com.company \</span><br><span class="line">    -DartifactId=project \</span><br><span class="line">    -Dversion=1.0-SNAPSHOT \</span><br><span class="line">    -Dpackaging=jar</span><br></pre></td></tr></table></figure><ol start="2"><li>ä¹Ÿå¯ä»¥ä½¿ç”¨æ‰¹é‡ä¸Šä¼ å·¥å…·,å¦‚é˜¿é‡Œäº‘äº‘æ•ˆçš„ <code>migrate-local-repo-tool.jar</code></li></ol><h3 id="ä¿®æ”¹çˆ¶POMé…ç½®"><a href="#ä¿®æ”¹çˆ¶POMé…ç½®" class="headerlink" title="ä¿®æ”¹çˆ¶POMé…ç½®"></a>ä¿®æ”¹çˆ¶POMé…ç½®</h3><p>åœ¨é¡¹ç›®é¡¶çº§pom.xmlä¸­é…ç½®ä»“åº“ä¿¡æ¯:</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven-public<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>maven-public<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://nexus.your-company.com:8081/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven-releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>maven-releases<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://nexus.your-company.com:8081/repository/maven-releases/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>maven-snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://nexus.your-company.com:8081/repository/maven-snapshots/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Nexusä»“åº“è¯´æ˜"><a href="#Nexusä»“åº“è¯´æ˜" class="headerlink" title="Nexusä»“åº“è¯´æ˜"></a>Nexusä»“åº“è¯´æ˜</h3><p>Nexusä½œä¸ºä»“åº“ç®¡ç†å·¥å…·çš„ä¸»è¦åŠŸèƒ½:</p><pre><code class="highlight mermaid">graph LR    A[ç”¨æˆ·] --&gt; |mvn install / package| B[maven]    B --&gt; C[nexus]    C --&gt; |æŸ¥æ‰¾ä¾èµ–| D&#123;åˆ¤æ–­&#125;    D -- å­˜åœ¨ --&gt; E[ç›´æ¥è¿”å›ç»™ç”¨æˆ·]    D -- ä¸å­˜åœ¨ --&gt; F[æ‰¾å…¬ç½‘]    F --&gt; G[å…¬å…±ä»“åº“]    G --&gt; H[mavenä¸­å¤®ä»“åº“]    G -.-&gt; C    C -.-&gt; A</code></pre><h4 id="Mavenå…¬å…±ä»“åº“"><a href="#Mavenå…¬å…±ä»“åº“" class="headerlink" title="Mavenå…¬å…±ä»“åº“"></a>Mavenå…¬å…±ä»“åº“</h4><ul><li>ç”¨é€”:å­˜å‚¨å…¬å…±ä¾èµ–åŒ…</li><li>ç‰¹ç‚¹:è‡ªåŠ¨ä»å…¬ç½‘ä»“åº“åŒæ­¥å’Œç¼“å­˜</li><li>åº”ç”¨:ä¸»è¦ç”¨äºä¾èµ–è§£æå’Œä¸‹è½½</li></ul><h4 id="Maven-Releasesä»“åº“"><a href="#Maven-Releasesä»“åº“" class="headerlink" title="Maven Releasesä»“åº“"></a>Maven Releasesä»“åº“</h4><ul><li>ç”¨é€”:å­˜å‚¨ç¨³å®šç‰ˆæœ¬æ„ä»¶</li><li>ç‰¹ç‚¹:ä¸å¯å˜æ€§,ç‰ˆæœ¬å”¯ä¸€</li><li>åº”ç”¨:æ­£å¼å‘å¸ƒç‰ˆæœ¬ç®¡ç†</li></ul><h4 id="Maven-Snapshotsä»“åº“"><a href="#Maven-Snapshotsä»“åº“" class="headerlink" title="Maven Snapshotsä»“åº“"></a>Maven Snapshotsä»“åº“</h4><ul><li>ç”¨é€”:å­˜å‚¨å¼€å‘ç‰ˆæœ¬æ„ä»¶</li><li>ç‰¹ç‚¹:å¯è¦†ç›–æ›´æ–°,ç‰ˆæœ¬å·å¸¦-SNAPSHOTåç¼€</li><li>åº”ç”¨:å¼€å‘é˜¶æ®µä½¿ç”¨</li></ul><h4 id="ä½¿ç”¨å»ºè®®"><a href="#ä½¿ç”¨å»ºè®®" class="headerlink" title="ä½¿ç”¨å»ºè®®"></a>ä½¿ç”¨å»ºè®®</h4><ol><li>ä¸¥æ ¼éµå¾ªç‰ˆæœ¬å‘½åè§„èŒƒ</li><li>åˆç†é…ç½®æƒé™ç®¡ç†</li><li>æ­£ç¡®é…ç½®pom.xmlå’Œsettings.xml</li><li>ç¡®ä¿ç½‘ç»œç¯å¢ƒæ­£å¸¸è®¿é—®</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Mavenç§æœ‰ä»“åº“(Nexus)æ˜¯ä¼ä¸šè¿›è¡Œä¾èµ–ç®¡ç†çš„é‡è¦åŸºç¡€è®¾æ–½ã€‚ç„¶è€Œåœ¨å®é™…ä½¿ç”¨ä¸­,å›¢é˜Ÿå¸¸å¸¸å› é…ç½®æ··ä¹±å¯¼è‡´è·¨å›¢é˜Ÿåä½œå›°éš¾,ä¾èµ–é—®é¢˜é¢‘å‘ã€‚æ¯”å¦‚æœ¬åœ°æ„å»ºæˆ–æ‰“åŒ…æ—¶å‡ºç°å¼‚å¸¸,å…¬æœ‰äº‘ä»“åº“ä¸ç§æœ‰ä»“åº“æ··ç”¨å¯¼è‡´ç¼“å­˜å¤±æ•ˆ,è¿™äº›éƒ½å¢åŠ äº†ä¸å¿…è¦çš„æ²Ÿé€šä¸æ’æŸ¥æˆæœ¬ã€‚ä¸ºæ­¤,æˆ‘ä»¬éœ€è¦ç»Ÿä¸€è§„èŒƒé…ç½®,æ˜ç¡®ä¾èµ–ç®¡ç†æµç¨‹,åŒ…æ‹¬æ‹‰å–ä¾èµ–ã€ä¸Šä¼ ç§æœ‰åŒ…ç­‰æ ‡å‡†æ“ä½œæ–¹å¼ã€‚é€šè¿‡è§„èŒƒåŒ–ç®¡ç†,ä¸ä»…å¯ä»¥æ–¹ä¾¿é¡¹ç›®äº¤æ¥å’Œæ–°äººä¸Šæ‰‹,è¿˜èƒ½å……åˆ†å‘æŒ¥ç§æœ‰ä»“åº“çš„ç¼“å­˜åŠ é€Ÿä½œç”¨,æå‡å›¢é˜Ÿæ•´ä½“å¼€å‘æ•ˆç‡ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»Mavenç§æœ‰ä»“åº“çš„æœ€ä½³å®è·µ,å¸®åŠ©å›¢é˜Ÿå»ºç«‹èµ·é«˜æ•ˆçš„ä¾èµ–ç®¡ç†ä½“ç³»ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Development" scheme="https://freemankevin.uk/categories/Development/"/>
    
    
    <category term="Nexus" scheme="https://freemankevin.uk/tags/Nexus/"/>
    
    <category term="Maven" scheme="https://freemankevin.uk/tags/Maven/"/>
    
    <category term="Aliyun" scheme="https://freemankevin.uk/tags/Aliyun/"/>
    
  </entry>
  
  <entry>
    <title>GitLab é…ç½®ä¼˜åŒ–ä¸ CICD é›†æˆæŒ‡å—</title>
    <link href="https://freemankevin.uk/2025/01/21/gitlab-cicd/"/>
    <id>https://freemankevin.uk/2025/01/21/gitlab-cicd/</id>
    <published>2025-01-21T09:32:25.000Z</published>
    <updated>2025-10-21T03:34:40.410Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æœ¬æ–‡æ¡£æ—¨åœ¨æä¾› GitLab é…ç½®ä¼˜åŒ–ã€é›†æˆæœ€ä½³å®è·µã€å®‰å…¨åŠ å›ºã€å¤‡ä»½ä¸æ¢å¤ç­–ç•¥ä»¥åŠç›‘æ§æ–¹æ³•ï¼Œå¸®åŠ©å›¢é˜Ÿåœ¨ä½¿ç”¨ GitLab è¿›è¡Œæºä»£ç ç®¡ç†å’ŒæŒç»­é›†æˆ&#x2F;æŒç»­äº¤ä»˜ï¼ˆCICDï¼‰æ—¶æå‡æ€§èƒ½ã€å®‰å…¨æ€§åŠç¨³å®šæ€§ã€‚</p><span id="more"></span><h2 id="GitLab-æ·»åŠ å†…ç½‘ä¿¡ä»»"><a href="#GitLab-æ·»åŠ å†…ç½‘ä¿¡ä»»" class="headerlink" title="GitLab æ·»åŠ å†…ç½‘ä¿¡ä»»"></a>GitLab æ·»åŠ å†…ç½‘ä¿¡ä»»</h2><h3 id="ç›®çš„"><a href="#ç›®çš„" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h3><p>ä¸º GitLab é…ç½®å†…ç½‘ä¿¡ä»»ï¼Œå…è®¸ GitLab è®¿é—®å†…ç½‘æœåŠ¡ã€‚</p><h3 id="æ“ä½œæ­¥éª¤"><a href="#æ“ä½œæ­¥éª¤" class="headerlink" title="æ“ä½œæ­¥éª¤"></a>æ“ä½œæ­¥éª¤</h3><ol><li>è¿›å…¥ GitLab ç®¡ç†å‘˜ç•Œé¢ã€‚</li><li>è¿›å…¥è®¾ç½®é¡µé¢ï¼Œé€‰æ‹© <strong>ç½‘ç»œ</strong>ã€‚</li><li>è¿›å…¥ <strong>å‡ºç«™è¯·æ±‚</strong>ï¼Œå‹¾é€‰ä»¥ä¸‹é€‰é¡¹ï¼š<ul><li>å…è®¸æ¥è‡ª <strong>webhooks</strong> å’Œé›†æˆå¯¹æœ¬åœ°ç½‘ç»œçš„è¯·æ±‚</li><li>å…è®¸ç³»ç»Ÿé’©å­å‘æœ¬åœ°ç½‘ç»œå‘é€è¯·æ±‚</li></ul></li><li>åœ¨ç©ºç™½æ¡†ä¸­ç²˜è´´éœ€è¦è°ƒç”¨çš„å†…ç½‘IPã€åŸŸåã€‚</li><li>ç™»å½• GitLab æœåŠ¡å™¨ï¼Œç¼–è¾‘ <strong>&#x2F;etc&#x2F;hosts</strong> æ–‡ä»¶ï¼Œæ·»åŠ è‡ªå®šä¹‰åŸŸåæ˜ å°„ã€‚</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">192.168.x.x traefik.k8scluster.com</span><br><span class="line">192.168.x.x harbor.dockerregistry.com</span><br><span class="line">192.168.x.x argocd.k8scluster.com</span><br><span class="line">192.168.x.x grpc.argocd.k8scluster.com</span><br></pre></td></tr></table></figure><h2 id="GitLab-é›†æˆ-ArgoCD"><a href="#GitLab-é›†æˆ-ArgoCD" class="headerlink" title="GitLab é›†æˆ ArgoCD"></a>GitLab é›†æˆ ArgoCD</h2><h3 id="ç›®çš„-1"><a href="#ç›®çš„-1" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h3><p>é€šè¿‡ GitLab ä¸ ArgoCD é›†æˆï¼Œå®ç°æµæ°´çº¿ä¸­å¯¹ ArgoCD åº”ç”¨çš„è‡ªåŠ¨åŒ–æ“ä½œï¼ŒåŒæ—¶éšè— ArgoCD çœŸå®æœåŠ¡å™¨ä¿¡æ¯ã€‚</p><h3 id="æ“ä½œæ­¥éª¤-1"><a href="#æ“ä½œæ­¥éª¤-1" class="headerlink" title="æ“ä½œæ­¥éª¤"></a>æ“ä½œæ­¥éª¤</h3><ol><li>è¿›å…¥é¡¹ç›®ç»„é¡µé¢ï¼Œé€‰æ‹© <strong>è®¾ç½®</strong> -&gt; <strong>CI&#x2F;CD</strong> -&gt; <strong>å˜é‡</strong>ã€‚</li><li>æ·»åŠ ä»¥ä¸‹å˜é‡ï¼š<ul><li><strong>ARGOCD_USERNAME</strong>: è‡ªå®šä¹‰å€¼ï¼Œå‹¾é€‰ Masked</li><li><strong>ARGOCD_SERVER</strong>: è‡ªå®šä¹‰å€¼ï¼Œå‹¾é€‰ Masked</li><li><strong>ARGOCD_PASSWORD</strong>: è‡ªå®šä¹‰å€¼ï¼Œå‹¾é€‰ Masked</li></ul></li></ol><h2 id="GitLab-é›†æˆ-Minio"><a href="#GitLab-é›†æˆ-Minio" class="headerlink" title="GitLab é›†æˆ Minio"></a>GitLab é›†æˆ Minio</h2><h3 id="ç›®çš„-2"><a href="#ç›®çš„-2" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h3><p>å°†æ„å»ºçš„åˆ¶å“å­˜å‚¨åˆ° Minioï¼Œå‡è½» GitLab æœåŠ¡å™¨çš„è´Ÿæ‹…ã€‚</p><h3 id="æ“ä½œæ­¥éª¤-2"><a href="#æ“ä½œæ­¥éª¤-2" class="headerlink" title="æ“ä½œæ­¥éª¤"></a>æ“ä½œæ­¥éª¤</h3><ol><li><p>ä¿®æ”¹ GitLab é…ç½®æ–‡ä»¶ï¼š</p> <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/gitlab/gitlab.rb</span><br><span class="line">gitlab_rails[&#x27;artifacts_enabled&#x27;] = true</span><br><span class="line">gitlab_rails[&#x27;artifacts_object_store_enabled&#x27;] = true</span><br><span class="line">gitlab_rails[&#x27;artifacts_object_store_remote_directory&#x27;] = &#x27;gitlab-artifacts&#x27;</span><br><span class="line">gitlab_rails[&#x27;artifacts_object_store_connection&#x27;] = &#123;</span><br><span class="line">&#x27;provider&#x27; =&gt; &#x27;AWS&#x27;,</span><br><span class="line">&#x27;region&#x27; =&gt; &#x27;us-east-1&#x27;,</span><br><span class="line">&#x27;aws_access_key_id&#x27; =&gt; &#x27;your_access_key&#x27;,</span><br><span class="line">&#x27;aws_secret_access_key&#x27; =&gt; &#x27;your_secret_key&#x27;,</span><br><span class="line">&#x27;endpoint&#x27; =&gt; &#x27;http://&lt;minio_server&gt;:9000&#x27;,</span><br><span class="line">&#x27;path_style&#x27; =&gt; true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é‡è½½é…ç½®ï¼š</p></li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure><h2 id="GitLab-é›†æˆ-Harbor"><a href="#GitLab-é›†æˆ-Harbor" class="headerlink" title="GitLab é›†æˆ Harbor"></a>GitLab é›†æˆ Harbor</h2><h3 id="ç›®çš„-3"><a href="#ç›®çš„-3" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h3><p>å°†æ„å»ºçš„ Docker é•œåƒç›´æ¥æ¨é€åˆ° Harborï¼Œæ— éœ€é‡å¤é…ç½®ã€‚</p><h3 id="æ“ä½œæ­¥éª¤-3"><a href="#æ“ä½œæ­¥éª¤-3" class="headerlink" title="æ“ä½œæ­¥éª¤"></a>æ“ä½œæ­¥éª¤</h3><ol><li>è¿›å…¥ <strong>ç®¡ç†ç•Œé¢</strong> æˆ– <strong>é¡¹ç›®ç»„ç®¡ç†ç•Œé¢</strong>ï¼Œé€‰æ‹© <strong>è®¾ç½®</strong> -&gt; <strong>é›†æˆ</strong>ã€‚</li><li>æ·»åŠ  Harbor é›†æˆï¼Œè¾“å…¥ä»¥ä¸‹ä¿¡æ¯ï¼š<ul><li><strong>åŸŸå</strong>ï¼šHarbor åœ°å€</li><li><strong>é¡¹ç›®åç§°</strong>ï¼šç›®æ ‡é¡¹ç›®</li><li><strong>ç”¨æˆ·</strong>ï¼šä½¿ç”¨æœºå™¨äººåç§°</li><li><strong>ç”¨æˆ·å¯†ç </strong>ï¼šHarbor è®¤è¯å¯†ç </li></ul></li></ol><h2 id="GitLab-æ–‡ä»¶å¤§å°é™åˆ¶è°ƒæ•´"><a href="#GitLab-æ–‡ä»¶å¤§å°é™åˆ¶è°ƒæ•´" class="headerlink" title="GitLab æ–‡ä»¶å¤§å°é™åˆ¶è°ƒæ•´"></a>GitLab æ–‡ä»¶å¤§å°é™åˆ¶è°ƒæ•´</h2><h3 id="ç›®çš„-4"><a href="#ç›®çš„-4" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h3><p>è°ƒæ•´ GitLab ä¸Šä¼ æ–‡ä»¶çš„å¤§å°é™åˆ¶ï¼Œä»¥é€‚åº”å¤§æ–‡ä»¶çš„ä¸Šä¼ éœ€æ±‚ã€‚</p><h3 id="æ“ä½œæ­¥éª¤-4"><a href="#æ“ä½œæ­¥éª¤-4" class="headerlink" title="æ“ä½œæ­¥éª¤"></a>æ“ä½œæ­¥éª¤</h3><ol><li><p>è¿›å…¥ <strong>ç®¡ç†å‘˜ç•Œé¢</strong> æˆ– <strong>é¡¹ç›®ç»„é¡µé¢</strong>ï¼Œé€‰æ‹© <strong>è®¾ç½®</strong> -&gt; <strong>CI&#x2F;CD</strong> -&gt; <strong>æµæ°´çº¿é€šç”¨è®¾ç½®</strong>ï¼Œè°ƒæ•´ <strong>æœ€å¤§å·¥ä»¶å¤§å°</strong>ã€‚</p></li><li><p>å¦‚æœä»¥ä¸Šè®¾ç½®æ— æ•ˆï¼Œä¿®æ”¹ GitLab æœåŠ¡å™¨é…ç½®æ–‡ä»¶ï¼š</p> <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/gitlab/gitlab.rb</span><br><span class="line">nginx[&#x27;client_max_body_size&#x27;] = &#x27;200m&#x27;</span><br></pre></td></tr></table></figure></li><li><p>é‡è½½é…ç½®ï¼š</p></li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure><h2 id="GitLab-é›†æˆ-CICD"><a href="#GitLab-é›†æˆ-CICD" class="headerlink" title="GitLab é›†æˆ CICD"></a>GitLab é›†æˆ CICD</h2><h3 id="ç›®çš„-5"><a href="#ç›®çš„-5" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h3><p>é…ç½® GitLab CI&#x2F;CDï¼Œä½¿æœºå™¨äººèƒ½å¤Ÿè‡ªåŠ¨åŒ–æ›´æ–°ä»£ç ã€‚</p><h3 id="æ“ä½œæ­¥éª¤-5"><a href="#æ“ä½œæ­¥éª¤-5" class="headerlink" title="æ“ä½œæ­¥éª¤"></a>æ“ä½œæ­¥éª¤</h3><ol><li>è¿›å…¥é¡¹ç›®é¡µé¢ï¼Œé€‰æ‹© <strong>è®¾ç½®</strong> -&gt; <strong>è®¿é—®ä»¤ç‰Œ</strong>ï¼Œåˆ›å»ºä¸€ä¸ªé•¿æœŸæœ‰æ•ˆçš„å¼€å‘è€…èº«ä»½ä»¤ç‰Œã€‚</li><li>è¿›å…¥ <strong>CI&#x2F;CD</strong> -&gt; <strong>å˜é‡</strong>ï¼Œæ·»åŠ ä»¥ä¸‹å˜é‡ï¼š<ul><li><strong>GITLAB_CI_TOKEN</strong>: è‡ªå®šä¹‰å€¼ï¼Œå‹¾é€‰ Masked</li></ul></li></ol><h2 id="GitLab-æ€§èƒ½ä¼˜åŒ–"><a href="#GitLab-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="GitLab æ€§èƒ½ä¼˜åŒ–"></a>GitLab æ€§èƒ½ä¼˜åŒ–</h2><h3 id="ç›®çš„-6"><a href="#ç›®çš„-6" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h3><p>ä¼˜åŒ– GitLab æ€§èƒ½ï¼Œæé«˜å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œå‡å°‘å“åº”æ—¶é—´ã€‚</p><h3 id="æ“ä½œæ­¥éª¤-6"><a href="#æ“ä½œæ­¥éª¤-6" class="headerlink" title="æ“ä½œæ­¥éª¤"></a>æ“ä½œæ­¥éª¤</h3><ol><li><strong>ä¼˜åŒ–æ•°æ®åº“</strong>ï¼šè°ƒæ•´ PostgreSQL é…ç½®ï¼Œå¢åŠ  <code>shared_buffers</code> å’Œ <code>work_mem</code> è®¾ç½®ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/gitlab/postgresql.conf</span><br><span class="line">shared_buffers = 1GB</span><br><span class="line">work_mem = 64MB</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>å¯ç”¨ Redis ç¼“å­˜</strong>ï¼šé…ç½® GitLab ä½¿ç”¨ Redis ç¼“å­˜ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/gitlab/gitlab.rb</span><br><span class="line">gitlab_rails[&#x27;redis_host&#x27;] = &#x27;localhost&#x27;</span><br><span class="line">gitlab_rails[&#x27;redis_port&#x27;] = 6379</span><br></pre></td></tr></table></figure><ol start="3"><li><p><strong>ä½¿ç”¨ SSD å­˜å‚¨</strong>ï¼šä¸º GitLab é…ç½® SSD å­˜å‚¨ï¼Œæé«˜ I&#x2F;O æ€§èƒ½ã€‚</p></li><li><p><strong>ä¼˜åŒ– Nginx é…ç½®</strong>ï¼šè°ƒæ•´ Nginx è®¾ç½®ï¼Œæé«˜ååé‡ï¼š</p></li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/gitlab/nginx/gitlab-http.conf</span><br><span class="line">worker_processes auto;</span><br><span class="line">worker_connections 4096;</span><br></pre></td></tr></table></figure><ol start="5"><li><strong>åˆ†ç¦» GitLab æœåŠ¡</strong>ï¼šå°† GitLab æœåŠ¡åˆ†ç¦»åˆ°ä¸åŒæœåŠ¡å™¨ï¼Œå‡è½»å•å°æœåŠ¡å™¨è´Ÿæ‹…ã€‚</li></ol><h2 id="GitLab-å®‰å…¨åŠ å›º"><a href="#GitLab-å®‰å…¨åŠ å›º" class="headerlink" title="GitLab å®‰å…¨åŠ å›º"></a>GitLab å®‰å…¨åŠ å›º</h2><h3 id="ç›®çš„-7"><a href="#ç›®çš„-7" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h3><p>åŠ å¼º GitLab çš„å®‰å…¨æ€§ï¼Œé˜²æ­¢æ½œåœ¨çš„å®‰å…¨æ¼æ´ã€‚</p><h3 id="æ“ä½œæ­¥éª¤-7"><a href="#æ“ä½œæ­¥éª¤-7" class="headerlink" title="æ“ä½œæ­¥éª¤"></a>æ“ä½œæ­¥éª¤</h3><ol><li><strong>å¯ç”¨ HTTPS</strong>ï¼šä¸º GitLab é…ç½® SSLï¼Œç¡®ä¿æ•°æ®ä¼ è¾“åŠ å¯†ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/gitlab/gitlab.rb</span><br><span class="line">external_url &#x27;https://gitlab.example.com&#x27;</span><br><span class="line">nginx[&#x27;ssl_certificate&#x27;] = &quot;/etc/ssl/certs/gitlab.crt&quot;</span><br><span class="line">nginx[&#x27;ssl_certificate_key&#x27;] = &quot;/etc/ssl/private/gitlab.key&quot;</span><br></pre></td></tr></table></figure><ol start="2"><li><p><strong>å¯ç”¨åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰</strong>ï¼šåœ¨ GitLab è®¾ç½®é¡µé¢å¯ç”¨ 2FAã€‚</p></li><li><p><strong>ä½¿ç”¨ LDAP æˆ– OAuth å®ç°ä¼ä¸šè®¤è¯</strong>ï¼š</p></li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/gitlab/gitlab.rb</span><br><span class="line">gitlab_rails[&#x27;ldap_enabled&#x27;] = true</span><br><span class="line">gitlab_rails[&#x27;ldap_servers&#x27;] = YAML.load &lt;&lt;-EOS</span><br><span class="line">main:</span><br><span class="line">  label: &#x27;LDAP&#x27;</span><br><span class="line">  host: &#x27;_your_ldap_server_&#x27;</span><br><span class="line">  port: 389</span><br><span class="line">  uid: &#x27;sAMAccountName&#x27;</span><br><span class="line">  bind_dn: &#x27;CN=bind_user,CN=Users,DC=example,DC=com&#x27;</span><br><span class="line">  password: &#x27;_your_password_&#x27;</span><br><span class="line">EOS</span><br></pre></td></tr></table></figure><h2 id="GitLab-å¤‡ä»½ä¸æ¢å¤"><a href="#GitLab-å¤‡ä»½ä¸æ¢å¤" class="headerlink" title="GitLab å¤‡ä»½ä¸æ¢å¤"></a>GitLab å¤‡ä»½ä¸æ¢å¤</h2><h3 id="ç›®çš„-8"><a href="#ç›®çš„-8" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h3><p>é…ç½®è‡ªåŠ¨å¤‡ä»½ï¼Œä»¥ç¡®ä¿ GitLab æ•°æ®çš„å®‰å…¨æ€§ã€‚</p><h3 id="æ“ä½œæ­¥éª¤-8"><a href="#æ“ä½œæ­¥éª¤-8" class="headerlink" title="æ“ä½œæ­¥éª¤"></a>æ“ä½œæ­¥éª¤</h3><ol><li><strong>é…ç½®è‡ªåŠ¨å¤‡ä»½</strong>ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/gitlab/gitlab.rb</span><br><span class="line">gitlab_rails[&#x27;backup_path&#x27;] = &#x27;/var/opt/gitlab/backups&#x27;</span><br><span class="line">gitlab_rails[&#x27;backup_keep_time&#x27;] = 604800  # ä¿ç•™7å¤©å¤‡ä»½</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½® crontab å®šæœŸå¤‡ä»½</span></span><br><span class="line">crontab -e</span><br><span class="line">0 2 * * * gitlab-rake gitlab:backup:create</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>æ¢å¤å¤‡ä»½</strong>ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo gitlab-rake gitlab:backup:restore BACKUP=timestamp_of_backup</span><br></pre></td></tr></table></figure><ol start="3"><li><strong>å¤‡ä»½æ¢å¤æµ‹è¯•</strong>ï¼šå®šæœŸè¿›è¡Œæ¢å¤æµ‹è¯•ï¼Œç¡®ä¿å¤‡ä»½æ•°æ®å¯ç”¨ã€‚</li></ol><h2 id="GitLab-æ—¥å¿—ä¸ç›‘æ§"><a href="#GitLab-æ—¥å¿—ä¸ç›‘æ§" class="headerlink" title="GitLab æ—¥å¿—ä¸ç›‘æ§"></a>GitLab æ—¥å¿—ä¸ç›‘æ§</h2><h3 id="ç›®çš„-9"><a href="#ç›®çš„-9" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h3><p>é€šè¿‡æ—¥å¿—ç®¡ç†å’Œç›‘æ§ GitLab æœåŠ¡ï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³é—®é¢˜ã€‚</p><h3 id="æ“ä½œæ­¥éª¤-9"><a href="#æ“ä½œæ­¥éª¤-9" class="headerlink" title="æ“ä½œæ­¥éª¤"></a>æ“ä½œæ­¥éª¤</h3><ol><li><strong>é…ç½®æ—¥å¿—æ”¶é›†</strong>ï¼šä½¿ç”¨ <code>logrotate</code> ç®¡ç† GitLab æ—¥å¿—æ–‡ä»¶ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/logrotate.d/gitlab</span><br><span class="line">/var/log/gitlab/*.log &#123;</span><br><span class="line">    daily</span><br><span class="line">    rotate 7</span><br><span class="line">    compress</span><br><span class="line">    missingok</span><br><span class="line">    notifempty</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><p><strong>ä½¿ç”¨ Prometheus å’Œ Grafana ç›‘æ§ GitLab</strong>ï¼šé€šè¿‡ Prometheus é›†æˆç›‘æ§ GitLab æ€§èƒ½ï¼Œä½¿ç”¨ Grafana å±•ç¤ºæ•°æ®ã€‚</p></li><li><p><strong>è®¾ç½®é‚®ä»¶é€šçŸ¥</strong>ï¼šé…ç½® GitLab é‚®ä»¶é€šçŸ¥ï¼ŒåŠæ—¶äº†è§£ç³»ç»ŸçŠ¶æ€ã€‚</p></li></ol><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>æœ¬æ–‡æ¡£æ¶µç›–äº† GitLab çš„å¸¸è§é…ç½®ä¼˜åŒ–ã€é›†æˆ CICDã€å¤‡ä»½æ¢å¤ã€å®‰å…¨åŠ å›ºå’Œç›‘æ§ç­‰æ–¹é¢ã€‚é€šè¿‡è¿™äº›æ“ä½œï¼Œæ‚¨å¯ä»¥æœ‰æ•ˆæå‡ GitLab çš„æ€§èƒ½ã€å®‰å…¨æ€§å’Œå¯é æ€§ã€‚å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜æˆ–è¿›ä¸€æ­¥çš„éœ€æ±‚ï¼Œæ¬¢è¿ç•™è¨€è®¨è®ºã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; æœ¬æ–‡æ¡£æ—¨åœ¨æä¾› GitLab é…ç½®ä¼˜åŒ–ã€é›†æˆæœ€ä½³å®è·µã€å®‰å…¨åŠ å›ºã€å¤‡ä»½ä¸æ¢å¤ç­–ç•¥ä»¥åŠç›‘æ§æ–¹æ³•ï¼Œå¸®åŠ©å›¢é˜Ÿåœ¨ä½¿ç”¨ GitLab è¿›è¡Œæºä»£ç ç®¡ç†å’ŒæŒç»­é›†æˆ&amp;#x2F;æŒç»­äº¤ä»˜ï¼ˆCICDï¼‰æ—¶æå‡æ€§èƒ½ã€å®‰å…¨æ€§åŠç¨³å®šæ€§ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Development" scheme="https://freemankevin.uk/categories/Development/"/>
    
    
    <category term="Development" scheme="https://freemankevin.uk/tags/Development/"/>
    
    <category term="GitLab" scheme="https://freemankevin.uk/tags/GitLab/"/>
    
    <category term="CICD" scheme="https://freemankevin.uk/tags/CICD/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åœ¨ Docker ç¯å¢ƒä¸­éƒ¨ç½² GitLab Runner</title>
    <link href="https://freemankevin.uk/2025/01/21/docker-runner/"/>
    <id>https://freemankevin.uk/2025/01/21/docker-runner/</id>
    <published>2025-01-21T09:14:25.000Z</published>
    <updated>2025-10-21T03:34:40.408Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•åœ¨ Docker ç¯å¢ƒä¸­éƒ¨ç½² GitLab Runnerï¼Œä»¥ä¾¿ä½¿ç”¨ GitLab CI&#x2F;CD å®ç°è‡ªåŠ¨åŒ–æ„å»ºä¸éƒ¨ç½²ã€‚æˆ‘ä»¬å°†é€šè¿‡ Docker Compose é…ç½®å¹¶ç®¡ç† GitLab Runner å®¹å™¨ï¼Œè¯¦ç»†è®²è§£é…ç½®æ–‡ä»¶å’Œæ³¨å†Œè¿‡ç¨‹ã€‚</p><span id="more"></span><h2 id="éƒ¨ç½²-GitLab-Runner"><a href="#éƒ¨ç½²-GitLab-Runner" class="headerlink" title="éƒ¨ç½² GitLab Runner"></a>éƒ¨ç½² GitLab Runner</h2><p>GitLab Runner æ˜¯ GitLab CI&#x2F;CD çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œç”¨äºæ‰§è¡Œ CI&#x2F;CD ä½œä¸šã€‚æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•åœ¨ Docker ç¯å¢ƒä¸­éƒ¨ç½² GitLab Runnerï¼Œå¹¶é…ç½®å…¶ä¸ GitLab æœåŠ¡å™¨çš„è¿æ¥ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ Docker Compose æ¥ç®¡ç† GitLab Runner å®¹å™¨çš„å¯åŠ¨å’Œé…ç½®ã€‚</p><h3 id="åˆ›å»º-Docker-Compose-é…ç½®æ–‡ä»¶"><a href="#åˆ›å»º-Docker-Compose-é…ç½®æ–‡ä»¶" class="headerlink" title="åˆ›å»º Docker Compose é…ç½®æ–‡ä»¶"></a>åˆ›å»º Docker Compose é…ç½®æ–‡ä»¶</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸º GitLab Runner åˆ›å»ºä¸€ä¸ª <code>docker-compose.yml</code> é…ç½®æ–‡ä»¶ã€‚åœ¨è¯¥æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº† GitLab Runner å®¹å™¨çš„åŸºæœ¬é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä½¿ç”¨çš„é•œåƒã€æŒ‚è½½çš„å·ä»¥åŠå®¹å™¨çš„ç‰¹æƒæ¨¡å¼ã€‚</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">gitlab-runner-npm:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">gitlab/gitlab-runner:latest</span>  <span class="comment"># ä½¿ç”¨ GitLab Runner çš„æœ€æ–°ç‰ˆæœ¬é•œåƒ</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gitlab-runner-npm</span>  <span class="comment"># å®¹å™¨åç§°</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span>  <span class="comment"># å¯ç”¨ç‰¹æƒæ¨¡å¼ï¼Œå…è®¸å®¹å™¨æ‰§è¡Œ Docker æ“ä½œ</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span>  <span class="comment"># å®¹å™¨å´©æºƒæ—¶è‡ªåŠ¨é‡å¯</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./gitlab-runner/:/etc/gitlab-runner</span>  <span class="comment"># å°†æœ¬åœ°çš„ GitLab Runner é…ç½®æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨ä¸­</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/.docker:/root/.docker</span>  <span class="comment"># å°†æœ¬åœ° Docker é…ç½®æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼Œç¡®ä¿ Runner å¯ä»¥ä½¿ç”¨ Docker å®¢æˆ·ç«¯</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span>  <span class="comment"># å…±äº« Docker å¥—æ¥å­—ï¼Œå…è®¸ Runner æ‰§è¡Œ Docker å‘½ä»¤</span></span><br><span class="line">      <span class="comment">#- ./cache:/cache  # å¯é€‰çš„ç¼“å­˜æŒ‚è½½ï¼Œç”¨äºåŠ é€Ÿæ„å»ºè¿‡ç¨‹</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ª <code>docker-compose.yml</code> æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æŒ‚è½½äº†å‡ ä¸ªç›®å½•å’Œæ–‡ä»¶ä»¥ç¡®ä¿å®¹å™¨èƒ½å¤Ÿæ­£ç¡®å·¥ä½œï¼š</p><ul><li><code>./gitlab-runner/</code>ï¼šç”¨äºå­˜å‚¨ GitLab Runner é…ç½®ã€‚</li><li><code>~/.docker</code>ï¼šå°†ä¸»æœºä¸Šçš„ Docker é…ç½®æŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚</li><li><code>/var/run/docker.sock</code>ï¼šå®¹å™¨é€šè¿‡è¿™ä¸ªæŒ‚è½½ä¸å®¿ä¸»æœºçš„ Docker å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œé€šä¿¡ï¼Œå…è®¸ Runner æ‰§è¡Œ Docker å‘½ä»¤ã€‚</li></ul><h3 id="æ³¨å†Œ-GitLab-Runner"><a href="#æ³¨å†Œ-GitLab-Runner" class="headerlink" title="æ³¨å†Œ GitLab Runner"></a>æ³¨å†Œ GitLab Runner</h3><p>GitLab Runner éœ€è¦åœ¨æ³¨å†Œåæ‰èƒ½ä¸ GitLab æœåŠ¡è¿›è¡Œé€šä¿¡ã€‚ä»¥ä¸‹æ˜¯æ³¨å†Œ GitLab Runner çš„è„šæœ¬ï¼Œå®ƒé€šè¿‡ Docker æ‰§è¡Œ <code>gitlab-runner register</code> å‘½ä»¤ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">REGISTRATION_TOKEN=&quot;YOUR_REGISTRATION_TOKEN&quot;  # GitLab æ³¨å†Œä»¤ç‰Œï¼Œæ›¿æ¢ä¸ºå®é™…å€¼</span><br><span class="line">RUNNER_NAME=&quot;gitlab-runner-npm-group&quot;  # Runner çš„åç§°</span><br><span class="line"></span><br><span class="line">docker exec -it &quot;$&#123;RUNNER_NAME&#125;&quot; gitlab-runner register \</span><br><span class="line">  --non-interactive \</span><br><span class="line">  --url &quot;http://gitlab.example.com/&quot; \  # GitLab æœåŠ¡å™¨åœ°å€ï¼Œæ›¿æ¢ä¸ºå®é™…åœ°å€</span><br><span class="line">  --registration-token &quot;$&#123;REGISTRATION_TOKEN&#125;&quot; \</span><br><span class="line">  --executor &quot;docker&quot; \  # ä½¿ç”¨ Docker æ‰§è¡Œå™¨</span><br><span class="line">  --docker-image &quot;docker:19.03.12&quot; \  # Docker é•œåƒï¼Œé€‰æ‹©é€‚åˆçš„ç‰ˆæœ¬</span><br><span class="line">  --description &quot;Docker Runner&quot; \  # Runner æè¿°</span><br><span class="line">  --tag-list &quot;docker-npm&quot; \  # Runner æ ‡ç­¾ï¼Œå¸®åŠ©è¿‡æ»¤ä»»åŠ¡</span><br><span class="line">  --locked=true \  # é”å®š Runnerï¼Œé˜²æ­¢å…¶ä»– GitLab å®ä¾‹æ³¨å†Œ</span><br><span class="line">  --docker-privileged=true \  # å¯ç”¨ Docker ç‰¹æƒæ¨¡å¼</span><br><span class="line">  --run-untagged=false \  # ä¸è¿è¡Œæœªæ‰“æ ‡ç­¾çš„ä½œä¸š</span><br><span class="line">  --docker-tlsverify=false \  # ç¦ç”¨ Docker TLS éªŒè¯</span><br><span class="line">  --docker-disable-entrypoint-overwrite=false \  # ä¸ç¦ç”¨å®¹å™¨å…¥å£ç‚¹è¦†ç›–</span><br><span class="line">  --docker-oom-kill-disable=false \  # å¯ç”¨ OOM æ€æ­»</span><br><span class="line">  --docker-disable-cache=false \  # å¯ç”¨ Docker ç¼“å­˜</span><br><span class="line">  --docker-shm-size=0 \  # è®¾ç½®å…±äº«å†…å­˜å¤§å°</span><br><span class="line">  --cache-type=&quot;s3&quot; \  # é…ç½® S3 ç¼“å­˜</span><br><span class="line">  --cache-path=&quot;runner&quot; \  # ç¼“å­˜è·¯å¾„</span><br><span class="line">  --cache-shared=true \  # å¯ç”¨å…±äº«ç¼“å­˜</span><br><span class="line">  --cache-s3-server-address=&quot;s3.example.com:9000&quot; \  # S3 æœåŠ¡å™¨åœ°å€ï¼Œæ›¿æ¢ä¸ºå®é™…å€¼</span><br><span class="line">  --cache-s3-access-key=&quot;YOUR_S3_ACCESS_KEY&quot; \  # S3 è®¿é—®å¯†é’¥</span><br><span class="line">  --cache-s3-secret-key=&quot;YOUR_S3_SECRET_KEY&quot; \  # S3 ç§˜å¯†è®¿é—®å¯†é’¥</span><br><span class="line">  --cache-s3-bucket-name=&quot;runner-cache&quot; \  # S3 å­˜å‚¨æ¡¶åç§°</span><br><span class="line">  --cache-s3-insecure=true  # å¯ç”¨ä¸å®‰å…¨è¿æ¥</span><br></pre></td></tr></table></figure><h3 id="GitLab-Runner-é…ç½®"><a href="#GitLab-Runner-é…ç½®" class="headerlink" title="GitLab Runner é…ç½®"></a>GitLab Runner é…ç½®</h3><p>åœ¨å®¹å™¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–è¾‘ GitLab Runner çš„é…ç½®æ–‡ä»¶ <code>config.toml</code>ï¼Œä»¥è®¾ç½®å¹¶ä¼˜åŒ– Runner çš„è¡Œä¸ºã€‚ä»¥ä¸‹æ˜¯ <code>config.toml</code> æ–‡ä»¶çš„ç¤ºä¾‹ï¼Œå…¶ä¸­åŒ…å«äº†å¤šä¸ªé‡è¦çš„é…ç½®é¡¹ï¼š</p><figure class="highlight toml"><table><tr><td class="code"><pre><span class="line"><span class="attr">concurrent</span> = <span class="number">1</span>  <span class="comment"># é™åˆ¶åŒæ—¶è¿è¡Œçš„ä½œä¸šæ•°</span></span><br><span class="line"><span class="attr">check_interval</span> = <span class="number">0</span>  <span class="comment"># æ£€æŸ¥ä»»åŠ¡é˜Ÿåˆ—çš„é—´éš”æ—¶é—´</span></span><br><span class="line"></span><br><span class="line"><span class="section">[session_server]</span></span><br><span class="line">  <span class="attr">session_timeout</span> = <span class="number">1800</span>  <span class="comment"># ä¼šè¯è¶…æ—¶è®¾ç½®ï¼ˆå•ä½ï¼šç§’ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[runners]]</span></span><br><span class="line">  <span class="attr">name</span> = <span class="string">&quot;Docker Runner&quot;</span>  <span class="comment"># Runner åç§°</span></span><br><span class="line">  <span class="attr">url</span> = <span class="string">&quot;http://gitlab.example.com/&quot;</span>  <span class="comment"># GitLab å®ä¾‹çš„ URL</span></span><br><span class="line">  <span class="attr">token</span> = <span class="string">&quot;YOUR_REGISTRATION_TOKEN&quot;</span>  <span class="comment"># æ³¨å†Œä»¤ç‰Œï¼Œæ›¿æ¢ä¸ºå®é™…å€¼</span></span><br><span class="line">  <span class="attr">executor</span> = <span class="string">&quot;docker&quot;</span>  <span class="comment"># ä½¿ç”¨ Docker æ‰§è¡Œä½œä¸š</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[runners.custom_build_dir]</span></span><br><span class="line">  <span class="comment">#[runners.cache]  # ç¼“å­˜é…ç½®ï¼Œé€šå¸¸ç”¨äºåŠ é€Ÿæ„å»ºè¿‡ç¨‹</span></span><br><span class="line">  <span class="comment">#  Type = &quot;local&quot;</span></span><br><span class="line">  <span class="comment">#  Path = &quot;/cache&quot;</span></span><br><span class="line">  <span class="comment">#  Shared = true</span></span><br><span class="line">  <span class="section">[runners.cache]</span></span><br><span class="line">    <span class="attr">Type</span> = <span class="string">&quot;s3&quot;</span>  <span class="comment"># ä½¿ç”¨ S3 ä½œä¸ºç¼“å­˜ç±»å‹</span></span><br><span class="line">    <span class="attr">Path</span> = <span class="string">&quot;runner&quot;</span>  <span class="comment"># ç¼“å­˜è·¯å¾„</span></span><br><span class="line">    <span class="attr">Shared</span> = <span class="literal">true</span>  <span class="comment"># å¯ç”¨å…±äº«ç¼“å­˜</span></span><br><span class="line">    <span class="section">[runners.cache.s3]</span></span><br><span class="line">      <span class="attr">ServerAddress</span> = <span class="string">&quot;s3.example.com:9000&quot;</span>  <span class="comment"># S3 æœåŠ¡å™¨åœ°å€ï¼Œæ›¿æ¢ä¸ºå®é™…åœ°å€</span></span><br><span class="line">      <span class="attr">AccessKey</span> = <span class="string">&quot;YOUR_S3_ACCESS_KEY&quot;</span>  <span class="comment"># S3 è®¿é—®å¯†é’¥</span></span><br><span class="line">      <span class="attr">SecretKey</span> = <span class="string">&quot;YOUR_S3_SECRET_KEY&quot;</span>  <span class="comment"># S3 ç§˜å¯†è®¿é—®å¯†é’¥</span></span><br><span class="line">      <span class="attr">BucketName</span> = <span class="string">&quot;runner-cache&quot;</span>  <span class="comment"># S3 å­˜å‚¨æ¡¶åç§°</span></span><br><span class="line">      <span class="attr">Insecure</span> = <span class="literal">true</span>  <span class="comment"># å¯ç”¨ä¸å®‰å…¨è¿æ¥</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[runners.docker]</span></span><br><span class="line">    <span class="attr">tls_verify</span> = <span class="literal">false</span>  <span class="comment"># ç¦ç”¨ Docker TLS éªŒè¯</span></span><br><span class="line">    <span class="attr">image</span> = <span class="string">&quot;docker:19.03.12&quot;</span>  <span class="comment"># Docker é•œåƒç‰ˆæœ¬</span></span><br><span class="line">    <span class="attr">privileged</span> = <span class="literal">true</span>  <span class="comment"># å¯ç”¨ç‰¹æƒæ¨¡å¼</span></span><br><span class="line">    <span class="attr">disable_entrypoint_overwrite</span> = <span class="literal">false</span>  <span class="comment"># å¯ç”¨å®¹å™¨å…¥å£ç‚¹è¦†ç›–</span></span><br><span class="line">    <span class="attr">oom_kill_disable</span> = <span class="literal">false</span>  <span class="comment"># å¯ç”¨ OOM æ€æ­»</span></span><br><span class="line">    <span class="attr">disable_cache</span> = <span class="literal">false</span>  <span class="comment"># å¯ç”¨ç¼“å­˜</span></span><br><span class="line">    <span class="attr">volumes</span> = [<span class="string">&quot;/cache&quot;</span>]  <span class="comment"># æŒ‚è½½çš„ç›®å½•</span></span><br><span class="line">    <span class="attr">shm_size</span> = <span class="number">536870912</span>  <span class="comment"># è®¾ç½®å…±äº«å†…å­˜å¤§å°</span></span><br><span class="line">    <span class="attr">memory</span> = <span class="string">&quot;24000m&quot;</span>  <span class="comment"># åˆ†é…å†…å­˜</span></span><br><span class="line">    <span class="attr">memory_swap</span> = <span class="string">&quot;26g&quot;</span>  <span class="comment"># è®¾ç½®äº¤æ¢å†…å­˜</span></span><br><span class="line">    <span class="attr">cpus</span> = <span class="string">&quot;12&quot;</span>  <span class="comment"># åˆ†é… CPU æ ¸æ•°</span></span><br><span class="line">    <span class="attr">allowed_images</span> = [  <span class="comment"># é™åˆ¶ Runner ä½¿ç”¨çš„é•œåƒåˆ—è¡¨</span></span><br><span class="line">      <span class="string">&quot;harbor.dockerregistry.com/kubernetes/maven:3.6.3-openjdk-8-slim&quot;</span>,</span><br><span class="line">      <span class="string">&quot;harbor.dockerregistry.com/kubernetes/kaniko-project/executor:v1.14.0-debug&quot;</span>,</span><br><span class="line">      <span class="string">&quot;harbor.dockerregistry.com/kubernetes/argocli-git:v2.7.14&quot;</span>,</span><br><span class="line">      <span class="string">&quot;harbor.dockerregistry.com/kubernetes/nodejs:*&quot;</span></span><br><span class="line">    ]</span><br></pre></td></tr></table></figure><h4 id="é‡è¦é…ç½®è¯´æ˜ï¼š"><a href="#é‡è¦é…ç½®è¯´æ˜ï¼š" class="headerlink" title="é‡è¦é…ç½®è¯´æ˜ï¼š"></a>é‡è¦é…ç½®è¯´æ˜ï¼š</h4><ul><li><strong><code>privileged</code></strong>ï¼šå¯ç”¨ç‰¹æƒæ¨¡å¼ï¼Œå…è®¸å®¹å™¨æ‰§è¡Œ Docker æ“ä½œã€‚è¿™æ˜¯å¿…éœ€çš„ï¼Œå› ä¸º GitLab Runner éœ€è¦èƒ½å¤Ÿåœ¨å®¹å™¨ä¸­æ‰§è¡Œæ„å»ºä»»åŠ¡ã€‚</li><li><strong><code>executor</code></strong>ï¼šæŒ‡å®šè¿è¡Œä½œä¸šçš„æ‰§è¡Œå™¨ï¼Œé€šå¸¸ä¸º <code>docker</code>ï¼Œå¯ä»¥åœ¨å®¹å™¨ä¸­è¿è¡Œä»»åŠ¡ã€‚</li><li><strong><code>volumes</code></strong>ï¼šæŒ‚è½½å·ï¼Œå…è®¸å®¹å™¨è®¿é—®å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿã€‚ä¾‹å¦‚ï¼ŒæŒ‚è½½ Docker å¥—æ¥å­—å’Œå…±äº«ç¼“å­˜ç›®å½•ã€‚</li><li><strong><code>memory</code> å’Œ <code>cpus</code></strong>ï¼šä¸º Runner åˆ†é…å†…å­˜å’Œ CPU èµ„æºï¼Œæ ¹æ®éœ€è¦è°ƒæ•´è¿™äº›å‚æ•°ä»¥ä¼˜åŒ–æ„å»ºæ€§èƒ½ã€‚</li></ul><h3 id="å¯åŠ¨-GitLab-Runner"><a href="#å¯åŠ¨-GitLab-Runner" class="headerlink" title="å¯åŠ¨ GitLab Runner"></a>å¯åŠ¨ GitLab Runner</h3><p>å®Œæˆä»¥ä¸Šé…ç½®åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ GitLab Runner å®¹å™¨ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker-compose up -d  # åœ¨åå°å¯åŠ¨æœåŠ¡</span><br></pre></td></tr></table></figure><p>è¿™å°†å¯åŠ¨ GitLab Runnerï¼Œå¹¶ä¸”å®ƒä¼šè‡ªåŠ¨ä¸ GitLab å®ä¾‹æ³¨å†Œã€‚æ‚¨å¯ä»¥ç™»å½• GitLab æŸ¥çœ‹ Runner æ˜¯å¦æˆåŠŸæ³¨å†Œå¹¶å¼€å§‹å¤„ç†ä½œä¸šã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•åœ¨ Docker ç¯å¢ƒä¸­éƒ¨ç½² GitLab Runnerï¼Œä»¥ä¾¿ä½¿ç”¨ GitLab CI&amp;#x2F;CD å®ç°è‡ªåŠ¨åŒ–æ„å»ºä¸éƒ¨ç½²ã€‚æˆ‘ä»¬å°†é€šè¿‡ Docker Compose é…ç½®å¹¶ç®¡ç† GitLab Runner å®¹å™¨ï¼Œè¯¦ç»†è®²è§£é…ç½®æ–‡ä»¶å’Œæ³¨å†Œè¿‡ç¨‹ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Development" scheme="https://freemankevin.uk/categories/Development/"/>
    
    
    <category term="Docker" scheme="https://freemankevin.uk/tags/Docker/"/>
    
    <category term="GitLab Runner" scheme="https://freemankevin.uk/tags/GitLab-Runner/"/>
    
    <category term="GitLab" scheme="https://freemankevin.uk/tags/GitLab/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åœ¨Kubernetes ç¯å¢ƒä¸­å®‰è£… Grafana éƒ¨ç½²æŒ‡å—</title>
    <link href="https://freemankevin.uk/2025/01/21/k8s-grafana/"/>
    <id>https://freemankevin.uk/2025/01/21/k8s-grafana/</id>
    <published>2025-01-21T08:53:25.000Z</published>
    <updated>2025-10-21T03:34:40.413Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æœ¬æ–‡ä»‹ç»å¦‚ä½•é€šè¿‡ Helm éƒ¨ç½² Grafana å¹¶é…ç½®åå‘ä»£ç†ï¼Œä»¥ä¾¿åœ¨ Kubernetes é›†ç¾¤ä¸­ä½¿ç”¨ Grafanaï¼Œæ”¯æŒ HTTPS åŠ å¯†å’ŒåŸºæœ¬è®¤è¯ã€‚</p><span id="more"></span><h2 id="ä¸‹è½½-Helm-Chart"><a href="#ä¸‹è½½-Helm-Chart" class="headerlink" title="ä¸‹è½½ Helm Chart"></a>ä¸‹è½½ Helm Chart</h2><p>é¦–å…ˆåˆ›å»ºç›®å½•å¹¶ä¸‹è½½ Grafana çš„ Helm Chartã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir -p grafana </span><br><span class="line">cd grafana</span><br><span class="line">helm repo add grafana https://grafana.github.io/helm-charts</span><br><span class="line">helm repo update</span><br><span class="line">helm search repo grafana/grafana -l</span><br><span class="line">helm search repo grafana/grafana --versions</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¦‚æœéœ€è¦ä¸‹è½½æŒ‡å®šç‰ˆæœ¬</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">helm pull grafana/grafana --version 7.2.3</span> </span><br><span class="line">tar xf grafana-7.2.3.tgz</span><br><span class="line">cp -rvf grafana/values.yaml&#123;,.bak&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆ›å»ºè‡ªå®šä¹‰-values-yaml"><a href="#åˆ›å»ºè‡ªå®šä¹‰-values-yaml" class="headerlink" title="åˆ›å»ºè‡ªå®šä¹‰ values.yaml"></a>åˆ›å»ºè‡ªå®šä¹‰ <code>values.yaml</code></h2><p>Grafana çš„ <code>values.yaml</code> æ–‡ä»¶ç”¨äºé…ç½® Helm Chart éƒ¨ç½²çš„å‚æ•°ã€‚ä»¥ä¸‹æ˜¯å¸¸ç”¨çš„é…ç½®é¡¹ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">image:</span></span><br><span class="line">  <span class="attr">registry:</span> <span class="string">docker.io</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">grafana/grafana</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">&quot;10.2.3&quot;</span>  <span class="comment"># ä¿®æ”¹ä¸ºå›ºå®šç‰ˆæœ¬çš„é•œåƒæ ‡ç­¾</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">ingress:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span>  <span class="comment"># å¯ç”¨ Ingress</span></span><br><span class="line">  <span class="attr">annotations:</span>  <span class="comment"># æ·»åŠ æ³¨é‡Š</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/$1</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/use-regex:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">grafana.k8scluster.com</span>  <span class="comment"># ä½¿ç”¨åŸŸåè®¿é—® Grafana</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">persistence:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">pvc</span> </span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span>  <span class="comment"># å¯ç”¨ PVC æŒä¹…åŒ–å­˜å‚¨</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">default</span>  <span class="comment"># ä½¿ç”¨é»˜è®¤å­˜å‚¨ç±»</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">size:</span> <span class="string">1Gi</span>  <span class="comment"># è®¾ç½® PVC å¤§å°ä¸º 1Gi</span></span><br><span class="line"></span><br><span class="line"><span class="attr">extraVolumeMounts:</span>  <span class="comment"># é…ç½®é¢å¤–çš„æŒ‚è½½è·¯å¾„</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-data</span></span><br><span class="line">    <span class="attr">mountPath:</span> <span class="string">/var/lib/grafana/plugins</span></span><br><span class="line">    <span class="attr">subPath:</span> <span class="string">plugins</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-data</span></span><br><span class="line">    <span class="attr">mountPath:</span> <span class="string">/var/lib/grafana/dashboards</span></span><br><span class="line">    <span class="attr">subPath:</span> <span class="string">dashboards</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-data</span></span><br><span class="line">    <span class="attr">mountPath:</span> <span class="string">/etc/grafana/provisioning</span></span><br><span class="line">    <span class="attr">subPath:</span> <span class="string">provisioning</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">extraVolumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-data</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">grafana-data-pvc</span>  <span class="comment"># ä½¿ç”¨æŒ‡å®šçš„ PVC</span></span><br></pre></td></tr></table></figure><h3 id="é…ç½®è§£é‡Š"><a href="#é…ç½®è§£é‡Š" class="headerlink" title="é…ç½®è§£é‡Š"></a>é…ç½®è§£é‡Š</h3><ul><li><p><strong>é•œåƒé…ç½® (<code>image</code>)</strong>ï¼šé€‰æ‹©æ­£ç¡®çš„ Grafana é•œåƒç‰ˆæœ¬ã€‚è¿™é‡Œçš„ <code>tag</code> å‚æ•°è®¾ç½®ä¸ºå…·ä½“ç‰ˆæœ¬ï¼Œå¦‚ <code>10.2.3</code>ã€‚</p></li><li><p><strong>Ingress é…ç½® (<code>ingress</code>)</strong>ï¼š</p><ul><li>å¯ç”¨ Ingress ä»¥ä¾¿é€šè¿‡åŸŸåè®¿é—® Grafanaã€‚</li><li><code>nginx.ingress.kubernetes.io/rewrite-target</code>ï¼šå°†è¯·æ±‚è·¯å¾„é‡å†™ä¸ºé€‚åˆ Grafana çš„è·¯å¾„ã€‚</li><li><code>path</code> å’Œ <code>pathType</code> é…ç½®äº†è®¿é—®è·¯å¾„ï¼Œå¹¶ä½¿ç”¨æ­£åˆ™åŒ¹é…æ¥çµæ´»å¤„ç†è¯·æ±‚ã€‚</li><li><code>hosts</code> é…ç½®ä¸ºæœ¬åœ°åŸŸåï¼Œç¡®ä¿ Grafana å¯ä»¥é€šè¿‡æŒ‡å®šåŸŸåè®¿é—®ã€‚</li></ul></li><li><p><strong>æŒä¹…åŒ–é…ç½® (<code>persistence</code>)</strong>ï¼š</p><ul><li>ä½¿ç”¨ PVC è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ï¼Œä»¥ä¾¿åœ¨ Grafana Pod é‡å¯æ—¶ä¸ä¼šä¸¢å¤±æ•°æ®ã€‚</li><li>é…ç½®å­˜å‚¨å¤§å°ä¸º <code>1Gi</code>ï¼Œå¹¶é€‰æ‹©åˆé€‚çš„å­˜å‚¨ç±» <code>default</code>ã€‚</li></ul></li><li><p><strong>é¢å¤–çš„æŒ‚è½½é…ç½® (<code>extraVolumeMounts</code>)</strong>ï¼š</p><ul><li>å°† Grafana çš„æ’ä»¶ã€ä»ªè¡¨ç›˜å’Œé…ç½®æ–‡ä»¶å¤¹æŒ‚è½½åˆ°æŒ‡å®šè·¯å¾„ï¼Œç¡®ä¿ Grafana å¯åŠ¨æ—¶èƒ½å¤Ÿä½¿ç”¨è¿™äº›èµ„æºã€‚</li></ul></li></ul><h2 id="ä½¿ç”¨-Helm-å®‰è£…-Grafana"><a href="#ä½¿ç”¨-Helm-å®‰è£…-Grafana" class="headerlink" title="ä½¿ç”¨ Helm å®‰è£… Grafana"></a>ä½¿ç”¨ Helm å®‰è£… Grafana</h2><p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… Grafana å¹¶æŒ‡å®šè‡ªå®šä¹‰çš„ <code>values.yaml</code> é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm install grafana -f grafana/values.yaml ./grafana --namespace grafana --create-namespace</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…å®Œæˆåè¾“å‡º"><a href="#å®‰è£…å®Œæˆåè¾“å‡º" class="headerlink" title="å®‰è£…å®Œæˆåè¾“å‡º"></a>å®‰è£…å®Œæˆåè¾“å‡º</h3><p>å®‰è£…å®Œæˆåï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è·å– Grafana çš„é»˜è®¤ç®¡ç†å‘˜å¯†ç ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl get secret --namespace grafana grafana -o jsonpath=&quot;&#123;.data.admin-password&#125;&quot; | base64 --decode ; echo</span><br></pre></td></tr></table></figure><p>Grafana æ§åˆ¶å°å¯ä»¥é€šè¿‡ä»¥ä¸‹ DNS åœ°å€è®¿é—®ï¼š</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">http://grafana.k8scluster.com</span><br></pre></td></tr></table></figure><p>ç™»å½•æ—¶ï¼Œä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ· <code>admin</code> å’Œå¯†ç ã€‚</p><h2 id="æ›´æ–°-Helm-éƒ¨ç½²"><a href="#æ›´æ–°-Helm-éƒ¨ç½²" class="headerlink" title="æ›´æ–° Helm éƒ¨ç½²"></a>æ›´æ–° Helm éƒ¨ç½²</h2><p>è‹¥éœ€è¦å¯¹å·²éƒ¨ç½²çš„ Grafana è¿›è¡Œæ›´æ–°ï¼ˆä¾‹å¦‚ä¿®æ”¹é…ç½®ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm upgrade grafana -f grafana/values.yaml ./grafana --namespace grafana</span><br></pre></td></tr></table></figure><h3 id="æ›´æ–°åè¾“å‡º"><a href="#æ›´æ–°åè¾“å‡º" class="headerlink" title="æ›´æ–°åè¾“å‡º"></a>æ›´æ–°åè¾“å‡º</h3><p>æ›´æ–°ååŒæ ·å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è·å–æ›´æ–°åçš„ç®¡ç†å‘˜å¯†ç ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl get secret --namespace grafana grafana -o jsonpath=&quot;&#123;.data.admin-password&#125;&quot; | base64 --decode ; echo</span><br></pre></td></tr></table></figure><h2 id="ç™»å½•-Grafana-æ§åˆ¶å°"><a href="#ç™»å½•-Grafana-æ§åˆ¶å°" class="headerlink" title="ç™»å½• Grafana æ§åˆ¶å°"></a>ç™»å½• Grafana æ§åˆ¶å°</h2><p>Grafana æ§åˆ¶å°å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®ä»¥ä¸‹åœ°å€ï¼š</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">http://grafana.k8scluster.com:30886/grafana</span><br></pre></td></tr></table></figure><p>ç™»å½•æ—¶ï¼Œä½¿ç”¨ä¹‹å‰è·å–çš„ç®¡ç†å‘˜å¯†ç è¿›è¡Œç™»å½•ã€‚</p><h2 id="å¯¼å‡º-Prometheus-å’Œ-Alertmanager"><a href="#å¯¼å‡º-Prometheus-å’Œ-Alertmanager" class="headerlink" title="å¯¼å‡º Prometheus å’Œ Alertmanager"></a>å¯¼å‡º Prometheus å’Œ Alertmanager</h2><h3 id="åˆ›å»º-Prometheus-å’Œ-Alertmanager-çš„-Ingress"><a href="#åˆ›å»º-Prometheus-å’Œ-Alertmanager-çš„-Ingress" class="headerlink" title="åˆ›å»º Prometheus å’Œ Alertmanager çš„ Ingress"></a>åˆ›å»º Prometheus å’Œ Alertmanager çš„ Ingress</h3><p>ä¸º Prometheus å’Œ Alertmanager åˆ›å»ºä¸€ä¸ª Ingress èµ„æºï¼Œä½¿å…¶é€šè¿‡åŸŸåè®¿é—®ã€‚</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubesphere-monitoring-system</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-realm:</span> <span class="string">Authentication</span> <span class="string">Required</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-secret:</span> <span class="string">prometheus-basic-auth</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-type:</span> <span class="string">basic</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-body-size:</span> <span class="string">2048m</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-connect-timeout:</span> <span class="string">&#x27;1800&#x27;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-read-timeout:</span> <span class="string">&#x27;1800&#x27;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-send-timeout:</span> <span class="string">&#x27;1800&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">prometheus.k8scluster.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">prometheus-k8s</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">alertmanager.k8scluster.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">alertmanager-main</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">web</span></span><br></pre></td></tr></table></figure><h3 id="åˆ›å»º-HTTP-åŸºæœ¬è®¤è¯"><a href="#åˆ›å»º-HTTP-åŸºæœ¬è®¤è¯" class="headerlink" title="åˆ›å»º HTTP åŸºæœ¬è®¤è¯"></a>åˆ›å»º HTTP åŸºæœ¬è®¤è¯</h3><p>é€šè¿‡ <code>htpasswd</code> åˆ›å»ºä¸€ä¸ªåŸºæœ¬è®¤è¯æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä½œä¸º Secret å­˜å‚¨ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">htpasswd -c auth admin  # è®¾ç½®ç®¡ç†å‘˜å¯†ç </span><br></pre></td></tr></table></figure><h3 id="åˆ›å»º-Secret"><a href="#åˆ›å»º-Secret" class="headerlink" title="åˆ›å»º Secret"></a>åˆ›å»º Secret</h3><p>åˆ›å»º Kubernetes Secretï¼Œç”¨äºå­˜å‚¨åŸºæœ¬è®¤è¯å‡­è¯ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl create secret generic prometheus-basic-auth --from-file=auth -n monitoring</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; æœ¬æ–‡ä»‹ç»å¦‚ä½•é€šè¿‡ Helm éƒ¨ç½² Grafana å¹¶é…ç½®åå‘ä»£ç†ï¼Œä»¥ä¾¿åœ¨ Kubernetes é›†ç¾¤ä¸­ä½¿ç”¨ Grafanaï¼Œæ”¯æŒ HTTPS åŠ å¯†å’ŒåŸºæœ¬è®¤è¯ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Kubernetes" scheme="https://freemankevin.uk/categories/Kubernetes/"/>
    
    
    <category term="TLS" scheme="https://freemankevin.uk/tags/TLS/"/>
    
    <category term="KubeSphere" scheme="https://freemankevin.uk/tags/KubeSphere/"/>
    
    <category term="Ingress-NGINX" scheme="https://freemankevin.uk/tags/Ingress-NGINX/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åœ¨Kubernetes ç¯å¢ƒä¸­å®‰è£… KubeSphere</title>
    <link href="https://freemankevin.uk/2025/01/21/k8s-kubesphere/"/>
    <id>https://freemankevin.uk/2025/01/21/k8s-kubesphere/</id>
    <published>2025-01-21T08:32:25.000Z</published>
    <updated>2025-10-21T03:34:40.413Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•åœ¨ Kubernetes é›†ç¾¤ä¸­åœ¨çº¿å®‰è£… KubeSphereï¼Œè¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å®¹å™¨ç®¡ç†å¹³å°ï¼Œèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·æ–¹ä¾¿åœ°ç®¡ç† Kubernetes ç¯å¢ƒã€‚æˆ‘ä»¬å°†é€šè¿‡ Helm è¿›è¡Œå®‰è£…ï¼Œè¯¦ç»†è®²è§£æ¯ä¸€æ­¥çš„æ“ä½œæµç¨‹ï¼Œå¹¶å±•ç¤ºå¦‚ä½•é€šè¿‡æµè§ˆå™¨è®¿é—® KubeSphere æ§åˆ¶å°ã€‚æœ€åï¼Œæˆ‘ä»¬è¿˜ä¼šæä¾›å¸è½½ KubeSphere çš„æ­¥éª¤ï¼Œå¸®åŠ©æ‚¨è½»æ¾ç®¡ç†å¹³å°çš„ç”Ÿå‘½å‘¨æœŸã€‚</p><span id="more"></span><h2 id="å®‰è£…-KubeSphere"><a href="#å®‰è£…-KubeSphere" class="headerlink" title="å®‰è£… KubeSphere"></a>å®‰è£… KubeSphere</h2><p>KubeSphere æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç®¡ç†å¹³å°ï¼Œå¯ä»¥è½»æ¾å®ç° Kubernetes é›†ç¾¤çš„ç»Ÿä¸€ç®¡ç†ã€‚è¦å®‰è£… KubeSphereï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Helm å·¥å…·è¿›è¡Œåœ¨çº¿å®‰è£…ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><p>é¦–å…ˆï¼Œåœ¨ Kubernetes é›†ç¾¤ä¸­åº”ç”¨ KubeSphere çš„å®‰è£…æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubesphere/ks-installer/releases/download/v3.4.1/kubesphere-installer.yaml</span><br><span class="line">kubectl apply -f https://github.com/kubesphere/ks-installer/releases/download/v3.4.1/cluster-configuration.yaml</span><br></pre></td></tr></table></figure><p>æ¥ç€ï¼Œè®¾ç½®åŒºåŸŸä¸ºä¸­å›½ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export KKZONE=cn</span><br><span class="line">echo &quot;export KKZONE=cn&quot; &gt;&gt; /etc/profile</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œé€šè¿‡ Helm å®‰è£… KubeSphereï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm repo add kubesphere https://charts.kubesphere.io/main</span><br><span class="line">helm repo update</span><br><span class="line">helm install ks kubesphere/kubesphere --namespace kubesphere-system --create-namespace</span><br></pre></td></tr></table></figure><p>å®‰è£…è¿‡ç¨‹ä¼šè‡ªåŠ¨æ‹‰å–æ‰€éœ€çš„é•œåƒå¹¶é…ç½®ç›¸åº”çš„æœåŠ¡ã€‚</p><p>å®‰è£…å®Œæˆåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ KubeSphere å®‰è£…æ—¥å¿—ï¼Œç¡®ä¿å®‰è£…æˆåŠŸï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl logs -n kubesphere-system -l app=ks-installer -f</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œä½¿ç”¨æµè§ˆå™¨è®¿é—® KubeSphere æ§åˆ¶å°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ§åˆ¶å°: http://&lt;Your-IP&gt;:30880</span><br><span class="line">è´¦æˆ·: admin</span><br><span class="line">å¯†ç : P@88w0rd</span><br></pre></td></tr></table></figure><hr><h2 id="å¸è½½-KubeSphere"><a href="#å¸è½½-KubeSphere" class="headerlink" title="å¸è½½ KubeSphere"></a>å¸è½½ KubeSphere</h2><p>å¦‚æœéœ€è¦å¸è½½ KubeSphereï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ“ä½œã€‚è¯·æ³¨æ„ï¼Œå¸è½½è¿‡ç¨‹ä¼šåˆ é™¤ KubeSphere æ‰€æœ‰ç›¸å…³èµ„æºï¼Œè¯·è°¨æ…æ“ä½œã€‚</p><p>é¦–å…ˆï¼Œæ‰§è¡Œå¸è½½å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">helm uninstall ks --namespace kubesphere-system</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œæ¸…ç†æ®‹ç•™çš„èµ„æºï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl delete namespace kubesphere-system</span><br></pre></td></tr></table></figure><p>å¦‚æœé‡åˆ°å‘½åç©ºé—´æ— æ³•åˆ é™¤çš„æƒ…å†µï¼Œå¯ä»¥æ‰‹åŠ¨åˆ é™¤ <code>finalizers</code> å­—æ®µï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl get namespace kubesphere-system -o json &gt; kubesphere-system-temp.json</span><br><span class="line">vim kubesphere-system-temp.json</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ é™¤ <span class="string">&quot;finalizers&quot;</span> å­—æ®µ</span></span><br><span class="line">kubectl replace --raw &quot;/api/v1/namespaces/kubesphere-system/finalize&quot; -f ./kubesphere-system-temp.json</span><br></pre></td></tr></table></figure><p>å®Œæˆåï¼ŒKubeSphere å°±ä¼šè¢«å½»åº•å¸è½½ã€‚</p><h2 id="é…ç½®-KubeSphere-ä»£ç†"><a href="#é…ç½®-KubeSphere-ä»£ç†" class="headerlink" title="é…ç½® KubeSphere ä»£ç†"></a>é…ç½® KubeSphere ä»£ç†</h2><p>åœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œæ‚¨å¯èƒ½éœ€è¦ä¸º KubeSphere æ§åˆ¶å°æ·»åŠ ä¸€ä¸ªä»£ç†ï¼Œä»¥ä¾¿æ›´æ–¹ä¾¿åœ°é€šè¿‡è‡ªå®šä¹‰åŸŸåè®¿é—®ã€‚ä¸‹é¢æ˜¯å¦‚ä½•é€šè¿‡ Docker Compose é…ç½® Nginx ä»£ç†æœåŠ¡çš„æ­¥éª¤ã€‚</p><p>é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ª <code>docker-compose.yaml</code> æ–‡ä»¶ï¼Œé…ç½® Nginx ä»£ç†ï¼Œå¹¶æ˜ å°„ KubeSphere æ§åˆ¶å°çš„ç«¯å£ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´çš„é…ç½®æ–‡ä»¶å†…å®¹ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">ks-console-proxy:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">harbor.dockerregistry.com/library/nginx:1.21.6-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">ks-console-proxy</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span>   <span class="comment"># æ˜ å°„ HTTP ç«¯å£</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8443:8443&quot;</span>   <span class="comment"># æ˜ å°„ HTTPS ç«¯å£</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;/etc/localtime:/etc/localtime:ro&#x27;</span>                       <span class="comment"># ç¡®ä¿å®¹å™¨ä½¿ç”¨å®¿ä¸»æœºçš„æ—¶åŒºè®¾ç½®</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;./nginx/ssl:/etc/nginx/ssl&#x27;</span>                               <span class="comment"># ç»‘å®š SSL è¯ä¹¦æ–‡ä»¶</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;./nginx/nginx.conf:/etc/nginx/nginx.conf&#x27;</span>                 <span class="comment"># é…ç½® Nginx ä¸»é…ç½®æ–‡ä»¶</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;./nginx/conf.d/ks-console.conf:/etc/nginx/conf.d/default.conf&#x27;</span>  <span class="comment"># é…ç½® KubeSphere æ§åˆ¶å°çš„åå‘ä»£ç†</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;/data/nginx/logs:/var/log/nginx&#x27;</span>                          <span class="comment"># æ˜ å°„æ—¥å¿—æ–‡ä»¶</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD-SHELL&quot;</span>, <span class="string">&quot;curl --silent --fail --insecure https://localhost:8443 || exit 1&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">1m30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">3s</span></span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶è¯´æ˜"><a href="#æ–‡ä»¶è¯´æ˜" class="headerlink" title="æ–‡ä»¶è¯´æ˜"></a>æ–‡ä»¶è¯´æ˜</h3><ul><li><code>ks-console-proxy</code>ï¼šæ­¤æœåŠ¡ä¸º KubeSphere æ§åˆ¶å°æä¾›åå‘ä»£ç†ã€‚</li><li><code>ports</code>ï¼šæ˜ å°„å®¹å™¨çš„ HTTP (8080) å’Œ HTTPS (8443) ç«¯å£ï¼Œæ–¹ä¾¿ç”¨æˆ·é€šè¿‡æµè§ˆå™¨è®¿é—®æ§åˆ¶å°ã€‚</li><li><code>volumes</code>ï¼š<ul><li><code>/etc/localtime:/etc/localtime:ro</code>ï¼šä½¿å®¹å™¨æ—¶åŒºä¸å®¿ä¸»æœºä¸€è‡´ã€‚</li><li><code>./nginx/ssl:/etc/nginx/ssl</code>ï¼šå­˜æ”¾ SSL è¯ä¹¦çš„ç›®å½•ï¼Œç”¨äºåŠ å¯† HTTPS è®¿é—®ã€‚</li><li><code>./nginx/nginx.conf:/etc/nginx/nginx.conf</code>ï¼šNginx çš„ä¸»é…ç½®æ–‡ä»¶ã€‚</li><li><code>./nginx/conf.d/ks-console.conf:/etc/nginx/conf.d/default.conf</code>ï¼šé…ç½® KubeSphere æ§åˆ¶å°çš„åå‘ä»£ç†è§„åˆ™ã€‚</li><li><code>/data/nginx/logs:/var/log/nginx</code>ï¼šå®¹å™¨çš„æ—¥å¿—æ–‡ä»¶å­˜æ”¾ç›®å½•ã€‚</li></ul></li><li><code>healthcheck</code>ï¼šé…ç½®å¥åº·æ£€æŸ¥ï¼Œç¡®ä¿å®¹å™¨æ­£å¸¸è¿è¡Œã€‚</li></ul><h3 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h3><p>åœ¨æ‚¨çš„æœåŠ¡å™¨ä¸Šï¼Œåˆ›å»ºä»¥ä¸‹ç›®å½•ç»“æ„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ks-console</span><br><span class="line">â”œâ”€â”€ docker-compose.yaml           # Docker Compose é…ç½®æ–‡ä»¶</span><br><span class="line">â””â”€â”€ nginx</span><br><span class="line">    â”œâ”€â”€ conf.d</span><br><span class="line">    â”‚   â””â”€â”€ ks-console.conf      # KubeSphere æ§åˆ¶å°çš„ä»£ç†é…ç½®æ–‡ä»¶</span><br><span class="line">    â”œâ”€â”€ nginx.conf               # Nginx ä¸»é…ç½®æ–‡ä»¶</span><br><span class="line">    â””â”€â”€ ssl</span><br><span class="line">        â”œâ”€â”€ kubesphere.k8scluster.com.crt  # KubeSphere SSL è¯ä¹¦</span><br><span class="line">        â””â”€â”€ kubesphere.k8scluster.com.key  # KubeSphere SSL å¯†é’¥</span><br></pre></td></tr></table></figure><h3 id="é…ç½®æ–‡ä»¶ç¤ºä¾‹"><a href="#é…ç½®æ–‡ä»¶ç¤ºä¾‹" class="headerlink" title="é…ç½®æ–‡ä»¶ç¤ºä¾‹"></a>é…ç½®æ–‡ä»¶ç¤ºä¾‹</h3><ol><li><p><strong>Nginx é…ç½®æ–‡ä»¶ <code>nginx.conf</code></strong>ï¼ˆä½äº <code>./nginx/nginx.conf</code>ï¼‰ï¼š</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">user</span> nginx;</span><br><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"><span class="attribute">error_log</span> /var/log/nginx/<span class="literal">error</span>.log;</span><br><span class="line"><span class="attribute">pid</span> /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       /etc/nginx/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/access.log;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nopush</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span> <span class="number">65</span>;</span><br><span class="line">    <span class="attribute">types_hash_max_size</span> <span class="number">2048</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>KubeSphere æ§åˆ¶å°ä»£ç†é…ç½® <code>ks-console.conf</code></strong>ï¼ˆä½äº <code>./nginx/conf.d/ks-console.conf</code>ï¼‰ï¼š</p><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment"># HTTP server</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_name</span> kubesphere.k8scluster.com;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¼ºåˆ¶å°†æ‰€æœ‰ HTTP æµé‡é‡å®šå‘åˆ° HTTPS</span></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span>:8443<span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTPS server</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8443</span> ssl;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">server_name</span> kubesphere.k8scluster.com;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¿é—®æ—¥å¿—å’Œé”™è¯¯æ—¥å¿—é…ç½®</span></span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/access.log main;</span><br><span class="line">    <span class="attribute">error_log</span>  /var/log/nginx/<span class="literal">error</span>.log;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># é»˜è®¤é¦–é¡µæ–‡ä»¶</span></span><br><span class="line">    <span class="attribute">index</span> index.html index.htm;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># SSL é…ç½®</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span>     /etc/nginx/ssl/kubesphere.k8scluster.com.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/kubesphere.k8scluster.com.key;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> <span class="string">&quot;EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH&quot;</span>;</span><br><span class="line">    <span class="attribute">ssl_ecdh_curve</span> secp384r1;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">10m</span>;</span><br><span class="line">    <span class="attribute">ssl_session_tickets</span> <span class="literal">off</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">add_header</span> Strict-Transport-Security <span class="string">&quot;max-age=63072000; includeSubDomains&quot;</span>;</span><br><span class="line">    <span class="attribute">add_header</span> X-Frame-Options DENY;</span><br><span class="line">    <span class="attribute">add_header</span> X-Content-Type-Options nosniff;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¼ºåˆ¶ HTTPS åè®®</span></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$ssl_protocol</span> = <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å…¨å±€ä»£ç†è®¾ç½®</span></span><br><span class="line">    <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span>    Host <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span>    X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span>    X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    <span class="attribute">proxy_connect_timeout</span> <span class="number">3600s</span>;</span><br><span class="line">    <span class="attribute">proxy_read_timeout</span>  <span class="number">3600s</span>;</span><br><span class="line">    <span class="attribute">proxy_send_timeout</span>  <span class="number">3600s</span>;</span><br><span class="line">    <span class="attribute">send_timeout</span>        <span class="number">3600s</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»£ç†åˆ° KubeSphere æ§åˆ¶å°</span></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://&lt;kubesphere_address&gt;:30880;  <span class="comment"># æ›¿æ¢ä¸º KubeSphere æ§åˆ¶å°å®é™…åœ°å€</span></span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># API è·¯å¾„ä»£ç†</span></span><br><span class="line">    <span class="section">location</span> /api/ &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://&lt;kubesphere_address&gt;:30880;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>    Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>    X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>    Connection <span class="string">&quot;upgrade&quot;</span>; </span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¸€äº›ç‰¹å®š API è·¯å¾„ä»£ç†</span></span><br><span class="line">    <span class="section">location</span> <span class="regexp">~ /apis/monitoring.coreos.com/|/api/v1/|/apis/storage.k8s.io|/apis/apps/v1/namespaces/|/kapis/resources.kubesphere.io/v1alpha2/namespaces|/kapis/resources.kubesphere.io/|/apis/devops.kubesphere.io/|/apis/apps/v1/|/apis/|/api/v1/watch/namespaces|/kapis/terminal.kubesphere.io/</span> &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://&lt;kubesphere_address&gt;:30880;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol><h3 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h3><p>å®Œæˆé…ç½®åï¼Œè¿›å…¥ <code>ks-console</code> ç›®å½•å¹¶è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨ Nginx ä»£ç†æœåŠ¡ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><p>é€šè¿‡æµè§ˆå™¨è®¿é—® KubeSphere æ§åˆ¶å°ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿé€šè¿‡é…ç½®çš„è‡ªå®šä¹‰åŸŸåè®¿é—®æ§åˆ¶å°ï¼Œå¦‚ <code>https://kubesphere.k8scluster.com:8443</code>ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•åœ¨ Kubernetes é›†ç¾¤ä¸­åœ¨çº¿å®‰è£… KubeSphereï¼Œè¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å®¹å™¨ç®¡ç†å¹³å°ï¼Œèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·æ–¹ä¾¿åœ°ç®¡ç† Kubernetes ç¯å¢ƒã€‚æˆ‘ä»¬å°†é€šè¿‡ Helm è¿›è¡Œå®‰è£…ï¼Œè¯¦ç»†è®²è§£æ¯ä¸€æ­¥çš„æ“ä½œæµç¨‹ï¼Œå¹¶å±•ç¤ºå¦‚ä½•é€šè¿‡æµè§ˆå™¨è®¿é—® KubeSphere æ§åˆ¶å°ã€‚æœ€åï¼Œæˆ‘ä»¬è¿˜ä¼šæä¾›å¸è½½ KubeSphere çš„æ­¥éª¤ï¼Œå¸®åŠ©æ‚¨è½»æ¾ç®¡ç†å¹³å°çš„ç”Ÿå‘½å‘¨æœŸã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Kubernetes" scheme="https://freemankevin.uk/categories/Kubernetes/"/>
    
    
    <category term="Linux" scheme="https://freemankevin.uk/tags/Linux/"/>
    
    <category term="KubeSphere" scheme="https://freemankevin.uk/tags/KubeSphere/"/>
    
    <category term="Helm" scheme="https://freemankevin.uk/tags/Helm/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åœ¨Kubernetes ç¯å¢ƒä¸­å®‰è£… INGRESS-NGINX</title>
    <link href="https://freemankevin.uk/2025/01/21/k8s-ingress-nginx/"/>
    <id>https://freemankevin.uk/2025/01/21/k8s-ingress-nginx/</id>
    <published>2025-01-21T07:57:25.000Z</published>
    <updated>2025-10-21T03:34:40.413Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ Kubernetes ä¸­éƒ¨ç½² Ingress-NGINX æ§åˆ¶å™¨ï¼Œå¹¶é…ç½® HTTP å’Œ HTTPS è®¿é—®ã€‚é€šè¿‡ Helm å·¥å…·ï¼Œæ‚¨å¯ä»¥å¿«é€Ÿå®‰è£…å¹¶è®¾ç½® NGINX æ¥ä»£ç†å¤–éƒ¨æµé‡ï¼ŒåŒæ—¶æš´éœ² NodePort æœåŠ¡ã€‚æˆ‘ä»¬è¿˜ä¼šè®²è§£å¦‚ä½•é…ç½® TLS å®‰å…¨è¿æ¥ï¼Œå¹¶ä½¿ç”¨ Kubernetes Secret æ¥å­˜å‚¨è¯ä¹¦ï¼Œç¡®ä¿æ•°æ®ä¼ è¾“åŠ å¯†ã€‚è·Ÿç€æœ¬æ–‡çš„æ­¥éª¤èµ°ï¼Œæ‚¨å°±èƒ½é¡ºåˆ©å®Œæˆ Ingress éƒ¨ç½²ï¼Œè®©é›†ç¾¤åº”ç”¨è®¿é—®æ›´åŠ ä¾¿æ·å®‰å…¨ã€‚</p><span id="more"></span><h3 id="æ‹‰å–-Helm-åŒ…"><a href="#æ‹‰å–-Helm-åŒ…" class="headerlink" title="æ‹‰å– Helm åŒ…"></a>æ‹‰å– Helm åŒ…</h3><p>é¦–å…ˆï¼Œæ·»åŠ  <code>ingress-nginx</code> å®˜æ–¹ä»“åº“å¹¶æ›´æ–°ä»“åº“ä¿¡æ¯ï¼Œæ¥ç€æ‹‰å–æ‰€éœ€çš„ Helm åŒ…ã€‚</p><h4 id="æ·»åŠ -Helm-ä»“åº“"><a href="#æ·»åŠ -Helm-ä»“åº“" class="headerlink" title="æ·»åŠ  Helm ä»“åº“"></a>æ·»åŠ  Helm ä»“åº“</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure><h4 id="æœç´¢å¹¶æ‹‰å–æŒ‡å®šç‰ˆæœ¬çš„-Helm-åŒ…"><a href="#æœç´¢å¹¶æ‹‰å–æŒ‡å®šç‰ˆæœ¬çš„-Helm-åŒ…" class="headerlink" title="æœç´¢å¹¶æ‹‰å–æŒ‡å®šç‰ˆæœ¬çš„ Helm åŒ…"></a>æœç´¢å¹¶æ‹‰å–æŒ‡å®šç‰ˆæœ¬çš„ Helm åŒ…</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm search repo ingress-nginx/ingress-nginx -l  <span class="comment"># æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬</span></span><br><span class="line">helm pull ingress-nginx/ingress-nginx --version 4.8.3  <span class="comment"># æ‹‰å–æŒ‡å®šç‰ˆæœ¬</span></span><br></pre></td></tr></table></figure><h4 id="è§£å‹-Helm-åŒ…"><a href="#è§£å‹-Helm-åŒ…" class="headerlink" title="è§£å‹ Helm åŒ…"></a>è§£å‹ Helm åŒ…</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tar xf ingress-nginx-4.8.3.tgz</span><br><span class="line"><span class="built_in">cd</span> ingress-nginx</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶-values-yaml"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶-values-yaml" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶ values.yaml"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶ <code>values.yaml</code></h3><p>åœ¨å®‰è£…ä¹‹å‰ï¼Œæ‚¨å¯èƒ½éœ€è¦æ ¹æ®éœ€æ±‚ä¿®æ”¹ <code>values.yaml</code> æ–‡ä»¶ï¼Œä»¥é…ç½® <code>ingress-nginx</code> æ§åˆ¶å™¨çš„è¡Œä¸ºã€‚å¸¸è§çš„é…ç½®ä¿®æ”¹åŒ…æ‹¬æš´éœ² NodePort ç«¯å£ã€‚</p><h4 id="ç¼–è¾‘-values-yaml-æ–‡ä»¶"><a href="#ç¼–è¾‘-values-yaml-æ–‡ä»¶" class="headerlink" title="ç¼–è¾‘ values.yaml æ–‡ä»¶"></a>ç¼–è¾‘ <code>values.yaml</code> æ–‡ä»¶</h4><p>ä¿®æ”¹ <code>values.yaml</code> æ–‡ä»¶ä¸­çš„ <code>service</code> é…ç½®ï¼Œå°† <code>type</code> è®¾ç½®ä¸º <code>NodePort</code>ï¼Œå¹¶é…ç½® <code>nodePorts</code>ã€‚</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>  <span class="comment"># è®¾ç½®ä¸º NodePort ç±»å‹</span></span><br><span class="line">  <span class="attr">nodePorts:</span></span><br><span class="line">    <span class="attr">http:</span> <span class="string">&quot;30886&quot;</span>  <span class="comment"># HTTP ç«¯å£</span></span><br><span class="line">    <span class="attr">https:</span> <span class="string">&quot;30887&quot;</span>  <span class="comment"># HTTPS ç«¯å£</span></span><br><span class="line">    <span class="attr">tcp:</span> &#123;&#125;  <span class="comment"># TCP ç«¯å£é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰</span></span><br><span class="line">    <span class="attr">udp:</span> &#123;&#125;  <span class="comment"># UDP ç«¯å£é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰</span></span><br></pre></td></tr></table></figure><h3 id="å®‰è£…-ingress-nginx-æ§åˆ¶å™¨"><a href="#å®‰è£…-ingress-nginx-æ§åˆ¶å™¨" class="headerlink" title="å®‰è£… ingress-nginx æ§åˆ¶å™¨"></a>å®‰è£… <code>ingress-nginx</code> æ§åˆ¶å™¨</h3><p>å®‰è£… <code>ingress-nginx</code> æ§åˆ¶å™¨å¹¶åˆ›å»ºä¸€ä¸ª <code>ingress-nginx</code> å‘½åç©ºé—´ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">helm upgrade --install ingress-nginx ./ingress-nginx --namespace ingress-nginx --create-namespace</span><br></pre></td></tr></table></figure><p>å®‰è£…å®Œæˆåï¼Œæ‚¨å°†çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹è¾“å‡ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Release &quot;ingress-nginx&quot; does not exist. Installing it now.</span><br><span class="line">NAME: ingress-nginx</span><br><span class="line">LAST DEPLOYED: Sat Dec 23 11:00:59 2023</span><br><span class="line">NAMESPACE: ingress-nginx</span><br><span class="line">STATUS: deployed</span><br></pre></td></tr></table></figure><h3 id="é…ç½®å¹¶æµ‹è¯•-Ingress"><a href="#é…ç½®å¹¶æµ‹è¯•-Ingress" class="headerlink" title="é…ç½®å¹¶æµ‹è¯• Ingress"></a>é…ç½®å¹¶æµ‹è¯• Ingress</h3><h4 id="åˆ›å»ºä¸€ä¸ªç®€å•çš„åº”ç”¨æœåŠ¡"><a href="#åˆ›å»ºä¸€ä¸ªç®€å•çš„åº”ç”¨æœåŠ¡" class="headerlink" title="åˆ›å»ºä¸€ä¸ªç®€å•çš„åº”ç”¨æœåŠ¡"></a>åˆ›å»ºä¸€ä¸ªç®€å•çš„åº”ç”¨æœåŠ¡</h4><p>ä¸ºæµ‹è¯• <code>Ingress</code> æ§åˆ¶å™¨ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªç®€å•çš„ HTTP æœåŠ¡ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create deployment demo --image=httpd --port=80</span><br><span class="line">kubectl expose deployment demo</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»º-Ingress-èµ„æº"><a href="#åˆ›å»º-Ingress-èµ„æº" class="headerlink" title="åˆ›å»º Ingress èµ„æº"></a>åˆ›å»º Ingress èµ„æº</h4><p>åˆ›å»ºä¸€ä¸ª <code>Ingress</code> èµ„æºï¼Œé…ç½®ä¸€ä¸ªç®€å•çš„è·¯ç”±è§„åˆ™ï¼ŒæŒ‡å‘åˆšæ‰æš´éœ²çš„ <code>demo</code> æœåŠ¡ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create ingress demo-localhost --class=nginx \</span><br><span class="line">  --rule=<span class="string">&quot;demo.localdev.me/*=demo:80&quot;</span></span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨-kubectl-port-forward-è¿›è¡Œæœ¬åœ°è®¿é—®"><a href="#ä½¿ç”¨-kubectl-port-forward-è¿›è¡Œæœ¬åœ°è®¿é—®" class="headerlink" title="ä½¿ç”¨ kubectl port-forward è¿›è¡Œæœ¬åœ°è®¿é—®"></a>ä½¿ç”¨ <code>kubectl port-forward</code> è¿›è¡Œæœ¬åœ°è®¿é—®</h4><p>é€šè¿‡ <code>port-forward</code> å°† Ingress æ§åˆ¶å™¨æš´éœ²åˆ°æœ¬åœ°ç«¯å£ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl port-forward --namespace=ingress-nginx service/ingress-nginx-controller 8080:80</span><br></pre></td></tr></table></figure><p>æ¥ç€ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æµ‹è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl --resolve demo.localdev.me:8080:127.0.0.1 http://demo.localdev.me:8080</span><br></pre></td></tr></table></figure><p>æ‚¨åº”å½“çœ‹åˆ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure><h3 id="é…ç½®-TLSï¼ˆHTTPSï¼‰"><a href="#é…ç½®-TLSï¼ˆHTTPSï¼‰" class="headerlink" title="é…ç½® TLSï¼ˆHTTPSï¼‰"></a>é…ç½® TLSï¼ˆHTTPSï¼‰</h3><p>ä¸ºäº†å¯ç”¨ HTTPSï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªåŒ…å«è¯ä¹¦å’Œç§é’¥çš„ Kubernetes Secretï¼Œå¹¶åœ¨ <code>Ingress</code> èµ„æºä¸­å¼•ç”¨è¯¥ Secretã€‚</p><h4 id="åˆ›å»º-TLS-è¯ä¹¦"><a href="#åˆ›å»º-TLS-è¯ä¹¦" class="headerlink" title="åˆ›å»º TLS è¯ä¹¦"></a>åˆ›å»º TLS è¯ä¹¦</h4><p>å¦‚æœæ‚¨æ²¡æœ‰ç°æˆçš„è¯ä¹¦ï¼Œå¯ä»¥ä½¿ç”¨ <code>openssl</code> åˆ›å»ºä¸€ä¸ªè‡ªç­¾åè¯ä¹¦ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout demo-tls.key -out demo-tls.crt</span><br></pre></td></tr></table></figure><p>è¿™å°†ç”Ÿæˆ <code>demo-tls.crt</code> å’Œ <code>demo-tls.key</code> æ–‡ä»¶ã€‚</p><h4 id="åˆ›å»º-Kubernetes-TLS-Secret"><a href="#åˆ›å»º-Kubernetes-TLS-Secret" class="headerlink" title="åˆ›å»º Kubernetes TLS Secret"></a>åˆ›å»º Kubernetes TLS Secret</h4><p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†è¯ä¹¦å’Œç§é’¥åˆ›å»ºä¸º Kubernetes Secretï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create secret tls demo-tls-secret \</span><br><span class="line">  --cert=demo-tls.crt \</span><br><span class="line">  --key=demo-tls.key \</span><br><span class="line">  --namespace=default</span><br></pre></td></tr></table></figure><h4 id="é…ç½®-Ingress-ä½¿ç”¨-TLS"><a href="#é…ç½®-Ingress-ä½¿ç”¨-TLS" class="headerlink" title="é…ç½® Ingress ä½¿ç”¨ TLS"></a>é…ç½® Ingress ä½¿ç”¨ TLS</h4><p>ç¼–è¾‘æ‚¨çš„ <code>Ingress</code> é…ç½®ï¼Œå¼•ç”¨åˆšåˆšåˆ›å»ºçš„ <code>demo-tls-secret</code>ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo-tls-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.demo.io</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">demo</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">www.demo.io</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">demo-tls-secret</span>  <span class="comment"># å¼•ç”¨ TLS Secret</span></span><br></pre></td></tr></table></figure><h4 id="æµ‹è¯•-TLS-é…ç½®"><a href="#æµ‹è¯•-TLS-é…ç½®" class="headerlink" title="æµ‹è¯• TLS é…ç½®"></a>æµ‹è¯• TLS é…ç½®</h4><p>åœ¨ <code>Ingress</code> é…ç½®å®Œæˆåï¼Œæ‚¨å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—® <code>https://www.demo.io</code> æ¥éªŒè¯ HTTPS æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚å¦‚æœä¸€åˆ‡é…ç½®æ­£ç¡®ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿå®‰å…¨åœ°è®¿é—®æ‚¨çš„æœåŠ¡ã€‚</p><h3 id="é…ç½®æœ¬åœ°-DNSï¼ˆå¯é€‰ï¼‰"><a href="#é…ç½®æœ¬åœ°-DNSï¼ˆå¯é€‰ï¼‰" class="headerlink" title="é…ç½®æœ¬åœ° DNSï¼ˆå¯é€‰ï¼‰"></a>é…ç½®æœ¬åœ° DNSï¼ˆå¯é€‰ï¼‰</h3><p>å¦‚æœæ‚¨å¸Œæœ›ä½¿ç”¨è‡ªå®šä¹‰åŸŸåè®¿é—®æœåŠ¡ï¼Œå¯ä»¥ä¿®æ”¹æœ¬åœ° <code>hosts</code> æ–‡ä»¶ï¼Œå°†åŸŸåæŒ‡å‘ç›¸åº”çš„ IP åœ°å€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;192.168.1.120 www.demo.io&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> -a /etc/hosts</span><br></pre></td></tr></table></figure><p>ä¹‹åï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—® <code>http://www.demo.io:30886/</code> æˆ– <code>https://www.demo.io:30887/</code> æ¥éªŒè¯æœåŠ¡ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæ‚¨æˆåŠŸå®‰è£…å¹¶é…ç½®äº† <code>ingress-nginx</code> æ§åˆ¶å™¨ï¼Œå¹¶é€šè¿‡ Kubernetes Secret é…ç½®äº† TLS åŠ å¯†è¿æ¥ï¼Œç¡®ä¿äº†æµé‡çš„å®‰å…¨ä¼ è¾“ã€‚æ‚¨è¿˜å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ç«¯å£ã€è¯ä¹¦å’ŒåŸŸåç­‰é…ç½®ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–æ‚¨çš„éƒ¨ç½²ã€‚</p><h3 id="Q-A"><a href="#Q-A" class="headerlink" title="Q &amp; A"></a>Q &amp; A</h3><ol><li><p><strong>å¦‚ä½•ä¿®æ”¹æš´éœ²ç«¯å£ï¼Ÿ</strong><br>æ‚¨å¯ä»¥é€šè¿‡ç¼–è¾‘ <code>values.yaml</code> æ–‡ä»¶ä¸­çš„ <code>nodePorts</code> é…ç½®é¡¹ï¼Œæ¥ä¿®æ”¹æš´éœ²çš„ç«¯å£å·ã€‚</p></li><li><p><strong>å¦‚ä½•å¯ç”¨ TLSï¼Ÿ</strong><br>åœ¨ <code>Ingress</code> é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  <code>tls</code> éƒ¨åˆ†ï¼Œå¹¶ç¡®ä¿ Secret åŒ…å«æœ‰æ•ˆçš„è¯ä¹¦å’Œç§é’¥ã€‚</p></li><li><p><strong>å¦‚æœä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼Ÿ</strong><br>ä½¿ç”¨è‡ªç­¾åè¯ä¹¦æ—¶ï¼Œæµè§ˆå™¨å¯èƒ½ä¼šæ˜¾ç¤ºä¸å—ä¿¡ä»»çš„è­¦å‘Šï¼Œæ‚¨å¯ä»¥å¿½ç•¥è¿™ä¸ªè­¦å‘Šï¼Œæˆ–è€…åœ¨æµè§ˆå™¨ä¸­å°†è¯ä¹¦æ·»åŠ åˆ°ä¿¡ä»»åˆ—è¡¨ã€‚</p></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ Kubernetes ä¸­éƒ¨ç½² Ingress-NGINX æ§åˆ¶å™¨ï¼Œå¹¶é…ç½® HTTP å’Œ HTTPS è®¿é—®ã€‚é€šè¿‡ Helm å·¥å…·ï¼Œæ‚¨å¯ä»¥å¿«é€Ÿå®‰è£…å¹¶è®¾ç½® NGINX æ¥ä»£ç†å¤–éƒ¨æµé‡ï¼ŒåŒæ—¶æš´éœ² NodePort æœåŠ¡ã€‚æˆ‘ä»¬è¿˜ä¼šè®²è§£å¦‚ä½•é…ç½® TLS å®‰å…¨è¿æ¥ï¼Œå¹¶ä½¿ç”¨ Kubernetes Secret æ¥å­˜å‚¨è¯ä¹¦ï¼Œç¡®ä¿æ•°æ®ä¼ è¾“åŠ å¯†ã€‚è·Ÿç€æœ¬æ–‡çš„æ­¥éª¤èµ°ï¼Œæ‚¨å°±èƒ½é¡ºåˆ©å®Œæˆ Ingress éƒ¨ç½²ï¼Œè®©é›†ç¾¤åº”ç”¨è®¿é—®æ›´åŠ ä¾¿æ·å®‰å…¨ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Kubernetes" scheme="https://freemankevin.uk/categories/Kubernetes/"/>
    
    
    <category term="TLS" scheme="https://freemankevin.uk/tags/TLS/"/>
    
    <category term="KubeSphere" scheme="https://freemankevin.uk/tags/KubeSphere/"/>
    
    <category term="Ingress-NGINX" scheme="https://freemankevin.uk/tags/Ingress-NGINX/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åœ¨Kubernetes ç¯å¢ƒä¸­éƒ¨ç½²ArgoCD</title>
    <link href="https://freemankevin.uk/2025/01/15/k8s-argocd/"/>
    <id>https://freemankevin.uk/2025/01/15/k8s-argocd/</id>
    <published>2025-01-15T09:47:25.000Z</published>
    <updated>2025-10-21T03:34:40.412Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æœ¬æ–‡è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½²é«˜å¯ç”¨çš„ ArgoCDï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯å·¥å…·å®‰è£…ã€æœåŠ¡ç«¯éƒ¨ç½²ã€TLS é…ç½®ã€ç”¨æˆ·è®¤è¯ã€RBAC æƒé™ç®¡ç†ç­‰å®Œæ•´çš„éƒ¨ç½²å’Œé…ç½®æµç¨‹ã€‚</p><span id="more"></span><h2 id="ç¯å¢ƒè¦æ±‚"><a href="#ç¯å¢ƒè¦æ±‚" class="headerlink" title="ç¯å¢ƒè¦æ±‚"></a>ç¯å¢ƒè¦æ±‚</h2><h3 id="åŸºç¡€ç¯å¢ƒ"><a href="#åŸºç¡€ç¯å¢ƒ" class="headerlink" title="åŸºç¡€ç¯å¢ƒ"></a>åŸºç¡€ç¯å¢ƒ</h3><ul><li>Kubernetes é›†ç¾¤ (ç‰ˆæœ¬ &gt;&#x3D; 1.21)</li><li>è‡³å°‘ä¸‰ä¸ª Worker èŠ‚ç‚¹ï¼ˆç”¨äº HA éƒ¨ç½²ï¼‰</li><li>å¯ç”¨çš„æŒä¹…åŒ–å­˜å‚¨</li><li>é›†ç¾¤è´Ÿè½½å‡è¡¡èƒ½åŠ›</li></ul><h3 id="ç‰ˆæœ¬é€‰æ‹©"><a href="#ç‰ˆæœ¬é€‰æ‹©" class="headerlink" title="ç‰ˆæœ¬é€‰æ‹©"></a>ç‰ˆæœ¬é€‰æ‹©</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç‰ˆæœ¬å…¼å®¹æ€§</span></span><br><span class="line"><span class="comment"># https://argo-cd.readthedocs.io/en/stable/operator-manual/installation/#tested-versions</span></span><br></pre></td></tr></table></figure><h2 id="å®¢æˆ·ç«¯å®‰è£…"><a href="#å®¢æˆ·ç«¯å®‰è£…" class="headerlink" title="å®¢æˆ·ç«¯å®‰è£…"></a>å®¢æˆ·ç«¯å®‰è£…</h2><h3 id="ä¸‹è½½å®‰è£…"><a href="#ä¸‹è½½å®‰è£…" class="headerlink" title="ä¸‹è½½å®‰è£…"></a>ä¸‹è½½å®‰è£…</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½ ArgoCD CLI</span></span><br><span class="line">curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/download/v2.9.2/argocd-linux-amd64</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…åˆ°ç³»ç»Ÿç›®å½•</span></span><br><span class="line"><span class="built_in">sudo</span> install -m 555 argocd-linux-amd64 /usr/local/bin/argocd</span><br><span class="line"><span class="built_in">rm</span> argocd-linux-amd64</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯å®‰è£…</span></span><br><span class="line">argocd version</span><br></pre></td></tr></table></figure><h3 id="å¤šèŠ‚ç‚¹éƒ¨ç½²"><a href="#å¤šèŠ‚ç‚¹éƒ¨ç½²" class="headerlink" title="å¤šèŠ‚ç‚¹éƒ¨ç½²"></a>å¤šèŠ‚ç‚¹éƒ¨ç½²</h3><p>åœ¨æ‰€æœ‰éœ€è¦ä½¿ç”¨ ArgoCD CLI çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œå®‰è£…ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ†å‘ CLI åˆ°å…¶ä»–èŠ‚ç‚¹ï¼ˆæ ¹æ®å®é™…ç¯å¢ƒä¿®æ”¹èŠ‚ç‚¹åç§°ï¼‰</span></span><br><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> &lt;node1&gt; &lt;node2&gt; &lt;node3&gt;; <span class="keyword">do</span></span><br><span class="line">  scp /usr/local/bin/argocd <span class="variable">$node</span>:/usr/local/bin/</span><br><span class="line">  ssh <span class="variable">$node</span> <span class="string">&quot;chmod +x /usr/local/bin/argocd&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="æœåŠ¡ç«¯éƒ¨ç½²"><a href="#æœåŠ¡ç«¯éƒ¨ç½²" class="headerlink" title="æœåŠ¡ç«¯éƒ¨ç½²"></a>æœåŠ¡ç«¯éƒ¨ç½²</h2><h3 id="å‡†å¤‡å‘½åç©ºé—´"><a href="#å‡†å¤‡å‘½åç©ºé—´" class="headerlink" title="å‡†å¤‡å‘½åç©ºé—´"></a>å‡†å¤‡å‘½åç©ºé—´</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸“ç”¨å‘½åç©ºé—´</span></span><br><span class="line">kubectl create namespace argocd</span><br></pre></td></tr></table></figure><h3 id="éƒ¨ç½²-ArgoCD"><a href="#éƒ¨ç½²-ArgoCD" class="headerlink" title="éƒ¨ç½² ArgoCD"></a>éƒ¨ç½² ArgoCD</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ  Helm ä»“åº“</span></span><br><span class="line">helm repo add argo https://argoproj.github.io/argo-helm</span><br><span class="line">helm repo update</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºé…ç½®æ–‡ä»¶ values.yaml</span></span><br><span class="line"><span class="built_in">cat</span> &gt; values.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"># å…¨å±€é…ç½®</span></span><br><span class="line"><span class="string">global:</span></span><br><span class="line"><span class="string">  image:</span></span><br><span class="line"><span class="string">    repository: quay.io/argoproj/argocd</span></span><br><span class="line"><span class="string">    tag: v2.9.2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># HA é…ç½®</span></span><br><span class="line"><span class="string">controller:</span></span><br><span class="line"><span class="string">  replicas: 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">server:</span></span><br><span class="line"><span class="string">  replicas: 2</span></span><br><span class="line"><span class="string">  service:</span></span><br><span class="line"><span class="string">    type: NodePort</span></span><br><span class="line"><span class="string">    nodePortHttp: &lt;HTTP_PORT&gt;    # ä¾‹å¦‚ï¼š30884</span></span><br><span class="line"><span class="string">    nodePortHttps: &lt;HTTPS_PORT&gt;  # ä¾‹å¦‚ï¼š30885</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Redis HA é…ç½®</span></span><br><span class="line"><span class="string">redis-ha:</span></span><br><span class="line"><span class="string">  enabled: true</span></span><br><span class="line"><span class="string">  persistentVolume:</span></span><br><span class="line"><span class="string">    enabled: true</span></span><br><span class="line"><span class="string">    size: 8Gi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># è®¤è¯é…ç½®</span></span><br><span class="line"><span class="string">dex:</span></span><br><span class="line"><span class="string">  enabled: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># èµ„æºé™åˆ¶</span></span><br><span class="line"><span class="string">resources:</span></span><br><span class="line"><span class="string">  limits:</span></span><br><span class="line"><span class="string">    cpu: 500m</span></span><br><span class="line"><span class="string">    memory: 512Mi</span></span><br><span class="line"><span class="string">  requests:</span></span><br><span class="line"><span class="string">    cpu: 250m</span></span><br><span class="line"><span class="string">    memory: 256Mi</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… ArgoCD</span></span><br><span class="line">helm install argocd argo/argo-cd \</span><br><span class="line">  --namespace argocd \</span><br><span class="line">  --values values.yaml</span><br></pre></td></tr></table></figure><h3 id="éªŒè¯éƒ¨ç½²"><a href="#éªŒè¯éƒ¨ç½²" class="headerlink" title="éªŒè¯éƒ¨ç½²"></a>éªŒè¯éƒ¨ç½²</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥ Pod çŠ¶æ€</span></span><br><span class="line">kubectl get pods -n argocd</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥æœåŠ¡çŠ¶æ€</span></span><br><span class="line">kubectl get svc -n argocd</span><br></pre></td></tr></table></figure><h2 id="è®¿é—®é…ç½®"><a href="#è®¿é—®é…ç½®" class="headerlink" title="è®¿é—®é…ç½®"></a>è®¿é—®é…ç½®</h2><h3 id="æš´éœ²æœåŠ¡"><a href="#æš´éœ²æœåŠ¡" class="headerlink" title="æš´éœ²æœåŠ¡"></a>æš´éœ²æœåŠ¡</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é…ç½® NodePort è®¿é—®ï¼ˆç«¯å£å·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰</span></span><br><span class="line">kubectl patch svc argocd-server -n argocd -p <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;spec&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;type&quot;: &quot;NodePort&quot;,</span></span><br><span class="line"><span class="string">    &quot;ports&quot;: [</span></span><br><span class="line"><span class="string">      &#123;&quot;nodePort&quot;: &lt;HTTP_PORT&gt;, &quot;port&quot;: 80&#125;,</span></span><br><span class="line"><span class="string">      &#123;&quot;nodePort&quot;: &lt;HTTPS_PORT&gt;, &quot;port&quot;: 443&#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="é…ç½®-DNS"><a href="#é…ç½®-DNS" class="headerlink" title="é…ç½® DNS"></a>é…ç½® DNS</h3><p>åœ¨ CoreDNS ä¸­æ·»åŠ è§£æï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¾‘ CoreDNS é…ç½®</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">-n</span> <span class="string">kube-system</span> <span class="string">edit</span> <span class="string">cm</span> <span class="string">coredns</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ ä»¥ä¸‹é…ç½®ï¼ˆæ›¿æ¢ä¸ºå®é™…çš„ IP å’ŒåŸŸåï¼‰</span></span><br><span class="line"><span class="string">hosts</span> &#123;</span><br><span class="line">  <span class="string">&lt;NODE_IP&gt;</span> <span class="string">&lt;ARGOCD_DOMAIN&gt;</span>  <span class="comment"># ä¾‹å¦‚ï¼šargocd.example.com</span></span><br><span class="line">  <span class="string">fallthrough</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯ CoreDNS</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">pod</span> <span class="string">-n</span> <span class="string">kube-system</span> <span class="string">-l</span> <span class="string">k8s-app=kube-dns</span></span><br></pre></td></tr></table></figure><h2 id="åˆå§‹é…ç½®"><a href="#åˆå§‹é…ç½®" class="headerlink" title="åˆå§‹é…ç½®"></a>åˆå§‹é…ç½®</h2><h3 id="è·å–åˆå§‹å¯†ç "><a href="#è·å–åˆå§‹å¯†ç " class="headerlink" title="è·å–åˆå§‹å¯†ç "></a>è·å–åˆå§‹å¯†ç </h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è·å–ç®¡ç†å‘˜å¯†ç </span></span><br><span class="line">kubectl -n argocd get secret argocd-initial-admin-secret \</span><br><span class="line">  -o jsonpath=<span class="string">&quot;&#123;.data.password&#125;&quot;</span> | <span class="built_in">base64</span> -d</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹å¯†ç "><a href="#ä¿®æ”¹å¯†ç " class="headerlink" title="ä¿®æ”¹å¯†ç "></a>ä¿®æ”¹å¯†ç </h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç™»å½• ArgoCDï¼ˆä½¿ç”¨å®é™…çš„åŸŸåå’Œç«¯å£ï¼‰</span></span><br><span class="line">argocd login &lt;ARGOCD_DOMAIN&gt;:&lt;PORT&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹å¯†ç </span></span><br><span class="line">argocd account update-password</span><br></pre></td></tr></table></figure><h2 id="RBAC-é…ç½®"><a href="#RBAC-é…ç½®" class="headerlink" title="RBAC é…ç½®"></a>RBAC é…ç½®</h2><h3 id="è§’è‰²é…ç½®"><a href="#è§’è‰²é…ç½®" class="headerlink" title="è§’è‰²é…ç½®"></a>è§’è‰²é…ç½®</h3><p>ç¼–è¾‘ <code>argocd-rbac-cm</code> é…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">argocd-rbac-cm</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">argocd</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">policy.csv:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    # é¡¹ç›®ç®¡ç†å‘˜è§’è‰²</span></span><br><span class="line"><span class="string">    p, role:project-admin, applications, create, project/*, allow</span></span><br><span class="line"><span class="string">    p, role:project-admin, applications, delete, project/*, allow</span></span><br><span class="line"><span class="string">    p, role:project-admin, applications, sync, project/*, allow</span></span><br><span class="line"><span class="string">    p, role:project-admin, applications, update, project/*, allow</span></span><br><span class="line"><span class="string">    p, role:project-admin, logs, get, project/*, allow</span></span><br><span class="line"><span class="string"></span>    </span><br><span class="line">    <span class="comment"># åªè¯»è§’è‰²</span></span><br><span class="line">    <span class="string">p,</span> <span class="string">role:readonly,</span> <span class="string">applications,</span> <span class="string">get,</span> <span class="string">*/*,</span> <span class="string">allow</span></span><br><span class="line">    <span class="string">p,</span> <span class="string">role:readonly,</span> <span class="string">logs,</span> <span class="string">get,</span> <span class="string">*/*,</span> <span class="string">allow</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç”¨æˆ·ç»„æ˜ å°„</span></span><br><span class="line">    <span class="string">g,</span> <span class="string">project-admins,</span> <span class="string">role:project-admin</span></span><br><span class="line">    <span class="string">g,</span> <span class="string">viewers,</span> <span class="string">role:readonly</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">policy.default:</span> <span class="string">role:readonly</span></span><br></pre></td></tr></table></figure><h3 id="ç”¨æˆ·ç®¡ç†"><a href="#ç”¨æˆ·ç®¡ç†" class="headerlink" title="ç”¨æˆ·ç®¡ç†"></a>ç”¨æˆ·ç®¡ç†</h3><p>ç¼–è¾‘ <code>argocd-cm</code> é…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">argocd-cm</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">argocd</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># å¯ç”¨æœ¬åœ°ç”¨æˆ·</span></span><br><span class="line">  <span class="attr">accounts.project-admin:</span> <span class="string">apiKey,login</span></span><br><span class="line">  <span class="attr">accounts.viewer:</span> <span class="string">login</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># OIDC é…ç½®ï¼ˆå¯é€‰ï¼Œæ ¹æ®å®é™…ç¯å¢ƒé…ç½®ï¼‰</span></span><br><span class="line">  <span class="attr">oidc.config:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    name: &lt;SSO_PROVIDER&gt;</span></span><br><span class="line"><span class="string">    issuer: https://&lt;SSO_URL&gt;/auth/realms/&lt;REALM_NAME&gt;</span></span><br><span class="line"><span class="string">    clientID: &lt;CLIENT_ID&gt;</span></span><br><span class="line"><span class="string">    clientSecret: &lt;CLIENT_SECRET&gt;</span></span><br></pre></td></tr></table></figure><h2 id="é«˜çº§é…ç½®"><a href="#é«˜çº§é…ç½®" class="headerlink" title="é«˜çº§é…ç½®"></a>é«˜çº§é…ç½®</h2><h3 id="èµ„æºé™åˆ¶"><a href="#èµ„æºé™åˆ¶" class="headerlink" title="èµ„æºé™åˆ¶"></a>èµ„æºé™åˆ¶</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®èµ„æºé™åˆ¶</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">argocd-application-controller</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br></pre></td></tr></table></figure><h3 id="TLS-é…ç½®"><a href="#TLS-é…ç½®" class="headerlink" title="TLS é…ç½®"></a>TLS é…ç½®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º TLS è¯ä¹¦ï¼ˆä½¿ç”¨å®é™…çš„è¯ä¹¦æ–‡ä»¶ï¼‰</span></span><br><span class="line">kubectl create secret tls argocd-server-tls \</span><br><span class="line">  --cert=&lt;CERT_FILE&gt; \</span><br><span class="line">  --key=&lt;KEY_FILE&gt; \</span><br><span class="line">  -n argocd</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½® ArgoCD ä½¿ç”¨è¯ä¹¦</span></span><br><span class="line">kubectl patch deployment argocd-server \</span><br><span class="line">  -n argocd \</span><br><span class="line">  --<span class="built_in">type</span> json \</span><br><span class="line">  -p=<span class="string">&#x27;[&#123;&quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/args/-&quot;, &quot;value&quot;: &quot;--tls.certificate=/etc/argocd/tls/tls.crt&quot;&#125;, &#123;&quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/args/-&quot;, &quot;value&quot;: &quot;--tls.privatekey=/etc/argocd/tls/tls.key&quot;&#125;]&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="æ•…éšœæ’æŸ¥"><a href="#æ•…éšœæ’æŸ¥" class="headerlink" title="æ•…éšœæ’æŸ¥"></a>æ•…éšœæ’æŸ¥</h2><h3 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h3><ol><li>ç™»å½•é—®é¢˜</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">argocd admin initial-password -n argocd</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥æœåŠ¡çŠ¶æ€</span></span><br><span class="line">kubectl get pods -n argocd</span><br><span class="line">kubectl logs -f deployment/argocd-server -n argocd</span><br></pre></td></tr></table></figure><ol start="2"><li>åŒæ­¥å¤±è´¥</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥åº”ç”¨çŠ¶æ€</span></span><br><span class="line">argocd app get &lt;APP_NAME&gt;</span><br><span class="line">argocd app logs &lt;APP_NAME&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥æ§åˆ¶å™¨æ—¥å¿—</span></span><br><span class="line">kubectl logs -f deployment/argocd-application-controller -n argocd</span><br></pre></td></tr></table></figure><h3 id="å¥åº·æ£€æŸ¥"><a href="#å¥åº·æ£€æŸ¥" class="headerlink" title="å¥åº·æ£€æŸ¥"></a>å¥åº·æ£€æŸ¥</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥ç»„ä»¶çŠ¶æ€</span></span><br><span class="line">kubectl get pods -n argocd</span><br><span class="line">kubectl get svc -n argocd</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€</span></span><br><span class="line">argocd admin cluster info</span><br></pre></td></tr></table></figure><h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><h3 id="å®‰å…¨å»ºè®®"><a href="#å®‰å…¨å»ºè®®" class="headerlink" title="å®‰å…¨å»ºè®®"></a>å®‰å…¨å»ºè®®</h3><ul><li>åŠæ—¶æ›´æ–° ArgoCD ç‰ˆæœ¬</li><li>ä½¿ç”¨ HTTPS å’Œè¯ä¹¦</li><li>å®æ–½æœ€å°æƒé™åŸåˆ™</li><li>å®šæœŸè½®æ¢å¯†é’¥å’Œè¯ä¹¦</li><li>å¯ç”¨å®¡è®¡æ—¥å¿—</li></ul><h3 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h3><ul><li>åˆç†é…ç½®èµ„æºé™åˆ¶</li><li>ä½¿ç”¨ Redis HA æé«˜å¯ç”¨æ€§</li><li>é…ç½®åˆé€‚çš„åŒæ­¥å‘¨æœŸ</li><li>ä½¿ç”¨é¡¹ç›®é…ç½®é™åˆ¶èµ„æºèŒƒå›´</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; æœ¬æ–‡è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½²é«˜å¯ç”¨çš„ ArgoCDï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯å·¥å…·å®‰è£…ã€æœåŠ¡ç«¯éƒ¨ç½²ã€TLS é…ç½®ã€ç”¨æˆ·è®¤è¯ã€RBAC æƒé™ç®¡ç†ç­‰å®Œæ•´çš„éƒ¨ç½²å’Œé…ç½®æµç¨‹ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="DevOps" scheme="https://freemankevin.uk/categories/DevOps/"/>
    
    <category term="Kubernetes" scheme="https://freemankevin.uk/categories/DevOps/Kubernetes/"/>
    
    
    <category term="ArgoCD" scheme="https://freemankevin.uk/tags/ArgoCD/"/>
    
    <category term="Kubernetes" scheme="https://freemankevin.uk/tags/Kubernetes/"/>
    
    <category term="GitOps" scheme="https://freemankevin.uk/tags/GitOps/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åœ¨Kubernetes ç¯å¢ƒä¸­éƒ¨ç½²GitLab Runner</title>
    <link href="https://freemankevin.uk/2025/01/15/k8s-runner/"/>
    <id>https://freemankevin.uk/2025/01/15/k8s-runner/</id>
    <published>2025-01-15T09:25:25.000Z</published>
    <updated>2025-10-21T03:34:40.414Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½² GitLab Runnerï¼ŒåŒ…æ‹¬ç¯å¢ƒå‡†å¤‡ã€Runner é…ç½®ã€è®¤è¯è®¾ç½®ã€ç½‘ç»œæ”¯æŒã€Harbor é›†æˆç­‰å®Œæ•´çš„éƒ¨ç½²å’Œé…ç½®æµç¨‹ã€‚</p><span id="more"></span><h2 id="ç¯å¢ƒè¦æ±‚"><a href="#ç¯å¢ƒè¦æ±‚" class="headerlink" title="ç¯å¢ƒè¦æ±‚"></a>ç¯å¢ƒè¦æ±‚</h2><h3 id="åŸºç¡€ç¯å¢ƒ"><a href="#åŸºç¡€ç¯å¢ƒ" class="headerlink" title="åŸºç¡€ç¯å¢ƒ"></a>åŸºç¡€ç¯å¢ƒ</h3><ul><li>Kubernetes é›†ç¾¤ (ç‰ˆæœ¬ &gt;&#x3D; 1.16)</li><li>Helm (ç‰ˆæœ¬ &gt;&#x3D; 3.9)</li><li>kubectl å·²é…ç½®å¯è®¿é—®é›†ç¾¤</li><li>GitLab æœåŠ¡å™¨å·²éƒ¨ç½²(ç‰ˆæœ¬ &gt;&#x3D; 15.11)</li></ul><h3 id="ç‰ˆæœ¬é€‰æ‹©"><a href="#ç‰ˆæœ¬é€‰æ‹©" class="headerlink" title="ç‰ˆæœ¬é€‰æ‹©"></a>ç‰ˆæœ¬é€‰æ‹©</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å¯ç”¨çš„ Runner ç‰ˆæœ¬</span></span><br><span class="line">helm repo add gitlab https://charts.gitlab.io</span><br><span class="line">helm repo update gitlab</span><br><span class="line">helm search repo -l gitlab/gitlab-runner | grep 15.11</span><br></pre></td></tr></table></figure><h2 id="Runner-å®‰è£…é…ç½®"><a href="#Runner-å®‰è£…é…ç½®" class="headerlink" title="Runner å®‰è£…é…ç½®"></a>Runner å®‰è£…é…ç½®</h2><h3 id="å‡†å¤‡å®‰è£…åŒ…"><a href="#å‡†å¤‡å®‰è£…åŒ…" class="headerlink" title="å‡†å¤‡å®‰è£…åŒ…"></a>å‡†å¤‡å®‰è£…åŒ…</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºå·¥ä½œç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> -p gitlab-runner &amp;&amp; <span class="built_in">cd</span> gitlab-runner</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ Helm Chart</span></span><br><span class="line">helm pull gitlab/gitlab-runner --version v0.52.1</span><br><span class="line">tar xf gitlab-runner-0.52.1.tgz</span><br><span class="line"><span class="built_in">cp</span> gitlab-runner/values.yaml&#123;,.bak&#125;</span><br></pre></td></tr></table></figure><h3 id="é…ç½®-Runner"><a href="#é…ç½®-Runner" class="headerlink" title="é…ç½® Runner"></a>é…ç½® Runner</h3><p>ç¼–è¾‘ <code>gitlab-runner/values.yaml</code> é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Runner é•œåƒé…ç½®</span></span><br><span class="line"><span class="attr">image:</span></span><br><span class="line">  <span class="attr">registry:</span> <span class="string">docker.io</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">gitlab/gitlab-runner</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">alpine-v15.11.1</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># Harbor è®¤è¯é…ç½®</span></span><br><span class="line"><span class="attr">imagePullSecrets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;harbor-credentials&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Runner å®ä¾‹æ•°</span></span><br><span class="line"><span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GitLab æœåŠ¡å™¨é…ç½®</span></span><br><span class="line"><span class="attr">gitlabUrl:</span> <span class="string">http://your-gitlab-server:port/</span></span><br><span class="line"><span class="comment">#certsSecretName: runner-tls-chain   # å¦‚æœä½¿ç”¨ HTTPS åˆ™éœ€è¦é…ç½®</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¹¶å‘ä»»åŠ¡æ•°</span></span><br><span class="line"><span class="attr">concurrent:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—¥å¿—çº§åˆ«</span></span><br><span class="line"><span class="attr">logLevel:</span> <span class="string">info</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RBAC é…ç½®</span></span><br><span class="line"><span class="attr">rbac:</span></span><br><span class="line">  <span class="attr">create:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›‘æ§é…ç½®</span></span><br><span class="line"><span class="attr">metrics:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">portName:</span> <span class="string">metrics</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9252</span></span><br><span class="line">  <span class="attr">serviceMonitor:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Runner å…·ä½“é…ç½®</span></span><br><span class="line"><span class="attr">runners:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    [[runners]]</span></span><br><span class="line"><span class="string">      [runners.kubernetes]</span></span><br><span class="line"><span class="string">        namespace = &quot;&#123;&#123;.Release.Namespace&#125;&#125;&quot;</span></span><br><span class="line"><span class="string">        image = &quot;ubuntu:16.04&quot;</span></span><br><span class="line"><span class="string">      [runners.custom_build_dir]</span></span><br><span class="line"><span class="string">        enabled = true</span></span><br><span class="line"><span class="string">      # ç¼“å­˜é…ç½® - ä½¿ç”¨ MinIO</span></span><br><span class="line"><span class="string">      [runners.cache]</span></span><br><span class="line"><span class="string">        Type = &quot;s3&quot;</span></span><br><span class="line"><span class="string">        Path = &quot;runner&quot;</span></span><br><span class="line"><span class="string">        Shared = true</span></span><br><span class="line"><span class="string">        [runners.cache.s3]</span></span><br><span class="line"><span class="string">          ServerAddress = &quot;your-minio-server:9000&quot;</span></span><br><span class="line"><span class="string">          BucketName = &quot;runner-cache&quot;</span></span><br><span class="line"><span class="string">          AccessKey = &quot;your-access-key&quot;</span></span><br><span class="line"><span class="string">          SecretKey = &quot;your-secret-key&quot;</span></span><br><span class="line"><span class="string">          Insecure = true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">  <span class="comment"># Runner æ‰§è¡Œå™¨é…ç½®</span></span><br><span class="line">  <span class="attr">executor:</span> <span class="string">kubernetes</span></span><br><span class="line">  <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">&quot;kubernetes&quot;</span></span><br><span class="line">  <span class="attr">secret:</span> <span class="string">gitlab-runner</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># æ„å»ºå®¹å™¨èµ„æºé™åˆ¶</span></span><br><span class="line">  <span class="attr">builds:</span> </span><br><span class="line">    <span class="attr">cpuLimit:</span> <span class="string">2010m</span></span><br><span class="line">    <span class="attr">cpuLimitOverwriteMaxAllowed:</span> <span class="string">2010m</span></span><br><span class="line">    <span class="attr">memoryLimit:</span> <span class="string">2060Mi</span></span><br><span class="line">    <span class="attr">memoryLimitOverwriteMaxAllowed:</span> <span class="string">2060Mi</span></span><br><span class="line">    <span class="attr">cpuRequests:</span> <span class="string">100m</span></span><br><span class="line">    <span class="attr">cpuRequestsOverwriteMaxAllowed:</span> <span class="string">100m</span></span><br><span class="line">    <span class="attr">memoryRequests:</span> <span class="string">128Mi</span></span><br><span class="line">    <span class="attr">memoryRequestsOverwriteMaxAllowed:</span> <span class="string">128Mi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># æœåŠ¡å®¹å™¨èµ„æºé™åˆ¶</span></span><br><span class="line">  <span class="attr">services:</span> </span><br><span class="line">    <span class="attr">cpuLimit:</span> <span class="string">200m</span></span><br><span class="line">    <span class="attr">memoryLimit:</span> <span class="string">256Mi</span></span><br><span class="line">    <span class="attr">cpuRequests:</span> <span class="string">100m</span></span><br><span class="line">    <span class="attr">memoryRequests:</span> <span class="string">128Mi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Helper å®¹å™¨èµ„æºé™åˆ¶</span></span><br><span class="line">  <span class="attr">helpers:</span></span><br><span class="line">    <span class="attr">cpuLimit:</span> <span class="string">200m</span></span><br><span class="line">    <span class="attr">memoryLimit:</span> <span class="string">256Mi</span></span><br><span class="line">    <span class="attr">cpuRequests:</span> <span class="string">100m</span></span><br><span class="line">    <span class="attr">memoryRequests:</span> <span class="string">128Mi</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;gitlab/gitlab-runner-helper:x86_64-v15.11.1&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Runner Pod èµ„æºé™åˆ¶</span></span><br><span class="line">  <span class="attr">resources:</span> </span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">256Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">100m</span></span><br></pre></td></tr></table></figure><h2 id="è®¤è¯é…ç½®"><a href="#è®¤è¯é…ç½®" class="headerlink" title="è®¤è¯é…ç½®"></a>è®¤è¯é…ç½®</h2><h3 id="åˆ›å»ºå‘½åç©ºé—´"><a href="#åˆ›å»ºå‘½åç©ºé—´" class="headerlink" title="åˆ›å»ºå‘½åç©ºé—´"></a>åˆ›å»ºå‘½åç©ºé—´</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create ns gitlab-runner</span><br></pre></td></tr></table></figure><h3 id="é…ç½®é•œåƒä»“åº“è®¤è¯"><a href="#é…ç½®é•œåƒä»“åº“è®¤è¯" class="headerlink" title="é…ç½®é•œåƒä»“åº“è®¤è¯"></a>é…ç½®é•œåƒä»“åº“è®¤è¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º Harbor è®¤è¯å¯†é’¥</span></span><br><span class="line">kubectl create secret docker-registry harbor-credentials \</span><br><span class="line">    --docker-server=your-harbor-server \</span><br><span class="line">    --docker-username=your-robot-account \</span><br><span class="line">    --docker-password=your-robot-password \</span><br><span class="line">    -n gitlab-runner</span><br></pre></td></tr></table></figure><h3 id="é…ç½®-Runner-æ³¨å†Œä»¤ç‰Œ"><a href="#é…ç½®-Runner-æ³¨å†Œä»¤ç‰Œ" class="headerlink" title="é…ç½® Runner æ³¨å†Œä»¤ç‰Œ"></a>é…ç½® Runner æ³¨å†Œä»¤ç‰Œ</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º Runner æ³¨å†Œå¯†é’¥</span></span><br><span class="line">kubectl create secret generic gitlab-runner \</span><br><span class="line">  --from-literal=runner-registration-token=your-registration-token \</span><br><span class="line">  --from-literal=runner-token=<span class="string">&quot;&quot;</span> \</span><br><span class="line">  --<span class="built_in">type</span>=Opaque \</span><br><span class="line">  -n gitlab-runner</span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²-Runner"><a href="#éƒ¨ç½²-Runner" class="headerlink" title="éƒ¨ç½² Runner"></a>éƒ¨ç½² Runner</h2><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># éƒ¨ç½² Runner</span></span><br><span class="line">helm install gitlab-runner ./gitlab-runner \</span><br><span class="line">  -f gitlab-runner/values.yaml \</span><br><span class="line">  --namespace gitlab-runner \</span><br><span class="line">  --create-namespace</span><br></pre></td></tr></table></figure><h3 id="æ›´æ–°é…ç½®"><a href="#æ›´æ–°é…ç½®" class="headerlink" title="æ›´æ–°é…ç½®"></a>æ›´æ–°é…ç½®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–° Runner é…ç½®</span></span><br><span class="line">helm upgrade gitlab-runner ./gitlab-runner \</span><br><span class="line">  -f gitlab-runner/values.yaml \</span><br><span class="line">  --namespace gitlab-runner</span><br></pre></td></tr></table></figure><h3 id="å¸è½½"><a href="#å¸è½½" class="headerlink" title="å¸è½½"></a>å¸è½½</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®Œå…¨å¸è½½ Runner</span></span><br><span class="line">helm -n gitlab-runner uninstall gitlab-runner</span><br></pre></td></tr></table></figure><h2 id="ç½‘ç»œé…ç½®"><a href="#ç½‘ç»œé…ç½®" class="headerlink" title="ç½‘ç»œé…ç½®"></a>ç½‘ç»œé…ç½®</h2><h3 id="GitLab-æœåŠ¡å™¨é…ç½®"><a href="#GitLab-æœåŠ¡å™¨é…ç½®" class="headerlink" title="GitLab æœåŠ¡å™¨é…ç½®"></a>GitLab æœåŠ¡å™¨é…ç½®</h3><ol><li>ä¿®æ”¹ GitLab ä¸»é…ç½®ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¾‘ /etc/gitlab/gitlab.rb</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;outbound_local_requests&#x27;</span>] = &#123; <span class="string">&quot;allow&quot;</span> =&gt; <span class="literal">true</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯ GitLab æœåŠ¡</span></span><br><span class="line">gitlab-ctl restart</span><br></pre></td></tr></table></figure><ol start="2"><li>é…ç½®ç½‘ç»œè®¿é—®ç™½åå•ï¼š</li></ol><ul><li>è®¿é—®è·¯å¾„ï¼š<code>http(s)://&lt;gitlab-server&gt;:&lt;port&gt;/admin/application_settings/network</code></li><li>å¯ç”¨ä»¥ä¸‹é€‰é¡¹ï¼š<ul><li><input checked="" disabled="" type="checkbox"> Allow requests to the local network from webhooks and integrations</li><li><input checked="" disabled="" type="checkbox"> Allow requests to the local network from system hooks</li></ul></li><li>æ·»åŠ å…è®¸è®¿é—®çš„å†…ç½‘åŸŸå&#x2F;IPï¼š<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">harbor.your-domain.com</span><br><span class="line">minio.your-domain.com</span><br><span class="line">traefik.your-domain.com</span><br><span class="line">argocd.your-domain.com</span><br><span class="line">yourserver-internal-ips</span><br></pre></td></tr></table></figure></li></ul><h2 id="Harbor-é›†æˆ"><a href="#Harbor-é›†æˆ" class="headerlink" title="Harbor é›†æˆ"></a>Harbor é›†æˆ</h2><h3 id="GitLab-é…ç½®-Harbor"><a href="#GitLab-é…ç½®-Harbor" class="headerlink" title="GitLab é…ç½® Harbor"></a>GitLab é…ç½® Harbor</h3><ol><li>è®¿é—®é…ç½®é¡µé¢ï¼š<code>http(s)://&lt;gitlab-server&gt;:&lt;port&gt;/groups/your-group/-/settings/integrations</code></li><li>æ‰¾åˆ° Harbor é…ç½®åŒºåŸŸï¼š<ul><li><input checked="" disabled="" type="checkbox"> Enable integration</li><li>Harbor URL: <code>https://your-harbor-server</code></li><li>Harbor project name: <code>your-project-name</code></li><li>Harbor username: <code>your-robot-account</code></li><li>Harbor password: <code>your-robot-password</code></li></ul></li></ol><h3 id="é…ç½®-Harbor-è¯ä¹¦"><a href="#é…ç½®-Harbor-è¯ä¹¦" class="headerlink" title="é…ç½® Harbor è¯ä¹¦"></a>é…ç½® Harbor è¯ä¹¦</h3><p>åœ¨æ‰€æœ‰ Worker èŠ‚ç‚¹ä¸Šé…ç½® Harbor è¯ä¹¦ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¤åˆ¶è¯ä¹¦</span></span><br><span class="line"><span class="built_in">cp</span> /etc/tls/harbor/ca.crt /etc/ssl/certs/</span><br><span class="line"><span class="built_in">cp</span> /etc/tls/harbor/harbor.cert /etc/ssl/certs/</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°è¯ä¹¦å­˜å‚¨</span></span><br><span class="line">update-ca-certificates</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯å®¹å™¨è¿è¡Œæ—¶</span></span><br><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure><h2 id="æ•…éšœæ’æŸ¥"><a href="#æ•…éšœæ’æŸ¥" class="headerlink" title="æ•…éšœæ’æŸ¥"></a>æ•…éšœæ’æŸ¥</h2><h3 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h3><ol><li>é•œåƒæ‹‰å–å¤±è´¥</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥ Harbor è®¤è¯é…ç½®</span></span><br><span class="line">kubectl get secret harbor-credentials -n gitlab-runner</span><br><span class="line">kubectl describe secret harbor-credentials -n gitlab-runner</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥è¯ä¹¦é…ç½®</span></span><br><span class="line"><span class="built_in">ls</span> -l /etc/ssl/certs/harbor*</span><br></pre></td></tr></table></figure><ol start="2"><li>Runner æ³¨å†Œå¤±è´¥</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥ Runner çŠ¶æ€</span></span><br><span class="line">kubectl get pods -n gitlab-runner</span><br><span class="line">kubectl logs -f &lt;runner-pod-name&gt; -n gitlab-runner</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯ GitLab è¿æ¥</span></span><br><span class="line">curl -k https://your-gitlab-server/</span><br></pre></td></tr></table></figure><h3 id="èµ„æºé™åˆ¶éªŒè¯"><a href="#èµ„æºé™åˆ¶éªŒè¯" class="headerlink" title="èµ„æºé™åˆ¶éªŒè¯"></a>èµ„æºé™åˆ¶éªŒè¯</h3><p>æ£€æŸ¥ Runner Pod çš„èµ„æºé™åˆ¶æ˜¯å¦ç”Ÿæ•ˆï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pod &lt;runner-pod-name&gt; -n gitlab-runner -o yaml</span><br></pre></td></tr></table></figure><h3 id="æ—¥å¿—æŸ¥çœ‹"><a href="#æ—¥å¿—æŸ¥çœ‹" class="headerlink" title="æ—¥å¿—æŸ¥çœ‹"></a>æ—¥å¿—æŸ¥çœ‹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ Runner Pod æ—¥å¿—</span></span><br><span class="line">kubectl logs -f &lt;runner-pod-name&gt; -n gitlab-runner</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ„å»ºä»»åŠ¡ Pod æ—¥å¿—</span></span><br><span class="line">kubectl logs -f &lt;build-pod-name&gt; -n gitlab-runner</span><br></pre></td></tr></table></figure><h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><h3 id="èµ„æºé…ç½®å»ºè®®"><a href="#èµ„æºé…ç½®å»ºè®®" class="headerlink" title="èµ„æºé…ç½®å»ºè®®"></a>èµ„æºé…ç½®å»ºè®®</h3><ul><li>æ ¹æ®é¡¹ç›®è§„æ¨¡å’Œæ„å»ºéœ€æ±‚è°ƒæ•´èµ„æºé™åˆ¶</li><li>ä¸ºä¸åŒç±»å‹çš„æ„å»ºä»»åŠ¡è®¾ç½®ä¸åŒçš„èµ„æºé…ç½®</li><li>åˆç†è®¾ç½®ç¼“å­˜ç­–ç•¥ï¼Œæé«˜æ„å»ºæ•ˆç‡</li></ul><h3 id="å®‰å…¨å»ºè®®"><a href="#å®‰å…¨å»ºè®®" class="headerlink" title="å®‰å…¨å»ºè®®"></a>å®‰å…¨å»ºè®®</h3><ul><li>ä½¿ç”¨ä¸“ç”¨çš„ Runner å‘½åç©ºé—´</li><li>é…ç½®é€‚å½“çš„ RBAC æƒé™</li><li>å®šæœŸæ›´æ–° Runner ç‰ˆæœ¬</li><li>ä½¿ç”¨ HTTPS è¿›è¡Œå®‰å…¨é€šä¿¡</li><li>å¦¥å–„ä¿ç®¡å„ç±»å¯†é’¥å’Œè¯ä¹¦</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½² GitLab Runnerï¼ŒåŒ…æ‹¬ç¯å¢ƒå‡†å¤‡ã€Runner é…ç½®ã€è®¤è¯è®¾ç½®ã€ç½‘ç»œæ”¯æŒã€Harbor é›†æˆç­‰å®Œæ•´çš„éƒ¨ç½²å’Œé…ç½®æµç¨‹ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Kubernetes" scheme="https://freemankevin.uk/categories/Kubernetes/"/>
    
    
    <category term="GitLab" scheme="https://freemankevin.uk/tags/GitLab/"/>
    
    <category term="Kubernetes" scheme="https://freemankevin.uk/tags/Kubernetes/"/>
    
    <category term="Helm" scheme="https://freemankevin.uk/tags/Helm/"/>
    
    <category term="Runner" scheme="https://freemankevin.uk/tags/Runner/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•åœ¨Kubernetes ç¯å¢ƒä¸­éƒ¨ç½²Traefik</title>
    <link href="https://freemankevin.uk/2025/01/15/k8s-traefik/"/>
    <id>https://freemankevin.uk/2025/01/15/k8s-traefik/</id>
    <published>2025-01-15T09:10:25.000Z</published>
    <updated>2025-10-21T03:34:40.414Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ Kubernetes é›†ç¾¤ä¸­å®‰è£…å’Œé…ç½®å¸¦æœ‰ TLS çš„ Traefik Ingress Controllerã€‚åŒ…æ‹¬ç¯å¢ƒå‡†å¤‡ã€å®‰è£…é…ç½®ã€TLS è¯ä¹¦ç®¡ç†ã€è®¤è¯è®¾ç½®ä»¥åŠå¸¸è§é—®é¢˜æ’æŸ¥ç­‰å®Œæ•´æµç¨‹ã€‚</p><span id="more"></span><h2 id="ç¯å¢ƒè¦æ±‚"><a href="#ç¯å¢ƒè¦æ±‚" class="headerlink" title="ç¯å¢ƒè¦æ±‚"></a>ç¯å¢ƒè¦æ±‚</h2><h3 id="åŸºç¡€ç¯å¢ƒè¦æ±‚"><a href="#åŸºç¡€ç¯å¢ƒè¦æ±‚" class="headerlink" title="åŸºç¡€ç¯å¢ƒè¦æ±‚"></a>åŸºç¡€ç¯å¢ƒè¦æ±‚</h3><ul><li>Kubernetes é›†ç¾¤ (ç‰ˆæœ¬ &gt;&#x3D; 1.16)</li><li>Helm (ç‰ˆæœ¬ &gt;&#x3D; 3.9)</li><li>kubectl å·²é…ç½®å¯è®¿é—®é›†ç¾¤</li></ul><h3 id="ç‰ˆæœ¬ä¿¡æ¯"><a href="#ç‰ˆæœ¬ä¿¡æ¯" class="headerlink" title="ç‰ˆæœ¬ä¿¡æ¯"></a>ç‰ˆæœ¬ä¿¡æ¯</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥ helm ç‰ˆæœ¬</span></span><br><span class="line">helm version</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…-Traefik"><a href="#å®‰è£…-Traefik" class="headerlink" title="å®‰è£… Traefik"></a>å®‰è£… Traefik</h2><h3 id="æ·»åŠ -Helm-ä»“åº“"><a href="#æ·»åŠ -Helm-ä»“åº“" class="headerlink" title="æ·»åŠ  Helm ä»“åº“"></a>æ·»åŠ  Helm ä»“åº“</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ å®˜æ–¹ helm ä»“åº“</span></span><br><span class="line">helm repo add traefik https://traefik.github.io/charts</span><br><span class="line">helm repo update</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬</span></span><br><span class="line">helm search repo traefik/traefik -l</span><br></pre></td></tr></table></figure><h3 id="å‡†å¤‡é…ç½®æ–‡ä»¶"><a href="#å‡†å¤‡é…ç½®æ–‡ä»¶" class="headerlink" title="å‡†å¤‡é…ç½®æ–‡ä»¶"></a>å‡†å¤‡é…ç½®æ–‡ä»¶</h3><p>åˆ›å»º <code>values.yaml</code> é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Traefik åŸºç¡€é…ç½®</span></span><br><span class="line"><span class="attr">ingressRoute:</span></span><br><span class="line">  <span class="attr">dashboard:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ingressClass:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">isDefaultClass:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">providers:</span></span><br><span class="line">  <span class="attr">kubernetesCRD:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">allowCrossNamespace:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">allowExternalNameServices:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kubernetesIngress:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">allowExternalNameServices:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—¥å¿—é…ç½®</span></span><br><span class="line"><span class="attr">logs:</span></span><br><span class="line">  <span class="attr">general:</span></span><br><span class="line">    <span class="attr">level:</span> <span class="string">DEBUG</span></span><br><span class="line">  <span class="attr">access:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœåŠ¡é…ç½®</span></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">single:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é¢å¤–å‚æ•°</span></span><br><span class="line"><span class="attr">additionalArguments:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;--log.level=DEBUG&quot;</span></span><br></pre></td></tr></table></figure><h3 id="éƒ¨ç½²-Traefik"><a href="#éƒ¨ç½²-Traefik" class="headerlink" title="éƒ¨ç½² Traefik"></a>éƒ¨ç½² Traefik</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºå‘½åç©ºé—´å¹¶å®‰è£… Traefik</span></span><br><span class="line">helm install traefik traefik/traefik \</span><br><span class="line">  --namespace=traefik-v2 \</span><br><span class="line">  --create-namespace \</span><br><span class="line">  --values=values.yaml \</span><br><span class="line">  --version 25.0.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€</span></span><br><span class="line">kubectl get pods -n traefik-v2</span><br></pre></td></tr></table></figure><h2 id="é…ç½®-TLS"><a href="#é…ç½®-TLS" class="headerlink" title="é…ç½® TLS"></a>é…ç½® TLS</h2><h3 id="ç”Ÿæˆè¯ä¹¦"><a href="#ç”Ÿæˆè¯ä¹¦" class="headerlink" title="ç”Ÿæˆè¯ä¹¦"></a>ç”Ÿæˆè¯ä¹¦</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºè¯ä¹¦ç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> -p tls &amp;&amp; <span class="built_in">cd</span> tls</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º CA é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">cat</span> &gt; openssl-ca.cnf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[req]</span></span><br><span class="line"><span class="string">distinguished_name = req_distinguished_name</span></span><br><span class="line"><span class="string">x509_extensions = v3_ca</span></span><br><span class="line"><span class="string">default_days = 3650</span></span><br><span class="line"><span class="string">default_md = sha256</span></span><br><span class="line"><span class="string">prompt = no</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[req_distinguished_name]</span></span><br><span class="line"><span class="string">CN = My Root CA</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[v3_ca]</span></span><br><span class="line"><span class="string">subjectKeyIdentifier=hash</span></span><br><span class="line"><span class="string">authorityKeyIdentifier=keyid:always,issuer</span></span><br><span class="line"><span class="string">basicConstraints = critical, CA:true </span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡å™¨è¯ä¹¦é…ç½®</span></span><br><span class="line"><span class="built_in">cat</span> &gt; openssl-server.cnf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[req]</span></span><br><span class="line"><span class="string">distinguished_name = req_distinguished_name</span></span><br><span class="line"><span class="string">x509_extensions = v3_req</span></span><br><span class="line"><span class="string">prompt = no</span></span><br><span class="line"><span class="string">default_days = 3650</span></span><br><span class="line"><span class="string">default_md = sha256</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[req_distinguished_name]</span></span><br><span class="line"><span class="string">CN = traefik.k8scluster.com</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[v3_req]</span></span><br><span class="line"><span class="string">keyUsage = digitalSignature, keyEncipherment</span></span><br><span class="line"><span class="string">extendedKeyUsage = serverAuth</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[alt_names]</span></span><br><span class="line"><span class="string">DNS.1 = traefik.k8scluster.com</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆè¯ä¹¦</span></span><br><span class="line">openssl genrsa -out rootCA.key 2048</span><br><span class="line">openssl req -x509 -new -nodes -key rootCA.key -sha256 -days 3650 -out rootCA.crt -config openssl-ca.cnf</span><br><span class="line">openssl genrsa -out server.key 2048</span><br><span class="line">openssl req -new -key server.key -out server.csr -config openssl-server.cnf</span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> server.csr -CA rootCA.crt -CAkey rootCA.key -CAcreateserial -out server.crt -days 3650 -sha256 -extensions v3_req -extfile openssl-server.cnf</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»º-TLS-Secret"><a href="#åˆ›å»º-TLS-Secret" class="headerlink" title="åˆ›å»º TLS Secret"></a>åˆ›å»º TLS Secret</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create secret tls traefik-ingress-dashboard \</span><br><span class="line">  --namespace traefik-v2 \</span><br><span class="line">  --key ./server.key \</span><br><span class="line">  --cert ./server.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯è¯ä¹¦</span></span><br><span class="line">kubectl -n traefik-v2 get secret traefik-ingress-dashboard -o jsonpath=<span class="string">&quot;&#123;.data.tls\.crt&#125;&quot;</span> | <span class="built_in">base64</span> --decode | openssl x509 -inform pem -text -noout</span><br></pre></td></tr></table></figure><h2 id="é…ç½®è®¤è¯"><a href="#é…ç½®è®¤è¯" class="headerlink" title="é…ç½®è®¤è¯"></a>é…ç½®è®¤è¯</h2><h3 id="åˆ›å»º-Basic-Auth"><a href="#åˆ›å»º-Basic-Auth" class="headerlink" title="åˆ›å»º Basic Auth"></a>åˆ›å»º Basic Auth</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… htpasswd å·¥å…·</span></span><br><span class="line">apt-get update &amp;&amp; apt-get install apache2-utils -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆå¯†ç </span></span><br><span class="line">htpasswd -nb admin &lt;your-password&gt; | kubectl create secret generic basic-auth \</span><br><span class="line">  --namespace=traefik-v2 \</span><br><span class="line">  --from-file=auth=/dev/stdin</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»º-IngressRoute"><a href="#åˆ›å»º-IngressRoute" class="headerlink" title="åˆ›å»º IngressRoute"></a>åˆ›å»º IngressRoute</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># traefik-websecure-dashboard.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">websecure-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">traefik-v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">websecure</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">Host(`traefik.k8scluster.com`)</span> <span class="string">&amp;&amp;</span> <span class="string">(PathPrefix(`/dashboard`)</span> <span class="string">||</span> <span class="string">PathPrefix(`/api`))</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">api@internal</span></span><br><span class="line">          <span class="attr">kind:</span> <span class="string">TraefikService</span></span><br><span class="line">      <span class="attr">middlewares:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">basic-auth</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">traefik-v2</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">traefik-ingress-dashboard</span></span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºè®¤è¯ä¸­é—´ä»¶"><a href="#åˆ›å»ºè®¤è¯ä¸­é—´ä»¶" class="headerlink" title="åˆ›å»ºè®¤è¯ä¸­é—´ä»¶"></a>åˆ›å»ºè®¤è¯ä¸­é—´ä»¶</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># traefik-middleware.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Middleware</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">basic-auth</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">traefik-v2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">basicAuth:</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">basic-auth</span></span><br></pre></td></tr></table></figure><h2 id="æš´éœ²æœåŠ¡"><a href="#æš´éœ²æœåŠ¡" class="headerlink" title="æš´éœ²æœåŠ¡"></a>æš´éœ²æœåŠ¡</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é…ç½® NodePort æœåŠ¡</span></span><br><span class="line">kubectl patch svc traefik -n traefik-v2 -p <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;spec&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;type&quot;: &quot;NodePort&quot;,</span></span><br><span class="line"><span class="string">    &quot;ports&quot;: [</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        &quot;name&quot;: &quot;web&quot;,</span></span><br><span class="line"><span class="string">        &quot;port&quot;: 80,</span></span><br><span class="line"><span class="string">        &quot;targetPort&quot;: &quot;web&quot;,</span></span><br><span class="line"><span class="string">        &quot;nodePort&quot;: 30882</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        &quot;name&quot;: &quot;websecure&quot;,</span></span><br><span class="line"><span class="string">        &quot;port&quot;: 443,</span></span><br><span class="line"><span class="string">        &quot;targetPort&quot;: &quot;websecure&quot;,</span></span><br><span class="line"><span class="string">        &quot;nodePort&quot;: 30883</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯æœåŠ¡çŠ¶æ€</span></span><br><span class="line">kubectl get svc -n traefik-v2</span><br></pre></td></tr></table></figure><h2 id="è®¿é—®æ§åˆ¶å°"><a href="#è®¿é—®æ§åˆ¶å°" class="headerlink" title="è®¿é—®æ§åˆ¶å°"></a>è®¿é—®æ§åˆ¶å°</h2><ol><li>æ·»åŠ åŸŸåè§£æï¼ˆæœ¬åœ°æµ‹è¯•å¯ä¿®æ”¹ hosts æ–‡ä»¶ï¼‰ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;NODE_IP&#125;</span> traefik.k8scluster.com&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure><ol start="2"><li>è®¿é—®åœ°å€ï¼š</li></ol><ul><li>Dashboard: <span class="exturl" data-url="aHR0cHM6Ly90cmFlZmlrLms4c2NsdXN0ZXIuY29tOjMwODgzL2Rhc2hib2FyZC8=">https://traefik.k8scluster.com:30883/dashboard/<i class="fa fa-external-link-alt"></i></span></li><li>ä½¿ç”¨ä¹‹å‰è®¾ç½®çš„ç”¨æˆ·åå¯†ç ç™»å½•</li></ul><h2 id="å¸¸è§é—®é¢˜æ’æŸ¥"><a href="#å¸¸è§é—®é¢˜æ’æŸ¥" class="headerlink" title="å¸¸è§é—®é¢˜æ’æŸ¥"></a>å¸¸è§é—®é¢˜æ’æŸ¥</h2><h3 id="è¯ä¹¦é—®é¢˜"><a href="#è¯ä¹¦é—®é¢˜" class="headerlink" title="è¯ä¹¦é—®é¢˜"></a>è¯ä¹¦é—®é¢˜</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥è¯ä¹¦æ˜¯å¦æ­£ç¡®åˆ›å»º</span></span><br><span class="line">kubectl get secret -n traefik-v2</span><br><span class="line">kubectl describe secret traefik-ingress-dashboard -n traefik-v2</span><br></pre></td></tr></table></figure><h3 id="è®¿é—®é—®é¢˜"><a href="#è®¿é—®é—®é¢˜" class="headerlink" title="è®¿é—®é—®é¢˜"></a>è®¿é—®é—®é¢˜</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥ Pod çŠ¶æ€</span></span><br><span class="line">kubectl get pods -n traefik-v2</span><br><span class="line">kubectl describe pod -n traefik-v2 &lt;pod-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥æ—¥å¿—</span></span><br><span class="line">kubectl logs -n traefik-v2 &lt;pod-name&gt;</span><br></pre></td></tr></table></figure><h3 id="é…ç½®æ›´æ–°"><a href="#é…ç½®æ›´æ–°" class="headerlink" title="é…ç½®æ›´æ–°"></a>é…ç½®æ›´æ–°</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–° Traefik é…ç½®</span></span><br><span class="line">helm upgrade traefik traefik/traefik \</span><br><span class="line">  --namespace=traefik-v2 \</span><br><span class="line">  --values=values.yaml</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ Kubernetes é›†ç¾¤ä¸­å®‰è£…å’Œé…ç½®å¸¦æœ‰ TLS çš„ Traefik Ingress Controllerã€‚åŒ…æ‹¬ç¯å¢ƒå‡†å¤‡ã€å®‰è£…é…ç½®ã€TLS è¯ä¹¦ç®¡ç†ã€è®¤è¯è®¾ç½®ä»¥åŠå¸¸è§é—®é¢˜æ’æŸ¥ç­‰å®Œæ•´æµç¨‹ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Kubernetes" scheme="https://freemankevin.uk/categories/Kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="https://freemankevin.uk/tags/Kubernetes/"/>
    
    <category term="TLS" scheme="https://freemankevin.uk/tags/TLS/"/>
    
    <category term="NGINX" scheme="https://freemankevin.uk/tags/NGINX/"/>
    
    <category term="Traefik" scheme="https://freemankevin.uk/tags/Traefik/"/>
    
  </entry>
  
  <entry>
    <title>MinIO TLSéƒ¨ç½²æŒ‡å—</title>
    <link href="https://freemankevin.uk/2025/01/15/tls-minio/"/>
    <id>https://freemankevin.uk/2025/01/15/tls-minio/</id>
    <published>2025-01-15T08:49:25.000Z</published>
    <updated>2025-10-21T03:34:40.419Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†MinIOå¯¹è±¡å­˜å‚¨æœåŠ¡çš„TLSå®‰å…¨éƒ¨ç½²æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æœåŠ¡å®‰è£…ã€TLSè¯ä¹¦é…ç½®ã€Nginxåå‘ä»£ç†ç­‰æ ¸å¿ƒå†…å®¹ã€‚é€šè¿‡åœ¨çº¿å®‰è£…å’Œé…ç½®ï¼Œå®ç°äº†MinIOæœåŠ¡çš„HTTPSå®‰å…¨è®¿é—®ï¼Œé€‚åˆéœ€è¦éƒ¨ç½²å®‰å…¨å¯¹è±¡å­˜å‚¨æœåŠ¡çš„è¿ç»´äººå‘˜å‚è€ƒã€‚</p><span id="more"></span><h2 id="å®‰è£…-MinIO-æœåŠ¡"><a href="#å®‰è£…-MinIO-æœåŠ¡" class="headerlink" title="å®‰è£… MinIO æœåŠ¡"></a>å®‰è£… MinIO æœåŠ¡</h2><h3 id="å®‰è£…MinIOæœåŠ¡ç«¯"><a href="#å®‰è£…MinIOæœåŠ¡ç«¯" class="headerlink" title="å®‰è£…MinIOæœåŠ¡ç«¯"></a>å®‰è£…MinIOæœåŠ¡ç«¯</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ MinIOä»“åº“</span></span><br><span class="line">curl -O https://dl.min.io/repos/minio-repo.sh</span><br><span class="line">sh minio-repo.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£…MinIO</span></span><br><span class="line">apt update &amp;&amp; apt install minio -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯å®‰è£…</span></span><br><span class="line">minio --version</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…MinIOå®¢æˆ·ç«¯-å¯é€‰"><a href="#å®‰è£…MinIOå®¢æˆ·ç«¯-å¯é€‰" class="headerlink" title="å®‰è£…MinIOå®¢æˆ·ç«¯(å¯é€‰)"></a>å®‰è£…MinIOå®¢æˆ·ç«¯(å¯é€‰)</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸‹è½½MinIOå®¢æˆ·ç«¯</span></span><br><span class="line">curl https://dl.min.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc</span><br><span class="line">chmod +x /usr/local/bin/mc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éªŒè¯å®‰è£…</span></span><br><span class="line">mc --version</span><br></pre></td></tr></table></figure><h2 id="é…ç½®TLSè¯ä¹¦"><a href="#é…ç½®TLSè¯ä¹¦" class="headerlink" title="é…ç½®TLSè¯ä¹¦"></a>é…ç½®TLSè¯ä¹¦</h2><h3 id="åˆ›å»ºè¯ä¹¦ç›®å½•"><a href="#åˆ›å»ºè¯ä¹¦ç›®å½•" class="headerlink" title="åˆ›å»ºè¯ä¹¦ç›®å½•"></a>åˆ›å»ºè¯ä¹¦ç›®å½•</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir -p /etc/minio/ssl/certs &amp;&amp; cd /etc/minio/ssl/certs</span><br></pre></td></tr></table></figure><h3 id="ç”ŸæˆCAé…ç½®"><a href="#ç”ŸæˆCAé…ç½®" class="headerlink" title="ç”ŸæˆCAé…ç½®"></a>ç”ŸæˆCAé…ç½®</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat &gt; openssl-ca.cnf &lt;&lt;EOF</span><br><span class="line">[req]</span><br><span class="line">distinguished_name = req_distinguished_name</span><br><span class="line">x509_extensions = v3_ca</span><br><span class="line">default_days = 3650</span><br><span class="line">default_md = sha256</span><br><span class="line">prompt = no</span><br><span class="line"></span><br><span class="line">[req_distinguished_name]</span><br><span class="line">CN = My Root CA</span><br><span class="line"></span><br><span class="line">[v3_ca]</span><br><span class="line">subjectKeyIdentifier=hash</span><br><span class="line">authorityKeyIdentifier=keyid:always,issuer</span><br><span class="line">basicConstraints = critical, CA:true</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦é…ç½®"><a href="#ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦é…ç½®" class="headerlink" title="ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦é…ç½®"></a>ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦é…ç½®</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat &gt; openssl-server.cnf &lt;&lt;EOF</span><br><span class="line">[req]</span><br><span class="line">distinguished_name = req_distinguished_name</span><br><span class="line">x509_extensions = v3_req</span><br><span class="line">prompt = no</span><br><span class="line">default_days = 3650</span><br><span class="line">default_md = sha256</span><br><span class="line"></span><br><span class="line">[req_distinguished_name]</span><br><span class="line">CN = minio.objectstorage.com</span><br><span class="line"></span><br><span class="line">[v3_req]</span><br><span class="line">keyUsage = digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1 = minio.objectstorage.com</span><br><span class="line">IP.1 = YOUR_SERVER_IP</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="ç”Ÿæˆè¯ä¹¦"><a href="#ç”Ÿæˆè¯ä¹¦" class="headerlink" title="ç”Ÿæˆè¯ä¹¦"></a>ç”Ÿæˆè¯ä¹¦</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”ŸæˆCAè¯ä¹¦</span></span><br><span class="line">openssl genrsa -out rootCA.key 2048</span><br><span class="line">openssl req -x509 -new -nodes -key rootCA.key -sha256 -days 3650 -out rootCA.crt -config openssl-ca.cnf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦</span></span><br><span class="line">openssl genrsa -out server.key 2048</span><br><span class="line">openssl req -new -key server.key -out server.csr -config openssl-server.cnf</span><br><span class="line">openssl x509 -req -in server.csr -CA rootCA.crt -CAkey rootCA.key -CAcreateserial \</span><br><span class="line">    -out server.crt -days 3650 -sha256 -extensions v3_req -extfile openssl-server.cnf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡å‘½åä¸ºMinIOæ‰€éœ€çš„æ–‡ä»¶å</span></span><br><span class="line">mv server.key private.key</span><br><span class="line">mv server.crt public.crt</span><br></pre></td></tr></table></figure><h2 id="é…ç½®MinIOæœåŠ¡"><a href="#é…ç½®MinIOæœåŠ¡" class="headerlink" title="é…ç½®MinIOæœåŠ¡"></a>é…ç½®MinIOæœåŠ¡</h2><h3 id="åˆ›å»ºæ•°æ®ç›®å½•"><a href="#åˆ›å»ºæ•°æ®ç›®å½•" class="headerlink" title="åˆ›å»ºæ•°æ®ç›®å½•"></a>åˆ›å»ºæ•°æ®ç›®å½•</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir -p /data/minio</span><br></pre></td></tr></table></figure><h3 id="é…ç½®MinIOç¯å¢ƒ"><a href="#é…ç½®MinIOç¯å¢ƒ" class="headerlink" title="é…ç½®MinIOç¯å¢ƒ"></a>é…ç½®MinIOç¯å¢ƒ</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat &gt; /etc/default/minio &lt;&lt;EOF</span><br><span class="line">MINIO_ROOT_USER=admin</span><br><span class="line">MINIO_ROOT_PASSWORD=admin@123</span><br><span class="line">MINIO_VOLUMES=&quot;/data/minio&quot;</span><br><span class="line">MINIO_SERVER_URL=&quot;https://minio.objectstorage.com:9000&quot;</span><br><span class="line">MINIO_OPTS=&quot;--address :9000 --certs-dir /etc/minio/ssl/certs --console-address :9001&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="è®¾ç½®æƒé™"><a href="#è®¾ç½®æƒé™" class="headerlink" title="è®¾ç½®æƒé™"></a>è®¾ç½®æƒé™</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">useradd -r minio-user -s /sbin/nologin</span><br><span class="line">chown -R minio-user:minio-user /data/minio</span><br><span class="line">chown -R minio-user:minio-user /etc/minio</span><br></pre></td></tr></table></figure><h2 id="é…ç½®Nginxä»£ç†"><a href="#é…ç½®Nginxä»£ç†" class="headerlink" title="é…ç½®Nginxä»£ç†"></a>é…ç½®Nginxä»£ç†</h2><h3 id="å®‰è£…Nginx"><a href="#å®‰è£…Nginx" class="headerlink" title="å®‰è£…Nginx"></a>å®‰è£…Nginx</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">apt update &amp;&amp; apt install nginx -y</span><br></pre></td></tr></table></figure><h3 id="é…ç½®Nginxä»£ç†-1"><a href="#é…ç½®Nginxä»£ç†-1" class="headerlink" title="é…ç½®Nginxä»£ç†"></a>é…ç½®Nginxä»£ç†</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat &gt; /etc/nginx/conf.d/minio.conf &lt;&lt;EOF</span><br><span class="line">upstream minio_s3 &#123;</span><br><span class="line">    server localhost:9000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream minio_console &#123;</span><br><span class="line">    server localhost:9001;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name minio.objectstorage.com;</span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/nginx/ssl/minio/public.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/minio/private.key;</span><br><span class="line"></span><br><span class="line">    # ä»£ç†MinIO API</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_set_header Host \$http_host;</span><br><span class="line">        proxy_set_header X-Real-IP \$remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto \$scheme;</span><br><span class="line"></span><br><span class="line">        proxy_connect_timeout 300;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection &quot;&quot;;</span><br><span class="line">        chunked_transfer_encoding off;</span><br><span class="line"></span><br><span class="line">        proxy_pass http://minio_s3;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 9443 ssl;</span><br><span class="line">    server_name minio.objectstorage.com;</span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/nginx/ssl/minio/public.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/minio/private.key;</span><br><span class="line"></span><br><span class="line">    # ä»£ç†MinIO Console</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_set_header Host \$http_host;</span><br><span class="line">        proxy_set_header X-Real-IP \$remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto \$scheme;</span><br><span class="line"></span><br><span class="line">        proxy_connect_timeout 300;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Upgrade \$http_upgrade;</span><br><span class="line">        proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line"></span><br><span class="line">        proxy_pass http://minio_console;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h2><h3 id="å¯åŠ¨MinIO"><a href="#å¯åŠ¨MinIO" class="headerlink" title="å¯åŠ¨MinIO"></a>å¯åŠ¨MinIO</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl start minio</span><br><span class="line">systemctl enable minio</span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨Nginx"><a href="#å¯åŠ¨Nginx" class="headerlink" title="å¯åŠ¨Nginx"></a>å¯åŠ¨Nginx</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl start nginx</span><br><span class="line">systemctl enable nginx</span><br></pre></td></tr></table></figure><h2 id="éªŒè¯éƒ¨ç½²"><a href="#éªŒè¯éƒ¨ç½²" class="headerlink" title="éªŒè¯éƒ¨ç½²"></a>éªŒè¯éƒ¨ç½²</h2><h3 id="æ£€æŸ¥æœåŠ¡çŠ¶æ€"><a href="#æ£€æŸ¥æœåŠ¡çŠ¶æ€" class="headerlink" title="æ£€æŸ¥æœåŠ¡çŠ¶æ€"></a>æ£€æŸ¥æœåŠ¡çŠ¶æ€</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl status minio</span><br><span class="line">systemctl status nginx</span><br></pre></td></tr></table></figure><h3 id="éªŒè¯è®¿é—®"><a href="#éªŒè¯è®¿é—®" class="headerlink" title="éªŒè¯è®¿é—®"></a>éªŒè¯è®¿é—®</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æµ‹è¯•APIç«¯ç‚¹</span></span><br><span class="line">curl -k https://minio.objectstorage.com/minio/health</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¿é—®æ§åˆ¶å°</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨æµè§ˆå™¨ä¸­è®¿é—® https://minio.objectstorage.com:9443</span></span><br></pre></td></tr></table></figure><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><h3 id="å®‰å…¨å»ºè®®"><a href="#å®‰å…¨å»ºè®®" class="headerlink" title="å®‰å…¨å»ºè®®"></a>å®‰å…¨å»ºè®®</h3><ol><li><p>è®¿é—®æ§åˆ¶ï¼š</p><ul><li>ä¿®æ”¹é»˜è®¤çš„ç®¡ç†å‘˜å¯†ç ï¼Œä½¿ç”¨å¼ºå¯†ç ç­–ç•¥</li><li>ä½¿ç”¨ç­–ç•¥ç®¡ç†è®¿é—®æƒé™ï¼Œéµå¾ªæœ€å°æƒé™åŸåˆ™</li><li>å®šæœŸå®¡è®¡è®¿é—®æ—¥å¿—ï¼Œç›‘æ§å¼‚å¸¸è®¿é—®</li><li>é…ç½®IPç™½åå•ï¼Œé™åˆ¶ç®¡ç†æ§åˆ¶å°è®¿é—®èŒƒå›´</li></ul></li><li><p>è¯ä¹¦ç®¡ç†ï¼š</p><ul><li>ä½¿ç”¨åˆé€‚çš„è¯ä¹¦æœ‰æ•ˆæœŸï¼ˆå»ºè®®1-2å¹´ï¼‰</li><li>è®¾ç½®è¯ä¹¦åˆ°æœŸæé†’æœºåˆ¶</li><li>ä¿ç®¡å¥½è¯ä¹¦ç§é’¥ï¼Œé¿å…æ³„éœ²</li><li>å®šæœŸæ›´æ–°è¯ä¹¦ï¼Œç¡®ä¿TLSå®‰å…¨</li></ul></li><li><p>ç½‘ç»œå®‰å…¨ï¼š</p><ul><li>é…ç½®é˜²ç«å¢™è§„åˆ™ï¼Œåªå¼€æ”¾å¿…è¦ç«¯å£</li><li>ä½¿ç”¨å®‰å…¨çš„TLSç‰ˆæœ¬ï¼ˆTLS 1.2+ï¼‰</li><li>ç¦ç”¨ä¸å®‰å…¨çš„åŠ å¯†å¥—ä»¶</li><li>é…ç½®é€‚å½“çš„è¯·æ±‚é€Ÿç‡é™åˆ¶</li></ul></li></ol><h3 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h3><ol><li>ç³»ç»Ÿé…ç½®ï¼š<ul><li>è°ƒæ•´ç³»ç»Ÿæ–‡ä»¶æè¿°ç¬¦é™åˆ¶</li></ul></li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/etc/security/limits.conf</span></span><br><span class="line">minio-user soft nofile 65536</span><br><span class="line">minio-user hard nofile 65536</span><br></pre></td></tr></table></figure><ol start="2"><li><p>å­˜å‚¨ä¼˜åŒ–ï¼š</p><ul><li>ä½¿ç”¨XFSæ–‡ä»¶ç³»ç»Ÿè·å¾—æ›´å¥½æ€§èƒ½</li><li>é…ç½®åˆé€‚çš„ç£ç›˜é¢„è¯»å€¼</li><li>å¯ç”¨ç£ç›˜ç¼“å­˜</li><li>å®šæœŸè¿›è¡Œç¢ç‰‡æ•´ç†</li></ul></li><li><p>ç½‘ç»œä¼˜åŒ–ï¼š</p><ul><li>è°ƒæ•´TCPå‚æ•°ä¼˜åŒ–ç½‘ç»œæ€§èƒ½</li><li>é…ç½®åˆé€‚çš„Nginx workerè¿›ç¨‹æ•°</li><li>å¯ç”¨Nginxå‹ç¼©å‡å°‘ä¼ è¾“é‡</li><li>é…ç½®å®¢æˆ·ç«¯ç¼“å­˜ç­–ç•¥</li></ul></li></ol><h3 id="ç»´æŠ¤å»ºè®®"><a href="#ç»´æŠ¤å»ºè®®" class="headerlink" title="ç»´æŠ¤å»ºè®®"></a>ç»´æŠ¤å»ºè®®</h3><ol><li><p>æ•°æ®å¤‡ä»½ï¼š</p><ul><li>åˆ¶å®šå®šæœŸå¤‡ä»½è®¡åˆ’</li><li>éªŒè¯å¤‡ä»½æ•°æ®çš„å®Œæ•´æ€§</li><li>å­˜å‚¨å¤šä¸ªå¤‡ä»½å‰¯æœ¬</li><li>æµ‹è¯•æ•°æ®æ¢å¤æµç¨‹</li></ul></li><li><p>ç›‘æ§å‘Šè­¦ï¼š</p><ul><li>ç›‘æ§æœåŠ¡çŠ¶æ€å’Œèµ„æºä½¿ç”¨</li><li>è®¾ç½®ç£ç›˜ç©ºé—´å‘Šè­¦é˜ˆå€¼</li><li>ç›‘æ§è¯ä¹¦æœ‰æ•ˆæœŸ</li><li>é…ç½®æœåŠ¡å¯ç”¨æ€§ç›‘æ§</li></ul></li><li><p>ç‰ˆæœ¬ç®¡ç†ï¼š</p><ul><li>å…³æ³¨å®‰å…¨æ›´æ–°å’Œè¡¥ä¸</li><li>åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯æ–°ç‰ˆæœ¬</li><li>åˆ¶å®šå›æ»šè®¡åˆ’</li><li>è®°å½•ç‰ˆæœ¬å˜æ›´æ—¥å¿—</li></ul></li></ol><h3 id="æ•…éšœæ’æŸ¥"><a href="#æ•…éšœæ’æŸ¥" class="headerlink" title="æ•…éšœæ’æŸ¥"></a>æ•…éšœæ’æŸ¥</h3><ol><li><p>å¸¸è§é—®é¢˜ï¼š</p><ul><li>è¯ä¹¦é…ç½®é”™è¯¯ï¼šæ£€æŸ¥è¯ä¹¦è·¯å¾„å’Œæƒé™</li><li>ç«¯å£å†²çªï¼šç¡®è®¤ç«¯å£å ç”¨æƒ…å†µ</li><li>æƒé™é—®é¢˜ï¼šæ£€æŸ¥ç›®å½•å’Œæ–‡ä»¶æƒé™</li><li>ç½‘ç»œè¿æ¥ï¼šéªŒè¯é˜²ç«å¢™å’Œç½‘ç»œé…ç½®</li></ul></li><li><p>æ—¥å¿—åˆ†æï¼š</p></li></ol><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MinIOæ—¥å¿—</span></span><br><span class="line">tail -f /var/log/minio/minio.log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Nginxè®¿é—®æ—¥å¿—</span></span><br><span class="line">tail -f /var/log/nginx/access.log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Nginxé”™è¯¯æ—¥å¿—</span></span><br><span class="line">tail -f /var/log/nginx/error.log</span><br></pre></td></tr></table></figure><ol start="3"><li>æœåŠ¡æ¢å¤ï¼š<ul><li>ä¿å­˜é—®é¢˜ç°åœºï¼Œæ”¶é›†ç›¸å…³æ—¥å¿—</li><li>æŒ‰ç…§æ ‡å‡†æµç¨‹è¿›è¡Œæ•…éšœå¤„ç†</li><li>è®°å½•è§£å†³æ–¹æ¡ˆï¼Œæ›´æ–°æ–‡æ¡£</li><li>æ€»ç»“ç»éªŒæ•™è®­ï¼Œä¼˜åŒ–æµç¨‹</li></ul></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†MinIOå¯¹è±¡å­˜å‚¨æœåŠ¡çš„TLSå®‰å…¨éƒ¨ç½²æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æœåŠ¡å®‰è£…ã€TLSè¯ä¹¦é…ç½®ã€Nginxåå‘ä»£ç†ç­‰æ ¸å¿ƒå†…å®¹ã€‚é€šè¿‡åœ¨çº¿å®‰è£…å’Œé…ç½®ï¼Œå®ç°äº†MinIOæœåŠ¡çš„HTTPSå®‰å…¨è®¿é—®ï¼Œé€‚åˆéœ€è¦éƒ¨ç½²å®‰å…¨å¯¹è±¡å­˜å‚¨æœåŠ¡çš„è¿ç»´äººå‘˜å‚è€ƒã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="MinIO" scheme="https://freemankevin.uk/categories/MinIO/"/>
    
    
    <category term="MinIO" scheme="https://freemankevin.uk/tags/MinIO/"/>
    
    <category term="TLS" scheme="https://freemankevin.uk/tags/TLS/"/>
    
    <category term="NGINX" scheme="https://freemankevin.uk/tags/NGINX/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤æŒ‡å—</title>
    <link href="https://freemankevin.uk/2025/01/15/backup-pg/"/>
    <id>https://freemankevin.uk/2025/01/15/backup-pg/</id>
    <published>2025-01-15T08:09:25.000Z</published>
    <updated>2025-10-21T03:34:40.405Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†PostgreSQLæ•°æ®åº“çš„ä¸¤ç§ä¸»è¦å¤‡ä»½æ–¹æ¡ˆï¼šåŸºäºå½’æ¡£æ—¥å¿—çš„PITRå’ŒåŸºäºpg_basebackupçš„ç‰©ç†å¤‡ä»½ã€‚æ–‡æ¡£æ¶µç›–äº†ç³»ç»Ÿé…ç½®ã€æ€§èƒ½ä¼˜åŒ–ã€ç›‘æ§å‘Šè­¦ã€ç¾éš¾æ¢å¤ç­‰å®Œæ•´è§£å†³æ–¹æ¡ˆï¼Œå¹¶æä¾›äº†è¯¦ç»†çš„è„šæœ¬ç¤ºä¾‹å’Œæœ€ä½³å®è·µå»ºè®®ï¼Œå¸®åŠ©æ•°æ®åº“ç®¡ç†å‘˜å®ç°å¯é çš„æ•°æ®å¤‡ä»½ä¸æ¢å¤ç­–ç•¥ã€‚</p><span id="more"></span><h2 id="å¤‡ä»½ç­–ç•¥é€‰æ‹©"><a href="#å¤‡ä»½ç­–ç•¥é€‰æ‹©" class="headerlink" title="å¤‡ä»½ç­–ç•¥é€‰æ‹©"></a>å¤‡ä»½ç­–ç•¥é€‰æ‹©</h2><ol><li><p>PITRé€‚ç”¨åœºæ™¯ï¼š</p><ul><li>éœ€è¦ç²¾ç¡®æ—¶é—´ç‚¹æ¢å¤</li><li>å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜</li><li>æœ‰å……è¶³çš„å­˜å‚¨ç©ºé—´</li><li>å¯ä»¥æ‰¿å—ä¸€å®šçš„æ€§èƒ½å¼€é”€</li></ul></li><li><p>ç‰©ç†å¤‡ä»½é€‚ç”¨åœºæ™¯ï¼š</p><ul><li>éœ€è¦å®Œæ•´çš„æ•°æ®åº“å‰¯æœ¬</li><li>å¯¹å¤‡ä»½å’Œæ¢å¤é€Ÿåº¦è¦æ±‚é«˜</li><li>å­˜å‚¨ç©ºé—´æœ‰é™</li><li>ä¸»è¦ç”¨äºç¾éš¾æ¢å¤</li></ul></li></ol><h2 id="æ–¹æ¡ˆä¸€ï¼šå½’æ¡£æ—¥å¿—å¤‡ä»½-PITR"><a href="#æ–¹æ¡ˆä¸€ï¼šå½’æ¡£æ—¥å¿—å¤‡ä»½-PITR" class="headerlink" title="æ–¹æ¡ˆä¸€ï¼šå½’æ¡£æ—¥å¿—å¤‡ä»½(PITR)"></a>æ–¹æ¡ˆä¸€ï¼šå½’æ¡£æ—¥å¿—å¤‡ä»½(PITR)</h2><h3 id="ç³»ç»Ÿè¦æ±‚"><a href="#ç³»ç»Ÿè¦æ±‚" class="headerlink" title="ç³»ç»Ÿè¦æ±‚"></a>ç³»ç»Ÿè¦æ±‚</h3><ol><li><p>å­˜å‚¨ç©ºé—´ï¼š</p><ul><li>WALæ—¥å¿—ç©ºé—´ &#x3D; æ¯æ—¥WALç”Ÿæˆé‡ Ã— ä¿ç•™å¤©æ•°</li><li>å½’æ¡£ç©ºé—´ &#x3D; WALæ—¥å¿—ç©ºé—´ Ã— 1.2(å‹ç¼©æ¯”)</li><li>åŸºç¡€å¤‡ä»½ç©ºé—´ &#x3D; æ•°æ®åº“å¤§å° Ã— 2</li></ul></li><li><p>æ€§èƒ½å½±å“ï¼š</p><ul><li>CPU: é¢å¤–5-10%è´Ÿè½½(å½’æ¡£å‹ç¼©)</li><li>I&#x2F;O: é¢å¤–10-20%å†™å…¥é‡</li><li>ç½‘ç»œ: å½’æ¡£ä¼ è¾“å¸¦å®½</li></ul></li></ol><h3 id="è¯¦ç»†é…ç½®"><a href="#è¯¦ç»†é…ç½®" class="headerlink" title="è¯¦ç»†é…ç½®"></a>è¯¦ç»†é…ç½®</h3><ol><li>postgresql.confæ ¸å¿ƒå‚æ•°ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># WALé…ç½®</span></span><br><span class="line">wal_level = replica                    <span class="comment"># å¯ç”¨å¿…è¦çš„WALä¿¡æ¯</span></span><br><span class="line">archive_mode = on                      <span class="comment"># å¼€å¯å½’æ¡£</span></span><br><span class="line">archive_command = <span class="string">&#x27;test ! -f /archive/%f &amp;&amp; cp %p /archive/%f&#x27;</span>  <span class="comment"># å½’æ¡£å‘½ä»¤</span></span><br><span class="line">archive_timeout = 60                   <span class="comment"># æœ€å¤§å½’æ¡£é—´éš”(ç§’)</span></span><br><span class="line">wal_keep_segments = 32                 <span class="comment"># ä¿ç•™çš„WALæ•°é‡</span></span><br><span class="line">max_wal_size = 1GB                    <span class="comment"># WALæœ€å¤§å¤§å°</span></span><br><span class="line">min_wal_size = 80MB                   <span class="comment"># WALæœ€å°å¤§å°</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ç‚¹é…ç½®</span></span><br><span class="line">checkpoint_timeout = 5min              <span class="comment"># æ£€æŸ¥ç‚¹é—´éš”</span></span><br><span class="line">checkpoint_completion_target = 0.9     <span class="comment"># æ£€æŸ¥ç‚¹å®Œæˆç›®æ ‡</span></span><br><span class="line">checkpoint_warning = 30s               <span class="comment"># æ£€æŸ¥ç‚¹è­¦å‘Šé˜ˆå€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å½’æ¡£å‚æ•°</span></span><br><span class="line">archive_timeout = 60                   <span class="comment"># å¼ºåˆ¶åˆ‡æ¢WALçš„æ—¶é—´</span></span><br><span class="line">archive_library = <span class="string">&#x27;&#x27;</span>                   <span class="comment"># è‡ªå®šä¹‰å½’æ¡£æ¨¡å—</span></span><br></pre></td></tr></table></figure><ol start="2"><li>é«˜çº§å½’æ¡£å‘½ä»¤ç¤ºä¾‹ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¸¦å‹ç¼©çš„å½’æ¡£</span></span><br><span class="line">archive_command = <span class="string">&#x27;gzip &lt; %p &gt; /archive/%f.gz&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸¦éªŒè¯çš„å½’æ¡£</span></span><br><span class="line">archive_command = <span class="string">&#x27;cp %p /archive/%f &amp;&amp; sha256sum /archive/%f &gt; /archive/%f.sha256&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿œç¨‹å½’æ¡£</span></span><br><span class="line">archive_command = <span class="string">&#x27;rsync -a %p backup_server:/archive/%f&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤šç›®æ ‡å½’æ¡£</span></span><br><span class="line">archive_command = <span class="string">&#x27;cp %p /archive1/%f &amp;&amp; cp %p /archive2/%f&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="ç›‘æ§å’Œç»´æŠ¤"><a href="#ç›‘æ§å’Œç»´æŠ¤" class="headerlink" title="ç›‘æ§å’Œç»´æŠ¤"></a>ç›‘æ§å’Œç»´æŠ¤</h3><ol><li>å½’æ¡£çŠ¶æ€ç›‘æ§ï¼š</li></ol><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å½’æ¡£ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> pg_stat_archiver;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- WALç”Ÿæˆé€Ÿç‡</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="built_in">current_timestamp</span>,</span><br><span class="line">    pg_walfile_name(pg_current_wal_lsn()),</span><br><span class="line">    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), <span class="string">&#x27;0/0&#x27;</span>::pg_lsn)) <span class="keyword">as</span> total_wal_size;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å½’æ¡£å»¶è¿Ÿç›‘æ§</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    archived_count,</span><br><span class="line">    failed_count,</span><br><span class="line">    stats_reset,</span><br><span class="line">    <span class="keyword">CASE</span> <span class="keyword">WHEN</span> last_failed_wal <span class="keyword">IS</span> <span class="keyword">NOT NULL</span> </span><br><span class="line">         <span class="keyword">THEN</span> <span class="string">&#x27;Warning: Archive failed for &#x27;</span> <span class="operator">||</span> last_failed_wal </span><br><span class="line">         <span class="keyword">ELSE</span> <span class="string">&#x27;OK&#x27;</span> </span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">as</span> archive_status</span><br><span class="line"><span class="keyword">FROM</span> pg_stat_archiver;</span><br></pre></td></tr></table></figure><ol start="2"><li>ç©ºé—´ç›‘æ§è„šæœ¬ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">ARCHIVE_DIR=<span class="string">&quot;/archive&quot;</span></span><br><span class="line">THRESHOLD=80  <span class="comment"># ç©ºé—´ä½¿ç”¨ç‡è­¦å‘Šé˜ˆå€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥å½’æ¡£ç›®å½•ç©ºé—´</span></span><br><span class="line">usage=$(<span class="built_in">df</span> -h <span class="variable">$&#123;ARCHIVE_DIR&#125;</span> | awk <span class="string">&#x27;NR==2 &#123;print $5&#125;&#x27;</span> | sed <span class="string">&#x27;s/%//&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$usage</span> -gt <span class="variable">$THRESHOLD</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Warning: Archive directory usage is <span class="variable">$&#123;usage&#125;</span>%&quot;</span></span><br><span class="line">    <span class="comment"># å¯ä»¥æ·»åŠ å‘Šè­¦é€šçŸ¥</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥æœ€è€çš„å½’æ¡£æ–‡ä»¶</span></span><br><span class="line">oldest_archive=$(find <span class="variable">$&#123;ARCHIVE_DIR&#125;</span> -<span class="built_in">type</span> f -name <span class="string">&quot;*.gz&quot;</span> -<span class="built_in">printf</span> <span class="string">&#x27;%T+ %p\n&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">head</span> -n 1)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Oldest archive file: <span class="variable">$&#123;oldest_archive&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><h2 id="æ–¹æ¡ˆäºŒï¼šç‰©ç†å¤‡ä»½"><a href="#æ–¹æ¡ˆäºŒï¼šç‰©ç†å¤‡ä»½" class="headerlink" title="æ–¹æ¡ˆäºŒï¼šç‰©ç†å¤‡ä»½"></a>æ–¹æ¡ˆäºŒï¼šç‰©ç†å¤‡ä»½</h2><h3 id="é«˜çº§é…ç½®"><a href="#é«˜çº§é…ç½®" class="headerlink" title="é«˜çº§é…ç½®"></a>é«˜çº§é…ç½®</h3><ol><li>å¤‡ä»½å‹ç¼©é€‰é¡¹ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># GZIPå‹ç¼©(é»˜è®¤)</span></span><br><span class="line">pg_basebackup -Z 9 -D /backup/base</span><br><span class="line"></span><br><span class="line"><span class="comment"># ZSTDå‹ç¼©(æ¨è)</span></span><br><span class="line">pg_basebackup -Z zstd -D /backup/base</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¹¶è¡Œå‹ç¼©</span></span><br><span class="line">pg_basebackup -j 4 -Z zstd -D /backup/base</span><br></pre></td></tr></table></figure><ol start="2"><li>å¢å¼ºçš„å¤‡ä»½è„šæœ¬ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®</span></span><br><span class="line">BACKUP_DIR=<span class="string">&quot;/backup/pg&quot;</span></span><br><span class="line">RETENTION_DAYS=90</span><br><span class="line">DATE=$(<span class="built_in">date</span> +%Y%m%d_%H%M%S)</span><br><span class="line">LOG_DIR=<span class="string">&quot;/var/log/pg_backup&quot;</span></span><br><span class="line">ALERT_EMAIL=<span class="string">&quot;dba@example.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$&#123;BACKUP_DIR&#125;</span>/<span class="variable">$&#123;DATE&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$LOG_DIR</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤‡ä»½å‰æ£€æŸ¥</span></span><br><span class="line"><span class="function"><span class="title">check_prerequisites</span></span>() &#123;</span><br><span class="line">    <span class="comment"># æ£€æŸ¥ç©ºé—´</span></span><br><span class="line">    <span class="built_in">local</span> required_space=$(<span class="built_in">du</span> -s <span class="variable">$PGDATA</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">    <span class="built_in">local</span> available_space=$(<span class="built_in">df</span> <span class="variable">$BACKUP_DIR</span> | awk <span class="string">&#x27;NR==2 &#123;print $4&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$available_space</span> -lt <span class="variable">$required_space</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Error: Insufficient space&quot;</span> | mail -s <span class="string">&quot;Backup Failed&quot;</span> <span class="variable">$ALERT_EMAIL</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ£€æŸ¥è¿æ¥æ€§</span></span><br><span class="line">    <span class="keyword">if</span> ! psql -c <span class="string">&quot;SELECT 1&quot;</span> &gt; /dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Error: Cannot connect to database&quot;</span> | mail -s <span class="string">&quot;Backup Failed&quot;</span> <span class="variable">$ALERT_EMAIL</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œå¤‡ä»½</span></span><br><span class="line"><span class="function"><span class="title">perform_backup</span></span>() &#123;</span><br><span class="line">    pg_basebackup \</span><br><span class="line">        -D <span class="string">&quot;<span class="variable">$&#123;BACKUP_DIR&#125;</span>/<span class="variable">$&#123;DATE&#125;</span>&quot;</span> \</span><br><span class="line">        -Ft -j 4 \</span><br><span class="line">        -Z zstd \</span><br><span class="line">        -P \</span><br><span class="line">        -X stream \</span><br><span class="line">        -U backup_user \</span><br><span class="line">        --checkpoint=fast \</span><br><span class="line">        --wal-method=stream \</span><br><span class="line">        --progress \</span><br><span class="line">        --verbose</span><br><span class="line"></span><br><span class="line">    <span class="comment"># éªŒè¯å¤‡ä»½</span></span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># åˆ›å»ºæ ¡éªŒå’Œ</span></span><br><span class="line">        <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$&#123;BACKUP_DIR&#125;</span>/<span class="variable">$&#123;DATE&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">sha256sum</span> * &gt; SHA256SUMS</span><br><span class="line">        <span class="comment"># è®°å½•å¤‡ä»½å…ƒæ•°æ®</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Backup completed at <span class="subst">$(date)</span>&quot;</span> &gt; backup_info.txt</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;PostgreSQL Version: <span class="subst">$(psql -V)</span>&quot;</span> &gt;&gt; backup_info.txt</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Backup Size: <span class="subst">$(du -sh .)</span>&quot;</span> &gt;&gt; backup_info.txt</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Backup failed&quot;</span> | mail -s <span class="string">&quot;Backup Failed&quot;</span> <span class="variable">$ALERT_EMAIL</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…ç†</span></span><br><span class="line"><span class="function"><span class="title">cleanup_old_backups</span></span>() &#123;</span><br><span class="line">    find <span class="variable">$BACKUP_DIR</span> -maxdepth 1 -mtime +<span class="variable">$RETENTION_DAYS</span> -<span class="built_in">exec</span> <span class="built_in">rm</span> -rf &#123;&#125; \;</span><br><span class="line">    <span class="comment"># ä¿ç•™æœ€æ–°çš„5ä¸ªå¤‡ä»½ï¼Œå³ä½¿è¶…è¿‡ä¿ç•™å¤©æ•°</span></span><br><span class="line">    <span class="built_in">ls</span> -t <span class="variable">$BACKUP_DIR</span> | <span class="built_in">tail</span> -n +6 | xargs -I &#123;&#125; <span class="built_in">rm</span> -rf <span class="string">&quot;<span class="variable">$BACKUP_DIR</span>/&#123;&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸»æµç¨‹</span></span><br><span class="line">check_prerequisites</span><br><span class="line">perform_backup</span><br><span class="line">cleanup_old_backups</span><br></pre></td></tr></table></figure><h3 id="æ¢å¤éªŒè¯"><a href="#æ¢å¤éªŒè¯" class="headerlink" title="æ¢å¤éªŒè¯"></a>æ¢å¤éªŒè¯</h3><ol><li>è‡ªåŠ¨æ¢å¤éªŒè¯è„šæœ¬ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æµ‹è¯•ç¯å¢ƒ</span></span><br><span class="line">TEST_DIR=<span class="string">&quot;/tmp/pg_restore_test&quot;</span></span><br><span class="line">BACKUP_DIR=<span class="string">&quot;/backup/pg&quot;</span></span><br><span class="line">LATEST_BACKUP=$(<span class="built_in">ls</span> -t <span class="variable">$BACKUP_DIR</span> | <span class="built_in">head</span> -n1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡†å¤‡æµ‹è¯•ç¯å¢ƒ</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$TEST_DIR</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$TEST_DIR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å‹æœ€æ–°å¤‡ä»½</span></span><br><span class="line">tar xf <span class="variable">$BACKUP_DIR</span>/<span class="variable">$LATEST_BACKUP</span>/base.tar.zst</span><br><span class="line">tar xf <span class="variable">$BACKUP_DIR</span>/<span class="variable">$LATEST_BACKUP</span>/pg_wal.tar.zst</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æµ‹è¯•å®ä¾‹</span></span><br><span class="line">initdb -D <span class="variable">$TEST_DIR</span>/data</span><br><span class="line"><span class="built_in">cp</span> postgresql.conf postgresql.conf.orig</span><br><span class="line">sed -i <span class="string">&#x27;s/port = 5432/port = 5433/&#x27;</span> postgresql.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨æµ‹è¯•å®ä¾‹</span></span><br><span class="line">pg_ctl -D <span class="variable">$TEST_DIR</span>/data -l logfile start</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯æ•°æ®</span></span><br><span class="line">psql -p 5433 -c <span class="string">&quot;SELECT count(*) FROM pg_database;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…ç†</span></span><br><span class="line">pg_ctl -D <span class="variable">$TEST_DIR</span>/data stop</span><br><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$TEST_DIR</span></span><br></pre></td></tr></table></figure><h2 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h2><h3 id="I-Oä¼˜åŒ–"><a href="#I-Oä¼˜åŒ–" class="headerlink" title="I&#x2F;Oä¼˜åŒ–"></a>I&#x2F;Oä¼˜åŒ–</h3><ol><li>æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨XFSæ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">mkfs.xfs -f -d agcount=16 -l size=128m /dev/sdb1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‚è½½é€‰é¡¹</span></span><br><span class="line">mount -o noatime,nodiratime,logbufs=8 /dev/sdb1 /archive</span><br></pre></td></tr></table></figure><ol start="2"><li>I&#x2F;Oè°ƒåº¦ä¼˜åŒ–ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®I/Oè°ƒåº¦å™¨</span></span><br><span class="line"><span class="built_in">echo</span> deadline &gt; /sys/block/sda/queue/scheduler</span><br><span class="line"></span><br><span class="line"><span class="comment"># è°ƒæ•´é¢„è¯»å¤§å°</span></span><br><span class="line">blockdev --setra 16384 /dev/sda</span><br></pre></td></tr></table></figure><h3 id="ç½‘ç»œä¼˜åŒ–"><a href="#ç½‘ç»œä¼˜åŒ–" class="headerlink" title="ç½‘ç»œä¼˜åŒ–"></a>ç½‘ç»œä¼˜åŒ–</h3><ol><li>TCPå‚æ•°ä¼˜åŒ–ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/sysctl.conf</span></span><br><span class="line">net.core.rmem_max = 16777216</span><br><span class="line">net.core.wmem_max = 16777216</span><br><span class="line">net.ipv4.tcp_rmem = 4096 87380 16777216</span><br><span class="line">net.ipv4.tcp_wmem = 4096 65536 16777216</span><br><span class="line">net.ipv4.tcp_window_scaling = 1</span><br></pre></td></tr></table></figure><ol start="2"><li>ç½‘ç»œæ¥å£ä¼˜åŒ–ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è°ƒæ•´ç½‘å¡é˜Ÿåˆ—é•¿åº¦</span></span><br><span class="line">ethtool -G eth0 rx 4096 tx 4096</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯ç½‘å¡å¤šé˜Ÿåˆ—</span></span><br><span class="line">ethtool -L eth0 combined 4</span><br></pre></td></tr></table></figure><h2 id="ç›‘æ§ä¸å‘Šè­¦"><a href="#ç›‘æ§ä¸å‘Šè­¦" class="headerlink" title="ç›‘æ§ä¸å‘Šè­¦"></a>ç›‘æ§ä¸å‘Šè­¦</h2><ol><li>å¤‡ä»½ç›‘æ§æŒ‡æ ‡ï¼š</li></ol><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å¤‡ä»½å»¶è¿Ÿç›‘æ§</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">FUNCTION</span> check_backup_delay()</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="keyword">TABLE</span> (</span><br><span class="line">    backup_type text,</span><br><span class="line">    last_backup <span class="type">timestamp</span>,</span><br><span class="line">    delay_hours <span class="type">numeric</span>,</span><br><span class="line">    status text</span><br><span class="line">) <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">RETURN</span> QUERY</span><br><span class="line">    <span class="keyword">WITH</span> backup_status <span class="keyword">AS</span> (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            <span class="string">&#x27;Physical Backup&#x27;</span> <span class="keyword">as</span> type,</span><br><span class="line">            <span class="built_in">COALESCE</span>(</span><br><span class="line">                (<span class="keyword">SELECT</span> <span class="built_in">MAX</span>(modified_time)</span><br><span class="line">                 <span class="keyword">FROM</span> pg_ls_dir_timestamp(<span class="string">&#x27;/backup/pg&#x27;</span>)),</span><br><span class="line">                <span class="string">&#x27;1970-01-01&#x27;</span>::<span class="type">timestamp</span></span><br><span class="line">            ) <span class="keyword">as</span> last_time</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        type,</span><br><span class="line">        last_time,</span><br><span class="line">        <span class="built_in">EXTRACT</span>(EPOCH <span class="keyword">FROM</span> (now() <span class="operator">-</span> last_time))<span class="operator">/</span><span class="number">3600</span> <span class="keyword">as</span> hours,</span><br><span class="line">        <span class="keyword">CASE</span></span><br><span class="line">            <span class="keyword">WHEN</span> <span class="built_in">EXTRACT</span>(EPOCH <span class="keyword">FROM</span> (now() <span class="operator">-</span> last_time))<span class="operator">/</span><span class="number">3600</span> <span class="operator">&gt;</span> <span class="number">24</span> </span><br><span class="line">            <span class="keyword">THEN</span> <span class="string">&#x27;CRITICAL&#x27;</span></span><br><span class="line">            <span class="keyword">WHEN</span> <span class="built_in">EXTRACT</span>(EPOCH <span class="keyword">FROM</span> (now() <span class="operator">-</span> last_time))<span class="operator">/</span><span class="number">3600</span> <span class="operator">&gt;</span> <span class="number">12</span> </span><br><span class="line">            <span class="keyword">THEN</span> <span class="string">&#x27;WARNING&#x27;</span></span><br><span class="line">            <span class="keyword">ELSE</span> <span class="string">&#x27;OK&#x27;</span></span><br><span class="line">        <span class="keyword">END</span></span><br><span class="line">    <span class="keyword">FROM</span> backup_status;</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line">$$ <span class="keyword">LANGUAGE</span> plpgsql;</span><br></pre></td></tr></table></figure><ol start="2"><li>å‘Šè­¦é›†æˆï¼š</li></ol><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> psycopg2</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_backup_status</span>():</span><br><span class="line">    conn = psycopg2.connect(<span class="string">&quot;dbname=postgres&quot;</span>)</span><br><span class="line">    cur = conn.cursor()</span><br><span class="line">    </span><br><span class="line">    cur.execute(<span class="string">&quot;SELECT * FROM check_backup_delay()&quot;</span>)</span><br><span class="line">    results = cur.fetchall()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">        <span class="keyword">if</span> result[<span class="number">3</span>] != <span class="string">&#x27;OK&#x27;</span>:</span><br><span class="line">            send_alert(<span class="string">f&quot;Backup Alert: <span class="subst">&#123;result[<span class="number">0</span>]&#125;</span> is <span class="subst">&#123;result[<span class="number">3</span>]&#125;</span>, delay: <span class="subst">&#123;result[<span class="number">2</span>]&#125;</span> hours&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_alert</span>(<span class="params">message</span>):</span><br><span class="line">    webhook_url = <span class="string">&quot;https://alert.example.com/webhook&quot;</span></span><br><span class="line">    payload = &#123;<span class="string">&quot;text&quot;</span>: message&#125;</span><br><span class="line">    requests.post(webhook_url, json=payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    check_backup_status()</span><br></pre></td></tr></table></figure><h2 id="ç¾éš¾æ¢å¤"><a href="#ç¾éš¾æ¢å¤" class="headerlink" title="ç¾éš¾æ¢å¤"></a>ç¾éš¾æ¢å¤</h2><h3 id="æ¢å¤æ—¶é—´ç›®æ ‡-RTO-è¯„ä¼°"><a href="#æ¢å¤æ—¶é—´ç›®æ ‡-RTO-è¯„ä¼°" class="headerlink" title="æ¢å¤æ—¶é—´ç›®æ ‡(RTO)è¯„ä¼°"></a>æ¢å¤æ—¶é—´ç›®æ ‡(RTO)è¯„ä¼°</h3><ol><li><p>è¯„ä¼°å› ç´ ï¼š</p><ul><li>æ•°æ®åº“å¤§å°</li><li>å¯ç”¨ç½‘ç»œå¸¦å®½</li><li>å­˜å‚¨æ€§èƒ½</li><li>WALé‡æ”¾é€Ÿåº¦</li></ul></li><li><p>è®¡ç®—å…¬å¼ï¼š</p></li></ol><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_rto</span>(<span class="params">db_size_gb, network_speed_mbps, storage_iops</span>):</span><br><span class="line">    <span class="comment"># ä¼ è¾“æ—¶é—´</span></span><br><span class="line">    transfer_time = (db_size_gb * <span class="number">1024</span> * <span class="number">8</span>) / (network_speed_mbps * <span class="number">60</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è§£å‹æ—¶é—´</span></span><br><span class="line">    decompress_time = db_size_gb * <span class="number">0.5</span>  <span class="comment"># ä¼°ç®—å€¼</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># WALé‡æ”¾æ—¶é—´</span></span><br><span class="line">    wal_replay_time = db_size_gb * <span class="number">0.3</span>  <span class="comment"># ä¼°ç®—å€¼</span></span><br><span class="line">    </span><br><span class="line">    total_time = transfer_time + decompress_time + wal_replay_time</span><br><span class="line">    <span class="keyword">return</span> total_time</span><br></pre></td></tr></table></figure><h3 id="æ¢å¤æ¼”ç»ƒ"><a href="#æ¢å¤æ¼”ç»ƒ" class="headerlink" title="æ¢å¤æ¼”ç»ƒ"></a>æ¢å¤æ¼”ç»ƒ</h3><ol><li><p>æ¼”ç»ƒè®¡åˆ’ï¼š</p><ul><li>æ¯å­£åº¦è¿›è¡Œä¸€æ¬¡å®Œæ•´æ¢å¤æ¼”ç»ƒ</li><li>æ¯æœˆè¿›è¡Œä¸€æ¬¡éƒ¨åˆ†æ•°æ®æ¢å¤æµ‹è¯•</li><li>è®°å½•å¹¶ä¼˜åŒ–æ¢å¤æµç¨‹</li></ul></li><li><p>æ¼”ç»ƒæ–‡æ¡£æ¨¡æ¿ï¼š</p></li></ol><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># æ¢å¤æ¼”ç»ƒæŠ¥å‘Š</span></span><br><span class="line"></span><br><span class="line"><span class="section">## åŸºæœ¬ä¿¡æ¯</span></span><br><span class="line"><span class="bullet">-</span> æ¼”ç»ƒæ—¥æœŸï¼š</span><br><span class="line"><span class="bullet">-</span> æ¼”ç»ƒç¯å¢ƒï¼š</span><br><span class="line"><span class="bullet">-</span> æ•°æ®åº“ç‰ˆæœ¬ï¼š</span><br><span class="line"><span class="bullet">-</span> å¤‡ä»½å¤§å°ï¼š</span><br><span class="line"></span><br><span class="line"><span class="section">## æ¢å¤æ­¥éª¤</span></span><br><span class="line"><span class="bullet">1.</span> å‡†å¤‡é˜¶æ®µ</span><br><span class="line"><span class="bullet">   -</span> [ ] éªŒè¯å¤‡ä»½å®Œæ•´æ€§</span><br><span class="line"><span class="bullet">   -</span> [ ] å‡†å¤‡æ¢å¤ç¯å¢ƒ</span><br><span class="line"><span class="bullet">   -</span> [ ] ç¡®è®¤å­˜å‚¨ç©ºé—´</span><br><span class="line"></span><br><span class="line"><span class="bullet">2.</span> æ‰§è¡Œé˜¶æ®µ</span><br><span class="line"><span class="bullet">   -</span> [ ] è§£å‹å¤‡ä»½æ–‡ä»¶</span><br><span class="line"><span class="bullet">   -</span> [ ] é…ç½®æ¢å¤å‚æ•°</span><br><span class="line"><span class="bullet">   -</span> [ ] å¯åŠ¨æ•°æ®åº“</span><br><span class="line"><span class="bullet">   -</span> [ ] éªŒè¯æ•°æ®ä¸€è‡´æ€§</span><br><span class="line"></span><br><span class="line"><span class="bullet">3.</span> éªŒè¯é˜¶æ®µ</span><br><span class="line"><span class="bullet">   -</span> [ ] æ£€æŸ¥ç³»ç»Ÿè¡¨</span><br><span class="line"><span class="bullet">   -</span> [ ] éªŒè¯ç”¨æˆ·æ•°æ®</span><br><span class="line"><span class="bullet">   -</span> [ ] æµ‹è¯•åº”ç”¨è¿æ¥</span><br><span class="line"></span><br><span class="line"><span class="section">## ç»“æœåˆ†æ</span></span><br><span class="line"><span class="bullet">-</span> æ¢å¤æ€»è€—æ—¶ï¼š</span><br><span class="line"><span class="bullet">-</span> é—®é¢˜è®°å½•ï¼š</span><br><span class="line"><span class="bullet">-</span> ä¼˜åŒ–å»ºè®®ï¼š</span><br></pre></td></tr></table></figure><h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><h3 id="å®‰å…¨å»ºè®®"><a href="#å®‰å…¨å»ºè®®" class="headerlink" title="å®‰å…¨å»ºè®®"></a>å®‰å…¨å»ºè®®</h3><ol><li>åŠ å¯†é…ç½®ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨GPGåŠ å¯†å¤‡ä»½</span></span><br><span class="line">gpg --encrypt --recipient backup@example.com base.tar.zst</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–ä½¿ç”¨openssl</span></span><br><span class="line">openssl enc -aes-256-cbc -salt -<span class="keyword">in</span> base.tar.zst -out base.tar.zst.enc</span><br></pre></td></tr></table></figure><ol start="2"><li>è®¿é—®æ§åˆ¶ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¤‡ä»½ç›®å½•æƒé™</span></span><br><span class="line"><span class="built_in">chmod</span> 700 /backup/pg</span><br><span class="line">setfacl -m u:postgres:rx /backup/pg</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ å¯†å¯†é’¥ç®¡ç†</span></span><br><span class="line">gpg --gen-key</span><br><span class="line">gpg --export-secret-keys --armor &gt; backup-key.asc</span><br></pre></td></tr></table></figure><h3 id="å­˜å‚¨ç®¡ç†"><a href="#å­˜å‚¨ç®¡ç†" class="headerlink" title="å­˜å‚¨ç®¡ç†"></a>å­˜å‚¨ç®¡ç†</h3><ol><li>å¤‡ä»½å‹ç¼©ç‡ç›‘æ§ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># ç›‘æ§å¤‡ä»½å‹ç¼©æ•ˆç‡</span></span><br><span class="line"><span class="keyword">for</span> backup <span class="keyword">in</span> /backup/pg/*/base.tar.zst; <span class="keyword">do</span></span><br><span class="line">    original_size=$(zstd -l <span class="string">&quot;<span class="variable">$backup</span>&quot;</span> | awk <span class="string">&#x27;NR==4 &#123;print $4&#125;&#x27;</span>)</span><br><span class="line">    compressed_size=$(zstd -l <span class="string">&quot;<span class="variable">$backup</span>&quot;</span> | awk <span class="string">&#x27;NR==4 &#123;print $2&#125;&#x27;</span>)</span><br><span class="line">    ratio=$(<span class="built_in">echo</span> <span class="string">&quot;scale=2; <span class="variable">$compressed_size</span>/<span class="variable">$original_size</span> * 100&quot;</span> | bc)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$backup</span>: <span class="variable">$ratio</span>% of original size&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><ol start="2"><li>å­˜å‚¨ç©ºé—´é¢„æµ‹ï¼š</li></ol><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">predict_storage_usage</span>(<span class="params">backup_dir, days=<span class="number">30</span></span>):</span><br><span class="line">    <span class="comment"># è·å–å†å²ä½¿ç”¨æ•°æ®</span></span><br><span class="line">    usage_data = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(days):</span><br><span class="line">        usage = psutil.disk_usage(backup_dir).used</span><br><span class="line">        usage_data.append(usage)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># çº¿æ€§å›å½’é¢„æµ‹</span></span><br><span class="line">    X = np.arange(days).reshape(-<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    y = np.array(usage_data)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LinearRegression</span><br><span class="line">    model = LinearRegression()</span><br><span class="line">    model.fit(X, y)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é¢„æµ‹ä¸‹ä¸€å‘¨æœŸ</span></span><br><span class="line">    future_days = np.arange(days, days+<span class="number">7</span>).reshape(-<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    predictions = model.predict(future_days)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> predictions</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡æ¡£æä¾›äº†PostgreSQLæ•°æ®åº“å¤‡ä»½ä¸æ¢å¤çš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬PITRå’Œç‰©ç†å¤‡ä»½ä¸¤ç§æ–¹æ¡ˆçš„è¯¦ç»†é…ç½®ã€ç›‘æ§ã€ä¼˜åŒ–å’Œæœ€ä½³å®è·µã€‚å»ºè®®æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„å¤‡ä»½ç­–ç•¥ï¼Œå¹¶å®šæœŸè¿›è¡Œæ¢å¤æ¼”ç»ƒä»¥ç¡®ä¿æ•°æ®å®‰å…¨ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†PostgreSQLæ•°æ®åº“çš„ä¸¤ç§ä¸»è¦å¤‡ä»½æ–¹æ¡ˆï¼šåŸºäºå½’æ¡£æ—¥å¿—çš„PITRå’ŒåŸºäºpg_basebackupçš„ç‰©ç†å¤‡ä»½ã€‚æ–‡æ¡£æ¶µç›–äº†ç³»ç»Ÿé…ç½®ã€æ€§èƒ½ä¼˜åŒ–ã€ç›‘æ§å‘Šè­¦ã€ç¾éš¾æ¢å¤ç­‰å®Œæ•´è§£å†³æ–¹æ¡ˆï¼Œå¹¶æä¾›äº†è¯¦ç»†çš„è„šæœ¬ç¤ºä¾‹å’Œæœ€ä½³å®è·µå»ºè®®ï¼Œå¸®åŠ©æ•°æ®åº“ç®¡ç†å‘˜å®ç°å¯é çš„æ•°æ®å¤‡ä»½ä¸æ¢å¤ç­–ç•¥ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="PostgreSQL" scheme="https://freemankevin.uk/categories/PostgreSQL/"/>
    
    
    <category term="Backup" scheme="https://freemankevin.uk/tags/Backup/"/>
    
    <category term="PITR" scheme="https://freemankevin.uk/tags/PITR/"/>
    
    <category term="PostgreSQL" scheme="https://freemankevin.uk/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>MinIO æ•°æ®åŒæ­¥ä¸è¿ç§»æŒ‡å—</title>
    <link href="https://freemankevin.uk/2025/01/15/backup-minio/"/>
    <id>https://freemankevin.uk/2025/01/15/backup-minio/</id>
    <published>2025-01-15T07:57:25.000Z</published>
    <updated>2025-10-21T03:34:40.405Z</updated>
    
    <content type="html"><![CDATA[<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†MinIOå¯¹è±¡å­˜å‚¨æœåŠ¡çš„æ•°æ®åŒæ­¥å’Œè¿ç§»æ–¹æ¡ˆï¼Œé‡ç‚¹å…³æ³¨2022å¹´6æœˆå‰åç‰ˆæœ¬çš„å­˜å‚¨ç»“æ„å·®å¼‚ã€‚æ–‡æ¡£æ¶µç›–äº†åŒç‰ˆæœ¬åŒæ­¥ã€è·¨ç‰ˆæœ¬è¿ç§»ã€åŸåœ°å‡çº§å’ŒåŒæœºè¿ç§»ç­‰å¤šç§åœºæ™¯çš„å…·ä½“æ“ä½œæ–¹æ³•ï¼Œå¹¶æä¾›äº†å®Œæ•´çš„å‘½ä»¤ç¤ºä¾‹å’Œæ³¨æ„äº‹é¡¹ï¼Œå¸®åŠ©è¿ç»´äººå‘˜å®‰å…¨å¯é åœ°å®ŒæˆMinIOæ•°æ®è¿ç§»å·¥ä½œã€‚</p><span id="more"></span><h2 id="ç‰ˆæœ¬ç‰¹æ€§å¯¹æ¯”"><a href="#ç‰ˆæœ¬ç‰¹æ€§å¯¹æ¯”" class="headerlink" title="ç‰ˆæœ¬ç‰¹æ€§å¯¹æ¯”"></a>ç‰ˆæœ¬ç‰¹æ€§å¯¹æ¯”</h2><h3 id="å­˜å‚¨ç»“æ„æ¼”è¿›"><a href="#å­˜å‚¨ç»“æ„æ¼”è¿›" class="headerlink" title="å­˜å‚¨ç»“æ„æ¼”è¿›"></a>å­˜å‚¨ç»“æ„æ¼”è¿›</h3><ol><li><p>2019å¹´åŠä»¥å‰ç‰ˆæœ¬ï¼š</p><ul><li>é‡‡ç”¨ç›´æ¥æ–‡ä»¶å­˜å‚¨æ¨¡å¼</li><li>ç®€å•çš„Webç•Œé¢</li><li>åŸºç¡€çš„å­˜å‚¨åŠŸèƒ½</li></ul></li><li><p>2020-2022.5ç‰ˆæœ¬ï¼š</p><ul><li>ä¿æŒç›´æ¥æ–‡ä»¶å­˜å‚¨æ¨¡å¼</li><li>æ”¹è¿›çš„Webç•Œé¢</li><li>å¼•å…¥Consoleç«¯å£é…ç½®</li></ul></li></ol><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">command:</span> <span class="string">server</span> <span class="string">/data</span> <span class="string">--console-address</span> <span class="string">&quot;:9001&quot;</span></span><br></pre></td></tr></table></figure><ol start="3"><li>2022.6åŠä»¥åç‰ˆæœ¬ï¼š<ul><li>é‡‡ç”¨ç›®å½•åŒ–å­˜å‚¨ç»“æ„</li><li>å®Œæ•´çš„Webæ§åˆ¶å°</li><li>å¢å¼ºçš„ç®¡ç†åŠŸèƒ½</li><li>å…ƒæ•°æ®åˆ†ç¦»å­˜å‚¨</li></ul></li></ol><h2 id="æ•°æ®åŒæ­¥æ–¹æ¡ˆ"><a href="#æ•°æ®åŒæ­¥æ–¹æ¡ˆ" class="headerlink" title="æ•°æ®åŒæ­¥æ–¹æ¡ˆ"></a>æ•°æ®åŒæ­¥æ–¹æ¡ˆ</h2><h3 id="åŒç‰ˆæœ¬åŒæ­¥"><a href="#åŒç‰ˆæœ¬åŒæ­¥" class="headerlink" title="åŒç‰ˆæœ¬åŒæ­¥"></a>åŒç‰ˆæœ¬åŒæ­¥</h3><ol><li>æ•°æ®æ–‡ä»¶åŒæ­¥ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åŒæ­¥æ¡¶æ•°æ®</span></span><br><span class="line"><span class="built_in">cp</span> -r /source/bucket/* /target/bucket/</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŒæ­¥å…ƒæ•°æ®</span></span><br><span class="line"><span class="built_in">cp</span> -r /source/.minio.sys /target/</span><br></pre></td></tr></table></figure><ol start="2"><li>æƒé™ç»´æŠ¤ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç¡®ä¿æƒé™æ­£ç¡®</span></span><br><span class="line"><span class="built_in">chown</span> -R minio:minio /target/bucket</span><br><span class="line"><span class="built_in">chmod</span> -R 750 /target/bucket</span><br></pre></td></tr></table></figure><h3 id="è·¨ç‰ˆæœ¬è¿ç§»"><a href="#è·¨ç‰ˆæœ¬è¿ç§»" class="headerlink" title="è·¨ç‰ˆæœ¬è¿ç§»"></a>è·¨ç‰ˆæœ¬è¿ç§»</h3><ol><li>ç¯å¢ƒå‡†å¤‡ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½MinIOå®¢æˆ·ç«¯</span></span><br><span class="line">wget https://dl.min.io/client/mc/release/linux-amd64/mc</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æ‰§è¡Œæƒé™</span></span><br><span class="line"><span class="built_in">chmod</span> +x mc</span><br></pre></td></tr></table></figure><ol start="2"><li>é…ç½®æœåŠ¡ç«¯ç‚¹ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é…ç½®æºæœåŠ¡å™¨</span></span><br><span class="line">./mc <span class="built_in">alias</span> <span class="built_in">set</span> source-minio http://source-ip:9000 access-key secret-key</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®ç›®æ ‡æœåŠ¡å™¨</span></span><br><span class="line">./mc <span class="built_in">alias</span> <span class="built_in">set</span> target-minio http://target-ip:9000 access-key secret-key</span><br></pre></td></tr></table></figure><ol start="3"><li>æ•°æ®è¿ç§»ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºæºæ¡¶</span></span><br><span class="line">./mc <span class="built_in">ls</span> source-minio</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºç›®æ ‡æ¡¶</span></span><br><span class="line">./mc <span class="built_in">ls</span> target-minio</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œè¿ç§»</span></span><br><span class="line">./mc mirror source-minio/source-bucket target-minio/target-bucket</span><br></pre></td></tr></table></figure><h2 id="å‡çº§ç­–ç•¥"><a href="#å‡çº§ç­–ç•¥" class="headerlink" title="å‡çº§ç­–ç•¥"></a>å‡çº§ç­–ç•¥</h2><h3 id="åŸåœ°å‡çº§æ–¹æ¡ˆ"><a href="#åŸåœ°å‡çº§æ–¹æ¡ˆ" class="headerlink" title="åŸåœ°å‡çº§æ–¹æ¡ˆ"></a>åŸåœ°å‡çº§æ–¹æ¡ˆ</h3><ol><li>å‡†å¤‡å·¥ä½œï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¤‡ä»½ç°æœ‰æ•°æ®</span></span><br><span class="line">tar -czf minio-backup.tar.gz /path/to/minio/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœæ­¢ç°æœ‰æœåŠ¡</span></span><br><span class="line">docker-compose down</span><br></pre></td></tr></table></figure><ol start="2"><li>éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹docker-compose.yml</span></span><br><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  minio:</span><br><span class="line">    image: minio/minio:latest</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">      - <span class="string">&quot;9001:9001&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ./data:/data</span><br><span class="line">    <span class="built_in">command</span>: server /data --console-address <span class="string">&quot;:9001&quot;</span></span><br></pre></td></tr></table></figure><h3 id="åŒæœºè¿ç§»æ–¹æ¡ˆ"><a href="#åŒæœºè¿ç§»æ–¹æ¡ˆ" class="headerlink" title="åŒæœºè¿ç§»æ–¹æ¡ˆ"></a>åŒæœºè¿ç§»æ–¹æ¡ˆ</h3><ol><li>æ–°ç¯å¢ƒéƒ¨ç½²ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># éƒ¨ç½²æ–°ç‰ˆMinIO</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯æœåŠ¡çŠ¶æ€</span></span><br><span class="line">curl http://new-minio:9000/minio/health</span><br></pre></td></tr></table></figure><ol start="2"><li>æ•°æ®è¿ç§»ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ‰§è¡Œå¢é‡åŒæ­¥</span></span><br><span class="line">./mc mirror --watch source-minio/bucket target-minio/bucket</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯æ•°æ®ä¸€è‡´æ€§</span></span><br><span class="line">./mc diff source-minio/bucket target-minio/bucket</span><br></pre></td></tr></table></figure><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><ol><li><p>å­˜å‚¨å…¼å®¹æ€§ï¼š</p><ul><li>2022.6å‰åç‰ˆæœ¬å­˜å‚¨ç»“æ„å·®å¼‚æ˜¾è‘—</li><li>éœ€è¦ä½¿ç”¨mcå·¥å…·è¿›è¡Œæ•°æ®è½¬æ¢</li><li>ç¡®ä¿æ•°æ®å®Œæ•´æ€§éªŒè¯</li></ul></li><li><p>æ€§èƒ½è€ƒè™‘ï¼š</p><ul><li>å¤§è§„æ¨¡æ•°æ®è¿ç§»éœ€è¦è¯„ä¼°ç½‘ç»œå¸¦å®½</li><li>å»ºè®®ä½¿ç”¨å‹ç¼©ä¼ è¾“</li><li>è€ƒè™‘åˆ†æ‰¹è¿ç§»ç­–ç•¥</li></ul></li><li><p>ä¸šåŠ¡å½±å“ï¼š</p><ul><li>è¯„ä¼°ä¸šåŠ¡åœæœºæ—¶é—´</li><li>å‡†å¤‡å›æ»šæ–¹æ¡ˆ</li><li>ç¡®ä¿é…ç½®æ–‡ä»¶åŒæ­¥æ›´æ–°</li></ul></li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡æ¡£æä¾›äº†å®Œæ•´çš„MinIOæ•°æ®åŒæ­¥ä¸è¿ç§»æ–¹æ¡ˆï¼Œé‡ç‚¹è§£å†³äº†ç‰ˆæœ¬å·®å¼‚å¸¦æ¥çš„å­˜å‚¨ç»“æ„å˜åŒ–é—®é¢˜ã€‚é€šè¿‡åˆç†ä½¿ç”¨mcå·¥å…·ï¼Œå¯ä»¥å®ç°å®‰å…¨å¯é çš„æ•°æ®è¿ç§»ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†MinIOå¯¹è±¡å­˜å‚¨æœåŠ¡çš„æ•°æ®åŒæ­¥å’Œè¿ç§»æ–¹æ¡ˆï¼Œé‡ç‚¹å…³æ³¨2022å¹´6æœˆå‰åç‰ˆæœ¬çš„å­˜å‚¨ç»“æ„å·®å¼‚ã€‚æ–‡æ¡£æ¶µç›–äº†åŒç‰ˆæœ¬åŒæ­¥ã€è·¨ç‰ˆæœ¬è¿ç§»ã€åŸåœ°å‡çº§å’ŒåŒæœºè¿ç§»ç­‰å¤šç§åœºæ™¯çš„å…·ä½“æ“ä½œæ–¹æ³•ï¼Œå¹¶æä¾›äº†å®Œæ•´çš„å‘½ä»¤ç¤ºä¾‹å’Œæ³¨æ„äº‹é¡¹ï¼Œå¸®åŠ©è¿ç»´äººå‘˜å®‰å…¨å¯é åœ°å®ŒæˆMinIOæ•°æ®è¿ç§»å·¥ä½œã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="MinIO" scheme="https://freemankevin.uk/categories/MinIO/"/>
    
    
    <category term="Docker" scheme="https://freemankevin.uk/tags/Docker/"/>
    
    <category term="Backup" scheme="https://freemankevin.uk/tags/Backup/"/>
    
    <category term="MinIO" scheme="https://freemankevin.uk/tags/MinIO/"/>
    
  </entry>
  
</feed>
